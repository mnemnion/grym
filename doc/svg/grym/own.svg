<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3578pt" height="1933pt"
 viewBox="0.00 0.00 3577.50 1932.80" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1928.8029)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1928.8029 3573.5,-1928.8029 3573.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1165" cy="-1906.8029" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1165" y="-1902.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 150</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1165" cy="-1834.8029" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="1165" y="-1830.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;48</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1165,-1888.6342C1165,-1880.9338 1165,-1871.7772 1165,-1863.2195"/>
<polygon fill="#000000" stroke="#000000" points="1168.5001,-1863.2161 1165,-1853.2161 1161.5001,-1863.2162 1168.5001,-1863.2161"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="228" cy="-1762.8029" rx="98.1935" ry="18"/>
<text text-anchor="middle" x="228" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Ownership function</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1106.0315,-1830.2717C949.865,-1818.2717 524.1867,-1785.5621 328.6542,-1770.5372"/>
<polygon fill="#000000" stroke="#000000" points="328.9051,-1767.0463 318.6663,-1769.7698 328.3688,-1774.0257 328.9051,-1767.0463"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="663" cy="-1762.8029" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="663" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;5</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1110.3216,-1826.9605C1013.352,-1813.0526 812.4487,-1784.2377 716.4006,-1770.4619"/>
<polygon fill="#000000" stroke="#000000" points="716.7248,-1766.9727 706.3292,-1769.0174 715.7309,-1773.9018 716.7248,-1766.9727"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="910" cy="-1762.8029" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="910" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 6&#45;8</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1120.8735,-1822.3436C1075.1893,-1809.4445 1004.0747,-1789.3652 957.2654,-1776.1484"/>
<polygon fill="#000000" stroke="#000000" points="957.9485,-1772.7045 947.3736,-1773.3554 956.0463,-1779.4411 957.9485,-1772.7045"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="1229" cy="-1762.8029" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="1229" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 9&#45;13</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1180.4926,-1817.3737C1188.4325,-1808.4413 1198.2394,-1797.4085 1206.953,-1787.6058"/>
<polygon fill="#000000" stroke="#000000" points="1209.6223,-1789.871 1213.6501,-1780.0716 1204.3904,-1785.2204 1209.6223,-1789.871"/>
</g>
<!-- codeblock_6 -->
<g id="node7" class="node">
<title>codeblock_6</title>
<ellipse fill="none" stroke="#000000" cx="1584" cy="-1762.8029" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="1584" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 14&#45;46</text>
</g>
<!-- section_1&#45;&gt;codeblock_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;codeblock_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1217.6424,-1825.7569C1291.9878,-1812.9816 1427.9987,-1789.6098 1511.7489,-1775.2183"/>
<polygon fill="#000000" stroke="#000000" points="1512.4329,-1778.6522 1521.6957,-1773.5091 1511.2473,-1771.7533 1512.4329,-1778.6522"/>
</g>
<!-- section_7 -->
<g id="node8" class="node">
<title>section_7</title>
<ellipse fill="none" stroke="#000000" cx="2399" cy="-1762.8029" rx="70.655" ry="18"/>
<text text-anchor="middle" x="2399" y="-1758.6029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 49&#45;150</text>
</g>
<!-- section_1&#45;&gt;section_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;section_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1224.9354,-1831.3058C1428.032,-1819.4558 2090.2929,-1780.815 2319.8214,-1767.4227"/>
<polygon fill="#000000" stroke="#000000" points="2320.3155,-1770.8999 2330.0946,-1766.8233 2319.9077,-1763.9118 2320.3155,-1770.8999"/>
</g>
<!-- leaf_8 -->
<g id="node9" class="node">
<title>leaf_8</title>
<polygon fill="none" stroke="#c0c0c0" points="54,-1480.8026 0,-1480.8026 0,-1444.8026 54,-1444.8026 54,-1480.8026"/>
</g>
<!-- header_2&#45;&gt;leaf_8 -->
<g id="edge8" class="edge">
<title>header_2&#45;&gt;leaf_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M163.6871,-1749.1C123.297,-1739.1596 76.3965,-1724.7107 63,-1708.8029 10.2875,-1646.209 15.9062,-1541.4053 22.3689,-1491.2417"/>
<polygon fill="#000000" stroke="#000000" points="25.8655,-1491.5082 23.7824,-1481.1202 18.9328,-1490.5399 25.8655,-1491.5082"/>
</g>
<!-- leaf_9 -->
<g id="node10" class="node">
<title>leaf_9</title>
<polygon fill="none" stroke="#c0c0c0" points="599.5,-1490.103 72.5,-1490.103 72.5,-1435.5021 599.5,-1435.5021 599.5,-1490.103"/>
<text text-anchor="middle" x="336" y="-1459.0026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Taking a multi&#45;pass approach to this Grimoire instance will benefit us </text>
<text text-anchor="middle" x="336" y="-1443.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">in a few ways. </text>
</g>
<!-- block_3&#45;&gt;leaf_9 -->
<g id="edge9" class="edge">
<title>block_3&#45;&gt;leaf_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M644.9533,-1746.2462C593.2799,-1698.8394 443.9633,-1561.8516 373.5677,-1497.2684"/>
<polygon fill="#000000" stroke="#000000" points="375.9304,-1494.6862 366.1955,-1490.5049 371.1981,-1499.8443 375.9304,-1494.6862"/>
</g>
<!-- leaf_10 -->
<g id="node11" class="node">
<title>leaf_10</title>
<polygon fill="none" stroke="#c0c0c0" points="1074.5,-1482.1031 617.5,-1482.1031 617.5,-1443.502 1074.5,-1443.502 1074.5,-1482.1031"/>
<text text-anchor="middle" x="846" y="-1467.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">First, Grimoire itself is structured in a certain fashion. The </text>
<text text-anchor="middle" x="846" y="-1451.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">straightforward thing is to mirror that fashion in code.</text>
</g>
<!-- block_4&#45;&gt;leaf_10 -->
<g id="edge10" class="edge">
<title>block_4&#45;&gt;leaf_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M906.0929,-1744.4881C895.369,-1694.22 865.4056,-1553.7663 852.2865,-1492.2704"/>
<polygon fill="#000000" stroke="#000000" points="855.6951,-1491.4728 850.1857,-1482.4231 848.8492,-1492.9333 855.6951,-1491.4728"/>
</g>
<!-- leaf_11 -->
<g id="node12" class="node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="1619.5,-1497.4038 1092.5,-1497.4038 1092.5,-1428.2013 1619.5,-1428.2013 1619.5,-1497.4038"/>
<text text-anchor="middle" x="1356" y="-1482.4026" font-family="Inconsolata" font-size="14.00" fill="#000000">Second, the critical path right now is simple code generation from </text>
<text text-anchor="middle" x="1356" y="-1467.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">Grimoire documents. Parsing prose gets useful later, for now I simply</text>
<text text-anchor="middle" x="1356" y="-1451.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">wish to unravel some existing code into Grimoire format and start working</text>
<text text-anchor="middle" x="1356" y="-1436.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">on it accordingly. </text>
</g>
<!-- block_5&#45;&gt;leaf_11 -->
<g id="edge11" class="edge">
<title>block_5&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1236.5641,-1744.9349C1256.1085,-1698.7671 1308.7424,-1574.4347 1337.171,-1507.2805"/>
<polygon fill="#000000" stroke="#000000" points="1340.5076,-1508.3768 1341.1829,-1497.8035 1334.0614,-1505.6479 1340.5076,-1508.3768"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="1948,-1708.8032 1638,-1708.8032 1638,-1216.8019 1948,-1216.8019 1948,-1708.8032"/>
<text text-anchor="middle" x="1793" y="-1693.6029" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="1793" y="-1662.2028" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;peg/epeg&quot;</text>
<text text-anchor="middle" x="1793" y="-1630.8028" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;../lib/util&quot;</text>
<text text-anchor="middle" x="1793" y="-1615.4028" font-family="Inconsolata" font-size="14.00" fill="#000000">local freeze = util.freeze</text>
<text text-anchor="middle" x="1793" y="-1584.0027" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp</text>
<text text-anchor="middle" x="1793" y="-1552.6027" font-family="Inconsolata" font-size="14.00" fill="#000000">local a = require &quot;../lib/ansi&quot;</text>
<text text-anchor="middle" x="1793" y="-1537.2027" font-family="Inconsolata" font-size="14.00" fill="#000000">local u = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="1793" y="-1489.8027" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="1793" y="-1458.4026" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;peg/node&quot;</text>
<text text-anchor="middle" x="1793" y="-1427.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">local m = require &quot;grym/morphemes&quot;</text>
<text text-anchor="middle" x="1793" y="-1395.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">local Header = require &quot;grym/header&quot;</text>
<text text-anchor="middle" x="1793" y="-1380.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">local Section = require &quot;grym/section&quot;</text>
<text text-anchor="middle" x="1793" y="-1364.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">local Block = require &quot;grym/block&quot;</text>
<text text-anchor="middle" x="1793" y="-1349.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">local Codeblock = require &quot;grym/codeblock&quot;</text>
<text text-anchor="middle" x="1793" y="-1318.0024" font-family="Inconsolata" font-size="14.00" fill="#000000">local own = {}</text>
<text text-anchor="middle" x="1793" y="-1286.6024" font-family="Inconsolata" font-size="14.00" fill="#000000">local blue = tostring(a.blue)</text>
<text text-anchor="middle" x="1793" y="-1271.2024" font-family="Inconsolata" font-size="14.00" fill="#000000">local red = tostring(a.red)</text>
<text text-anchor="middle" x="1793" y="-1255.8023" font-family="Inconsolata" font-size="14.00" fill="#000000">local dim = tostring(a.dim)</text>
<text text-anchor="middle" x="1793" y="-1240.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">local green = tostring(a.green)</text>
<text text-anchor="middle" x="1793" y="-1225.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">local cl &#160;&#160;= tostring(a.clear)</text>
</g>
<!-- codeblock_6&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>codeblock_6&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1599.0925,-1745.1337C1607.79,-1734.7439 1618.79,-1721.2439 1628,-1708.8029 1629.2335,-1707.1367 1630.469,-1705.4619 1631.7063,-1703.7794"/>
<polygon fill="#000000" stroke="#000000" points="1634.8264,-1705.442 1637.9049,-1695.3043 1629.1764,-1701.3096 1634.8264,-1705.442"/>
</g>
<!-- header_13 -->
<g id="node14" class="node">
<title>header_13</title>
<ellipse fill="none" stroke="#000000" cx="2108" cy="-1462.8026" rx="142.1715" ry="18"/>
<text text-anchor="middle" x="2108" y="-1458.6026" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : Helper functions for own.parse</text>
</g>
<!-- section_7&#45;&gt;header_13 -->
<g id="edge13" class="edge">
<title>section_7&#45;&gt;header_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2345.522,-1751.0216C2317.4495,-1742.7848 2283.827,-1729.4696 2259,-1708.8029 2185.4945,-1647.6148 2137.6633,-1540.9351 2118.079,-1490.6008"/>
<polygon fill="#000000" stroke="#000000" points="2121.265,-1489.1323 2114.4344,-1481.0333 2114.7235,-1491.6242 2121.265,-1489.1323"/>
</g>
<!-- block_14 -->
<g id="node15" class="node">
<title>block_14</title>
<ellipse fill="none" stroke="#000000" cx="2324" cy="-1462.8026" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2324" y="-1458.6026" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 49&#45;54</text>
</g>
<!-- section_7&#45;&gt;block_14 -->
<g id="edge14" class="edge">
<title>section_7&#45;&gt;block_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2394.4213,-1744.4881C2381.7602,-1693.8438 2346.2141,-1551.6591 2331.0251,-1490.9032"/>
<polygon fill="#000000" stroke="#000000" points="2334.3397,-1489.7301 2328.5188,-1480.8776 2327.5487,-1491.4279 2334.3397,-1489.7301"/>
</g>
<!-- codeblock_15 -->
<g id="node16" class="node">
<title>codeblock_15</title>
<ellipse fill="none" stroke="#000000" cx="2475" cy="-1462.8026" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="2475" y="-1458.6026" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 55&#45;65</text>
</g>
<!-- section_7&#45;&gt;codeblock_15 -->
<g id="edge15" class="edge">
<title>section_7&#45;&gt;codeblock_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2403.6397,-1744.4881C2416.4696,-1693.8438 2452.4897,-1551.6591 2467.8812,-1490.9032"/>
<polygon fill="#000000" stroke="#000000" points="2471.358,-1491.4309 2470.421,-1480.8776 2464.5723,-1489.7119 2471.358,-1491.4309"/>
</g>
<!-- block_16 -->
<g id="node17" class="node">
<title>block_16</title>
<ellipse fill="none" stroke="#000000" cx="2725" cy="-1462.8026" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2725" y="-1458.6026" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 68&#45;71</text>
</g>
<!-- section_7&#45;&gt;block_16 -->
<g id="edge16" class="edge">
<title>section_7&#45;&gt;block_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2458.1561,-1752.8957C2490.9752,-1745.1252 2531.0786,-1731.6567 2561,-1708.8029 2639.205,-1649.0701 2692.2543,-1540.8352 2713.9646,-1490.2461"/>
<polygon fill="#000000" stroke="#000000" points="2717.2329,-1491.5029 2717.887,-1480.9283 2710.7813,-1488.787 2717.2329,-1491.5029"/>
</g>
<!-- codeblock_17 -->
<g id="node18" class="node">
<title>codeblock_17</title>
<ellipse fill="none" stroke="#000000" cx="3126" cy="-1462.8026" rx="82.2579" ry="18"/>
<text text-anchor="middle" x="3126" y="-1458.6026" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 72&#45;149</text>
</g>
<!-- section_7&#45;&gt;codeblock_17 -->
<g id="edge17" class="edge">
<title>section_7&#45;&gt;codeblock_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2466.8055,-1757.4691C2562.752,-1749.2388 2732.8319,-1731.9425 2790,-1708.8029 2921.899,-1655.4148 3049.5915,-1538.7089 3101.5803,-1487.604"/>
<polygon fill="#000000" stroke="#000000" points="3104.0537,-1490.0804 3108.693,-1480.5553 3099.1263,-1485.1084 3104.0537,-1490.0804"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="1816,-608.4011 1762,-608.4011 1762,-572.4011 1816,-572.4011 1816,-608.4011"/>
</g>
<!-- header_13&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>header_13&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2102.196,-1444.7393C2086.5799,-1399.1013 2039.1988,-1278.421 1957,-1216.8022 1908.3439,-1180.3282 1863.3651,-1227.9817 1825,-1180.8022 1685.8837,-1009.724 1754.8129,-710.2697 1780.6565,-618.1538"/>
<polygon fill="#000000" stroke="#000000" points="1784.048,-619.0239 1783.4381,-608.4466 1777.3188,-617.0955 1784.048,-619.0239"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="2256,-625.6015 1834,-625.6015 1834,-555.2007 2256,-555.2007 2256,-625.6015"/>
<text text-anchor="middle" x="2045" y="-594.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Trims leading whitespace, returning the amount taken and</text>
<text text-anchor="middle" x="2045" y="-578.9011" font-family="Inconsolata" font-size="14.00" fill="#000000">the trimmed string.</text>
<text text-anchor="middle" x="2045" y="-563.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
</g>
<!-- block_14&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>block_14&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2319.7021,-1444.7776C2309.8649,-1403.9454 2284.5818,-1301.3657 2259,-1216.8022 2192.3514,-996.4877 2098.9987,-737.4813 2061.5241,-635.1848"/>
<polygon fill="#000000" stroke="#000000" points="2064.8044,-633.9639 2058.0747,-625.7809 2058.2325,-636.3745 2064.8044,-633.9639"/>
</g>
<!-- leaf_20 -->
<g id="node21" class="node">
<title>leaf_20</title>
<polygon fill="none" stroke="#c0c0c0" points="2675.5,-663.5019 2274.5,-663.5019 2274.5,-517.3003 2675.5,-517.3003 2675.5,-663.5019"/>
<text text-anchor="middle" x="2475" y="-648.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">local function lead_whitespace(str)</text>
<text text-anchor="middle" x="2475" y="-633.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local lead_ws = L.match(m.WS, str)</text>
<text text-anchor="middle" x="2475" y="-617.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if lead_ws &gt; 1 then</text>
<text text-anchor="middle" x="2475" y="-602.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; &#160;io.write(green..(&quot;%&quot;):rep(lead_ws &#45; 1)..cl)</text>
<text text-anchor="middle" x="2475" y="-586.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;return lead_ws, str:sub(lead_ws)</text>
<text text-anchor="middle" x="2475" y="-571.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="2475" y="-556.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;return 0, str</text>
<text text-anchor="middle" x="2475" y="-540.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2475" y="-525.301" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_15&#45;&gt;leaf_20 -->
<g id="edge20" class="edge">
<title>codeblock_15&#45;&gt;leaf_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2475,-1444.5812C2475,-1345.4821 2475,-868.6878 2475,-673.7369"/>
<polygon fill="#000000" stroke="#000000" points="2478.5001,-673.5468 2475,-663.5468 2471.5001,-673.5468 2478.5001,-673.5468"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="2954.5,-617.7015 2693.5,-617.7015 2693.5,-563.1007 2954.5,-563.1007 2954.5,-617.7015"/>
<text text-anchor="middle" x="2824" y="-602.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> Takes a string, parsing ownership.</text>
<text text-anchor="middle" x="2824" y="-587.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> Returns a Doc.</text>
</g>
<!-- block_16&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>block_16&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2727.0678,-1444.5812C2739.3379,-1336.4554 2802.6326,-778.6932 2819.7358,-627.9775"/>
<polygon fill="#000000" stroke="#000000" points="2823.2361,-628.1721 2820.8861,-617.8412 2816.2808,-627.3827 2823.2361,-628.1721"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="3569.5,-1180.7034 2972.5,-1180.7034 2972.5,-.0989 3569.5,-.0989 3569.5,-1180.7034"/>
<text text-anchor="middle" x="3271" y="-1165.6022" font-family="Inconsolata" font-size="14.00" fill="#000000">function own(doc, str)</text>
<text text-anchor="middle" x="3271" y="-1150.2022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local linum = 1</text>
<text text-anchor="middle" x="3271" y="-1134.8022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local doc_level = 0</text>
<text text-anchor="middle" x="3271" y="-1119.4022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local start = 1</text>
<text text-anchor="middle" x="3271" y="-1104.0021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local num_lines = #(epeg.split(str,&quot;\n&quot;))</text>
<text text-anchor="middle" x="3271" y="-1088.6021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#45;&#45; Track code blocks separately to avoid `* A` type collisions in code</text>
<text text-anchor="middle" x="3271" y="-1073.2021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local code_block = false</text>
<text text-anchor="middle" x="3271" y="-1057.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, line in ipairs(epeg.split(str, &quot;\n&quot;)) do</text>
<text text-anchor="middle" x="3271" y="-1042.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text text-anchor="middle" x="3271" y="-1027.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; tab and return filtration</text>
<text text-anchor="middle" x="3271" y="-1011.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;local l, err = line:gsub(&quot;\t&quot;, &quot; &#160;&quot;):gsub(&quot;\r&quot;, &quot;&quot;) </text>
<text text-anchor="middle" x="3271" y="-996.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;local finish = start + #l</text>
<text text-anchor="middle" x="3271" y="-980.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; We should always have a string but..</text>
<text text-anchor="middle" x="3271" y="-965.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;if l then</text>
<text text-anchor="middle" x="3271" y="-950.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if not code_block then</text>
<text text-anchor="middle" x="3271" y="-934.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local indent, l_trim = lead_whitespace(l)</text>
<text text-anchor="middle" x="3271" y="-919.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local code_head = Codeblock.matchHead(l)</text>
<text text-anchor="middle" x="3271" y="-903.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if code_head then </text>
<text text-anchor="middle" x="3271" y="-888.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;code_block = true </text>
<text text-anchor="middle" x="3271" y="-873.0017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-857.6016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local isHeader, level, bareline = Header.match(l_trim) </text>
<text text-anchor="middle" x="3271" y="-826.2016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if isHeader then &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text text-anchor="middle" x="3271" y="-810.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local header = Header(bareline, level, start, finish, doc)</text>
<text text-anchor="middle" x="3271" y="-779.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; make new block and append to doc</text>
<text text-anchor="middle" x="3271" y="-764.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addSection(Section(header, linum, start, finish, doc.str), </text>
<text text-anchor="middle" x="3271" y="-748.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;linum, start)</text>
<text text-anchor="middle" x="3271" y="-717.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;else </text>
<text text-anchor="middle" x="3271" y="-701.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addLine(l, linum, finish)</text>
<text text-anchor="middle" x="3271" y="-686.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-671.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;else </text>
<text text-anchor="middle" x="3271" y="-655.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; code block logic, including restarts</text>
<text text-anchor="middle" x="3271" y="-640.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45;</text>
<text text-anchor="middle" x="3271" y="-624.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; NOTE that this will choke on unmatched code headers,</text>
<text text-anchor="middle" x="3271" y="-609.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; which I intend to fix. But it&#39;s fiddly.</text>
<text text-anchor="middle" x="3271" y="-594.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local code_foot = Codeblock.matchFoot(l)</text>
<text text-anchor="middle" x="3271" y="-578.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if code_foot then </text>
<text text-anchor="middle" x="3271" y="-563.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;code_block = false</text>
<text text-anchor="middle" x="3271" y="-547.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-532.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addLine(l, linum, finish)</text>
<text text-anchor="middle" x="3271" y="-517.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-501.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;elseif ER then</text>
<text text-anchor="middle" x="3271" y="-486.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;freeze(&quot;HUH?&quot;)</text>
<text text-anchor="middle" x="3271" y="-470.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-455.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;linum = linum + 1</text>
<text text-anchor="middle" x="3271" y="-440.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;start = finish</text>
<text text-anchor="middle" x="3271" y="-424.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;if linum &lt; num_lines then start = start + 1 end</text>
<text text-anchor="middle" x="3271" y="-409.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-393.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if (doc.latest) then</text>
<text text-anchor="middle" x="3271" y="-378.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;doc.latest.line_last = linum &#45; 1</text>
<text text-anchor="middle" x="3271" y="-363.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;assert(type(start) == &#39;number&#39;)</text>
<text text-anchor="middle" x="3271" y="-347.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;doc.latest.last = start</text>
<text text-anchor="middle" x="3271" y="-332.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="3271" y="-316.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;assert(false, &quot;no doc.latest&quot;)</text>
<text text-anchor="middle" x="3271" y="-301.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-286.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local sections = doc:select(&quot;section&quot;)</text>
<text text-anchor="middle" x="3271" y="-270.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, s in ipairs(sections) do</text>
<text text-anchor="middle" x="3271" y="-255.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:check()</text>
<text text-anchor="middle" x="3271" y="-239.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:block()</text>
<text text-anchor="middle" x="3271" y="-224.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:weed()</text>
<text text-anchor="middle" x="3271" y="-209.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-193.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local blocks = doc:select(&quot;block&quot;)</text>
<text text-anchor="middle" x="3271" y="-178.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, v in ipairs(blocks) do</text>
<text text-anchor="middle" x="3271" y="-162.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;v:toValue()</text>
<text text-anchor="middle" x="3271" y="-147.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-132.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local cbs = doc:select(&quot;codeblock&quot;)</text>
<text text-anchor="middle" x="3271" y="-116.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, v in ipairs(cbs) do</text>
<text text-anchor="middle" x="3271" y="-101.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;v:toValue()</text>
<text text-anchor="middle" x="3271" y="-85.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3271" y="-70.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;doc.linum = linum &#45; 1</text>
<text text-anchor="middle" x="3271" y="-55.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return doc</text>
<text text-anchor="middle" x="3271" y="-39.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3271" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">return own</text>
</g>
<!-- codeblock_17&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>codeblock_17&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3129.0285,-1444.5812C3135.5406,-1405.4011 3151.8653,-1307.1825 3171.2281,-1190.6852"/>
<polygon fill="#000000" stroke="#000000" points="3174.6811,-1191.2562 3172.8681,-1180.8177 3167.7758,-1190.1085 3174.6811,-1191.2562"/>
</g>
</g>
</svg>