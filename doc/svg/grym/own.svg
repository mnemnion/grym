<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3369pt" height="1887pt"
 viewBox="0.00 0.00 3368.50 1886.60" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1882.6028)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1882.6028 3364.5,-1882.6028 3364.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1242.5" cy="-1860.6028" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1242.5" y="-1856.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 147</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1242.5" cy="-1788.6028" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="1242.5" y="-1784.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;48</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1242.5,-1842.4341C1242.5,-1834.7337 1242.5,-1825.5771 1242.5,-1817.0194"/>
<polygon fill="#000000" stroke="#000000" points="1246.0001,-1817.016 1242.5,-1807.016 1239.0001,-1817.0161 1246.0001,-1817.016"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="971.5" cy="-1716.6028" rx="98.1935" ry="18"/>
<text text-anchor="middle" x="971.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Ownership function</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1197.1407,-1776.5516C1153.3499,-1764.9172 1086.5713,-1747.1752 1037.0113,-1734.008"/>
<polygon fill="#000000" stroke="#000000" points="1037.9042,-1730.6239 1027.3407,-1731.4387 1036.1067,-1737.3892 1037.9042,-1730.6239"/>
</g>
<!-- prose_3 -->
<g id="node4" class="node">
<title>prose_3</title>
<ellipse fill="none" stroke="#000000" cx="1119.5" cy="-1716.6028" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1119.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;prose_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1214.8964,-1772.4446C1195.8555,-1761.2987 1170.5105,-1746.4626 1150.7307,-1734.8842"/>
<polygon fill="#000000" stroke="#000000" points="1152.4752,-1731.8498 1142.0769,-1729.8185 1148.9389,-1737.8909 1152.4752,-1731.8498"/>
</g>
<!-- prose_4 -->
<g id="node5" class="node">
<title>prose_4</title>
<ellipse fill="none" stroke="#000000" cx="1201.5" cy="-1716.6028" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1201.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;prose_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1232.3652,-1770.805C1227.5632,-1762.3723 1221.7315,-1752.1313 1216.4358,-1742.8316"/>
<polygon fill="#000000" stroke="#000000" points="1219.3667,-1740.9053 1211.3768,-1733.9474 1213.2838,-1744.3692 1219.3667,-1740.9053"/>
</g>
<!-- prose_5 -->
<g id="node6" class="node">
<title>prose_5</title>
<ellipse fill="none" stroke="#000000" cx="1283.5" cy="-1716.6028" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1283.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;prose_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1252.6348,-1770.805C1257.4368,-1762.3723 1263.2685,-1752.1313 1268.5642,-1742.8316"/>
<polygon fill="#000000" stroke="#000000" points="1271.7162,-1744.3692 1273.6232,-1733.9474 1265.6333,-1740.9053 1271.7162,-1744.3692"/>
</g>
<!-- codeblock_6 -->
<g id="node7" class="node">
<title>codeblock_6</title>
<ellipse fill="none" stroke="#000000" cx="1566.5" cy="-1716.6028" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="1566.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 14&#45;46</text>
</g>
<!-- section_1&#45;&gt;codeblock_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;codeblock_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1291.3569,-1777.7457C1347.0371,-1765.3723 1438.3348,-1745.0839 1500.3573,-1731.3012"/>
<polygon fill="#000000" stroke="#000000" points="1501.4297,-1734.6483 1510.4323,-1729.0623 1499.9112,-1727.815 1501.4297,-1734.6483"/>
</g>
<!-- section_7 -->
<g id="node8" class="node">
<title>section_7</title>
<ellipse fill="none" stroke="#000000" cx="2292.5" cy="-1716.6028" rx="70.655" ry="18"/>
<text text-anchor="middle" x="2292.5" y="-1712.4028" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 49&#45;147</text>
</g>
<!-- section_1&#45;&gt;section_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;section_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1301.961,-1784.5255C1480.6292,-1772.2739 2012.7611,-1735.7849 2214.1214,-1721.9773"/>
<polygon fill="#000000" stroke="#000000" points="2214.5839,-1725.4539 2224.321,-1721.2779 2214.105,-1718.4703 2214.5839,-1725.4539"/>
</g>
<!-- leaf_8 -->
<g id="node9" class="node">
<title>leaf_8</title>
<polygon fill="none" stroke="#c0c0c0" points="527,-1451.9028 0,-1451.9028 0,-1381.3021 527,-1381.3021 527,-1451.9028"/>
<text text-anchor="middle" x="263.5" y="-1404.8025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Taking a multi&#45;pass approach to this Grimoire instance will benefit us </text>
<text text-anchor="middle" x="263.5" y="-1389.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">in a few ways. </text>
</g>
<!-- prose_3&#45;&gt;leaf_8 -->
<g id="edge8" class="edge">
<title>prose_3&#45;&gt;leaf_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1095.2698,-1704.3183C1089.871,-1702.0507 1084.0878,-1699.9699 1078.5,-1698.6028 961.033,-1669.8634 646.8512,-1709.7765 535.5,-1662.6028 431.9131,-1618.7184 341.7444,-1518.2251 295.817,-1460.1701"/>
<polygon fill="#000000" stroke="#000000" points="298.5532,-1457.9874 289.6333,-1452.2702 293.0411,-1462.3021 298.5532,-1457.9874"/>
</g>
<!-- leaf_9 -->
<g id="node10" class="node">
<title>leaf_9</title>
<polygon fill="none" stroke="#c0c0c0" points="1002,-1443.9029 545,-1443.9029 545,-1389.302 1002,-1389.302 1002,-1443.9029"/>
<text text-anchor="middle" x="773.5" y="-1412.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">First, Grimoire itself is structured in a certain fashion. The </text>
<text text-anchor="middle" x="773.5" y="-1397.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">straightforward thing is to mirror that fashion in code.</text>
</g>
<!-- prose_4&#45;&gt;leaf_9 -->
<g id="edge9" class="edge">
<title>prose_4&#45;&gt;leaf_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1176.6267,-1704.8401C1171.3689,-1702.5928 1165.8048,-1700.388 1160.5,-1698.6028 1095.5209,-1676.7359 1070.0047,-1696.6561 1010.5,-1662.6028 916.4488,-1608.7792 835.9159,-1506.4622 797.5192,-1452.2991"/>
<polygon fill="#000000" stroke="#000000" points="800.3305,-1450.212 791.723,-1444.0345 794.5995,-1454.2314 800.3305,-1450.212"/>
</g>
<!-- leaf_10 -->
<g id="node11" class="node">
<title>leaf_10</title>
<polygon fill="none" stroke="#c0c0c0" points="1547,-1459.2035 1020,-1459.2035 1020,-1374.0014 1547,-1374.0014 1547,-1459.2035"/>
<text text-anchor="middle" x="1283.5" y="-1428.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">Second, the critical path right now is simple code generation from </text>
<text text-anchor="middle" x="1283.5" y="-1412.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">Grimoire documents. Parsing prose gets useful later, for now I simply</text>
<text text-anchor="middle" x="1283.5" y="-1397.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">wish to unravel some existing code into Grimoire format and start working</text>
<text text-anchor="middle" x="1283.5" y="-1382.0024" font-family="Inconsolata" font-size="14.00" fill="#000000">on it accordingly. </text>
</g>
<!-- prose_5&#45;&gt;leaf_10 -->
<g id="edge10" class="edge">
<title>prose_5&#45;&gt;leaf_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1283.5,-1698.288C1283.5,-1653.6375 1283.5,-1537.8322 1283.5,-1469.4096"/>
<polygon fill="#000000" stroke="#000000" points="1287.0001,-1469.2628 1283.5,-1459.2629 1280.0001,-1469.2629 1287.0001,-1469.2628"/>
</g>
<!-- leaf_11 -->
<g id="node12" class="node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="1875.5,-1662.6031 1565.5,-1662.6031 1565.5,-1170.6018 1875.5,-1170.6018 1875.5,-1662.6031"/>
<text text-anchor="middle" x="1720.5" y="-1647.4028" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1616.0027" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;peg/epeg&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1584.6027" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;../lib/util&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1569.2027" font-family="Inconsolata" font-size="14.00" fill="#000000">local freeze = util.freeze</text>
<text text-anchor="middle" x="1720.5" y="-1537.8027" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp</text>
<text text-anchor="middle" x="1720.5" y="-1506.4026" font-family="Inconsolata" font-size="14.00" fill="#000000">local a = require &quot;../lib/ansi&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1491.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">local u = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1443.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1412.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;peg/node&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1380.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">local m = require &quot;grym/morphemes&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1349.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">local Header = require &quot;grym/header&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1334.0024" font-family="Inconsolata" font-size="14.00" fill="#000000">local Section = require &quot;grym/section&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1318.6024" font-family="Inconsolata" font-size="14.00" fill="#000000">local Block = require &quot;grym/block&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1303.2024" font-family="Inconsolata" font-size="14.00" fill="#000000">local Codeblock = require &quot;grym/codeblock&quot;</text>
<text text-anchor="middle" x="1720.5" y="-1271.8023" font-family="Inconsolata" font-size="14.00" fill="#000000">local own = {}</text>
<text text-anchor="middle" x="1720.5" y="-1240.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">local blue = tostring(a.blue)</text>
<text text-anchor="middle" x="1720.5" y="-1225.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">local red = tostring(a.red)</text>
<text text-anchor="middle" x="1720.5" y="-1209.6022" font-family="Inconsolata" font-size="14.00" fill="#000000">local dim = tostring(a.dim)</text>
<text text-anchor="middle" x="1720.5" y="-1194.2022" font-family="Inconsolata" font-size="14.00" fill="#000000">local green = tostring(a.green)</text>
<text text-anchor="middle" x="1720.5" y="-1178.8022" font-family="Inconsolata" font-size="14.00" fill="#000000">local cl &#160;&#160;= tostring(a.clear)</text>
</g>
<!-- codeblock_6&#45;&gt;leaf_11 -->
<g id="edge11" class="edge">
<title>codeblock_6&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1575.9016,-1698.288C1579.5749,-1691.1321 1584.1864,-1682.1486 1589.4856,-1671.8255"/>
<polygon fill="#000000" stroke="#000000" points="1592.6401,-1673.3444 1594.0932,-1662.8497 1586.4127,-1670.1477 1592.6401,-1673.3444"/>
</g>
<!-- header_12 -->
<g id="node13" class="node">
<title>header_12</title>
<ellipse fill="none" stroke="#000000" cx="2035.5" cy="-1416.6025" rx="142.1715" ry="18"/>
<text text-anchor="middle" x="2035.5" y="-1412.4025" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : Helper functions for own.parse</text>
</g>
<!-- section_7&#45;&gt;header_12 -->
<g id="edge12" class="edge">
<title>section_7&#45;&gt;header_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2251.6613,-1701.7704C2230.7736,-1692.746 2205.9387,-1679.6488 2187.5,-1662.6028 2117.3168,-1597.7207 2067.4556,-1493.2871 2046.5062,-1444.0142"/>
<polygon fill="#000000" stroke="#000000" points="2049.6767,-1442.5236 2042.5909,-1434.6469 2043.2181,-1445.2231 2049.6767,-1442.5236"/>
</g>
<!-- prose_13 -->
<g id="node14" class="node">
<title>prose_13</title>
<ellipse fill="none" stroke="#000000" cx="2228.5" cy="-1416.6025" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="2228.5" y="-1412.4025" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_7&#45;&gt;prose_13 -->
<g id="edge13" class="edge">
<title>section_7&#45;&gt;prose_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2283.9501,-1698.4589C2279.3845,-1688.1414 2274.0003,-1674.8683 2270.5,-1662.6028 2248.4855,-1585.461 2236.3449,-1491.221 2231.3114,-1444.9699"/>
<polygon fill="#000000" stroke="#000000" points="2234.7687,-1444.3815 2230.2364,-1434.8051 2227.8076,-1445.1177 2234.7687,-1444.3815"/>
</g>
<!-- codeblock_14 -->
<g id="node15" class="node">
<title>codeblock_14</title>
<ellipse fill="none" stroke="#000000" cx="2356.5" cy="-1416.6025" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="2356.5" y="-1412.4025" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 55&#45;65</text>
</g>
<!-- section_7&#45;&gt;codeblock_14 -->
<g id="edge14" class="edge">
<title>section_7&#45;&gt;codeblock_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2296.4071,-1698.288C2307.2113,-1647.6437 2337.544,-1505.459 2350.5052,-1444.7031"/>
<polygon fill="#000000" stroke="#000000" points="2353.9805,-1445.1877 2352.644,-1434.6775 2347.1346,-1443.7272 2353.9805,-1445.1877"/>
</g>
<!-- prose_15 -->
<g id="node16" class="node">
<title>prose_15</title>
<ellipse fill="none" stroke="#000000" cx="2594.5" cy="-1416.6025" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="2594.5" y="-1412.4025" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_7&#45;&gt;prose_15 -->
<g id="edge15" class="edge">
<title>section_7&#45;&gt;prose_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2349.0277,-1705.7738C2379.237,-1697.7814 2415.6296,-1684.396 2442.5,-1662.6028 2517.2801,-1601.9524 2565.3249,-1494.1082 2584.7223,-1443.8227"/>
<polygon fill="#000000" stroke="#000000" points="2588.066,-1444.8752 2588.3229,-1434.2835 2581.517,-1442.4032 2588.066,-1444.8752"/>
</g>
<!-- codeblock_16 -->
<g id="node17" class="node">
<title>codeblock_16</title>
<ellipse fill="none" stroke="#000000" cx="2931.5" cy="-1416.6025" rx="82.2579" ry="18"/>
<text text-anchor="middle" x="2931.5" y="-1412.4025" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 72&#45;146</text>
</g>
<!-- section_7&#45;&gt;codeblock_16 -->
<g id="edge16" class="edge">
<title>section_7&#45;&gt;codeblock_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2358.9863,-1710.3717C2444.3958,-1701.6424 2587.3722,-1684.3719 2635.5,-1662.6028 2754.5462,-1608.7559 2864.4263,-1493.6447 2909.6879,-1442.2754"/>
<polygon fill="#000000" stroke="#000000" points="2912.4504,-1444.433 2916.3888,-1434.5973 2907.1764,-1439.8302 2912.4504,-1444.433"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="2081.5,-610.5014 1659.5,-610.5014 1659.5,-524.1008 2081.5,-524.1008 2081.5,-610.5014"/>
<text text-anchor="middle" x="1870.5" y="-563.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Trims leading whitespace, returning the amount taken and</text>
<text text-anchor="middle" x="1870.5" y="-547.8011" font-family="Inconsolata" font-size="14.00" fill="#000000">the trimmed string.</text>
<text text-anchor="middle" x="1870.5" y="-532.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
</g>
<!-- prose_13&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>prose_13&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2231.0112,-1398.3835C2236.0747,-1353.9276 2242.6613,-1238.5706 2186.5,-1170.6022 2157.4745,-1135.4743 2122.901,-1166.6431 2090.5,-1134.6022 1942.4557,-988.2031 1891.9655,-730.9582 1876.5685,-620.3297"/>
<polygon fill="#000000" stroke="#000000" points="1880.0351,-619.8463 1875.2272,-610.4052 1873.0982,-620.7839 1880.0351,-619.8463"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="2501,-640.4019 2100,-640.4019 2100,-494.2003 2501,-494.2003 2501,-640.4019"/>
<text text-anchor="middle" x="2300.5" y="-625.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function lead_whitespace(str)</text>
<text text-anchor="middle" x="2300.5" y="-610.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local lead_ws = L.match(m.WS, str)</text>
<text text-anchor="middle" x="2300.5" y="-594.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if lead_ws &gt; 1 then</text>
<text text-anchor="middle" x="2300.5" y="-579.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; &#160;io.write(green..(&quot;%&quot;):rep(lead_ws &#45; 1)..cl)</text>
<text text-anchor="middle" x="2300.5" y="-563.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;return lead_ws, str:sub(lead_ws)</text>
<text text-anchor="middle" x="2300.5" y="-548.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="2300.5" y="-533.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;return 0, str</text>
<text text-anchor="middle" x="2300.5" y="-517.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2300.5" y="-502.201" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_14&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>codeblock_14&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2355.3045,-1398.4707C2348.9119,-1301.521 2318.5882,-841.6287 2305.9988,-650.6968"/>
<polygon fill="#000000" stroke="#000000" points="2309.4908,-650.4579 2305.3403,-640.7099 2302.5059,-650.9185 2309.4908,-650.4579"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="2780,-602.6014 2519,-602.6014 2519,-532.0007 2780,-532.0007 2780,-602.6014"/>
<text text-anchor="middle" x="2649.5" y="-571.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> Takes a string, parsing ownership.</text>
<text text-anchor="middle" x="2649.5" y="-556.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> Returns a Doc.</text>
</g>
<!-- prose_15&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>prose_15&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2595.6742,-1398.4707C2602.416,-1294.3653 2636.2592,-771.764 2646.5361,-613.0695"/>
<polygon fill="#000000" stroke="#000000" points="2650.0529,-612.9217 2647.2065,-602.7164 2643.0675,-612.4692 2650.0529,-612.9217"/>
</g>
<!-- leaf_20 -->
<g id="node21" class="node">
<title>leaf_20</title>
<polygon fill="none" stroke="#c0c0c0" points="3360.5,-1134.4033 2798.5,-1134.4033 2798.5,-.1989 3360.5,-.1989 3360.5,-1134.4033"/>
<text text-anchor="middle" x="3079.5" y="-1119.4022" font-family="Inconsolata" font-size="14.00" fill="#000000">function own(doc, str)</text>
<text text-anchor="middle" x="3079.5" y="-1104.0021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local linum = 1</text>
<text text-anchor="middle" x="3079.5" y="-1088.6021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local doc_level = 0</text>
<text text-anchor="middle" x="3079.5" y="-1073.2021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local start = 1</text>
<text text-anchor="middle" x="3079.5" y="-1057.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local num_lines = #(epeg.split(str,&quot;\n&quot;))</text>
<text text-anchor="middle" x="3079.5" y="-1042.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#45;&#45; Track code blocks separately to avoid `* A` type collisions in code</text>
<text text-anchor="middle" x="3079.5" y="-1027.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local code_block = false</text>
<text text-anchor="middle" x="3079.5" y="-1011.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, line in ipairs(epeg.split(str, &quot;\n&quot;)) do</text>
<text text-anchor="middle" x="3079.5" y="-996.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;local finish = start + #line</text>
<text text-anchor="middle" x="3079.5" y="-980.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; tab and return filtration</text>
<text text-anchor="middle" x="3079.5" y="-965.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;local l, err = line:gsub(&quot;\t&quot;, &quot; &#160;&quot;):gsub(&quot;\r&quot;, &quot;&quot;) </text>
<text text-anchor="middle" x="3079.5" y="-950.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; We should always have a string but..</text>
<text text-anchor="middle" x="3079.5" y="-934.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;if l then</text>
<text text-anchor="middle" x="3079.5" y="-919.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if not code_block then</text>
<text text-anchor="middle" x="3079.5" y="-903.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local indent, l_trim = lead_whitespace(l)</text>
<text text-anchor="middle" x="3079.5" y="-888.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local code_head = Codeblock.matchHead(l)</text>
<text text-anchor="middle" x="3079.5" y="-873.0017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if code_head then </text>
<text text-anchor="middle" x="3079.5" y="-857.6016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;code_block = true </text>
<text text-anchor="middle" x="3079.5" y="-842.2016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-826.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local isHeader, level, bareline = Header.match(l_trim) </text>
<text text-anchor="middle" x="3079.5" y="-795.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if isHeader then &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;</text>
<text text-anchor="middle" x="3079.5" y="-780.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local header = Header(bareline, level, start, finish, doc)</text>
<text text-anchor="middle" x="3079.5" y="-748.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; make new block and append to doc</text>
<text text-anchor="middle" x="3079.5" y="-733.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addSection(Section(header, linum), linum)</text>
<text text-anchor="middle" x="3079.5" y="-701.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;else </text>
<text text-anchor="middle" x="3079.5" y="-686.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addLine(l, linum)</text>
<text text-anchor="middle" x="3079.5" y="-671.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-655.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;else </text>
<text text-anchor="middle" x="3079.5" y="-640.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; code block logic, including restarts</text>
<text text-anchor="middle" x="3079.5" y="-624.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45;</text>
<text text-anchor="middle" x="3079.5" y="-609.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; NOTE that this will choke on unmatched code headers,</text>
<text text-anchor="middle" x="3079.5" y="-594.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; which I intend to fix. But it&#39;s fiddly.</text>
<text text-anchor="middle" x="3079.5" y="-578.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;local code_foot = Codeblock.matchFoot(l)</text>
<text text-anchor="middle" x="3079.5" y="-563.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if code_foot then </text>
<text text-anchor="middle" x="3079.5" y="-547.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;code_block = false</text>
<text text-anchor="middle" x="3079.5" y="-532.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-517.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;doc:addLine(l, linum)</text>
<text text-anchor="middle" x="3079.5" y="-501.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-486.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;elseif ER then</text>
<text text-anchor="middle" x="3079.5" y="-470.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;freeze(&quot;HUH?&quot;)</text>
<text text-anchor="middle" x="3079.5" y="-455.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-440.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;linum = linum + 1</text>
<text text-anchor="middle" x="3079.5" y="-424.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;start = finish</text>
<text text-anchor="middle" x="3079.5" y="-409.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;if linum &lt; num_lines then start = start + 1 end</text>
<text text-anchor="middle" x="3079.5" y="-393.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-378.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if (doc.latest) then</text>
<text text-anchor="middle" x="3079.5" y="-363.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;doc.latest.line_last = linum &#45; 1</text>
<text text-anchor="middle" x="3079.5" y="-347.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-332.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local sections = doc:select(&quot;section&quot;)</text>
<text text-anchor="middle" x="3079.5" y="-316.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, s in ipairs(sections) do</text>
<text text-anchor="middle" x="3079.5" y="-301.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:check()</text>
<text text-anchor="middle" x="3079.5" y="-286.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:block()</text>
<text text-anchor="middle" x="3079.5" y="-270.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-255.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local blocks = doc:select(&quot;block&quot;)</text>
<text text-anchor="middle" x="3079.5" y="-239.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, block in ipairs(blocks) do</text>
<text text-anchor="middle" x="3079.5" y="-224.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; block:toValue()</text>
<text text-anchor="middle" x="3079.5" y="-209.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;block:parseProse()</text>
<text text-anchor="middle" x="3079.5" y="-193.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-178.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, s in ipairs(sections) do</text>
<text text-anchor="middle" x="3079.5" y="-162.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;s:weed()</text>
<text text-anchor="middle" x="3079.5" y="-147.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-132.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local cbs = doc:select(&quot;codeblock&quot;)</text>
<text text-anchor="middle" x="3079.5" y="-116.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _, cb in ipairs(cbs) do</text>
<text text-anchor="middle" x="3079.5" y="-101.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;cb:toValue()</text>
<text text-anchor="middle" x="3079.5" y="-85.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3079.5" y="-70.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;doc.linum = linum &#45; 1</text>
<text text-anchor="middle" x="3079.5" y="-55.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return doc</text>
<text text-anchor="middle" x="3079.5" y="-39.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3079.5" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">return own</text>
</g>
<!-- codeblock_16&#45;&gt;leaf_20 -->
<g id="edge20" class="edge">
<title>codeblock_16&#45;&gt;leaf_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2934.6597,-1398.4707C2941.4881,-1359.2856 2958.6486,-1260.8097 2978.8705,-1144.766"/>
<polygon fill="#000000" stroke="#000000" points="2982.3774,-1145.0281 2980.6462,-1134.5757 2975.4814,-1143.8264 2982.3774,-1145.0281"/>
</g>
</g>
</svg>