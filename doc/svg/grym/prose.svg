<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="6316pt" height="4205pt"
 viewBox="0.00 0.00 6315.50 4205.41" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 4201.406)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-4201.406 6311.5,-4201.406 6311.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1988" cy="-4179.406" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1988" y="-4175.206" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 150</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1988" cy="-4107.406" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="1988" y="-4103.206" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;120</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1988,-4161.2373C1988,-4153.5369 1988,-4144.3803 1988,-4135.8226"/>
<polygon fill="#000000" stroke="#000000" points="1991.5001,-4135.8192 1988,-4125.8192 1984.5001,-4135.8193 1991.5001,-4135.8192"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="1545" cy="-3108.4046" rx="76.9193" ry="18"/>
<text text-anchor="middle" x="1545" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Prose module</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1925.0455,-4102.0821C1827.9858,-4093.2593 1650.8557,-4074.4769 1631,-4053.406 1377.7005,-3784.604 1502.1057,-3261.8281 1536.9245,-3136.0883"/>
<polygon fill="#000000" stroke="#000000" points="1540.2999,-3137.0136 1539.6382,-3126.4395 1533.5614,-3135.1184 1540.2999,-3137.0136"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="1686" cy="-3108.4046" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="1686" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;4</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1924.8795,-4102.1634C1859.7489,-4095.3279 1764.447,-4080.8595 1741,-4053.406 1619.8176,-3911.5164 1670.3473,-3277.7759 1683.3083,-3136.4202"/>
<polygon fill="#000000" stroke="#000000" points="1686.7998,-3136.6735 1684.2411,-3126.3923 1679.8299,-3136.0251 1686.7998,-3136.6735"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="1801" cy="-3108.4046" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="1801" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 5&#45;25</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1957.4506,-4091.4232C1943.0783,-4082.269 1927.127,-4069.4039 1918,-4053.406 1735.8844,-3734.1894 1781.8349,-3256.7474 1797.0834,-3136.611"/>
<polygon fill="#000000" stroke="#000000" points="1800.5898,-3136.7889 1798.4139,-3126.4199 1793.6487,-3135.8827 1800.5898,-3136.7889"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="1988" cy="-3108.4046" rx="60.9913" ry="18"/>
<text text-anchor="middle" x="1988" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 26&#45;120</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1988,-4089.2136C1988,-3968.602 1988,-3284.5852 1988,-3136.6259"/>
<polygon fill="#000000" stroke="#000000" points="1991.5001,-3136.5421 1988,-3126.5422 1984.5001,-3136.5422 1991.5001,-3136.5421"/>
</g>
<!-- section_6 -->
<g id="node7" class="node">
<title>section_6</title>
<ellipse fill="none" stroke="#000000" cx="2769" cy="-3108.4046" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="2769" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 30&#45;94</text>
</g>
<!-- section_1&#45;&gt;section_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;section_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2012.9739,-4090.6524C2026.9652,-4080.6705 2044.2998,-4067.2722 2058,-4053.406 2380.0867,-3727.4137 2681.0252,-3251.4918 2752.8424,-3134.9063"/>
<polygon fill="#000000" stroke="#000000" points="2755.917,-3136.588 2758.1689,-3126.2352 2749.9524,-3132.9241 2755.917,-3136.588"/>
</g>
<!-- section_7 -->
<g id="node8" class="node">
<title>section_7</title>
<ellipse fill="none" stroke="#000000" cx="5477" cy="-3108.4046" rx="75.4916" ry="18"/>
<text text-anchor="middle" x="5477" y="-3104.2046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 121&#45;150</text>
</g>
<!-- section_1&#45;&gt;section_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;section_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2053.4884,-4105.6564C2226.5493,-4100.6529 2693.0711,-4084.5974 2844,-4053.406 3936.9923,-3827.5249 5189.4067,-3245.6776 5434.2686,-3128.968"/>
<polygon fill="#000000" stroke="#000000" points="5436.024,-3132.0084 5443.5402,-3124.5414 5433.008,-3125.6914 5436.024,-3132.0084"/>
</g>
<!-- leaf_60 -->
<g id="node61" class="node">
<title>leaf_60</title>
<polygon fill="none" stroke="#c0c0c0" points="6125.5,-4053.4074 5570.5,-4053.4074 5570.5,-2163.4017 6125.5,-2163.4017 6125.5,-4053.4074"/>
<text text-anchor="middle" x="5848" y="-4038.206" font-family="Inconsolata" font-size="14.00" fill="#000000">* Prose module</text>
<text text-anchor="middle" x="5848" y="-4006.8059" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Here we need a proper recursive parser. &#160;Eventually.</text>
<text text-anchor="middle" x="5848" y="-3975.4059" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="5848" y="-3960.0059" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="5848" y="-3928.6058" font-family="Inconsolata" font-size="14.00" fill="#000000">local u = require &quot;util&quot;</text>
<text text-anchor="middle" x="5848" y="-3913.2058" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require (&quot;status&quot;)()</text>
<text text-anchor="middle" x="5848" y="-3897.8058" font-family="Inconsolata" font-size="14.00" fill="#000000">local epnf = require &quot;peg/epnf&quot;</text>
<text text-anchor="middle" x="5848" y="-3882.4057" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;peg/epeg&quot;</text>
<text text-anchor="middle" x="5848" y="-3867.0057" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp</text>
<text text-anchor="middle" x="5848" y="-3851.6057" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
<text text-anchor="middle" x="5848" y="-3820.2056" font-family="Inconsolata" font-size="14.00" fill="#000000">local m = require &quot;grym/morphemes&quot;</text>
<text text-anchor="middle" x="5848" y="-3788.8056" font-family="Inconsolata" font-size="14.00" fill="#000000">local Link = require &quot;grym/link&quot;</text>
<text text-anchor="middle" x="5848" y="-3773.4056" font-family="Inconsolata" font-size="14.00" fill="#000000">assert(type(Link) == &#39;function&#39;)</text>
<text text-anchor="middle" x="5848" y="-3758.0056" font-family="Inconsolata" font-size="14.00" fill="#000000">local Grammar = require &quot;node/grammar&quot;</text>
<text text-anchor="middle" x="5848" y="-3710.6055" font-family="Inconsolata" font-size="14.00" fill="#000000">local Pr, pr = u.inherit(Node)</text>
<text text-anchor="middle" x="5848" y="-3695.2055" font-family="Inconsolata" font-size="14.00" fill="#000000">Pr.id = &quot;prose&quot;</text>
<text text-anchor="middle" x="5848" y="-3679.8055" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="5848" y="-3648.4054" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="5848" y="-3633.0054" font-family="Inconsolata" font-size="14.00" fill="#000000">s.chatty = false &#160;</text>
<text text-anchor="middle" x="5848" y="-3617.6054" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="5848" y="-3586.2053" font-family="Inconsolata" font-size="14.00" fill="#000000">** Bookend parsing</text>
<text text-anchor="middle" x="5848" y="-3554.8053" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;We need to generate parsers to match sequences of single characters, so</text>
<text text-anchor="middle" x="5848" y="-3539.4053" font-family="Inconsolata" font-size="14.00" fill="#000000">that *bold*, **bold**, ***bold*** etc all work correctly.</text>
<text text-anchor="middle" x="5848" y="-3508.0052" font-family="Inconsolata" font-size="14.00" fill="#000000">Bookends are a fun construct borrowed from the [[LPEG manual][httk://]]]]</text>
<text text-anchor="middle" x="5848" y="-3492.6052" font-family="Inconsolata" font-size="14.00" fill="#000000">model for Lua long strings. &#160;The GGG/Pegylator form of a bookend construct</text>
<text text-anchor="middle" x="5848" y="-3477.2052" font-family="Inconsolata" font-size="14.00" fill="#000000">is </text>
<text text-anchor="middle" x="5848" y="-3445.8051" font-family="Inconsolata" font-size="14.00" fill="#000000">~#!peg</text>
<text text-anchor="middle" x="5848" y="-3430.4051" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;bookend = &quot;`&quot;:a !&quot;`&quot;:a pattern &#160;&quot;`&quot;:a</text>
<text text-anchor="middle" x="5848" y="-3415.0051" font-family="Inconsolata" font-size="14.00" fill="#000000">~#/peg</text>
<text text-anchor="middle" x="5848" y="-3383.6051" font-family="Inconsolata" font-size="14.00" fill="#000000">The =lpeg= engine doesn&#39;t model this directly but it&#39;s possible to provide</text>
<text text-anchor="middle" x="5848" y="-3368.205" font-family="Inconsolata" font-size="14.00" fill="#000000">it. &#160;We only need the subset of this where =a= is unique, that is, =pattern=</text>
<text text-anchor="middle" x="5848" y="-3352.805" font-family="Inconsolata" font-size="14.00" fill="#000000">does not contain =bookend= at any level of expansion. </text>
<text text-anchor="middle" x="5848" y="-3321.405" font-family="Inconsolata" font-size="14.00" fill="#000000">GGG being a specification format needn&#39;t respect this limitation. &#160;Orb</text>
<text text-anchor="middle" x="5848" y="-3306.0049" font-family="Inconsolata" font-size="14.00" fill="#000000">does so by design. &#160;It is a simple consquence of the sort of markup we are</text>
<text text-anchor="middle" x="5848" y="-3290.6049" font-family="Inconsolata" font-size="14.00" fill="#000000">using; there is no need to parse ***bold **inside bold** still bold*** twice,</text>
<text text-anchor="middle" x="5848" y="-3275.2049" font-family="Inconsolata" font-size="14.00" fill="#000000">and this generalizes to all text styles. </text>
<text text-anchor="middle" x="5848" y="-3243.8048" font-family="Inconsolata" font-size="14.00" fill="#000000">We do have to wire them up so that we don&#39;t cross the streams. &#160;Sans macros.</text>
<text text-anchor="middle" x="5848" y="-3228.4048" font-family="Inconsolata" font-size="14.00" fill="#000000">By hand. </text>
<text text-anchor="middle" x="5848" y="-3181.0048" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="5848" y="-3165.6047" font-family="Inconsolata" font-size="14.00" fill="#000000">local function equal_strings(s, i, a, b)</text>
<text text-anchor="middle" x="5848" y="-3150.2047" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns true if a and b are equal.</text>
<text text-anchor="middle" x="5848" y="-3134.8047" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; s and i are not used, provided because expected by Cb.</text>
<text text-anchor="middle" x="5848" y="-3119.4047" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return a == b</text>
<text text-anchor="middle" x="5848" y="-3104.0046" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5848" y="-3072.6046" font-family="Inconsolata" font-size="14.00" fill="#000000">local function bookends(sigil)</text>
<text text-anchor="middle" x="5848" y="-3057.2046" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local Cg, C, P, Cmt, Cb = L.Cg, L.C, L.P, L.Cmt, L.Cb</text>
<text text-anchor="middle" x="5848" y="-3041.8045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns a pair of patterns, _open and _close,</text>
<text text-anchor="middle" x="5848" y="-3026.4045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; which will match a brace of sigil.</text>
<text text-anchor="middle" x="5848" y="-3011.0045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; sigil must be a string. </text>
<text text-anchor="middle" x="5848" y="-2995.6044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _open = Cg(C(P(sigil)^1), sigil .. &quot;_init&quot;)</text>
<text text-anchor="middle" x="5848" y="-2980.2044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _close = &#160;Cmt(C(P(sigil)^1) * Cb(sigil .. &quot;_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="5848" y="-2964.8044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return _open, _close</text>
<text text-anchor="middle" x="5848" y="-2949.4043" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5848" y="-2918.0043" font-family="Inconsolata" font-size="14.00" fill="#000000">local bold_open, bold_close &#160;&#160;&#160;&#160;= &#160;bookends(&quot;*&quot;)</text>
<text text-anchor="middle" x="5848" y="-2902.6043" font-family="Inconsolata" font-size="14.00" fill="#000000">local italic_open, italic_close = &#160;bookends(&quot;/&quot;)</text>
<text text-anchor="middle" x="5848" y="-2887.2042" font-family="Inconsolata" font-size="14.00" fill="#000000">local under_open, under_close &#160;&#160;= &#160;bookends(&quot;_&quot;)</text>
<text text-anchor="middle" x="5848" y="-2871.8042" font-family="Inconsolata" font-size="14.00" fill="#000000">local strike_open, strike_close = &#160;bookends(&quot;&#45;&quot;)</text>
<text text-anchor="middle" x="5848" y="-2856.4042" font-family="Inconsolata" font-size="14.00" fill="#000000">local lit_open, lit_close &#160;&#160;&#160;&#160;&#160;&#160;= &#160;bookends(&quot;=&quot;)</text>
<text text-anchor="middle" x="5848" y="-2841.0042" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="5848" y="-2809.6041" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="5848" y="-2794.2041" font-family="Inconsolata" font-size="14.00" fill="#000000">function Pr.toMarkdown(prose)</text>
<text text-anchor="middle" x="5848" y="-2778.8041" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="5848" y="-2763.404" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for _, node in ipairs(prose) do</text>
<text text-anchor="middle" x="5848" y="-2748.004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if node.toMarkdown then</text>
<text text-anchor="middle" x="5848" y="-2732.604" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase .. node:toMarkdown()</text>
<text text-anchor="middle" x="5848" y="-2717.2039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id == &quot;raw&quot; then</text>
<text text-anchor="middle" x="5848" y="-2701.8039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase &#160;.. node:toValue()</text>
<text text-anchor="middle" x="5848" y="-2686.4039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="5848" y="-2671.0038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="5848" y="-2655.6038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="5848" y="-2640.2038" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5848" y="-2624.8037" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="5848" y="-2577.4037" font-family="Inconsolata" font-size="14.00" fill="#000000">*** prose grammar</text>
<text text-anchor="middle" x="5848" y="-2546.0037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The Prose module is the first one to use our shiny&#45;new Node module. &#160;Which</text>
<text text-anchor="middle" x="5848" y="-2530.6037" font-family="Inconsolata" font-size="14.00" fill="#000000">finally works the way I intend it to and I&#39;m pretty happy about this. </text>
<text text-anchor="middle" x="5848" y="-2499.2036" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s pure link&#45;or&#45;raw, but it has everything it needs to be so much more.</text>
<text text-anchor="middle" x="5848" y="-2467.8036" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="5848" y="-2452.4036" font-family="Inconsolata" font-size="14.00" fill="#000000">local function prose_gm(_ENV)</text>
<text text-anchor="middle" x="5848" y="-2437.0035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;START &quot;prose&quot;</text>
<text text-anchor="middle" x="5848" y="-2421.6035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;prose = (V&quot;link&quot; + V&quot;raw&quot;)^1</text>
<text text-anchor="middle" x="5848" y="-2406.2035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;link = m.link</text>
<text text-anchor="middle" x="5848" y="-2390.8034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;raw = (P(1) &#45; m.link)^1</text>
<text text-anchor="middle" x="5848" y="-2375.4034" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5848" y="-2344.0034" font-family="Inconsolata" font-size="14.00" fill="#000000">local function proseBuild(prose, str)</text>
<text text-anchor="middle" x="5848" y="-2328.6033" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return setmetatable(prose, {__index = Pr })</text>
<text text-anchor="middle" x="5848" y="-2313.2033" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5848" y="-2281.8033" font-family="Inconsolata" font-size="14.00" fill="#000000">local parse = Grammar(prose_gm, { prose = proseBuild,</text>
<text text-anchor="middle" x="5848" y="-2266.4032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;link &#160;= Link }) &#160;</text>
<text text-anchor="middle" x="5848" y="-2219.0032" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="5848" y="-2171.6032" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_1&#45;&gt;leaf_60 -->
<g id="edge60" class="edge">
<title>section_1&#45;&gt;leaf_60</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2053.8989,-4106.94C2537.8369,-4103.4549 5524.5693,-4080.8446 5561,-4053.406 5561.4949,-4053.0332 5561.9889,-4052.6597 5562.4822,-4052.2853"/>
<polygon fill="#000000" stroke="#000000" points="5564.6406,-4055.0406 5570.4006,-4046.1483 5560.3525,-4049.5078 5564.6406,-4055.0406"/>
</g>
<!-- leaf_8 -->
<g id="node9" class="node">
<title>leaf_8</title>
<polygon fill="none" stroke="#c0c0c0" points="1564,-1631.2044 1170,-1631.2044 1170,-1591.4002 1564,-1591.4002 1564,-1631.2044"/>
<text text-anchor="middle" x="1367" y="-1599.8023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;Here we need a proper recursive parser. &#160;Eventually.</text>
</g>
<!-- block_3&#45;&gt;leaf_8 -->
<g id="edge8" class="edge">
<title>block_3&#45;&gt;leaf_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1687.1642,-3090.1275C1694.3002,-2973.0144 1728.6853,-2327.5861 1631,-2163.4032 1615.4868,-2137.3295 1592.4881,-2150.6563 1573,-2127.4032 1443.449,-1972.8236 1388.1099,-1726.5302 1372.1712,-1641.4045"/>
<polygon fill="#000000" stroke="#000000" points="1375.5811,-1640.5938 1370.3396,-1631.3863 1368.6952,-1641.8527 1375.5811,-1640.5938"/>
</g>
<!-- codeblock_9 -->
<g id="node10" class="node">
<title>codeblock_9</title>
<ellipse fill="none" stroke="#000000" cx="1655" cy="-1611.3023" rx="72.5844" ry="18"/>
<text text-anchor="middle" x="1655" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 5&#45;24</text>
</g>
<!-- block_4&#45;&gt;codeblock_9 -->
<g id="edge9" class="edge">
<title>block_4&#45;&gt;codeblock_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1800.4666,-3090.3345C1797.5094,-2994.4952 1781.7618,-2535.9964 1741,-2163.4032 1718.8891,-1961.2928 1675.3384,-1720.0563 1660.2745,-1639.2315"/>
<polygon fill="#000000" stroke="#000000" points="1663.702,-1638.5187 1658.4223,-1629.333 1656.8214,-1639.8062 1663.702,-1638.5187"/>
</g>
<!-- leaf_11 -->
<g id="node12" class="node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="1800,-1629.3023 1746,-1629.3023 1746,-1593.3023 1800,-1593.3023 1800,-1629.3023"/>
</g>
<!-- block_4&#45;&gt;leaf_11 -->
<g id="edge11" class="edge">
<title>block_4&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1800.6611,-3090.283C1797.7582,-2935.0716 1777.1012,-1830.5837 1773.5264,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="1777.0243,-1639.2976 1773.3378,-1629.3648 1770.0255,-1639.4286 1777.0243,-1639.2976"/>
</g>
<!-- codeblock_12 -->
<g id="node13" class="node">
<title>codeblock_12</title>
<ellipse fill="none" stroke="#000000" cx="1895" cy="-1611.3023" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="1895" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 26&#45;28</text>
</g>
<!-- block_5&#45;&gt;codeblock_12 -->
<g id="edge12" class="edge">
<title>block_5&#45;&gt;codeblock_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1986.8743,-3090.283C1977.2326,-2935.0716 1908.6218,-1830.5837 1896.7485,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="1900.2354,-1639.1286 1896.122,-1629.3648 1893.2489,-1639.5626 1900.2354,-1639.1286"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="2044,-1629.3023 1990,-1629.3023 1990,-1593.3023 2044,-1593.3023 2044,-1629.3023"/>
</g>
<!-- block_5&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>block_5&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1988.351,-3090.283C1991.3576,-2935.0716 2012.7524,-1830.5837 2016.4548,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="2019.9557,-1639.4308 2016.6501,-1629.3648 2012.957,-1639.2951 2019.9557,-1639.4308"/>
</g>
<!-- header_15 -->
<g id="node16" class="node">
<title>header_15</title>
<ellipse fill="none" stroke="#000000" cx="2151" cy="-1611.3023" rx="88.5398" ry="18"/>
<text text-anchor="middle" x="2151" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">2 : Bookend parsing</text>
</g>
<!-- section_6&#45;&gt;header_15 -->
<g id="edge15" class="edge">
<title>section_6&#45;&gt;header_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2756.922,-3090.6477C2693.3081,-2996.2606 2394.5425,-2542.0979 2249,-2127.4032 2186.1165,-1948.229 2160.6962,-1719.1169 2153.3965,-1639.8153"/>
<polygon fill="#000000" stroke="#000000" points="2156.8633,-1639.2882 2152.4847,-1629.6405 2149.8913,-1639.913 2156.8633,-1639.2882"/>
</g>
<!-- block_16 -->
<g id="node17" class="node">
<title>block_16</title>
<ellipse fill="none" stroke="#000000" cx="2314" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2314" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 30&#45;34</text>
</g>
<!-- section_6&#45;&gt;block_16 -->
<g id="edge16" class="edge">
<title>section_6&#45;&gt;block_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2759.761,-3090.2888C2711.1311,-2994.0726 2483.1285,-2532.0955 2379,-2127.4032 2332.1458,-1945.3054 2318.5098,-1718.0253 2315.0514,-1639.5096"/>
<polygon fill="#000000" stroke="#000000" points="2318.5451,-1639.2825 2314.6286,-1629.4382 2311.5513,-1639.5762 2318.5451,-1639.2825"/>
</g>
<!-- block_17 -->
<g id="node18" class="node">
<title>block_17</title>
<ellipse fill="none" stroke="#000000" cx="2444" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2444" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 35&#45;38</text>
</g>
<!-- section_6&#45;&gt;block_17 -->
<g id="edge17" class="edge">
<title>section_6&#45;&gt;block_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2763.2049,-3090.2381C2732.3407,-2992.8355 2585.813,-2522.1597 2509,-2127.4032 2473.1687,-1943.2591 2452.6889,-1718.1384 2446.2397,-1639.7894"/>
<polygon fill="#000000" stroke="#000000" points="2449.7206,-1639.4115 2445.4226,-1629.7276 2442.7435,-1639.9781 2449.7206,-1639.4115"/>
</g>
<!-- block_18 -->
<g id="node19" class="node">
<title>block_18</title>
<ellipse fill="none" stroke="#000000" cx="2574" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2574" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 39&#45;42</text>
</g>
<!-- section_6&#45;&gt;block_18 -->
<g id="edge18" class="edge">
<title>section_6&#45;&gt;block_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2766.5637,-3090.3539C2753.3799,-2992.6077 2689.3129,-2516.7324 2639,-2127.4032 2614.9567,-1941.3525 2587.1343,-1717.4194 2577.497,-1639.586"/>
<polygon fill="#000000" stroke="#000000" points="2580.962,-1639.0865 2576.2601,-1629.5922 2574.015,-1639.9464 2580.962,-1639.0865"/>
</g>
<!-- block_19 -->
<g id="node20" class="node">
<title>block_19</title>
<ellipse fill="none" stroke="#000000" cx="2704" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2704" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 43&#45;46</text>
</g>
<!-- section_6&#45;&gt;block_19 -->
<g id="edge19" class="edge">
<title>section_6&#45;&gt;block_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2768.2132,-3090.283C2761.4744,-2935.0716 2713.5206,-1830.5837 2705.2221,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="2708.7148,-1639.2036 2704.7842,-1629.3648 2701.7214,-1639.5073 2708.7148,-1639.2036"/>
</g>
<!-- block_20 -->
<g id="node21" class="node">
<title>block_20</title>
<ellipse fill="none" stroke="#000000" cx="2834" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2834" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 47&#45;51</text>
</g>
<!-- section_6&#45;&gt;block_20 -->
<g id="edge20" class="edge">
<title>section_6&#45;&gt;block_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2769.7868,-3090.283C2776.5256,-2935.0716 2824.4794,-1830.5837 2832.7779,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="2836.2786,-1639.5073 2833.2158,-1629.3648 2829.2852,-1639.2036 2836.2786,-1639.5073"/>
</g>
<!-- block_21 -->
<g id="node22" class="node">
<title>block_21</title>
<ellipse fill="none" stroke="#000000" cx="3184" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="3184" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 52&#45;55</text>
</g>
<!-- section_6&#45;&gt;block_21 -->
<g id="edge21" class="edge">
<title>section_6&#45;&gt;block_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2774.0233,-3090.283C2817.0697,-2934.9943 3123.5196,-1829.4839 3176.2764,-1639.1651"/>
<polygon fill="#000000" stroke="#000000" points="3179.6945,-1639.9364 3178.993,-1629.3648 3172.9489,-1638.0665 3179.6945,-1639.9364"/>
</g>
<!-- block_22 -->
<g id="node23" class="node">
<title>block_22</title>
<ellipse fill="none" stroke="#000000" cx="3663" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="3663" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 56&#45;79</text>
</g>
<!-- section_6&#45;&gt;block_22 -->
<g id="edge22" class="edge">
<title>section_6&#45;&gt;block_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2779.6628,-3090.5484C2871.9763,-2935.9593 3535.214,-1825.2942 3647.0174,-1638.0669"/>
<polygon fill="#000000" stroke="#000000" points="3650.0809,-1639.7634 3652.2029,-1629.3833 3644.0709,-1636.1745 3650.0809,-1639.7634"/>
</g>
<!-- block_23 -->
<g id="node24" class="node">
<title>block_23</title>
<ellipse fill="none" stroke="#000000" cx="3907" cy="-1611.3023" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="3907" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 80&#45;94</text>
</g>
<!-- section_6&#45;&gt;block_23 -->
<g id="edge23" class="edge">
<title>section_6&#45;&gt;block_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2791.7958,-3091.482C2908.3531,-3003.824 3443.2745,-2587.7084 3728,-2127.4032 3832.563,-1958.3601 3885.8937,-1720.1761 3901.7937,-1639.3713"/>
<polygon fill="#000000" stroke="#000000" points="3905.2481,-1639.9423 3903.7103,-1629.4597 3898.3754,-1638.6133 3905.2481,-1639.9423"/>
</g>
<!-- section_24 -->
<g id="node25" class="node">
<title>section_24</title>
<ellipse fill="none" stroke="#000000" cx="4312" cy="-1611.3023" rx="70.655" ry="18"/>
<text text-anchor="middle" x="4312" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 95&#45;120</text>
</g>
<!-- section_6&#45;&gt;section_24 -->
<g id="edge24" class="edge">
<title>section_6&#45;&gt;section_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2795.1298,-3091.553C2930.4431,-3003.4396 3561.0416,-2582.3764 3972,-2127.4032 4123.3543,-1959.8384 4255.628,-1719.0023 4297.911,-1638.5958"/>
<polygon fill="#000000" stroke="#000000" points="4301.0823,-1640.0842 4302.6166,-1629.6011 4294.8798,-1636.8394 4301.0823,-1640.0842"/>
</g>
<!-- leaf_47 -->
<g id="node48" class="node">
<title>leaf_47</title>
<polygon fill="none" stroke="#c0c0c0" points="4955.5,-2127.504 4400.5,-2127.504 4400.5,-1095.1007 4955.5,-1095.1007 4955.5,-2127.504"/>
<text text-anchor="middle" x="4678" y="-2112.2032" font-family="Inconsolata" font-size="14.00" fill="#000000">** Bookend parsing</text>
<text text-anchor="middle" x="4678" y="-2080.8031" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;We need to generate parsers to match sequences of single characters, so</text>
<text text-anchor="middle" x="4678" y="-2065.4031" font-family="Inconsolata" font-size="14.00" fill="#000000">that *bold*, **bold**, ***bold*** etc all work correctly.</text>
<text text-anchor="middle" x="4678" y="-2034.0031" font-family="Inconsolata" font-size="14.00" fill="#000000">Bookends are a fun construct borrowed from the [[LPEG manual][httk://]]]]</text>
<text text-anchor="middle" x="4678" y="-2018.603" font-family="Inconsolata" font-size="14.00" fill="#000000">model for Lua long strings. &#160;The GGG/Pegylator form of a bookend construct</text>
<text text-anchor="middle" x="4678" y="-2003.203" font-family="Inconsolata" font-size="14.00" fill="#000000">is </text>
<text text-anchor="middle" x="4678" y="-1971.803" font-family="Inconsolata" font-size="14.00" fill="#000000">~#!peg</text>
<text text-anchor="middle" x="4678" y="-1956.4029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;bookend = &quot;`&quot;:a !&quot;`&quot;:a pattern &#160;&quot;`&quot;:a</text>
<text text-anchor="middle" x="4678" y="-1941.0029" font-family="Inconsolata" font-size="14.00" fill="#000000">~#/peg</text>
<text text-anchor="middle" x="4678" y="-1909.6029" font-family="Inconsolata" font-size="14.00" fill="#000000">The =lpeg= engine doesn&#39;t model this directly but it&#39;s possible to provide</text>
<text text-anchor="middle" x="4678" y="-1894.2028" font-family="Inconsolata" font-size="14.00" fill="#000000">it. &#160;We only need the subset of this where =a= is unique, that is, =pattern=</text>
<text text-anchor="middle" x="4678" y="-1878.8028" font-family="Inconsolata" font-size="14.00" fill="#000000">does not contain =bookend= at any level of expansion. </text>
<text text-anchor="middle" x="4678" y="-1847.4028" font-family="Inconsolata" font-size="14.00" fill="#000000">GGG being a specification format needn&#39;t respect this limitation. &#160;Orb</text>
<text text-anchor="middle" x="4678" y="-1832.0027" font-family="Inconsolata" font-size="14.00" fill="#000000">does so by design. &#160;It is a simple consquence of the sort of markup we are</text>
<text text-anchor="middle" x="4678" y="-1816.6027" font-family="Inconsolata" font-size="14.00" fill="#000000">using; there is no need to parse ***bold **inside bold** still bold*** twice,</text>
<text text-anchor="middle" x="4678" y="-1801.2027" font-family="Inconsolata" font-size="14.00" fill="#000000">and this generalizes to all text styles. </text>
<text text-anchor="middle" x="4678" y="-1769.8027" font-family="Inconsolata" font-size="14.00" fill="#000000">We do have to wire them up so that we don&#39;t cross the streams. &#160;Sans macros.</text>
<text text-anchor="middle" x="4678" y="-1754.4026" font-family="Inconsolata" font-size="14.00" fill="#000000">By hand. </text>
<text text-anchor="middle" x="4678" y="-1707.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="4678" y="-1691.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">local function equal_strings(s, i, a, b)</text>
<text text-anchor="middle" x="4678" y="-1676.2025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns true if a and b are equal.</text>
<text text-anchor="middle" x="4678" y="-1660.8025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; s and i are not used, provided because expected by Cb.</text>
<text text-anchor="middle" x="4678" y="-1645.4025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return a == b</text>
<text text-anchor="middle" x="4678" y="-1630.0024" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="4678" y="-1598.6024" font-family="Inconsolata" font-size="14.00" fill="#000000">local function bookends(sigil)</text>
<text text-anchor="middle" x="4678" y="-1583.2024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local Cg, C, P, Cmt, Cb = L.Cg, L.C, L.P, L.Cmt, L.Cb</text>
<text text-anchor="middle" x="4678" y="-1567.8023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns a pair of patterns, _open and _close,</text>
<text text-anchor="middle" x="4678" y="-1552.4023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; which will match a brace of sigil.</text>
<text text-anchor="middle" x="4678" y="-1537.0023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; sigil must be a string. </text>
<text text-anchor="middle" x="4678" y="-1521.6022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _open = Cg(C(P(sigil)^1), sigil .. &quot;_init&quot;)</text>
<text text-anchor="middle" x="4678" y="-1506.2022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _close = &#160;Cmt(C(P(sigil)^1) * Cb(sigil .. &quot;_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="4678" y="-1490.8022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return _open, _close</text>
<text text-anchor="middle" x="4678" y="-1475.4022" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="4678" y="-1444.0021" font-family="Inconsolata" font-size="14.00" fill="#000000">local bold_open, bold_close &#160;&#160;&#160;&#160;= &#160;bookends(&quot;*&quot;)</text>
<text text-anchor="middle" x="4678" y="-1428.6021" font-family="Inconsolata" font-size="14.00" fill="#000000">local italic_open, italic_close = &#160;bookends(&quot;/&quot;)</text>
<text text-anchor="middle" x="4678" y="-1413.2021" font-family="Inconsolata" font-size="14.00" fill="#000000">local under_open, under_close &#160;&#160;= &#160;bookends(&quot;_&quot;)</text>
<text text-anchor="middle" x="4678" y="-1397.802" font-family="Inconsolata" font-size="14.00" fill="#000000">local strike_open, strike_close = &#160;bookends(&quot;&#45;&quot;)</text>
<text text-anchor="middle" x="4678" y="-1382.402" font-family="Inconsolata" font-size="14.00" fill="#000000">local lit_open, lit_close &#160;&#160;&#160;&#160;&#160;&#160;= &#160;bookends(&quot;=&quot;)</text>
<text text-anchor="middle" x="4678" y="-1367.002" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="4678" y="-1335.6019" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="4678" y="-1320.2019" font-family="Inconsolata" font-size="14.00" fill="#000000">function Pr.toMarkdown(prose)</text>
<text text-anchor="middle" x="4678" y="-1304.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="4678" y="-1289.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for _, node in ipairs(prose) do</text>
<text text-anchor="middle" x="4678" y="-1274.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if node.toMarkdown then</text>
<text text-anchor="middle" x="4678" y="-1258.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase .. node:toMarkdown()</text>
<text text-anchor="middle" x="4678" y="-1243.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id == &quot;raw&quot; then</text>
<text text-anchor="middle" x="4678" y="-1227.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase &#160;.. node:toValue()</text>
<text text-anchor="middle" x="4678" y="-1212.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="4678" y="-1197.0017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="4678" y="-1181.6016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="4678" y="-1166.2016" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="4678" y="-1150.8016" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="4678" y="-1103.4015" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_6&#45;&gt;leaf_47 -->
<g id="edge47" class="edge">
<title>section_6&#45;&gt;leaf_47</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2807.7599,-3093.8483C3001.3154,-3019.5281 3874.4183,-2664.847 4392,-2127.4032 4392.5329,-2126.8498 4393.0652,-2126.2952 4393.5968,-2125.7394"/>
<polygon fill="#000000" stroke="#000000" points="4396.1566,-2128.1264 4400.47,-2118.4493 4391.0634,-2123.3244 4396.1566,-2128.1264"/>
</g>
<!-- header_48 -->
<g id="node49" class="node">
<title>header_48</title>
<ellipse fill="none" stroke="#000000" cx="5325" cy="-1611.3023" rx="68.2066" ry="18"/>
<text text-anchor="middle" x="5325" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">2 : Constructor</text>
</g>
<!-- section_7&#45;&gt;header_48 -->
<g id="edge48" class="edge">
<title>section_7&#45;&gt;header_48</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5475.1601,-3090.283C5459.4016,-2935.0716 5347.2635,-1830.5837 5327.8578,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="5331.3262,-1638.9601 5326.8339,-1629.3648 5324.362,-1639.6673 5331.3262,-1638.9601"/>
</g>
<!-- block_49 -->
<g id="node50" class="node">
<title>block_49</title>
<ellipse fill="none" stroke="#000000" cx="5477" cy="-1611.3023" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="5477" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 121&#45;124</text>
</g>
<!-- section_7&#45;&gt;block_49 -->
<g id="edge49" class="edge">
<title>section_7&#45;&gt;block_49</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5477,-3090.283C5477,-2935.0716 5477,-1830.5837 5477,-1639.4499"/>
<polygon fill="#000000" stroke="#000000" points="5480.5001,-1639.3648 5477,-1629.3648 5473.5001,-1639.3649 5480.5001,-1639.3648"/>
</g>
<!-- block_50 -->
<g id="node51" class="node">
<title>block_50</title>
<ellipse fill="none" stroke="#000000" cx="5687" cy="-1611.3023" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="5687" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 125&#45;135</text>
</g>
<!-- section_7&#45;&gt;block_50 -->
<g id="edge50" class="edge">
<title>section_7&#45;&gt;block_50</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5477.7315,-3090.2774C5481.7978,-2994.1471 5503.5812,-2534.4051 5562,-2163.4032 5593.9659,-1960.3965 5657.1133,-1720.6603 5679.173,-1639.651"/>
<polygon fill="#000000" stroke="#000000" points="5682.6278,-1640.2862 5681.8893,-1629.7171 5675.8756,-1638.4398 5682.6278,-1640.2862"/>
</g>
<!-- block_51 -->
<g id="node52" class="node">
<title>block_51</title>
<ellipse fill="none" stroke="#000000" cx="5893" cy="-1611.3023" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="5893" y="-1607.1023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 136&#45;150</text>
</g>
<!-- section_7&#45;&gt;block_51 -->
<g id="edge51" class="edge">
<title>section_7&#45;&gt;block_51</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5471.6342,-3090.1367C5441.7234,-2984.1413 5305.9193,-2443.1809 5562,-2163.4032 5622.9802,-2096.78 5695.9254,-2188.9773 5762,-2127.4032 5905.4922,-1993.6845 5901.1162,-1727.0976 5895.4127,-1639.7422"/>
<polygon fill="#000000" stroke="#000000" points="5898.8878,-1639.2673 5894.6851,-1629.5417 5891.9056,-1639.7654 5898.8878,-1639.2673"/>
</g>
<!-- leaf_59 -->
<g id="node60" class="node">
<title>leaf_59</title>
<polygon fill="none" stroke="#c0c0c0" points="6307.5,-1834.8028 5976.5,-1834.8028 5976.5,-1387.8019 6307.5,-1387.8019 6307.5,-1834.8028"/>
<text text-anchor="middle" x="6142" y="-1819.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">** Constructor</text>
<text text-anchor="middle" x="6142" y="-1788.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45; [ ] #todo smuggle in that offset in =parse=</text>
<text text-anchor="middle" x="6142" y="-1756.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="6142" y="-1741.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">local function new(Prose, block)</text>
<text text-anchor="middle" x="6142" y="-1726.0024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local phrase = &quot;\n&quot;</text>
<text text-anchor="middle" x="6142" y="-1710.6024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _,l in ipairs(block.lines) do</text>
<text text-anchor="middle" x="6142" y="-1695.2024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;phrase = phrase .. l .. &quot;\n&quot;</text>
<text text-anchor="middle" x="6142" y="-1679.8023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="6142" y="-1664.4023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local prose = parse(phrase, 0) </text>
<text text-anchor="middle" x="6142" y="-1649.0023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return prose</text>
<text text-anchor="middle" x="6142" y="-1633.6022" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="6142" y="-1618.2022" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="6142" y="-1586.8022" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="6142" y="-1571.4022" font-family="Inconsolata" font-size="14.00" fill="#000000">return u.export(pr, new)</text>
<text text-anchor="middle" x="6142" y="-1556.0021" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
</g>
<!-- section_7&#45;&gt;leaf_59 -->
<g id="edge59" class="edge">
<title>section_7&#45;&gt;leaf_59</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5471.3654,-3090.1301C5439.5696,-2982.9717 5293.3477,-2431.7153 5562,-2163.4032 5626.0876,-2099.3967 5896.8376,-2183.4386 5968,-2127.4032 6054.0913,-2059.6122 6097.8949,-1947.4367 6120.0546,-1844.9526"/>
<polygon fill="#000000" stroke="#000000" points="6123.5006,-1845.573 6122.1322,-1835.0669 6116.6503,-1844.1332 6123.5006,-1845.573"/>
</g>
<!-- leaf_10 -->
<g id="node11" class="node">
<title>leaf_10</title>
<polygon fill="none" stroke="#c0c0c0" points="282,-988.8017 0,-988.8017 0,-700.4007 282,-700.4007 282,-988.8017"/>
<text text-anchor="middle" x="141" y="-973.5014" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="141" y="-942.1014" font-family="Inconsolata" font-size="14.00" fill="#000000">local u = require &quot;util&quot;</text>
<text text-anchor="middle" x="141" y="-926.7014" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require (&quot;status&quot;)()</text>
<text text-anchor="middle" x="141" y="-911.3013" font-family="Inconsolata" font-size="14.00" fill="#000000">local epnf = require &quot;peg/epnf&quot;</text>
<text text-anchor="middle" x="141" y="-895.9013" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;peg/epeg&quot;</text>
<text text-anchor="middle" x="141" y="-880.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp</text>
<text text-anchor="middle" x="141" y="-865.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
<text text-anchor="middle" x="141" y="-833.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">local m = require &quot;grym/morphemes&quot;</text>
<text text-anchor="middle" x="141" y="-802.3012" font-family="Inconsolata" font-size="14.00" fill="#000000">local Link = require &quot;grym/link&quot;</text>
<text text-anchor="middle" x="141" y="-786.9011" font-family="Inconsolata" font-size="14.00" fill="#000000">assert(type(Link) == &#39;function&#39;)</text>
<text text-anchor="middle" x="141" y="-771.5011" font-family="Inconsolata" font-size="14.00" fill="#000000">local Grammar = require &quot;node/grammar&quot;</text>
<text text-anchor="middle" x="141" y="-724.1011" font-family="Inconsolata" font-size="14.00" fill="#000000">local Pr, pr = u.inherit(Node)</text>
<text text-anchor="middle" x="141" y="-708.701" font-family="Inconsolata" font-size="14.00" fill="#000000">Pr.id = &quot;prose&quot;</text>
</g>
<!-- codeblock_9&#45;&gt;leaf_10 -->
<g id="edge10" class="edge">
<title>codeblock_9&#45;&gt;leaf_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1659.1067,-1593.1891C1674.9744,-1517.9653 1724.1634,-1227.9564 1573,-1095.2015 1519.4642,-1048.1852 353.7178,-1093.0111 291,-1059.2015 263.3797,-1044.3121 239.7484,-1021.8491 219.9632,-996.9794"/>
<polygon fill="#000000" stroke="#000000" points="222.5536,-994.6071 213.6744,-988.8268 217.011,-998.8826 222.5536,-994.6071"/>
</g>
<!-- leaf_13 -->
<g id="node14" class="node">
<title>leaf_13</title>
<polygon fill="none" stroke="#c0c0c0" points="442,-862.6012 300,-862.6012 300,-826.6012 442,-826.6012 442,-862.6012"/>
<text text-anchor="middle" x="371" y="-841.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">s.chatty = false &#160;</text>
</g>
<!-- codeblock_12&#45;&gt;leaf_13 -->
<g id="edge13" class="edge">
<title>codeblock_12&#45;&gt;leaf_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1898.9535,-1593.1607C1914.1872,-1517.8239 1960.9538,-1227.4281 1809,-1095.2015 1695.1329,-996.117 573.8277,-1146.933 451,-1059.2015 390.2146,-1015.7847 375.5611,-920.5202 372.0668,-872.8868"/>
<polygon fill="#000000" stroke="#000000" points="375.5457,-872.4353 371.4368,-862.6697 368.559,-872.8662 375.5457,-872.4353"/>
</g>
<!-- leaf_25 -->
<g id="node26" class="node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="987.5,-871.9016 460.5,-871.9016 460.5,-817.3008 987.5,-817.3008 987.5,-871.9016"/>
<text text-anchor="middle" x="724" y="-840.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;We need to generate parsers to match sequences of single characters, so</text>
<text text-anchor="middle" x="724" y="-825.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">that *bold*, **bold**, ***bold*** etc all work correctly.</text>
</g>
<!-- block_16&#45;&gt;leaf_25 -->
<g id="edge25" class="edge">
<title>block_16&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2318.7829,-1593.2886C2337.4453,-1518.461 2397.2724,-1229.8089 2249,-1095.2015 2197.4797,-1048.4294 1062.4257,-1082.8964 997,-1059.2015 894.5601,-1022.1013 800.7017,-930.434 754.3609,-879.732"/>
<polygon fill="#000000" stroke="#000000" points="756.9081,-877.3305 747.6051,-872.2605 751.7159,-882.0253 756.9081,-877.3305"/>
</g>
<!-- leaf_26 -->
<g id="node27" class="node">
<title>leaf_26</title>
<polygon fill="none" stroke="#c0c0c0" points="1540,-871.8017 1006,-871.8017 1006,-817.4008 1540,-817.4008 1540,-871.8017"/>
<text text-anchor="middle" x="1273" y="-856.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">Bookends are a fun construct borrowed from the [[LPEG manual][httk://]]]]</text>
<text text-anchor="middle" x="1273" y="-841.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">model for Lua long strings. &#160;The GGG/Pegylator form of a bookend construct</text>
<text text-anchor="middle" x="1273" y="-825.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">is </text>
</g>
<!-- block_17&#45;&gt;leaf_26 -->
<g id="edge26" class="edge">
<title>block_17&#45;&gt;leaf_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2448.7299,-1593.3465C2467.1814,-1518.7496 2526.2858,-1230.8877 2379,-1095.2015 2311.1091,-1032.6574 1635.6452,-1091.0378 1549,-1059.2015 1445.7667,-1021.2702 1350.3987,-929.5225 1303.4805,-879.1447"/>
<polygon fill="#000000" stroke="#000000" points="1305.9942,-876.7076 1296.6435,-871.7263 1300.8469,-881.4516 1305.9942,-876.7076"/>
</g>
<!-- leaf_27 -->
<g id="node28" class="node">
<title>leaf_27</title>
<polygon fill="none" stroke="#c0c0c0" points="1861.5,-871.8017 1558.5,-871.8017 1558.5,-817.4008 1861.5,-817.4008 1861.5,-871.8017"/>
<text text-anchor="middle" x="1710" y="-856.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">~#!peg</text>
<text text-anchor="middle" x="1710" y="-841.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;bookend = &quot;`&quot;:a !&quot;`&quot;:a pattern &#160;&quot;`&quot;:a</text>
<text text-anchor="middle" x="1710" y="-825.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">~#/peg</text>
</g>
<!-- block_18&#45;&gt;leaf_27 -->
<g id="edge27" class="edge">
<title>block_18&#45;&gt;leaf_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2578.7443,-1593.1454C2597.0757,-1518.3581 2655.2343,-1231.6896 2509,-1095.2015 2457.0944,-1046.7553 1933.5883,-1092.7267 1871,-1059.2015 1797.7142,-1019.9462 1748.3541,-931.1028 1725.1837,-880.9062"/>
<polygon fill="#000000" stroke="#000000" points="1728.3351,-879.3805 1721.0307,-871.706 1721.955,-882.2605 1728.3351,-879.3805"/>
</g>
<!-- leaf_28 -->
<g id="node29" class="node">
<title>leaf_28</title>
<polygon fill="none" stroke="#c0c0c0" points="2428,-871.8017 1880,-871.8017 1880,-817.4008 2428,-817.4008 2428,-871.8017"/>
<text text-anchor="middle" x="2154" y="-856.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">The =lpeg= engine doesn&#39;t model this directly but it&#39;s possible to provide</text>
<text text-anchor="middle" x="2154" y="-841.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">it. &#160;We only need the subset of this where =a= is unique, that is, =pattern=</text>
<text text-anchor="middle" x="2154" y="-825.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">does not contain =bookend= at any level of expansion. </text>
</g>
<!-- block_19&#45;&gt;leaf_28 -->
<g id="edge28" class="edge">
<title>block_19&#45;&gt;leaf_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2708.3964,-1593.1126C2725.0326,-1519.39 2776.4758,-1239.8854 2639,-1095.2015 2576.185,-1029.093 2520.5403,-1095.7673 2437,-1059.2015 2335.7218,-1014.8718 2237.4905,-927.3702 2187.7176,-878.9145"/>
<polygon fill="#000000" stroke="#000000" points="2190.0297,-876.2796 2180.4416,-871.7719 2185.126,-881.2749 2190.0297,-876.2796"/>
</g>
<!-- leaf_29 -->
<g id="node30" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="3001.5,-879.2025 2446.5,-879.2025 2446.5,-810 3001.5,-810 3001.5,-879.2025"/>
<text text-anchor="middle" x="2724" y="-864.2013" font-family="Inconsolata" font-size="14.00" fill="#000000">GGG being a specification format needn&#39;t respect this limitation. &#160;Orb</text>
<text text-anchor="middle" x="2724" y="-848.8012" font-family="Inconsolata" font-size="14.00" fill="#000000">does so by design. &#160;It is a simple consquence of the sort of markup we are</text>
<text text-anchor="middle" x="2724" y="-833.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">using; there is no need to parse ***bold **inside bold** still bold*** twice,</text>
<text text-anchor="middle" x="2724" y="-818.0012" font-family="Inconsolata" font-size="14.00" fill="#000000">and this generalizes to all text styles. </text>
</g>
<!-- block_20&#45;&gt;leaf_29 -->
<g id="edge29" class="edge">
<title>block_20&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2832.043,-1592.9698C2824.8346,-1526.145 2798.6402,-1289.3736 2769,-1095.2015 2757.9546,-1022.8434 2742.3702,-939.2413 2732.7403,-889.2165"/>
<polygon fill="#000000" stroke="#000000" points="2736.1715,-888.5247 2730.8382,-879.3701 2729.2985,-889.8525 2736.1715,-888.5247"/>
</g>
<!-- leaf_30 -->
<g id="node31" class="node">
<title>leaf_30</title>
<polygon fill="none" stroke="#c0c0c0" points="3568,-871.9016 3020,-871.9016 3020,-817.3008 3568,-817.3008 3568,-871.9016"/>
<text text-anchor="middle" x="3294" y="-856.8012" font-family="Inconsolata" font-size="14.00" fill="#000000">We do have to wire them up so that we don&#39;t cross the streams. &#160;Sans macros.</text>
<text text-anchor="middle" x="3294" y="-841.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">By hand. </text>
</g>
<!-- block_21&#45;&gt;leaf_30 -->
<g id="edge30" class="edge">
<title>block_21&#45;&gt;leaf_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3186.6106,-1593.1063C3200.8161,-1494.0941 3268.8909,-1019.6116 3288.6266,-882.0538"/>
<polygon fill="#000000" stroke="#000000" points="3292.1131,-882.3972 3290.0688,-872.0014 3285.1841,-881.403 3292.1131,-882.3972"/>
</g>
<!-- codeblock_31 -->
<g id="node32" class="node">
<title>codeblock_31</title>
<ellipse fill="none" stroke="#000000" cx="3663" cy="-844.6012" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="3663" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 56&#45;78</text>
</g>
<!-- block_22&#45;&gt;codeblock_31 -->
<g id="edge31" class="edge">
<title>block_22&#45;&gt;codeblock_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3663,-1593.1063C3663,-1491.7394 3663,-996.831 3663,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="3666.5001,-872.6272 3663,-862.6272 3659.5001,-872.6272 3666.5001,-872.6272"/>
</g>
<!-- leaf_33 -->
<g id="node34" class="node">
<title>leaf_33</title>
<polygon fill="none" stroke="#c0c0c0" points="3812,-862.6012 3758,-862.6012 3758,-826.6012 3812,-826.6012 3812,-862.6012"/>
</g>
<!-- block_22&#45;&gt;leaf_33 -->
<g id="edge33" class="edge">
<title>block_22&#45;&gt;leaf_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3665.8954,-1593.1063C3682.0252,-1491.7394 3760.7767,-996.831 3780.5096,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="3784.0166,-873.053 3782.1316,-862.6272 3777.1036,-871.9529 3784.0166,-873.053"/>
</g>
<!-- codeblock_34 -->
<g id="node35" class="node">
<title>codeblock_34</title>
<ellipse fill="none" stroke="#000000" cx="3907" cy="-844.6012" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="3907" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 80&#45;92</text>
</g>
<!-- block_23&#45;&gt;codeblock_34 -->
<g id="edge34" class="edge">
<title>block_23&#45;&gt;codeblock_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3907,-1593.1063C3907,-1491.7394 3907,-996.831 3907,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="3910.5001,-872.6272 3907,-862.6272 3903.5001,-872.6272 3910.5001,-872.6272"/>
</g>
<!-- leaf_36 -->
<g id="node37" class="node">
<title>leaf_36</title>
<polygon fill="none" stroke="#c0c0c0" points="4056,-862.6012 4002,-862.6012 4002,-826.6012 4056,-826.6012 4056,-862.6012"/>
</g>
<!-- block_23&#45;&gt;leaf_36 -->
<g id="edge36" class="edge">
<title>block_23&#45;&gt;leaf_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3909.8954,-1593.1063C3926.0252,-1491.7394 4004.7767,-996.831 4024.5096,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="4028.0166,-873.053 4026.1316,-862.6272 4021.1036,-871.9529 4028.0166,-873.053"/>
</g>
<!-- header_37 -->
<g id="node38" class="node">
<title>header_37</title>
<ellipse fill="none" stroke="#000000" cx="4156" cy="-844.6012" rx="82.2061" ry="18"/>
<text text-anchor="middle" x="4156" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : prose grammar</text>
</g>
<!-- section_24&#45;&gt;header_37 -->
<g id="edge37" class="edge">
<title>section_24&#45;&gt;header_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4308.2977,-1593.1063C4287.6519,-1491.6374 4186.7714,-995.8348 4161.6659,-872.4478"/>
<polygon fill="#000000" stroke="#000000" points="4165.0914,-871.7285 4159.6677,-862.6272 4158.2319,-873.1243 4165.0914,-871.7285"/>
</g>
<!-- block_38 -->
<g id="node39" class="node">
<title>block_38</title>
<ellipse fill="none" stroke="#000000" cx="4312" cy="-844.6012" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="4312" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 95&#45;99</text>
</g>
<!-- section_24&#45;&gt;block_38 -->
<g id="edge38" class="edge">
<title>section_24&#45;&gt;block_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4312,-1593.1063C4312,-1491.7394 4312,-996.831 4312,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="4315.5001,-872.6272 4312,-862.6272 4308.5001,-872.6272 4315.5001,-872.6272"/>
</g>
<!-- block_39 -->
<g id="node40" class="node">
<title>block_39</title>
<ellipse fill="none" stroke="#000000" cx="4451" cy="-844.6012" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="4451" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 100&#45;101</text>
</g>
<!-- section_24&#45;&gt;block_39 -->
<g id="edge39" class="edge">
<title>section_24&#45;&gt;block_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4314.3239,-1592.9287C4322.9048,-1525.9628 4354.2704,-1288.7679 4392,-1095.2015 4407.8665,-1013.8004 4431.7273,-918.7507 4443.6589,-872.5992"/>
<polygon fill="#000000" stroke="#000000" points="4447.0948,-873.2927 4446.2206,-862.734 4440.3195,-871.5333 4447.0948,-873.2927"/>
</g>
<!-- block_40 -->
<g id="node41" class="node">
<title>block_40</title>
<ellipse fill="none" stroke="#000000" cx="4600" cy="-844.6012" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="4600" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 102&#45;120</text>
</g>
<!-- section_24&#45;&gt;block_40 -->
<g id="edge40" class="edge">
<title>section_24&#45;&gt;block_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4308.4878,-1592.8677C4295.6279,-1519.3696 4258.5152,-1244.0422 4392,-1095.2015 4433.1728,-1049.2922 4480.9038,-1101.2634 4526,-1059.2015 4579.4948,-1009.3061 4594.3184,-918.944 4598.4258,-873.0296"/>
<polygon fill="#000000" stroke="#000000" points="4601.9286,-873.1308 4599.2215,-862.8876 4594.95,-872.5832 4601.9286,-873.1308"/>
</g>
<!-- leaf_46 -->
<g id="node47" class="node">
<title>leaf_46</title>
<polygon fill="none" stroke="#c0c0c0" points="5232,-1059.3018 4684,-1059.3018 4684,-629.9006 5232,-629.9006 5232,-1059.3018"/>
<text text-anchor="middle" x="4958" y="-1044.0015" font-family="Inconsolata" font-size="14.00" fill="#000000">*** prose grammar</text>
<text text-anchor="middle" x="4958" y="-1012.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The Prose module is the first one to use our shiny&#45;new Node module. &#160;Which</text>
<text text-anchor="middle" x="4958" y="-997.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">finally works the way I intend it to and I&#39;m pretty happy about this. </text>
<text text-anchor="middle" x="4958" y="-965.8014" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s pure link&#45;or&#45;raw, but it has everything it needs to be so much more.</text>
<text text-anchor="middle" x="4958" y="-934.4014" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="4958" y="-919.0013" font-family="Inconsolata" font-size="14.00" fill="#000000">local function prose_gm(_ENV)</text>
<text text-anchor="middle" x="4958" y="-903.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;START &quot;prose&quot;</text>
<text text-anchor="middle" x="4958" y="-888.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;prose = (V&quot;link&quot; + V&quot;raw&quot;)^1</text>
<text text-anchor="middle" x="4958" y="-872.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;link = m.link</text>
<text text-anchor="middle" x="4958" y="-857.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;raw = (P(1) &#45; m.link)^1</text>
<text text-anchor="middle" x="4958" y="-842.0012" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="4958" y="-810.6012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function proseBuild(prose, str)</text>
<text text-anchor="middle" x="4958" y="-795.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return setmetatable(prose, {__index = Pr })</text>
<text text-anchor="middle" x="4958" y="-779.8011" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="4958" y="-748.4011" font-family="Inconsolata" font-size="14.00" fill="#000000">local parse = Grammar(prose_gm, { prose = proseBuild,</text>
<text text-anchor="middle" x="4958" y="-733.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;link &#160;= Link }) &#160;</text>
<text text-anchor="middle" x="4958" y="-685.601" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="4958" y="-638.201" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_24&#45;&gt;leaf_46 -->
<g id="edge46" class="edge">
<title>section_24&#45;&gt;leaf_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4308.0746,-1593.0888C4293.2128,-1518.6809 4248.2279,-1235.1075 4392,-1095.2015 4435.3932,-1052.9751 4600.5071,-1080.4298 4674.2075,-1058.8021"/>
<polygon fill="#000000" stroke="#000000" points="4675.6778,-1061.9968 4683.9781,-1055.4123 4673.3833,-1055.3835 4675.6778,-1061.9968"/>
</g>
<!-- leaf_32 -->
<g id="node33" class="node">
<title>leaf_32</title>
<polygon fill="none" stroke="#c0c0c0" points="3468.5,-593.8015 2927.5,-593.8015 2927.5,-261.5998 3468.5,-261.5998 3468.5,-593.8015"/>
<text text-anchor="middle" x="3198" y="-578.8009" font-family="Inconsolata" font-size="14.00" fill="#000000">local function equal_strings(s, i, a, b)</text>
<text text-anchor="middle" x="3198" y="-563.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns true if a and b are equal.</text>
<text text-anchor="middle" x="3198" y="-548.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; s and i are not used, provided because expected by Cb.</text>
<text text-anchor="middle" x="3198" y="-532.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return a == b</text>
<text text-anchor="middle" x="3198" y="-517.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3198" y="-485.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">local function bookends(sigil)</text>
<text text-anchor="middle" x="3198" y="-470.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local Cg, C, P, Cmt, Cb = L.Cg, L.C, L.P, L.Cmt, L.Cb</text>
<text text-anchor="middle" x="3198" y="-455.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns a pair of patterns, _open and _close,</text>
<text text-anchor="middle" x="3198" y="-439.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; which will match a brace of sigil.</text>
<text text-anchor="middle" x="3198" y="-424.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; sigil must be a string. </text>
<text text-anchor="middle" x="3198" y="-408.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _open = Cg(C(P(sigil)^1), sigil .. &quot;_init&quot;)</text>
<text text-anchor="middle" x="3198" y="-393.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _close = &#160;Cmt(C(P(sigil)^1) * Cb(sigil .. &quot;_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="3198" y="-378.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return _open, _close</text>
<text text-anchor="middle" x="3198" y="-362.6005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3198" y="-331.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">local bold_open, bold_close &#160;&#160;&#160;&#160;= &#160;bookends(&quot;*&quot;)</text>
<text text-anchor="middle" x="3198" y="-315.8005" font-family="Inconsolata" font-size="14.00" fill="#000000">local italic_open, italic_close = &#160;bookends(&quot;/&quot;)</text>
<text text-anchor="middle" x="3198" y="-300.4004" font-family="Inconsolata" font-size="14.00" fill="#000000">local under_open, under_close &#160;&#160;= &#160;bookends(&quot;_&quot;)</text>
<text text-anchor="middle" x="3198" y="-285.0004" font-family="Inconsolata" font-size="14.00" fill="#000000">local strike_open, strike_close = &#160;bookends(&quot;&#45;&quot;)</text>
<text text-anchor="middle" x="3198" y="-269.6004" font-family="Inconsolata" font-size="14.00" fill="#000000">local lit_open, lit_close &#160;&#160;&#160;&#160;&#160;&#160;= &#160;bookends(&quot;=&quot;)</text>
</g>
<!-- codeblock_31&#45;&gt;leaf_32 -->
<g id="edge32" class="edge">
<title>codeblock_31&#45;&gt;leaf_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3660.7789,-826.6082C3654.8227,-785.9091 3634.8184,-685.977 3577,-630.0009 3543.3625,-597.4353 3520.3123,-614.0427 3478,-594.0009 3477.9042,-593.9556 3477.8084,-593.9102 3477.7126,-593.8647"/>
<polygon fill="#000000" stroke="#000000" points="3479.3045,-590.7466 3468.7745,-589.5765 3476.2766,-597.0578 3479.3045,-590.7466"/>
</g>
<!-- leaf_35 -->
<g id="node36" class="node">
<title>leaf_35</title>
<polygon fill="none" stroke="#c0c0c0" points="3811,-516.6014 3487,-516.6014 3487,-338.7998 3811,-338.7998 3811,-516.6014"/>
<text text-anchor="middle" x="3649" y="-501.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">function Pr.toMarkdown(prose)</text>
<text text-anchor="middle" x="3649" y="-485.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="3649" y="-470.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for _, node in ipairs(prose) do</text>
<text text-anchor="middle" x="3649" y="-455.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if node.toMarkdown then</text>
<text text-anchor="middle" x="3649" y="-439.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase .. node:toMarkdown()</text>
<text text-anchor="middle" x="3649" y="-424.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id == &quot;raw&quot; then</text>
<text text-anchor="middle" x="3649" y="-408.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase &#160;.. node:toValue()</text>
<text text-anchor="middle" x="3649" y="-393.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3649" y="-378.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3649" y="-362.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="3649" y="-347.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_34&#45;&gt;leaf_35 -->
<g id="edge35" class="edge">
<title>codeblock_34&#45;&gt;leaf_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3901.9108,-826.4474C3890.756,-788.2889 3861.8485,-697.7028 3821,-630.0009 3798.7314,-593.0932 3769.784,-556.1582 3742.0073,-524.1397"/>
<polygon fill="#000000" stroke="#000000" points="3744.573,-521.7567 3735.3535,-516.5363 3739.3052,-526.3666 3744.573,-521.7567"/>
</g>
<!-- leaf_41 -->
<g id="node42" class="node">
<title>leaf_41</title>
<polygon fill="none" stroke="#c0c0c0" points="4377,-455.0011 3829,-455.0011 3829,-400.4002 4377,-400.4002 4377,-455.0011"/>
<text text-anchor="middle" x="4103" y="-423.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The Prose module is the first one to use our shiny&#45;new Node module. &#160;Which</text>
<text text-anchor="middle" x="4103" y="-408.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">finally works the way I intend it to and I&#39;m pretty happy about this. </text>
</g>
<!-- block_38&#45;&gt;leaf_41 -->
<g id="edge41" class="edge">
<title>block_38&#45;&gt;leaf_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4308.619,-826.6289C4301.0692,-788.814 4280.7955,-698.842 4247,-630.0009 4215.9612,-566.7752 4165.8894,-501.8542 4133.7203,-463.1535"/>
<polygon fill="#000000" stroke="#000000" points="4136.2467,-460.7191 4127.1408,-455.3032 4130.8818,-465.2155 4136.2467,-460.7191"/>
</g>
<!-- leaf_42 -->
<g id="node43" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="4922.5,-445.7006 4395.5,-445.7006 4395.5,-409.7006 4922.5,-409.7006 4922.5,-445.7006"/>
<text text-anchor="middle" x="4659" y="-424.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s pure link&#45;or&#45;raw, but it has everything it needs to be so much more.</text>
</g>
<!-- block_39&#45;&gt;leaf_42 -->
<g id="edge42" class="edge">
<title>block_39&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4455.5791,-826.4655C4465.4668,-788.7173 4490.7215,-699.4415 4525,-630.0009 4558.1459,-562.8546 4609.8648,-491.423 4638.3851,-454.0284"/>
<polygon fill="#000000" stroke="#000000" points="4641.4585,-455.773 4644.7756,-445.7108 4635.9076,-451.5082 4641.4585,-455.773"/>
</g>
<!-- codeblock_43 -->
<g id="node44" class="node">
<title>codeblock_43</title>
<ellipse fill="none" stroke="#000000" cx="5027" cy="-427.7006" rx="86.7905" ry="18"/>
<text text-anchor="middle" x="5027" y="-423.5006" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 102&#45;118</text>
</g>
<!-- block_40&#45;&gt;codeblock_43 -->
<g id="edge43" class="edge">
<title>block_40&#45;&gt;codeblock_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4600.3894,-826.4205C4602.3524,-784.4264 4613.5084,-680.43 4675,-630.0009 4764.1825,-556.8627 4836.5143,-658.6941 4932,-594.0009 4980.8138,-560.9288 5007.5847,-493.8803 5019.4288,-455.7941"/>
<polygon fill="#000000" stroke="#000000" points="5022.8837,-456.455 5022.3795,-445.8722 5016.1741,-454.4596 5022.8837,-456.455"/>
</g>
<!-- leaf_45 -->
<g id="node46" class="node">
<title>leaf_45</title>
<polygon fill="none" stroke="#c0c0c0" points="5186,-445.7006 5132,-445.7006 5132,-409.7006 5186,-409.7006 5186,-445.7006"/>
</g>
<!-- block_40&#45;&gt;leaf_45 -->
<g id="edge45" class="edge">
<title>block_40&#45;&gt;leaf_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4600.1795,-826.4864C4601.6798,-784.1667 4611.8918,-678.7153 4675,-630.0009 4754.0617,-568.9718 5047.8397,-659.7751 5123,-594.0009 5162.1505,-559.7396 5164.4717,-493.9126 5162.1081,-456.1662"/>
<polygon fill="#000000" stroke="#000000" points="5165.5717,-455.5628 5161.3021,-445.8663 5158.593,-456.1089 5165.5717,-455.5628"/>
</g>
<!-- leaf_44 -->
<g id="node45" class="node">
<title>leaf_44</title>
<polygon fill="none" stroke="#c0c0c0" points="5220.5,-225.6009 4833.5,-225.6009 4833.5,.2005 5220.5,.2005 5220.5,-225.6009"/>
<text text-anchor="middle" x="5027" y="-210.2003" font-family="Inconsolata" font-size="14.00" fill="#000000">local function prose_gm(_ENV)</text>
<text text-anchor="middle" x="5027" y="-194.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;START &quot;prose&quot;</text>
<text text-anchor="middle" x="5027" y="-179.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;prose = (V&quot;link&quot; + V&quot;raw&quot;)^1</text>
<text text-anchor="middle" x="5027" y="-164.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;link = m.link</text>
<text text-anchor="middle" x="5027" y="-148.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;raw = (P(1) &#45; m.link)^1</text>
<text text-anchor="middle" x="5027" y="-133.2002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5027" y="-101.8002" font-family="Inconsolata" font-size="14.00" fill="#000000">local function proseBuild(prose, str)</text>
<text text-anchor="middle" x="5027" y="-86.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return setmetatable(prose, {__index = Pr })</text>
<text text-anchor="middle" x="5027" y="-71.0001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="5027" y="-39.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">local parse = Grammar(prose_gm, { prose = proseBuild,</text>
<text text-anchor="middle" x="5027" y="-24.2" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;link &#160;= Link }) &#160;</text>
</g>
<!-- codeblock_43&#45;&gt;leaf_44 -->
<g id="edge44" class="edge">
<title>codeblock_43&#45;&gt;leaf_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5027,-409.4033C5027,-375.7442 5027,-301.4156 5027,-235.5783"/>
<polygon fill="#000000" stroke="#000000" points="5030.5001,-235.5128 5027,-225.5129 5023.5001,-235.5129 5030.5001,-235.5128"/>
</g>
<!-- leaf_52 -->
<g id="node53" class="node">
<title>leaf_52</title>
<polygon fill="none" stroke="#c0c0c0" points="5581.5,-864.5033 5250.5,-864.5033 5250.5,-824.6991 5581.5,-824.6991 5581.5,-864.5033"/>
<text text-anchor="middle" x="5416" y="-833.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45; [ ] #todo smuggle in that offset in =parse=</text>
</g>
<!-- block_49&#45;&gt;leaf_52 -->
<g id="edge52" class="edge">
<title>block_49&#45;&gt;leaf_52</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5475.5523,-1593.1063C5467.5231,-1492.1883 5428.4598,-1001.2065 5418.378,-874.4901"/>
<polygon fill="#000000" stroke="#000000" points="5421.854,-874.0483 5417.5718,-864.3574 5414.8761,-874.6035 5421.854,-874.0483"/>
</g>
<!-- codeblock_53 -->
<g id="node54" class="node">
<title>codeblock_53</title>
<ellipse fill="none" stroke="#000000" cx="5687" cy="-844.6012" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="5687" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 125&#45;134</text>
</g>
<!-- block_50&#45;&gt;codeblock_53 -->
<g id="edge53" class="edge">
<title>block_50&#45;&gt;codeblock_53</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5687,-1593.1063C5687,-1491.7394 5687,-996.831 5687,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="5690.5001,-872.6272 5687,-862.6272 5683.5001,-872.6272 5690.5001,-872.6272"/>
</g>
<!-- leaf_55 -->
<g id="node56" class="node">
<title>leaf_55</title>
<polygon fill="none" stroke="#c0c0c0" points="5846,-862.6012 5792,-862.6012 5792,-826.6012 5846,-826.6012 5846,-862.6012"/>
</g>
<!-- block_50&#45;&gt;leaf_55 -->
<g id="edge55" class="edge">
<title>block_50&#45;&gt;leaf_55</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5690.1882,-1593.1987C5702.3745,-1523.9529 5747.1251,-1269.2226 5783,-1059.2015 5794.4154,-992.3727 5807.5176,-913.7786 5814.3316,-872.757"/>
<polygon fill="#000000" stroke="#000000" points="5817.817,-873.1333 5816.002,-862.6951 5810.9115,-871.9868 5817.817,-873.1333"/>
</g>
<!-- codeblock_56 -->
<g id="node57" class="node">
<title>codeblock_56</title>
<ellipse fill="none" stroke="#000000" cx="5951" cy="-844.6012" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="5951" y="-840.4012" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 136&#45;138</text>
</g>
<!-- block_51&#45;&gt;codeblock_56 -->
<g id="edge56" class="edge">
<title>block_51&#45;&gt;codeblock_56</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5894.3765,-1593.1063C5902.0448,-1491.7394 5939.484,-996.831 5948.8652,-872.8209"/>
<polygon fill="#000000" stroke="#000000" points="5952.372,-872.8628 5949.6364,-862.6272 5945.3919,-872.3347 5952.372,-872.8628"/>
</g>
<!-- leaf_58 -->
<g id="node59" class="node">
<title>leaf_58</title>
<polygon fill="none" stroke="#c0c0c0" points="6110,-936.6012 6056,-936.6012 6056,-752.6012 6110,-752.6012 6110,-936.6012"/>
</g>
<!-- block_51&#45;&gt;leaf_58 -->
<g id="edge58" class="edge">
<title>block_51&#45;&gt;leaf_58</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5889.9395,-1593.0065C5878.9851,-1521.1645 5848.4429,-1254.5241 5968,-1095.2015 5991.159,-1064.3397 6023.5045,-1089.8079 6047,-1059.2015 6071.2844,-1027.5674 6081.6623,-985.5308 6085.4733,-947.0503"/>
<polygon fill="#000000" stroke="#000000" points="6088.9825,-947.0901 6086.3429,-936.8294 6082.0077,-946.4966 6088.9825,-947.0901"/>
</g>
<!-- leaf_54 -->
<g id="node55" class="node">
<title>leaf_54</title>
<polygon fill="none" stroke="#c0c0c0" points="5824.5,-493.401 5549.5,-493.401 5549.5,-362.0002 5824.5,-362.0002 5824.5,-493.401"/>
<text text-anchor="middle" x="5687" y="-478.1008" font-family="Inconsolata" font-size="14.00" fill="#000000">local function new(Prose, block)</text>
<text text-anchor="middle" x="5687" y="-462.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local phrase = &quot;\n&quot;</text>
<text text-anchor="middle" x="5687" y="-447.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;for _,l in ipairs(block.lines) do</text>
<text text-anchor="middle" x="5687" y="-431.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;phrase = phrase .. l .. &quot;\n&quot;</text>
<text text-anchor="middle" x="5687" y="-416.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="5687" y="-401.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local prose = parse(phrase, 0) </text>
<text text-anchor="middle" x="5687" y="-385.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return prose</text>
<text text-anchor="middle" x="5687" y="-370.3005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_53&#45;&gt;leaf_54 -->
<g id="edge54" class="edge">
<title>codeblock_53&#45;&gt;leaf_54</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5687,-826.4194C5687,-771.247 5687,-603.4442 5687,-503.9798"/>
<polygon fill="#000000" stroke="#000000" points="5690.5001,-503.6847 5687,-493.6847 5683.5001,-503.6847 5690.5001,-503.6847"/>
</g>
<!-- leaf_57 -->
<g id="node58" class="node">
<title>leaf_57</title>
<polygon fill="none" stroke="#c0c0c0" points="6043,-445.7006 5859,-445.7006 5859,-409.7006 6043,-409.7006 6043,-445.7006"/>
<text text-anchor="middle" x="5951" y="-424.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">return u.export(pr, new)</text>
</g>
<!-- codeblock_56&#45;&gt;leaf_57 -->
<g id="edge57" class="edge">
<title>codeblock_56&#45;&gt;leaf_57</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5951,-826.4194C5951,-760.8591 5951,-536.2634 5951,-456.2737"/>
<polygon fill="#000000" stroke="#000000" points="5954.5001,-455.9781 5951,-445.9781 5947.5001,-455.9782 5954.5001,-455.9781"/>
</g>
</g>
</svg>