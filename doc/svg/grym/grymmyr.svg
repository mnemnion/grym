<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="2888pt" height="3152pt"
 viewBox="0.00 0.00 2888.00 3151.80" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 3147.8046)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-3147.8046 2884,-3147.8046 2884,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1291.5" cy="-3125.8046" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1291.5" y="-3121.6046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 125</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1291.5" cy="-3053.8046" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="1291.5" y="-3049.6046" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;125</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1291.5,-3107.6359C1291.5,-3099.9355 1291.5,-3090.7789 1291.5,-3082.2212"/>
<polygon fill="#000000" stroke="#000000" points="1295.0001,-3082.2178 1291.5,-3072.2179 1288.0001,-3082.2179 1295.0001,-3082.2178"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="468.5" cy="-2033.2031" rx="96.1863" ry="18"/>
<text text-anchor="middle" x="468.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Grimoire Grammar</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1226.4615,-3051.1518C1054.0459,-3043.8238 596.8033,-3022.3482 573.5,-2999.8046 300.9123,-2736.103 425.9268,-2190.7094 460.5919,-2061.2199"/>
<polygon fill="#000000" stroke="#000000" points="464.0426,-2061.8688 463.2905,-2051.3007 457.2881,-2060.0312 464.0426,-2061.8688"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="628.5" cy="-2033.2031" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="628.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;3</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1225.8933,-3052.7235C1076.4371,-3049.5992 720.6666,-3038.1702 683.5,-2999.8046 550.5677,-2862.5841 610.353,-2206.8614 625.4126,-2061.699"/>
<polygon fill="#000000" stroke="#000000" points="628.9294,-2061.7226 626.4944,-2051.4114 621.9677,-2060.9905 628.9294,-2061.7226"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="743.5" cy="-2033.2031" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="743.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 4&#45;28</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1226.2606,-3051.4773C1141.6454,-3047.0819 1000.4827,-3034.6107 963.5,-2999.8046 682.1906,-2735.0511 725.0522,-2191.4798 739.8848,-2061.5512"/>
<polygon fill="#000000" stroke="#000000" points="743.4029,-2061.6038 741.1016,-2051.2619 736.4513,-2060.7816 743.4029,-2061.6038"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="1028.5" cy="-2033.2031" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1028.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 29&#45;32</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1263.9485,-3037.296C1250.6442,-3027.9288 1235.6239,-3015.0322 1226.5,-2999.8046 1030.5602,-2672.7865 1025.6583,-2183.8323 1027.7223,-2061.6459"/>
<polygon fill="#000000" stroke="#000000" points="1031.2286,-2061.3592 1027.9303,-2051.2909 1024.2301,-2061.2185 1031.2286,-2061.3592"/>
</g>
<!-- block_6 -->
<g id="node7" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="1291.5" cy="-2033.2031" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1291.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 33&#45;35</text>
</g>
<!-- section_1&#45;&gt;block_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;block_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1291.5,-3035.657C1291.5,-2913.5512 1291.5,-2212.057 1291.5,-2061.6095"/>
<polygon fill="#000000" stroke="#000000" points="1295.0001,-2061.3677 1291.5,-2051.3677 1288.0001,-2061.3677 1295.0001,-2061.3677"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="1604.5" cy="-2033.2031" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1604.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 36&#45;58</text>
</g>
<!-- section_1&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1318.4144,-3037.338C1331.7155,-3027.9005 1346.9265,-3014.9276 1356.5,-2999.8046 1562.939,-2673.699 1597.8895,-2183.1697 1603.4842,-2061.3406"/>
<polygon fill="#000000" stroke="#000000" points="1606.9816,-2061.4731 1603.9144,-2051.332 1599.9881,-2061.1724 1606.9816,-2061.4731"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="1882.5" cy="-2033.2031" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1882.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 59&#45;64</text>
</g>
<!-- section_1&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1354.5344,-3048.7088C1456.0684,-3039.929 1646.8102,-3020.8535 1669.5,-2999.8046 1952.5525,-2737.222 1902.8264,-2190.9832 1886.4248,-2061.2701"/>
<polygon fill="#000000" stroke="#000000" points="1889.8928,-2060.7968 1885.1286,-2051.3336 1882.9516,-2061.7023 1889.8928,-2060.7968"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="2204.5" cy="-2033.2031" rx="60.9913" ry="18"/>
<text text-anchor="middle" x="2204.5" y="-2029.0031" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 65&#45;125</text>
</g>
<!-- section_1&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1357.0359,-3052.6351C1514.205,-3049.2403 1902.8773,-3037.1258 1947.5,-2999.8046 2247.0953,-2749.2308 2218.6268,-2192.7847 2207.3019,-2061.3938"/>
<polygon fill="#000000" stroke="#000000" points="2210.779,-2060.9819 2206.3951,-2051.3366 2203.8073,-2061.6106 2210.779,-2060.9819"/>
</g>
<!-- leaf_25 -->
<g id="node26" class="node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="2880,-2999.9061 2283,-2999.9061 2283,-1066.5 2880,-1066.5 2880,-2999.9061"/>
<text text-anchor="middle" x="2581.5" y="-2984.6046" font-family="Inconsolata" font-size="14.00" fill="#000000"> * Grimoire Grammar</text>
<text text-anchor="middle" x="2581.5" y="-2937.2046" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="2581.5" y="-2921.8045" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2906.4045" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;../peg/epeg&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2891.0045" font-family="Inconsolata" font-size="14.00" fill="#000000">local epnf = require &quot;../peg/epnf&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2859.6044" font-family="Inconsolata" font-size="14.00" fill="#000000">local match = lpeg.match &#45;&#45; match a pattern against a string</text>
<text text-anchor="middle" x="2581.5" y="-2844.2044" font-family="Inconsolata" font-size="14.00" fill="#000000">local P = lpeg.P &#45;&#45; match a string literally</text>
<text text-anchor="middle" x="2581.5" y="-2828.8044" font-family="Inconsolata" font-size="14.00" fill="#000000">local S = lpeg.S &#160;&#45;&#45; match anything in a set</text>
<text text-anchor="middle" x="2581.5" y="-2813.4043" font-family="Inconsolata" font-size="14.00" fill="#000000">local R = epeg.R &#160;&#45;&#45; match anything in a range</text>
<text text-anchor="middle" x="2581.5" y="-2798.0043" font-family="Inconsolata" font-size="14.00" fill="#000000">local B = lpeg.B &#160;&#45;&#45; match iff the pattern precedes the use of B</text>
<text text-anchor="middle" x="2581.5" y="-2782.6043" font-family="Inconsolata" font-size="14.00" fill="#000000">local C = lpeg.C &#160;&#45;&#45; captures a match</text>
<text text-anchor="middle" x="2581.5" y="-2767.2042" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp &#45;&#45; captures start and end position of match</text>
<text text-anchor="middle" x="2581.5" y="-2751.8042" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cg = lpeg.Cg &#45;&#45; named capture group (for **balanced highlighting**)</text>
<text text-anchor="middle" x="2581.5" y="-2736.4042" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cb = lpeg.Cb &#45;&#45; Back capture</text>
<text text-anchor="middle" x="2581.5" y="-2721.0042" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cmt = lpeg.Cmt &#45;&#45; match&#45;time capture</text>
<text text-anchor="middle" x="2581.5" y="-2705.6041" font-family="Inconsolata" font-size="14.00" fill="#000000">local Ct = lpeg.Ct &#45;&#45; a table with all captures from the pattern</text>
<text text-anchor="middle" x="2581.5" y="-2690.2041" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = lpeg.V &#45;&#45; create a variable within a grammar</text>
<text text-anchor="middle" x="2581.5" y="-2658.8041" font-family="Inconsolata" font-size="14.00" fill="#000000">local letter = R&quot;AZ&quot; + R&quot;az&quot; &#160;&#160;</text>
<text text-anchor="middle" x="2581.5" y="-2643.404" font-family="Inconsolata" font-size="14.00" fill="#000000">local digit = R&quot;09&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2628.004" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="2581.5" y="-2596.604" font-family="Inconsolata" font-size="14.00" fill="#000000"> Punctuation is valid inside of prose blocks, even with leading</text>
<text text-anchor="middle" x="2581.5" y="-2581.2039" font-family="Inconsolata" font-size="14.00" fill="#000000"> whitespace</text>
<text text-anchor="middle" x="2581.5" y="-2549.8039" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="2581.5" y="-2534.4039" font-family="Inconsolata" font-size="14.00" fill="#000000">local punctuation = S&quot;!?,.:;\\^%~&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2519.0038" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="2581.5" y="-2487.6038" font-family="Inconsolata" font-size="14.00" fill="#000000"> Interior symbols are valid within a prose word, but not if </text>
<text text-anchor="middle" x="2581.5" y="-2472.2038" font-family="Inconsolata" font-size="14.00" fill="#000000"> preceded by whitespace</text>
<text text-anchor="middle" x="2581.5" y="-2440.8037" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="2581.5" y="-2425.4037" font-family="Inconsolata" font-size="14.00" fill="#000000">local interior = S&quot;*_&#45;/@#&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2410.0037" font-family="Inconsolata" font-size="14.00" fill="#000000">local sym = letter + digit + punctuation + interior</text>
<text text-anchor="middle" x="2581.5" y="-2394.6037" font-family="Inconsolata" font-size="14.00" fill="#000000">local first_letter = letter + digit + punctuation</text>
<text text-anchor="middle" x="2581.5" y="-2379.2036" font-family="Inconsolata" font-size="14.00" fill="#000000">local WS = P&#39; &#39; + P&#39;,&#39; + P&#39;\09&#39; &#45;&#45; Not accurate, refine (needs Unicode spaces)</text>
<text text-anchor="middle" x="2581.5" y="-2363.8036" font-family="Inconsolata" font-size="14.00" fill="#000000">local NL = P&quot;\n&quot;</text>
<text text-anchor="middle" x="2581.5" y="-2332.4036" font-family="Inconsolata" font-size="14.00" fill="#000000">local function equal_strings(s, i, a, b)</text>
<text text-anchor="middle" x="2581.5" y="-2317.0035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns true if a and b are equal.</text>
<text text-anchor="middle" x="2581.5" y="-2301.6035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; s and i are not used, provided because expected by Cb.</text>
<text text-anchor="middle" x="2581.5" y="-2286.2035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return a == b</text>
<text text-anchor="middle" x="2581.5" y="-2270.8034" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2581.5" y="-2239.4034" font-family="Inconsolata" font-size="14.00" fill="#000000">local function bookends(sigil)</text>
<text text-anchor="middle" x="2581.5" y="-2224.0034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns a pair of patterns, _open and _close,</text>
<text text-anchor="middle" x="2581.5" y="-2208.6033" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; which will match a brace of sigil.</text>
<text text-anchor="middle" x="2581.5" y="-2193.2033" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; sigil must be a string. </text>
<text text-anchor="middle" x="2581.5" y="-2177.8033" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _open = Cg(C(P(sigil)^1), sigil .. &quot;_init&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-2162.4032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _close = &#160;Cmt(C(P(sigil)^1) * Cb(sigil .. &quot;_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="2581.5" y="-2147.0032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return _open, _close</text>
<text text-anchor="middle" x="2581.5" y="-2131.6032" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2581.5" y="-2116.2032" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="2581.5" y="-2084.8031" font-family="Inconsolata" font-size="14.00" fill="#000000"> The Grimoire grammar is a specially&#45;massaged closure to be executed</text>
<text text-anchor="middle" x="2581.5" y="-2069.4031" font-family="Inconsolata" font-size="14.00" fill="#000000"> in the epnf context. </text>
<text text-anchor="middle" x="2581.5" y="-2054.0031" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
<text text-anchor="middle" x="2581.5" y="-2038.603" font-family="Inconsolata" font-size="14.00" fill="#000000"> The advantage of this approach is that we can make it look much like an</text>
<text text-anchor="middle" x="2581.5" y="-2023.203" font-family="Inconsolata" font-size="14.00" fill="#000000"> actual grammar. This should aid in porting to target languages. </text>
<text text-anchor="middle" x="2581.5" y="-1991.803" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="2581.5" y="-1976.4029" font-family="Inconsolata" font-size="14.00" fill="#000000">local _grym_fn = function ()</text>
<text text-anchor="middle" x="2581.5" y="-1961.0029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function grymmyr (_ENV)</text>
<text text-anchor="middle" x="2581.5" y="-1945.6029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;START &quot;grym&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1930.2028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;SUPPRESS (&quot;structure&quot;, &quot;structured&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1898.8028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local prose_word = first_letter * (sym^1)^0</text>
<text text-anchor="middle" x="2581.5" y="-1883.4028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local prose_span = (prose_word + WS^1)^1</text>
<text text-anchor="middle" x="2581.5" y="-1868.0027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local NEOL = NL + &#45;P(1)</text>
<text text-anchor="middle" x="2581.5" y="-1852.6027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local LS = B(&quot;\n&quot;) + &#45;B(1)</text>
<text text-anchor="middle" x="2581.5" y="-1821.2027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;grym &#160;&#160;&#160;&#160;&#160;= &#160;V&quot;section&quot;^1 * V&quot;unparsed&quot;^0</text>
<text text-anchor="middle" x="2581.5" y="-1789.8027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;section &#160;&#160;= &#160;(V&quot;header&quot; * V&quot;block&quot;^0) + V&quot;block&quot;^1</text>
<text text-anchor="middle" x="2581.5" y="-1758.4026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;structure = &#160;V&quot;blank_line&quot; &#45;&#45; list, table, json, comment...</text>
<text text-anchor="middle" x="2581.5" y="-1727.0026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;header &#160;&#160;&#160;&#160;= &#160;LS * V&quot;lead_ws&quot; * V&quot;lead_tar&quot; * V&quot;prose_line&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1711.6026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;lead_ws &#160;&#160;&#160;= &#160;Csp(P&quot; &quot;^0)</text>
<text text-anchor="middle" x="2581.5" y="-1696.2025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;lead_tar &#160;&#160;= &#160;Csp(P&quot;*&quot;^&#45;6 * P&quot; &quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1680.8025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;prose_line = &#160;Csp(prose_span * NEOL)</text>
<text text-anchor="middle" x="2581.5" y="-1649.4025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;block = &#160;(V&quot;structure&quot;^1 + V&quot;prose&quot;^1)^1 * #V&quot;block_end&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1618.0024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;prose &#160;&#160;&#160;&#160;&#160;&#160;&#160;= &#160;(V&quot;structured&quot; + V&quot;unstructured&quot;)^1</text>
<text text-anchor="middle" x="2581.5" y="-1602.6024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;unstructured = &#160;Csp(V&quot;prose_line&quot;^1 * prose_span + V&quot;prose_line&quot;^1</text>
<text text-anchor="middle" x="2581.5" y="-1587.2024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;+ prose_span &#45;V&quot;header&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1571.8023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;structured &#160;&#160;= &#160;V&quot;bold&quot; + V&quot;italic&quot; + V&quot;underscore&quot; + V&quot;strikethrough&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1556.4023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;+ V&quot;literal&quot; + V&quot;quoted&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1525.0023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;unparsed = Csp(P(1)^1)</text>
<text text-anchor="middle" x="2581.5" y="-1493.6022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; Highlighting</text>
<text text-anchor="middle" x="2581.5" y="-1478.2022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; These inner blocks will need to be re&#45;parsed to render, e.g., links</text>
<text text-anchor="middle" x="2581.5" y="-1462.8022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; or multiple layers of highlight. </text>
<text text-anchor="middle" x="2581.5" y="-1447.4022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local bold_open, bold_close &#160;&#160;&#160;&#160;= &#160;bookends(&quot;*&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1432.0021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local italic_open, italic_close = &#160;bookends(&quot;/&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1416.6021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local under_open, under_close &#160;&#160;= &#160;bookends(&quot;_&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1401.2021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local strike_open, strike_close = &#160;bookends(&quot;&#45;&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1385.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local lit_open, lit_close &#160;&#160;&#160;&#160;&#160;&#160;= &#160;bookends(&quot;=&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1370.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;bold &#160;&#160;= &#160;Csp(bold_open * (P(1) &#45; bold_close)^0 * bold_close / 1) &#45; V&quot;header&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1355.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;italic = &#160;Csp(italic_open * (P(1) &#45; italic_close)^0 * italic_close / 1)</text>
<text text-anchor="middle" x="2581.5" y="-1339.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;underscore = Csp(under_open * (P(1) &#45; under_close)^0 * under_close / 1)</text>
<text text-anchor="middle" x="2581.5" y="-1324.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;strikethrough = Csp(strike_open * (P(1) &#45; strike_close)^0 * strike_close / 1)</text>
<text text-anchor="middle" x="2581.5" y="-1308.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;literal = Csp(lit_open * (P(1) &#45; lit_close)^0 * lit_close / 1)</text>
<text text-anchor="middle" x="2581.5" y="-1277.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local quoted_open = Cg(C(P(&quot;\&quot;&quot;)^2), &quot;quoted_init&quot;)</text>
<text text-anchor="middle" x="2581.5" y="-1262.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local quoted_close = Cmt(C(P(&quot;\&quot;&quot;)^1) * Cb(&quot;quoted_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="2581.5" y="-1246.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;quoted = Csp(quoted_open * (P(1) &#45; quoted_close)^0 * quoted_close / 1)</text>
<text text-anchor="middle" x="2581.5" y="-1215.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;block_end = V&quot;blank_line&quot;^1 + &#45;P(1) + #V&quot;header&quot;</text>
<text text-anchor="middle" x="2581.5" y="-1183.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;blank_line = Csp((WS^0 * NL)^1)</text>
<text text-anchor="middle" x="2581.5" y="-1168.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2581.5" y="-1137.0017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return grymmyr</text>
<text text-anchor="middle" x="2581.5" y="-1121.6016" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2581.5" y="-1090.2016" font-family="Inconsolata" font-size="14.00" fill="#000000">return epnf.define(_grym_fn(), nil, false)</text>
<text text-anchor="middle" x="2581.5" y="-1074.8016" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
</g>
<!-- section_1&#45;&gt;leaf_25 -->
<g id="edge25" class="edge">
<title>section_1&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1357.017,-3052.2388C1571.0757,-3046.8588 2238.2286,-3027.9011 2274.5,-2999.8046 2274.587,-2999.7372 2274.674,-2999.6698 2274.7609,-2999.6023"/>
<polygon fill="#000000" stroke="#000000" points="2277.107,-3002.2092 2282.7777,-2993.2597 2272.7637,-2996.7195 2277.107,-3002.2092"/>
</g>
<!-- leaf_10 -->
<g id="node11" class="node">
<title>leaf_10</title>
<polygon fill="none" stroke="#c0c0c0" points="172.5,-1006.1015 118.5,-1006.1015 118.5,-970.1015 172.5,-970.1015 172.5,-1006.1015"/>
</g>
<!-- block_3&#45;&gt;leaf_10 -->
<g id="edge10" class="edge">
<title>block_3&#45;&gt;leaf_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M630.5006,-2014.9995C643.3636,-1894.0988 709.6843,-1207.6011 573.5,-1066.6015 512.7277,-1003.6804 259.1005,-1070.9811 181.5,-1030.6015 174.1417,-1026.7726 167.6726,-1020.7378 162.323,-1014.4053"/>
<polygon fill="#000000" stroke="#000000" points="165.0242,-1012.176 156.1628,-1006.3685 159.4685,-1016.4345 165.0242,-1012.176"/>
</g>
<!-- codeblock_11 -->
<g id="node12" class="node">
<title>codeblock_11</title>
<ellipse fill="none" stroke="#000000" cx="263.5" cy="-988.1015" rx="72.5844" ry="18"/>
<text text-anchor="middle" x="263.5" y="-983.9015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 4&#45;24</text>
</g>
<!-- block_4&#45;&gt;codeblock_11 -->
<g id="edge11" class="edge">
<title>block_4&#45;&gt;codeblock_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M749.6934,-2015.0276C785.1671,-1907.2191 951.7646,-1346.8824 683.5,-1066.6015 631.1178,-1011.873 416.9953,-1052.591 344.5,-1030.6015 328.5432,-1025.7615 312.0495,-1017.7421 298.1437,-1009.9656"/>
<polygon fill="#000000" stroke="#000000" points="299.8216,-1006.893 289.4109,-1004.9263 296.3229,-1012.9559 299.8216,-1006.893"/>
</g>
<!-- leaf_13 -->
<g id="node14" class="node">
<title>leaf_13</title>
<polygon fill="none" stroke="#c0c0c0" points="811,-1015.4019 354,-1015.4019 354,-960.801 811,-960.801 811,-1015.4019"/>
<text text-anchor="middle" x="582.5" y="-984.3015" font-family="Inconsolata" font-size="14.00" fill="#000000"> Punctuation is valid inside of prose blocks, even with leading</text>
<text text-anchor="middle" x="582.5" y="-968.9015" font-family="Inconsolata" font-size="14.00" fill="#000000"> whitespace</text>
</g>
<!-- block_4&#45;&gt;leaf_13 -->
<g id="edge13" class="edge">
<title>block_4&#45;&gt;leaf_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M747.4988,-2015.2424C769.0391,-1914.0794 863.753,-1407.7843 683.5,-1066.6015 674.0474,-1048.7096 658.5286,-1033.6094 642.4593,-1021.5803"/>
<polygon fill="#000000" stroke="#000000" points="644.2088,-1018.529 634.0352,-1015.5712 640.1438,-1024.2278 644.2088,-1018.529"/>
</g>
<!-- codeblock_14 -->
<g id="node15" class="node">
<title>codeblock_14</title>
<ellipse fill="none" stroke="#000000" cx="906.5" cy="-988.1015" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="906.5" y="-983.9015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 29&#45;31</text>
</g>
<!-- block_5&#45;&gt;codeblock_14 -->
<g id="edge14" class="edge">
<title>block_5&#45;&gt;codeblock_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1026.3825,-2015.0634C1011.906,-1891.0518 927.5745,-1168.6345 909.7915,-1016.2978"/>
<polygon fill="#000000" stroke="#000000" points="913.264,-1015.8575 908.628,-1006.3308 906.3112,-1016.6692 913.264,-1015.8575"/>
</g>
<!-- leaf_16 -->
<g id="node17" class="node">
<title>leaf_16</title>
<polygon fill="none" stroke="#c0c0c0" points="1055.5,-1006.1015 1001.5,-1006.1015 1001.5,-970.1015 1055.5,-970.1015 1055.5,-1006.1015"/>
</g>
<!-- block_5&#45;&gt;leaf_16 -->
<g id="edge16" class="edge">
<title>block_5&#45;&gt;leaf_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1028.5,-2015.0634C1028.5,-1891.1758 1028.5,-1170.0787 1028.5,-1016.7565"/>
<polygon fill="#000000" stroke="#000000" points="1032.0001,-1016.3308 1028.5,-1006.3308 1025.0001,-1016.3309 1032.0001,-1016.3308"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="1509.5,-1007.402 1073.5,-1007.402 1073.5,-968.8009 1509.5,-968.8009 1509.5,-1007.402"/>
<text text-anchor="middle" x="1291.5" y="-992.3015" font-family="Inconsolata" font-size="14.00" fill="#000000"> Interior symbols are valid within a prose word, but not if </text>
<text text-anchor="middle" x="1291.5" y="-976.9015" font-family="Inconsolata" font-size="14.00" fill="#000000"> preceded by whitespace</text>
</g>
<!-- block_6&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>block_6&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1291.5,-2015.0634C1291.5,-1891.4488 1291.5,-1173.2543 1291.5,-1017.7785"/>
<polygon fill="#000000" stroke="#000000" points="1295.0001,-1017.5726 1291.5,-1007.5726 1288.0001,-1017.5727 1295.0001,-1017.5726"/>
</g>
<!-- codeblock_18 -->
<g id="node19" class="node">
<title>codeblock_18</title>
<ellipse fill="none" stroke="#000000" cx="1604.5" cy="-988.1015" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="1604.5" y="-983.9015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 36&#45;57</text>
</g>
<!-- block_7&#45;&gt;codeblock_18 -->
<g id="edge18" class="edge">
<title>block_7&#45;&gt;codeblock_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1604.5,-2015.0634C1604.5,-1891.1758 1604.5,-1170.0787 1604.5,-1016.7565"/>
<polygon fill="#000000" stroke="#000000" points="1608.0001,-1016.3308 1604.5,-1006.3308 1601.0001,-1016.3309 1608.0001,-1016.3308"/>
</g>
<!-- leaf_20 -->
<g id="node21" class="node">
<title>leaf_20</title>
<polygon fill="none" stroke="#c0c0c0" points="1753.5,-1006.1015 1699.5,-1006.1015 1699.5,-970.1015 1753.5,-970.1015 1753.5,-1006.1015"/>
</g>
<!-- block_7&#45;&gt;leaf_20 -->
<g id="edge20" class="edge">
<title>block_7&#45;&gt;leaf_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1606.6175,-2015.0634C1621.094,-1891.0518 1705.4255,-1168.6345 1723.2085,-1016.2978"/>
<polygon fill="#000000" stroke="#000000" points="1726.6888,-1016.6692 1724.372,-1006.3308 1719.736,-1015.8575 1726.6888,-1016.6692"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="2291.5,-1030.6016 1771.5,-1030.6016 1771.5,-945.6013 2291.5,-945.6013 2291.5,-1030.6016"/>
<text text-anchor="middle" x="2031.5" y="-1015.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> The Grimoire grammar is a specially&#45;massaged closure to be executed</text>
<text text-anchor="middle" x="2031.5" y="-1000.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> in the epnf context. </text>
<text text-anchor="middle" x="2031.5" y="-984.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
<text text-anchor="middle" x="2031.5" y="-969.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> The advantage of this approach is that we can make it look much like an</text>
<text text-anchor="middle" x="2031.5" y="-953.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> actual grammar. This should aid in porting to target languages. </text>
</g>
<!-- block_8&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>block_8&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1885.0862,-2015.0634C1901.953,-1896.7574 1996.4646,-1233.8432 2023.9824,-1040.8309"/>
<polygon fill="#000000" stroke="#000000" points="2027.4858,-1041.0548 2025.4323,-1030.6609 2020.5558,-1040.0667 2027.4858,-1041.0548"/>
</g>
<!-- codeblock_22 -->
<g id="node23" class="node">
<title>codeblock_22</title>
<ellipse fill="none" stroke="#000000" cx="2391.5" cy="-988.1015" rx="82.2579" ry="18"/>
<text text-anchor="middle" x="2391.5" y="-983.9015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 65&#45;124</text>
</g>
<!-- block_9&#45;&gt;codeblock_22 -->
<g id="edge22" class="edge">
<title>block_9&#45;&gt;codeblock_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2200.362,-2015.0092C2178.1,-1912.5776 2080.6059,-1400.5301 2274.5,-1066.6015 2289.6389,-1040.529 2317.3213,-1021.3657 2341.9596,-1008.5022"/>
<polygon fill="#000000" stroke="#000000" points="2343.8368,-1011.477 2351.2209,-1003.8793 2340.7104,-1005.2139 2343.8368,-1011.477"/>
</g>
<!-- leaf_24 -->
<g id="node25" class="node">
<title>leaf_24</title>
<polygon fill="none" stroke="#c0c0c0" points="2545.5,-1006.1015 2491.5,-1006.1015 2491.5,-970.1015 2545.5,-970.1015 2545.5,-1006.1015"/>
</g>
<!-- block_9&#45;&gt;leaf_24 -->
<g id="edge24" class="edge">
<title>block_9&#45;&gt;leaf_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2198.8031,-2015.2467C2166.2209,-1908.6998 2013.9038,-1354.3887 2274.5,-1066.6015 2337.4732,-997.0576 2401.068,-1077.1935 2482.5,-1030.6015 2489.4243,-1026.6397 2495.6244,-1020.8176 2500.8481,-1014.7456"/>
<polygon fill="#000000" stroke="#000000" points="2503.9269,-1016.4913 2507.3422,-1006.462 2498.418,-1012.1724 2503.9269,-1016.4913"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="527,-605.6013 0,-605.6013 0,-304.0001 527,-304.0001 527,-605.6013"/>
<text text-anchor="middle" x="263.5" y="-590.501" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="263.5" y="-575.1009" font-family="Inconsolata" font-size="14.00" fill="#000000">local epeg = require &quot;../peg/epeg&quot;</text>
<text text-anchor="middle" x="263.5" y="-559.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">local epnf = require &quot;../peg/epnf&quot;</text>
<text text-anchor="middle" x="263.5" y="-528.3009" font-family="Inconsolata" font-size="14.00" fill="#000000">local match = lpeg.match &#45;&#45; match a pattern against a string</text>
<text text-anchor="middle" x="263.5" y="-512.9008" font-family="Inconsolata" font-size="14.00" fill="#000000">local P = lpeg.P &#45;&#45; match a string literally</text>
<text text-anchor="middle" x="263.5" y="-497.5008" font-family="Inconsolata" font-size="14.00" fill="#000000">local S = lpeg.S &#160;&#45;&#45; match anything in a set</text>
<text text-anchor="middle" x="263.5" y="-482.1008" font-family="Inconsolata" font-size="14.00" fill="#000000">local R = epeg.R &#160;&#45;&#45; match anything in a range</text>
<text text-anchor="middle" x="263.5" y="-466.7007" font-family="Inconsolata" font-size="14.00" fill="#000000">local B = lpeg.B &#160;&#45;&#45; match iff the pattern precedes the use of B</text>
<text text-anchor="middle" x="263.5" y="-451.3007" font-family="Inconsolata" font-size="14.00" fill="#000000">local C = lpeg.C &#160;&#45;&#45; captures a match</text>
<text text-anchor="middle" x="263.5" y="-435.9007" font-family="Inconsolata" font-size="14.00" fill="#000000">local Csp = epeg.Csp &#45;&#45; captures start and end position of match</text>
<text text-anchor="middle" x="263.5" y="-420.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cg = lpeg.Cg &#45;&#45; named capture group (for **balanced highlighting**)</text>
<text text-anchor="middle" x="263.5" y="-405.1006" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cb = lpeg.Cb &#45;&#45; Back capture</text>
<text text-anchor="middle" x="263.5" y="-389.7006" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cmt = lpeg.Cmt &#45;&#45; match&#45;time capture</text>
<text text-anchor="middle" x="263.5" y="-374.3005" font-family="Inconsolata" font-size="14.00" fill="#000000">local Ct = lpeg.Ct &#45;&#45; a table with all captures from the pattern</text>
<text text-anchor="middle" x="263.5" y="-358.9005" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = lpeg.V &#45;&#45; create a variable within a grammar</text>
<text text-anchor="middle" x="263.5" y="-327.5005" font-family="Inconsolata" font-size="14.00" fill="#000000">local letter = R&quot;AZ&quot; + R&quot;az&quot; &#160;&#160;</text>
<text text-anchor="middle" x="263.5" y="-312.1005" font-family="Inconsolata" font-size="14.00" fill="#000000">local digit = R&quot;09&quot;</text>
</g>
<!-- codeblock_11&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>codeblock_11&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M263.5,-970.052C263.5,-915.0802 263.5,-745.5686 263.5,-615.8379"/>
<polygon fill="#000000" stroke="#000000" points="267.0001,-615.7823 263.5,-605.7823 260.0001,-615.7824 267.0001,-615.7823"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="1033.5,-472.8007 779.5,-472.8007 779.5,-436.8007 1033.5,-436.8007 1033.5,-472.8007"/>
<text text-anchor="middle" x="906.5" y="-451.3007" font-family="Inconsolata" font-size="14.00" fill="#000000">local punctuation = S&quot;!?,.:;\\^%~&quot;</text>
</g>
<!-- codeblock_14&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>codeblock_14&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M906.5,-970.052C906.5,-891.4765 906.5,-578.8822 906.5,-482.9464"/>
<polygon fill="#000000" stroke="#000000" points="910.0001,-482.8456 906.5,-472.8456 903.0001,-482.8457 910.0001,-482.8456"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1885.5,-613.5013 1323.5,-613.5013 1323.5,-296.1001 1885.5,-296.1001 1885.5,-613.5013"/>
<text text-anchor="middle" x="1604.5" y="-598.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local interior = S&quot;*_&#45;/@#&quot;</text>
<text text-anchor="middle" x="1604.5" y="-582.8009" font-family="Inconsolata" font-size="14.00" fill="#000000">local sym = letter + digit + punctuation + interior</text>
<text text-anchor="middle" x="1604.5" y="-567.4009" font-family="Inconsolata" font-size="14.00" fill="#000000">local first_letter = letter + digit + punctuation</text>
<text text-anchor="middle" x="1604.5" y="-552.0009" font-family="Inconsolata" font-size="14.00" fill="#000000">local WS = P&#39; &#39; + P&#39;,&#39; + P&#39;\09&#39; &#45;&#45; Not accurate, refine (needs Unicode spaces)</text>
<text text-anchor="middle" x="1604.5" y="-536.6008" font-family="Inconsolata" font-size="14.00" fill="#000000">local NL = P&quot;\n&quot;</text>
<text text-anchor="middle" x="1604.5" y="-505.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">local function equal_strings(s, i, a, b)</text>
<text text-anchor="middle" x="1604.5" y="-489.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns true if a and b are equal.</text>
<text text-anchor="middle" x="1604.5" y="-474.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; s and i are not used, provided because expected by Cb.</text>
<text text-anchor="middle" x="1604.5" y="-459.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return a == b</text>
<text text-anchor="middle" x="1604.5" y="-443.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1604.5" y="-412.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">local function bookends(sigil)</text>
<text text-anchor="middle" x="1604.5" y="-396.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; Returns a pair of patterns, _open and _close,</text>
<text text-anchor="middle" x="1604.5" y="-381.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; which will match a brace of sigil.</text>
<text text-anchor="middle" x="1604.5" y="-366.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; sigil must be a string. </text>
<text text-anchor="middle" x="1604.5" y="-350.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _open = Cg(C(P(sigil)^1), sigil .. &quot;_init&quot;)</text>
<text text-anchor="middle" x="1604.5" y="-335.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local _close = &#160;Cmt(C(P(sigil)^1) * Cb(sigil .. &quot;_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="1604.5" y="-319.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return _open, _close</text>
<text text-anchor="middle" x="1604.5" y="-304.4004" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_18&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>codeblock_18&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1604.5,-970.052C1604.5,-916.1982 1604.5,-752.4161 1604.5,-623.8011"/>
<polygon fill="#000000" stroke="#000000" points="1608.0001,-623.4322 1604.5,-613.4322 1601.0001,-623.4322 1608.0001,-623.4322"/>
</g>
<!-- leaf_23 -->
<g id="node24" class="node">
<title>leaf_23</title>
<polygon fill="none" stroke="#c0c0c0" points="2690,-909.4021 2093,-909.4021 2093,-.1992 2690,-.1992 2690,-909.4021"/>
<text text-anchor="middle" x="2391.5" y="-894.4014" font-family="Inconsolata" font-size="14.00" fill="#000000">local _grym_fn = function ()</text>
<text text-anchor="middle" x="2391.5" y="-879.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function grymmyr (_ENV)</text>
<text text-anchor="middle" x="2391.5" y="-863.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;START &quot;grym&quot;</text>
<text text-anchor="middle" x="2391.5" y="-848.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;SUPPRESS (&quot;structure&quot;, &quot;structured&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-816.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local prose_word = first_letter * (sym^1)^0</text>
<text text-anchor="middle" x="2391.5" y="-801.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local prose_span = (prose_word + WS^1)^1</text>
<text text-anchor="middle" x="2391.5" y="-786.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local NEOL = NL + &#45;P(1)</text>
<text text-anchor="middle" x="2391.5" y="-770.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local LS = B(&quot;\n&quot;) + &#45;B(1)</text>
<text text-anchor="middle" x="2391.5" y="-739.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;grym &#160;&#160;&#160;&#160;&#160;= &#160;V&quot;section&quot;^1 * V&quot;unparsed&quot;^0</text>
<text text-anchor="middle" x="2391.5" y="-707.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;section &#160;&#160;= &#160;(V&quot;header&quot; * V&quot;block&quot;^0) + V&quot;block&quot;^1</text>
<text text-anchor="middle" x="2391.5" y="-676.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;structure = &#160;V&quot;blank_line&quot; &#45;&#45; list, table, json, comment...</text>
<text text-anchor="middle" x="2391.5" y="-645.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;header &#160;&#160;&#160;&#160;= &#160;LS * V&quot;lead_ws&quot; * V&quot;lead_tar&quot; * V&quot;prose_line&quot;</text>
<text text-anchor="middle" x="2391.5" y="-629.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;lead_ws &#160;&#160;&#160;= &#160;Csp(P&quot; &quot;^0)</text>
<text text-anchor="middle" x="2391.5" y="-614.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;lead_tar &#160;&#160;= &#160;Csp(P&quot;*&quot;^&#45;6 * P&quot; &quot;)</text>
<text text-anchor="middle" x="2391.5" y="-598.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;prose_line = &#160;Csp(prose_span * NEOL)</text>
<text text-anchor="middle" x="2391.5" y="-567.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;block = &#160;(V&quot;structure&quot;^1 + V&quot;prose&quot;^1)^1 * #V&quot;block_end&quot;</text>
<text text-anchor="middle" x="2391.5" y="-536.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;prose &#160;&#160;&#160;&#160;&#160;&#160;&#160;= &#160;(V&quot;structured&quot; + V&quot;unstructured&quot;)^1</text>
<text text-anchor="middle" x="2391.5" y="-520.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;unstructured = &#160;Csp(V&quot;prose_line&quot;^1 * prose_span + V&quot;prose_line&quot;^1</text>
<text text-anchor="middle" x="2391.5" y="-505.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;+ prose_span &#45;V&quot;header&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-489.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;structured &#160;&#160;= &#160;V&quot;bold&quot; + V&quot;italic&quot; + V&quot;underscore&quot; + V&quot;strikethrough&quot;</text>
<text text-anchor="middle" x="2391.5" y="-474.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;+ V&quot;literal&quot; + V&quot;quoted&quot;</text>
<text text-anchor="middle" x="2391.5" y="-443.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;unparsed = Csp(P(1)^1)</text>
<text text-anchor="middle" x="2391.5" y="-411.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; Highlighting</text>
<text text-anchor="middle" x="2391.5" y="-396.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; These inner blocks will need to be re&#45;parsed to render, e.g., links</text>
<text text-anchor="middle" x="2391.5" y="-380.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; or multiple layers of highlight. </text>
<text text-anchor="middle" x="2391.5" y="-365.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local bold_open, bold_close &#160;&#160;&#160;&#160;= &#160;bookends(&quot;*&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-350.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local italic_open, italic_close = &#160;bookends(&quot;/&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-334.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local under_open, under_close &#160;&#160;= &#160;bookends(&quot;_&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-319.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local strike_open, strike_close = &#160;bookends(&quot;&#45;&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-303.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local lit_open, lit_close &#160;&#160;&#160;&#160;&#160;&#160;= &#160;bookends(&quot;=&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-288.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;bold &#160;&#160;= &#160;Csp(bold_open * (P(1) &#45; bold_close)^0 * bold_close / 1) &#45; V&quot;header&quot;</text>
<text text-anchor="middle" x="2391.5" y="-273.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;italic = &#160;Csp(italic_open * (P(1) &#45; italic_close)^0 * italic_close / 1)</text>
<text text-anchor="middle" x="2391.5" y="-257.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;underscore = Csp(under_open * (P(1) &#45; under_close)^0 * under_close / 1)</text>
<text text-anchor="middle" x="2391.5" y="-242.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;strikethrough = Csp(strike_open * (P(1) &#45; strike_close)^0 * strike_close / 1)</text>
<text text-anchor="middle" x="2391.5" y="-226.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;literal = Csp(lit_open * (P(1) &#45; lit_close)^0 * lit_close / 1)</text>
<text text-anchor="middle" x="2391.5" y="-195.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local quoted_open = Cg(C(P(&quot;\&quot;&quot;)^2), &quot;quoted_init&quot;)</text>
<text text-anchor="middle" x="2391.5" y="-180.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local quoted_close = Cmt(C(P(&quot;\&quot;&quot;)^1) * Cb(&quot;quoted_init&quot;), equal_strings)</text>
<text text-anchor="middle" x="2391.5" y="-164.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;quoted = Csp(quoted_open * (P(1) &#45; quoted_close)^0 * quoted_close / 1)</text>
<text text-anchor="middle" x="2391.5" y="-133.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;block_end = V&quot;blank_line&quot;^1 + &#45;P(1) + #V&quot;header&quot;</text>
<text text-anchor="middle" x="2391.5" y="-101.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;blank_line = Csp((WS^0 * NL)^1)</text>
<text text-anchor="middle" x="2391.5" y="-86.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2391.5" y="-55.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return grymmyr</text>
<text text-anchor="middle" x="2391.5" y="-39.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2391.5" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">return epnf.define(_grym_fn(), nil, false)</text>
</g>
<!-- codeblock_22&#45;&gt;leaf_23 -->
<g id="edge23" class="edge">
<title>codeblock_22&#45;&gt;leaf_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2391.5,-970.052C2391.5,-958.0999 2391.5,-940.7333 2391.5,-919.5382"/>
<polygon fill="#000000" stroke="#000000" points="2395.0001,-919.5362 2391.5,-909.5362 2388.0001,-919.5363 2395.0001,-919.5362"/>
</g>
</g>
</svg>