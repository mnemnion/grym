<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3751pt" height="1250pt"
 viewBox="0.00 0.00 3750.50 1249.80" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1245.8018)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1245.8018 3746.5,-1245.8018 3746.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="espalier/node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1560" cy="-1223.8018" rx="42.1216" ry="18"/>
<text text-anchor="middle" x="1560" y="-1219.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 82</text>
</g>
<!-- section_1 -->
<g id="node2" class="espalier/node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1560" cy="-1151.8018" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="1560" y="-1147.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;82</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1560,-1205.6331C1560,-1197.9327 1560,-1188.7761 1560,-1180.2184"/>
<polygon fill="#000000" stroke="#000000" points="1563.5001,-1180.215 1560,-1170.215 1556.5001,-1180.2151 1563.5001,-1180.215"/>
</g>
<!-- header_2 -->
<g id="node3" class="espalier/node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="1141" cy="-1079.8018" rx="27" ry="18"/>
<text text-anchor="middle" x="1141" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1507.3576,-1142.7558C1421.2566,-1127.9604 1252.4473,-1098.9526 1177.8934,-1086.1414"/>
<polygon fill="#000000" stroke="#000000" points="1178.0469,-1082.6166 1167.5986,-1084.3724 1176.8614,-1089.5155 1178.0469,-1082.6166"/>
</g>
<!-- prose_3 -->
<g id="node4" class="espalier/node">
<title>prose_3</title>
<ellipse fill="none" stroke="#000000" cx="1314" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1314" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;prose_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1510.895,-1141.1427C1468.9578,-1131.5016 1407.3,-1116.0452 1355,-1097.8018 1352.7705,-1097.0241 1350.4928,-1096.1775 1348.2098,-1095.2893"/>
<polygon fill="#000000" stroke="#000000" points="1349.4846,-1092.0293 1338.9043,-1091.4742 1346.8291,-1098.5061 1349.4846,-1092.0293"/>
</g>
<!-- prose_4 -->
<g id="node5" class="espalier/node">
<title>prose_4</title>
<ellipse fill="none" stroke="#000000" cx="1396" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1396" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;prose_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1525.6202,-1136.7082C1497.8097,-1124.4987 1458.8158,-1107.3794 1430.8739,-1095.1123"/>
<polygon fill="#000000" stroke="#000000" points="1432.0513,-1091.8068 1421.4879,-1090.9916 1429.2374,-1098.2163 1432.0513,-1091.8068"/>
</g>
<!-- prose_5 -->
<g id="node6" class="espalier/node">
<title>prose_5</title>
<ellipse fill="none" stroke="#000000" cx="1478" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1478" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;prose_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1540.5671,-1134.7388C1529.3006,-1124.8462 1514.9965,-1112.2865 1502.9098,-1101.6738"/>
<polygon fill="#000000" stroke="#000000" points="1505.1653,-1098.9965 1495.3415,-1095.0285 1500.5466,-1104.2566 1505.1653,-1098.9965"/>
</g>
<!-- prose_6 -->
<g id="node7" class="espalier/node">
<title>prose_6</title>
<ellipse fill="none" stroke="#000000" cx="1560" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1560" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;prose_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1560,-1133.6331C1560,-1125.9327 1560,-1116.7761 1560,-1108.2184"/>
<polygon fill="#000000" stroke="#000000" points="1563.5001,-1108.215 1560,-1098.215 1556.5001,-1108.2151 1563.5001,-1108.215"/>
</g>
<!-- prose_7 -->
<g id="node8" class="espalier/node">
<title>prose_7</title>
<ellipse fill="none" stroke="#000000" cx="1642" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1642" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;prose_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1579.4329,-1134.7388C1590.6994,-1124.8462 1605.0035,-1112.2865 1617.0902,-1101.6738"/>
<polygon fill="#000000" stroke="#000000" points="1619.4534,-1104.2566 1624.6585,-1095.0285 1614.8347,-1098.9965 1619.4534,-1104.2566"/>
</g>
<!-- prose_8 -->
<g id="node9" class="espalier/node">
<title>prose_8</title>
<ellipse fill="none" stroke="#000000" cx="1724" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1724" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;prose_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1594.3798,-1136.7082C1622.1903,-1124.4987 1661.1842,-1107.3794 1689.1261,-1095.1123"/>
<polygon fill="#000000" stroke="#000000" points="1690.7626,-1098.2163 1698.5121,-1090.9916 1687.9487,-1091.8068 1690.7626,-1098.2163"/>
</g>
<!-- prose_9 -->
<g id="node10" class="espalier/node">
<title>prose_9</title>
<ellipse fill="none" stroke="#000000" cx="1806" cy="-1079.8018" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1806" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;prose_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1609.105,-1141.1427C1651.0422,-1131.5016 1712.7,-1116.0452 1765,-1097.8018 1767.2295,-1097.0241 1769.5072,-1096.1775 1771.7902,-1095.2893"/>
<polygon fill="#000000" stroke="#000000" points="1773.1709,-1098.5061 1781.0957,-1091.4742 1770.5154,-1092.0293 1773.1709,-1098.5061"/>
</g>
<!-- codeblock_10 -->
<g id="node11" class="espalier/node">
<title>codeblock_10</title>
<ellipse fill="none" stroke="#000000" cx="1998" cy="-1079.8018" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="1998" y="-1075.6018" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 23&#45;82</text>
</g>
<!-- section_1&#45;&gt;codeblock_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;codeblock_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1613.2695,-1143.0451C1691.2004,-1130.2346 1836.5589,-1106.3401 1924.5756,-1091.8715"/>
<polygon fill="#000000" stroke="#000000" points="1925.1895,-1095.3177 1934.4893,-1090.2419 1924.054,-1088.4104 1925.1895,-1095.3177"/>
</g>
<!-- leaf_11 -->
<g id="node12" class="espalier/node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="1269,-591.701 819,-591.701 819,-555.701 1269,-555.701 1269,-591.701"/>
<text text-anchor="middle" x="1044" y="-570.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> This walks an AST, making back references to the parent node.</text>
</g>
<!-- header_2&#45;&gt;leaf_11 -->
<g id="edge11" class="edge">
<title>header_2&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1137.5477,-1061.7894C1123.0527,-986.161 1067.0485,-693.957 1049.3754,-601.7475"/>
<polygon fill="#000000" stroke="#000000" points="1052.7813,-600.9235 1047.4614,-591.7611 1045.9064,-602.2412 1052.7813,-600.9235"/>
</g>
<!-- raw_12 -->
<g id="node13" class="espalier/node">
<title>raw_12</title>
<ellipse fill="none" stroke="#000000" cx="1314" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1314" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_3&#45;&gt;raw_12 -->
<g id="edge12" class="edge">
<title>prose_3&#45;&gt;raw_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1314,-1061.7894C1314,-986.2378 1314,-694.5501 1314,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1317.5001,-601.761 1314,-591.7611 1310.5001,-601.7611 1317.5001,-601.761"/>
</g>
<!-- raw_14 -->
<g id="node15" class="espalier/node">
<title>raw_14</title>
<ellipse fill="none" stroke="#000000" cx="1391" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1391" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_4&#45;&gt;raw_14 -->
<g id="edge14" class="edge">
<title>prose_4&#45;&gt;raw_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1395.822,-1061.7894C1395.0756,-986.2378 1392.1939,-694.5501 1391.2799,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1394.7771,-601.726 1391.1784,-591.7611 1387.7775,-601.7952 1394.7771,-601.726"/>
</g>
<!-- raw_16 -->
<g id="node17" class="espalier/node">
<title>raw_16</title>
<ellipse fill="none" stroke="#000000" cx="1470" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1470" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_5&#45;&gt;raw_16 -->
<g id="edge16" class="edge">
<title>prose_5&#45;&gt;raw_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1477.7153,-1061.7894C1476.521,-986.2378 1471.9103,-694.5501 1470.4478,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1473.9432,-601.7045 1470.2855,-591.7611 1466.9441,-601.8152 1473.9432,-601.7045"/>
</g>
<!-- raw_18 -->
<g id="node19" class="espalier/node">
<title>raw_18</title>
<ellipse fill="none" stroke="#000000" cx="1560" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1560" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_6&#45;&gt;raw_18 -->
<g id="edge18" class="edge">
<title>prose_6&#45;&gt;raw_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1560,-1061.7894C1560,-986.2378 1560,-694.5501 1560,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1563.5001,-601.761 1560,-591.7611 1556.5001,-601.7611 1563.5001,-601.761"/>
</g>
<!-- raw_20 -->
<g id="node21" class="espalier/node">
<title>raw_20</title>
<ellipse fill="none" stroke="#000000" cx="1647" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1647" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_7&#45;&gt;raw_20 -->
<g id="edge20" class="edge">
<title>prose_7&#45;&gt;raw_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1642.178,-1061.7894C1642.9244,-986.2378 1645.8061,-694.5501 1646.7201,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1650.2225,-601.7952 1646.8216,-591.7611 1643.2229,-601.726 1650.2225,-601.7952"/>
</g>
<!-- raw_22 -->
<g id="node23" class="espalier/node">
<title>raw_22</title>
<ellipse fill="none" stroke="#000000" cx="1729" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1729" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_8&#45;&gt;raw_22 -->
<g id="edge22" class="edge">
<title>prose_8&#45;&gt;raw_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1724.178,-1061.7894C1724.9244,-986.2378 1727.8061,-694.5501 1728.7201,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1732.2225,-601.7952 1728.8216,-591.7611 1725.2229,-601.726 1732.2225,-601.7952"/>
</g>
<!-- raw_24 -->
<g id="node25" class="espalier/node">
<title>raw_24</title>
<ellipse fill="none" stroke="#000000" cx="1806" cy="-573.701" rx="27" ry="18"/>
<text text-anchor="middle" x="1806" y="-569.501" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_9&#45;&gt;raw_24 -->
<g id="edge24" class="edge">
<title>prose_9&#45;&gt;raw_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1806,-1061.7894C1806,-986.2378 1806,-694.5501 1806,-602.0289"/>
<polygon fill="#000000" stroke="#000000" points="1809.5001,-601.761 1806,-591.7611 1802.5001,-601.7611 1809.5001,-601.761"/>
</g>
<!-- leaf_26 -->
<g id="node27" class="espalier/node">
<title>leaf_26</title>
<polygon fill="none" stroke="#c0c0c0" points="2273,-1025.9026 1851,-1025.9026 1851,-121.4993 2273,-121.4993 2273,-1025.9026"/>
<text text-anchor="middle" x="2062" y="-1010.6018" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="2062" y="-995.2017" font-family="Inconsolata" font-size="14.00" fill="#000000">local backwalk = {}</text>
<text text-anchor="middle" x="2062" y="-963.8017" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_backref (ast)</text>
<text text-anchor="middle" x="2062" y="-948.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return function() return ast end</text>
<text text-anchor="middle" x="2062" y="-933.0017" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2062" y="-885.6016" font-family="Inconsolata" font-size="14.00" fill="#000000">local function index_gen ()</text>
<text text-anchor="middle" x="2062" y="-870.2016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local first = {}</text>
<text text-anchor="middle" x="2062" y="-854.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local last &#160;= {}</text>
<text text-anchor="middle" x="2062" y="-839.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local closed = {}</text>
<text text-anchor="middle" x="2062" y="-824.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local depth = {}</text>
<text text-anchor="middle" x="2062" y="-808.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local length = 0</text>
<text text-anchor="middle" x="2062" y="-793.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local meta &#160;= util.F()</text>
<text text-anchor="middle" x="2062" y="-777.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__call = function(_, ordinal)</text>
<text text-anchor="middle" x="2062" y="-762.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return first[ordinal], last[ordinal], depth[ordinal]</text>
<text text-anchor="middle" x="2062" y="-747.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-731.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; This override requires 5.2</text>
<text text-anchor="middle" x="2062" y="-716.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__len = function() return length end</text>
<text text-anchor="middle" x="2062" y="-700.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.len = function() return length end</text>
<text text-anchor="middle" x="2062" y="-685.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.add = function(table, deep)</text>
<text text-anchor="middle" x="2062" y="-670.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;length = length+1</text>
<text text-anchor="middle" x="2062" y="-654.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[length] = table</text>
<text text-anchor="middle" x="2062" y="-639.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[table] &#160;= length &#45;&#45; Janus table!</text>
<text text-anchor="middle" x="2062" y="-623.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[length] = deep</text>
<text text-anchor="middle" x="2062" y="-608.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[table] &#160;= deep</text>
<text text-anchor="middle" x="2062" y="-593.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-577.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.close = function(table)</text>
<text text-anchor="middle" x="2062" y="-562.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[first[table]] = length</text>
<text text-anchor="middle" x="2062" y="-546.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[table] = length</text>
<text text-anchor="middle" x="2062" y="-531.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-516.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;setmetatable(closed,meta)</text>
<text text-anchor="middle" x="2062" y="-500.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return closed</text>
<text text-anchor="middle" x="2062" y="-485.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2062" y="-453.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">function backwalk.walk_ast (ast)</text>
<text text-anchor="middle" x="2062" y="-438.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local index = index_gen()</text>
<text text-anchor="middle" x="2062" y="-423.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local str = ast.str</text>
<text text-anchor="middle" x="2062" y="-407.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function walker (ast, parent, deep)</text>
<text text-anchor="middle" x="2062" y="-392.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;deep = deep + 1</text>
<text text-anchor="middle" x="2062" y="-376.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if ast.isnode then</text>
<text text-anchor="middle" x="2062" y="-361.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.add(ast,deep)</text>
<text text-anchor="middle" x="2062" y="-346.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for i, v in ipairs(ast) do</text>
<text text-anchor="middle" x="2062" y="-330.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; and v.isnode then</text>
<text text-anchor="middle" x="2062" y="-315.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;walker(v,ast, deep)</text>
<text text-anchor="middle" x="2062" y="-299.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-284.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-269.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ast.parent = make_backref(parent)</text>
<text text-anchor="middle" x="2062" y="-253.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.close(ast)</text>
<text text-anchor="middle" x="2062" y="-238.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-222.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2062" y="-207.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;walker(ast,ast,0)</text>
<text text-anchor="middle" x="2062" y="-192.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;ast.index = index</text>
<text text-anchor="middle" x="2062" y="-176.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return ast </text>
<text text-anchor="middle" x="2062" y="-161.2002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2062" y="-129.8002" font-family="Inconsolata" font-size="14.00" fill="#000000">return backwalk</text>
</g>
<!-- codeblock_10&#45;&gt;leaf_26 -->
<g id="edge26" class="edge">
<title>codeblock_10&#45;&gt;leaf_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2000.2778,-1061.7894C2001.1468,-1054.9172 2002.242,-1046.2567 2003.5238,-1036.1205"/>
<polygon fill="#000000" stroke="#000000" points="2007.0263,-1036.3205 2004.8086,-1025.9604 2000.0816,-1035.4422 2007.0263,-1036.3205"/>
</g>
<!-- leaf_13 -->
<g id="node14" class="espalier/node">
<title>leaf_13</title>
<polygon fill="none" stroke="#c0c0c0" points="506,-78.0004 0,-78.0004 0,-7.5997 506,-7.5997 506,-78.0004"/>
<text text-anchor="middle" x="253" y="-46.7001" font-family="Inconsolata" font-size="14.00" fill="#000000"> This walks an AST, making back references to the parent node.</text>
<text text-anchor="middle" x="253" y="-31.3001" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
<text text-anchor="middle" x="253" y="-15.9" font-family="Inconsolata" font-size="14.00" fill="#000000"> This shouldn&#39;t be a separate step, but that&#39;s premature optimization.</text>
</g>
<!-- raw_12&#45;&gt;leaf_13 -->
<g id="edge13" class="edge">
<title>raw_12&#45;&gt;leaf_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1319.5857,-556.0817C1339.8735,-488.2533 1402.1679,-241.8192 1278,-121.6001 1247.5123,-92.082 557.2044,-90.0282 515,-85.6001 498.2362,-83.8413 480.915,-81.7114 463.5378,-79.3525"/>
<polygon fill="#000000" stroke="#000000" points="463.6887,-75.8402 453.3036,-77.9382 462.7303,-82.7743 463.6887,-75.8402"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="espalier/node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="743.5,-62.7021 524.5,-62.7021 524.5,-22.898 743.5,-22.898 743.5,-62.7021"/>
<text text-anchor="middle" x="634" y="-31.3001" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is conceptually simple:</text>
</g>
<!-- raw_14&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>raw_14&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1396.4412,-555.6306C1415.8124,-487.2014 1473.8748,-241.7878 1350,-121.6001 1302.3056,-75.3253 818.0927,-98.9811 753,-85.6001 731.5615,-81.1931 708.7749,-73.7282 688.9409,-66.2553"/>
<polygon fill="#000000" stroke="#000000" points="690.0498,-62.9318 679.4602,-62.5995 687.5313,-69.4631 690.0498,-62.9318"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="espalier/node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="1212,-62.7021 762,-62.7021 762,-22.898 1212,-22.898 1212,-62.7021"/>
<text text-anchor="middle" x="987" y="-31.3001" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take the tree, add a parent reference &#160;that points to itself.</text>
</g>
<!-- raw_16&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>raw_16&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1475.0315,-555.5821C1492.5913,-488.0064 1543.9622,-248.084 1427,-121.6001 1395.449,-87.4806 1266.7458,-93.7808 1221,-85.6001 1182.8412,-78.7762 1141.2071,-71.2026 1103.776,-64.3464"/>
<polygon fill="#000000" stroke="#000000" points="1104.3146,-60.8868 1093.8474,-62.5265 1103.0525,-67.7721 1104.3146,-60.8868"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="espalier/node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1890,-70.1005 1230,-70.1005 1230,-15.4996 1890,-15.4996 1890,-70.1005"/>
<text text-anchor="middle" x="1560" y="-39.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take all child members, if they&#39;re nodes, call the function recursively with the parent and</text>
<text text-anchor="middle" x="1560" y="-23.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> nodes as argument.</text>
</g>
<!-- raw_18&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>raw_18&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1560,-555.4261C1560,-479.1862 1560,-185.5699 1560,-80.48"/>
<polygon fill="#000000" stroke="#000000" points="1563.5001,-80.3361 1560,-70.3361 1556.5001,-80.3362 1563.5001,-80.3361"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="espalier/node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="2414,-62.7021 1908,-62.7021 1908,-22.898 2414,-22.898 2414,-62.7021"/>
<text text-anchor="middle" x="2161" y="-31.3001" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is the usual recursive function wrapped in pre and post matter. </text>
</g>
<!-- raw_20&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>raw_20&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1642.086,-555.5391C1624.965,-487.8107 1575.1563,-247.4159 1693,-121.6001 1694.4693,-120.0315 1893.0547,-86.9964 2031.0378,-64.203"/>
<polygon fill="#000000" stroke="#000000" points="2031.9829,-67.5944 2041.279,-62.5116 2030.8423,-60.6879 2031.9829,-67.5944"/>
</g>
<!-- leaf_23 -->
<g id="node24" class="espalier/node">
<title>leaf_23</title>
<polygon fill="none" stroke="#c0c0c0" points="3099.5,-85.4011 2432.5,-85.4011 2432.5,-.199 3099.5,-.199 3099.5,-85.4011"/>
<text text-anchor="middle" x="2766" y="-54.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> Now that I&#39;ve added an index, I&#39;m considering a cleaner parent implementation, where the </text>
<text text-anchor="middle" x="2766" y="-39.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> parent is simply a number which must be looked up against the index. To completely eliminate</text>
<text text-anchor="middle" x="2766" y="-23.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> back references, the index might be a closure which returns the table given the argument, </text>
<text text-anchor="middle" x="2766" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000"> thus `index(i)` rather than `index[i]`. </text>
</g>
<!-- raw_22&#45;&gt;leaf_23 -->
<g id="edge23" class="edge">
<title>raw_22&#45;&gt;leaf_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1723.5395,-555.6106C1704.0981,-487.109 1645.8159,-241.4682 1770,-121.6001 1820.4449,-72.9085 2314.0651,-90.7167 2422.2121,-85.4117"/>
<polygon fill="#000000" stroke="#000000" points="2422.7107,-88.8865 2432.4584,-84.7354 2422.2496,-81.9017 2422.7107,-88.8865"/>
</g>
<!-- leaf_25 -->
<g id="node26" class="espalier/node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="3742.5,-70.1005 3117.5,-70.1005 3117.5,-15.4996 3742.5,-15.4996 3742.5,-70.1005"/>
<text text-anchor="middle" x="3430" y="-39.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> It would be useful for our decorated AST to have no cycles, since we&#39;re guaranteed to </text>
<text text-anchor="middle" x="3430" y="-23.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> traverse it in linear time with no cycle checking. </text>
</g>
<!-- raw_24&#45;&gt;leaf_25 -->
<g id="edge25" class="edge">
<title>raw_24&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1800.346,-556.0104C1779.8069,-487.9201 1716.711,-240.6504 1842,-121.6001 1893.0473,-73.0947 3038.8106,-91.2611 3109,-85.6001 3151.6323,-82.1617 3197.2735,-76.9873 3240.3706,-71.4123"/>
<polygon fill="#000000" stroke="#000000" points="3240.9305,-74.869 3250.3927,-70.1028 3240.0235,-67.928 3240.9305,-74.869"/>
</g>
</g>
</svg>