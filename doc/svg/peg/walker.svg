<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="4255pt" height="2460pt"
 viewBox="0.00 0.00 4254.50 2460.40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 2456.4039)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-2456.4039 4250.5,-2456.4039 4250.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="2096" cy="-2434.4039" rx="42.1216" ry="18"/>
<text text-anchor="middle" x="2096" y="-2430.2039" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 82</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="2096" cy="-2362.4039" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="2096" y="-2358.2039" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;82</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2096,-2416.2353C2096,-2408.5349 2096,-2399.3783 2096,-2390.8206"/>
<polygon fill="#000000" stroke="#000000" points="2099.5001,-2390.8172 2096,-2380.8172 2092.5001,-2390.8172 2099.5001,-2390.8172"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="1600" cy="-1677.1029" rx="27" ry="18"/>
<text text-anchor="middle" x="1600" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2035.5836,-2359.5751C1917.0052,-2353.4187 1662.9449,-2337.0129 1636,-2308.4039 1472.6044,-2134.9168 1560.4419,-1801.6875 1590.918,-1704.3985"/>
<polygon fill="#000000" stroke="#000000" points="1594.2999,-1705.3133 1594.006,-1694.7225 1587.6312,-1703.185 1594.2999,-1705.3133"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="1691" cy="-1677.1029" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="1691" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;5</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2037.7076,-2357.3235C1943.3424,-2348.5302 1765.641,-2329.3897 1746,-2308.4039 1583.1612,-2134.416 1656.5098,-1802.895 1682.9389,-1704.9876"/>
<polygon fill="#000000" stroke="#000000" points="1686.344,-1705.8051 1685.6274,-1695.2346 1679.5957,-1703.9449 1686.344,-1705.8051"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="1801" cy="-1677.1029" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="1801" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 6&#45;7</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2037.6553,-2357.0987C1974.4488,-2350.055 1879.4661,-2335.2569 1856,-2308.4039 1699.3655,-2129.1625 1768.2117,-1801.9464 1793.2835,-1704.9238"/>
<polygon fill="#000000" stroke="#000000" points="1796.668,-1705.8155 1795.8368,-1695.2533 1789.8999,-1704.0285 1796.668,-1705.8155"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="1911" cy="-1677.1029" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="1911" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 8&#45;9</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2042.5631,-2353.7298C2015.2133,-2346.3967 1983.9749,-2332.9536 1966,-2308.4039 1825.9746,-2117.1601 1882.6819,-1800.6808 1904.1618,-1705.2122"/>
<polygon fill="#000000" stroke="#000000" points="1907.6389,-1705.7096 1906.4751,-1695.1789 1900.8178,-1704.137 1907.6389,-1705.7096"/>
</g>
<!-- block_6 -->
<g id="node7" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="2031" cy="-1677.1029" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2031" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 10&#45;12</text>
</g>
<!-- section_1&#45;&gt;block_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;block_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2094.2614,-2344.0738C2085.3233,-2249.8385 2044.5432,-1819.8899 2033.6705,-1705.2584"/>
<polygon fill="#000000" stroke="#000000" points="2037.1425,-1704.7961 2032.7138,-1695.1713 2030.1737,-1705.4571 2037.1425,-1704.7961"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="2161" cy="-1677.1029" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2161" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 13&#45;14</text>
</g>
<!-- section_1&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2097.7386,-2344.0738C2106.6767,-2249.8385 2147.4568,-1819.8899 2158.3295,-1705.2584"/>
<polygon fill="#000000" stroke="#000000" points="2161.8263,-1705.4571 2159.2862,-1695.1713 2154.8575,-1704.7961 2161.8263,-1705.4571"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="2528" cy="-1677.1029" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2528" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 15&#45;19</text>
</g>
<!-- section_1&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2144.2951,-2351.4572C2171.061,-2343.3299 2203.3959,-2329.8514 2226,-2308.4039 2416.5038,-2127.6483 2500.6046,-1802.0807 2522.1725,-1705.0959"/>
<polygon fill="#000000" stroke="#000000" points="2525.6255,-1705.6883 2524.3368,-1695.1721 2518.7863,-1704.1967 2525.6255,-1705.6883"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="3044" cy="-1677.1029" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="3044" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 20&#45;22</text>
</g>
<!-- section_1&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2155.7327,-2358.6543C2279.5881,-2350.4859 2555.9645,-2330.0713 2593,-2308.4039 2846.7446,-2159.9521 2995.6364,-1805.7648 3034.0265,-1704.5467"/>
<polygon fill="#000000" stroke="#000000" points="3037.3603,-1705.6242 3037.5906,-1695.0318 3030.8051,-1703.1687 3037.3603,-1705.6242"/>
</g>
<!-- block_10 -->
<g id="node11" class="node">
<title>block_10</title>
<ellipse fill="none" stroke="#000000" cx="3506" cy="-1677.1029" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="3506" y="-1672.9029" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 23&#45;82</text>
</g>
<!-- section_1&#45;&gt;block_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;block_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2156.5001,-2360.7113C2368.5894,-2354.5792 3067.8145,-2332.6095 3109,-2308.4039 3352.3714,-2165.3697 3469.164,-1808.0426 3498.453,-1705.2017"/>
<polygon fill="#000000" stroke="#000000" points="3501.9106,-1705.8336 3501.2356,-1695.2603 3495.1697,-1703.9468 3501.9106,-1705.8336"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="4246.5,-2308.2051 3579.5,-2308.2051 3579.5,-1046.0006 4246.5,-1046.0006 4246.5,-2308.2051"/>
<text text-anchor="middle" x="3913" y="-2293.2039" font-family="Inconsolata" font-size="14.00" fill="#000000"> This walks an AST, making back references to the parent node.</text>
<text text-anchor="middle" x="3913" y="-2277.8039" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
<text text-anchor="middle" x="3913" y="-2262.4039" font-family="Inconsolata" font-size="14.00" fill="#000000"> This shouldn&#39;t be a separate step, but that&#39;s premature optimization.</text>
<text text-anchor="middle" x="3913" y="-2231.0038" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is conceptually simple:</text>
<text text-anchor="middle" x="3913" y="-2199.6038" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take the tree, add a parent reference &#160;that points to itself.</text>
<text text-anchor="middle" x="3913" y="-2168.2038" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take all child members, if they&#39;re nodes, call the function recursively with the parent and</text>
<text text-anchor="middle" x="3913" y="-2152.8037" font-family="Inconsolata" font-size="14.00" fill="#000000"> nodes as argument.</text>
<text text-anchor="middle" x="3913" y="-2121.4037" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is the usual recursive function wrapped in pre and post matter. </text>
<text text-anchor="middle" x="3913" y="-2090.0037" font-family="Inconsolata" font-size="14.00" fill="#000000"> Now that I&#39;ve added an index, I&#39;m considering a cleaner parent implementation, where the </text>
<text text-anchor="middle" x="3913" y="-2074.6037" font-family="Inconsolata" font-size="14.00" fill="#000000"> parent is simply a number which must be looked up against the index. To completely eliminate</text>
<text text-anchor="middle" x="3913" y="-2059.2036" font-family="Inconsolata" font-size="14.00" fill="#000000"> back references, the index might be a closure which returns the table given the argument, </text>
<text text-anchor="middle" x="3913" y="-2043.8036" font-family="Inconsolata" font-size="14.00" fill="#000000"> thus `index(i)` rather than `index[i]`. </text>
<text text-anchor="middle" x="3913" y="-2012.4036" font-family="Inconsolata" font-size="14.00" fill="#000000"> It would be useful for our decorated AST to have no cycles, since we&#39;re guaranteed to </text>
<text text-anchor="middle" x="3913" y="-1997.0035" font-family="Inconsolata" font-size="14.00" fill="#000000"> traverse it in linear time with no cycle checking. </text>
<text text-anchor="middle" x="3913" y="-1965.6035" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3913" y="-1950.2035" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="3913" y="-1934.8034" font-family="Inconsolata" font-size="14.00" fill="#000000">local backwalk = {}</text>
<text text-anchor="middle" x="3913" y="-1903.4034" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_backref (ast)</text>
<text text-anchor="middle" x="3913" y="-1888.0034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return function() return ast end</text>
<text text-anchor="middle" x="3913" y="-1872.6033" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3913" y="-1825.2033" font-family="Inconsolata" font-size="14.00" fill="#000000">local function index_gen ()</text>
<text text-anchor="middle" x="3913" y="-1809.8033" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local first = {}</text>
<text text-anchor="middle" x="3913" y="-1794.4032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local last &#160;= {}</text>
<text text-anchor="middle" x="3913" y="-1779.0032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local closed = {}</text>
<text text-anchor="middle" x="3913" y="-1763.6032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local depth = {}</text>
<text text-anchor="middle" x="3913" y="-1748.2032" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local length = 0</text>
<text text-anchor="middle" x="3913" y="-1732.8031" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local meta &#160;= util.F()</text>
<text text-anchor="middle" x="3913" y="-1717.4031" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__call = function(_, ordinal)</text>
<text text-anchor="middle" x="3913" y="-1702.0031" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return first[ordinal], last[ordinal], depth[ordinal]</text>
<text text-anchor="middle" x="3913" y="-1686.603" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1671.203" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; This override requires 5.2</text>
<text text-anchor="middle" x="3913" y="-1655.803" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__len = function() return length end</text>
<text text-anchor="middle" x="3913" y="-1640.4029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.len = function() return length end</text>
<text text-anchor="middle" x="3913" y="-1625.0029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.add = function(table, deep)</text>
<text text-anchor="middle" x="3913" y="-1609.6029" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;length = length+1</text>
<text text-anchor="middle" x="3913" y="-1594.2028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[length] = table</text>
<text text-anchor="middle" x="3913" y="-1578.8028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[table] &#160;= length &#45;&#45; Janus table!</text>
<text text-anchor="middle" x="3913" y="-1563.4028" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[length] = deep</text>
<text text-anchor="middle" x="3913" y="-1548.0027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[table] &#160;= deep</text>
<text text-anchor="middle" x="3913" y="-1532.6027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1517.2027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.close = function(table)</text>
<text text-anchor="middle" x="3913" y="-1501.8027" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[first[table]] = length</text>
<text text-anchor="middle" x="3913" y="-1486.4026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[table] = length</text>
<text text-anchor="middle" x="3913" y="-1471.0026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1455.6026" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;setmetatable(closed,meta)</text>
<text text-anchor="middle" x="3913" y="-1440.2025" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return closed</text>
<text text-anchor="middle" x="3913" y="-1424.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3913" y="-1393.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">function backwalk.walk_ast (ast)</text>
<text text-anchor="middle" x="3913" y="-1378.0024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local index = index_gen()</text>
<text text-anchor="middle" x="3913" y="-1362.6024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local str = ast.str</text>
<text text-anchor="middle" x="3913" y="-1347.2024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function walker (ast, parent, deep)</text>
<text text-anchor="middle" x="3913" y="-1331.8023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;deep = deep + 1</text>
<text text-anchor="middle" x="3913" y="-1316.4023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if ast.isnode then</text>
<text text-anchor="middle" x="3913" y="-1301.0023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.add(ast,deep)</text>
<text text-anchor="middle" x="3913" y="-1285.6022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for i, v in ipairs(ast) do</text>
<text text-anchor="middle" x="3913" y="-1270.2022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; and v.isnode then</text>
<text text-anchor="middle" x="3913" y="-1254.8022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;walker(v,ast, deep)</text>
<text text-anchor="middle" x="3913" y="-1239.4022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1224.0021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1208.6021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ast.parent = make_backref(parent)</text>
<text text-anchor="middle" x="3913" y="-1193.2021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.close(ast)</text>
<text text-anchor="middle" x="3913" y="-1177.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1162.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3913" y="-1147.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;walker(ast,ast,0)</text>
<text text-anchor="middle" x="3913" y="-1131.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;ast.index = index</text>
<text text-anchor="middle" x="3913" y="-1116.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return ast </text>
<text text-anchor="middle" x="3913" y="-1100.8019" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3913" y="-1069.4018" font-family="Inconsolata" font-size="14.00" fill="#000000">return backwalk</text>
<text text-anchor="middle" x="3913" y="-1054.0018" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
</g>
<!-- section_1&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>section_1&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2156.974,-2361.8527C2419.2122,-2359.2753 3443.2141,-2347.0193 3569.8767,-2307.0868"/>
<polygon fill="#000000" stroke="#000000" points="3571.4149,-2310.2369 3579.2774,-2303.1354 3568.7024,-2303.7838 3571.4149,-2310.2369"/>
</g>
<!-- leaf_11 -->
<g id="node12" class="node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="506,-1002.2022 0,-1002.2022 0,-947.8013 506,-947.8013 506,-1002.2022"/>
<text text-anchor="middle" x="253" y="-986.9018" font-family="Inconsolata" font-size="14.00" fill="#000000"> This walks an AST, making back references to the parent node.</text>
<text text-anchor="middle" x="253" y="-971.5017" font-family="Inconsolata" font-size="14.00" fill="#000000"> </text>
<text text-anchor="middle" x="253" y="-956.1017" font-family="Inconsolata" font-size="14.00" fill="#000000"> This shouldn&#39;t be a separate step, but that&#39;s premature optimization.</text>
</g>
<!-- block_3&#45;&gt;leaf_11 -->
<g id="edge11" class="edge">
<title>block_3&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1696.6838,-1659.0593C1722.0228,-1574.6807 1815.764,-1215.9753 1636,-1045.8018 1590.7497,-1002.9656 577.1001,-1014.9103 515,-1009.8018 493.8824,-1008.0646 471.8584,-1005.8218 449.9422,-1003.3124"/>
<polygon fill="#000000" stroke="#000000" points="450.2214,-999.8213 439.8837,-1002.1415 449.4119,-1006.7744 450.2214,-999.8213"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="743.5,-993.0017 524.5,-993.0017 524.5,-957.0017 743.5,-957.0017 743.5,-993.0017"/>
<text text-anchor="middle" x="634" y="-971.5017" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is conceptually simple:</text>
</g>
<!-- block_4&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>block_4&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1806.6683,-1659.0757C1831.9375,-1574.7706 1925.4118,-1216.3465 1746,-1045.8018 1705.9895,-1007.7687 807.4945,-1018.6168 753,-1009.8018 733.9076,-1006.7134 713.558,-1001.506 695.1855,-996.0474"/>
<polygon fill="#000000" stroke="#000000" points="696.0761,-992.66 685.4901,-993.0909 694.0343,-999.3556 696.0761,-992.66"/>
</g>
<!-- leaf_13 -->
<g id="node14" class="node">
<title>leaf_13</title>
<polygon fill="none" stroke="#c0c0c0" points="1212,-993.0017 762,-993.0017 762,-957.0017 1212,-957.0017 1212,-993.0017"/>
<text text-anchor="middle" x="987" y="-971.5017" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take the tree, add a parent reference &#160;that points to itself.</text>
</g>
<!-- block_5&#45;&gt;leaf_13 -->
<g id="edge13" class="edge">
<title>block_5&#45;&gt;leaf_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1916.5914,-1659.1558C1941.5141,-1575.2116 2033.6634,-1218.1671 1856,-1045.8018 1805.279,-996.5934 1291.3006,-1017.0069 1221,-1009.8018 1182.8375,-1005.8905 1141.3725,-1000.2007 1104.0951,-994.5509"/>
<polygon fill="#000000" stroke="#000000" points="1104.6215,-991.0908 1094.2072,-993.0385 1103.5631,-998.0103 1104.6215,-991.0908"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="1890,-994.3023 1230,-994.3023 1230,-955.7011 1890,-955.7011 1890,-994.3023"/>
<text text-anchor="middle" x="1560" y="-979.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> Take all child members, if they&#39;re nodes, call the function recursively with the parent and</text>
<text text-anchor="middle" x="1560" y="-963.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> nodes as argument.</text>
</g>
<!-- block_6&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>block_6&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2035.9512,-1658.9982C2057.4977,-1575.826 2134.6743,-1226.7254 1966,-1045.8018 1943.985,-1022.1881 1887.0403,-1006.4246 1822.5275,-995.9112"/>
<polygon fill="#000000" stroke="#000000" points="1822.9598,-992.4362 1812.5362,-994.3333 1821.8677,-999.3505 1822.9598,-992.4362"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="2414,-993.0017 1908,-993.0017 1908,-957.0017 2414,-957.0017 2414,-993.0017"/>
<text text-anchor="middle" x="2161" y="-971.5017" font-family="Inconsolata" font-size="14.00" fill="#000000"> This is the usual recursive function wrapped in pre and post matter. </text>
</g>
<!-- block_7&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>block_7&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2161,-1659.0419C2161,-1563.9134 2161,-1120.9142 2161,-1003.5811"/>
<polygon fill="#000000" stroke="#000000" points="2164.5001,-1003.2655 2161,-993.2656 2157.5001,-1003.2656 2164.5001,-1003.2655"/>
</g>
<!-- leaf_16 -->
<g id="node17" class="node">
<title>leaf_16</title>
<polygon fill="none" stroke="#c0c0c0" points="3099.5,-1009.603 2432.5,-1009.603 2432.5,-940.4004 3099.5,-940.4004 3099.5,-1009.603"/>
<text text-anchor="middle" x="2766" y="-994.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> Now that I&#39;ve added an index, I&#39;m considering a cleaner parent implementation, where the </text>
<text text-anchor="middle" x="2766" y="-979.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> parent is simply a number which must be looked up against the index. To completely eliminate</text>
<text text-anchor="middle" x="2766" y="-963.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> back references, the index might be a closure which returns the table given the argument, </text>
<text text-anchor="middle" x="2766" y="-948.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> thus `index(i)` rather than `index[i]`. </text>
</g>
<!-- block_8&#45;&gt;leaf_16 -->
<g id="edge16" class="edge">
<title>block_8&#45;&gt;leaf_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2534.1223,-1659.0419C2565.0352,-1567.8489 2704.315,-1156.9728 2750.8251,-1019.7679"/>
<polygon fill="#000000" stroke="#000000" points="2754.2436,-1020.585 2754.1394,-1009.9907 2747.6142,-1018.3377 2754.2436,-1020.585"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="3742.5,-994.3023 3117.5,-994.3023 3117.5,-955.7011 3742.5,-955.7011 3742.5,-994.3023"/>
<text text-anchor="middle" x="3430" y="-979.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> It would be useful for our decorated AST to have no cycles, since we&#39;re guaranteed to </text>
<text text-anchor="middle" x="3430" y="-963.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> traverse it in linear time with no cycle checking. </text>
</g>
<!-- block_9&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>block_9&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3053.9295,-1659.0419C3106.2629,-1563.8519 3350.0956,-1120.3411 3414.4126,-1003.3539"/>
<polygon fill="#000000" stroke="#000000" points="3417.4849,-1005.0304 3419.2356,-994.5812 3411.3508,-1001.658 3417.4849,-1005.0304"/>
</g>
<!-- codeblock_18 -->
<g id="node19" class="node">
<title>codeblock_18</title>
<ellipse fill="none" stroke="#000000" cx="3838" cy="-975.0017" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="3838" y="-970.8017" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 23&#45;82</text>
</g>
<!-- block_10&#45;&gt;codeblock_18 -->
<g id="edge18" class="edge">
<title>block_10&#45;&gt;codeblock_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3501.1466,-1659.0884C3480.0324,-1576.3144 3404.48,-1228.7102 3571,-1045.8018 3626.2162,-985.1513 3673.4146,-1033.2888 3752,-1009.8018 3765.6598,-1005.7192 3780.1551,-1000.2994 3793.2749,-994.9552"/>
<polygon fill="#000000" stroke="#000000" points="3794.6636,-998.1684 3802.5535,-991.0974 3791.9761,-991.7048 3794.6636,-998.1684"/>
</g>
<!-- leaf_20 -->
<g id="node21" class="node">
<title>leaf_20</title>
<polygon fill="none" stroke="#c0c0c0" points="3987,-993.0017 3933,-993.0017 3933,-957.0017 3987,-957.0017 3987,-993.0017"/>
</g>
<!-- block_10&#45;&gt;leaf_20 -->
<g id="edge20" class="edge">
<title>block_10&#45;&gt;leaf_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3500.8378,-1659.002C3478.1306,-1575.1123 3395.8142,-1220.8179 3571,-1045.8018 3626.7833,-990.0725 3852.4935,-1043.0335 3924,-1009.8018 3929.124,-1007.4205 3933.9668,-1004.0049 3938.3409,-1000.2338"/>
<polygon fill="#000000" stroke="#000000" points="3940.872,-1002.6559 3945.6676,-993.2085 3936.0272,-997.6033 3940.872,-1002.6559"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="4049,-904.3025 3627,-904.3025 3627,.1008 4049,.1008 4049,-904.3025"/>
<text text-anchor="middle" x="3838" y="-889.0017" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="3838" y="-873.6016" font-family="Inconsolata" font-size="14.00" fill="#000000">local backwalk = {}</text>
<text text-anchor="middle" x="3838" y="-842.2016" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_backref (ast)</text>
<text text-anchor="middle" x="3838" y="-826.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return function() return ast end</text>
<text text-anchor="middle" x="3838" y="-811.4015" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3838" y="-764.0015" font-family="Inconsolata" font-size="14.00" fill="#000000">local function index_gen ()</text>
<text text-anchor="middle" x="3838" y="-748.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local first = {}</text>
<text text-anchor="middle" x="3838" y="-733.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local last &#160;= {}</text>
<text text-anchor="middle" x="3838" y="-717.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local closed = {}</text>
<text text-anchor="middle" x="3838" y="-702.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local depth = {}</text>
<text text-anchor="middle" x="3838" y="-687.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local length = 0</text>
<text text-anchor="middle" x="3838" y="-671.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local meta &#160;= util.F()</text>
<text text-anchor="middle" x="3838" y="-656.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__call = function(_, ordinal)</text>
<text text-anchor="middle" x="3838" y="-640.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return first[ordinal], last[ordinal], depth[ordinal]</text>
<text text-anchor="middle" x="3838" y="-625.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-610.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45;&#45; This override requires 5.2</text>
<text text-anchor="middle" x="3838" y="-594.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;meta.__len = function() return length end</text>
<text text-anchor="middle" x="3838" y="-579.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.len = function() return length end</text>
<text text-anchor="middle" x="3838" y="-563.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.add = function(table, deep)</text>
<text text-anchor="middle" x="3838" y="-548.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;length = length+1</text>
<text text-anchor="middle" x="3838" y="-533.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[length] = table</text>
<text text-anchor="middle" x="3838" y="-517.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;first[table] &#160;= length &#45;&#45; Janus table!</text>
<text text-anchor="middle" x="3838" y="-502.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[length] = deep</text>
<text text-anchor="middle" x="3838" y="-486.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;depth[table] &#160;= deep</text>
<text text-anchor="middle" x="3838" y="-471.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-456.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;closed.close = function(table)</text>
<text text-anchor="middle" x="3838" y="-440.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[first[table]] = length</text>
<text text-anchor="middle" x="3838" y="-425.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;last[table] = length</text>
<text text-anchor="middle" x="3838" y="-409.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-394.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;setmetatable(closed,meta)</text>
<text text-anchor="middle" x="3838" y="-379.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return closed</text>
<text text-anchor="middle" x="3838" y="-363.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3838" y="-332.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">function backwalk.walk_ast (ast)</text>
<text text-anchor="middle" x="3838" y="-316.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local index = index_gen()</text>
<text text-anchor="middle" x="3838" y="-301.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local str = ast.str</text>
<text text-anchor="middle" x="3838" y="-286.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function walker (ast, parent, deep)</text>
<text text-anchor="middle" x="3838" y="-270.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;deep = deep + 1</text>
<text text-anchor="middle" x="3838" y="-255.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if ast.isnode then</text>
<text text-anchor="middle" x="3838" y="-239.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.add(ast,deep)</text>
<text text-anchor="middle" x="3838" y="-224.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;for i, v in ipairs(ast) do</text>
<text text-anchor="middle" x="3838" y="-209.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; and v.isnode then</text>
<text text-anchor="middle" x="3838" y="-193.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;walker(v,ast, deep)</text>
<text text-anchor="middle" x="3838" y="-178.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-162.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-147.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;ast.parent = make_backref(parent)</text>
<text text-anchor="middle" x="3838" y="-132.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;index.close(ast)</text>
<text text-anchor="middle" x="3838" y="-116.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-101.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3838" y="-85.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;walker(ast,ast,0)</text>
<text text-anchor="middle" x="3838" y="-70.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;ast.index = index</text>
<text text-anchor="middle" x="3838" y="-55.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return ast </text>
<text text-anchor="middle" x="3838" y="-39.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3838" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">return backwalk</text>
</g>
<!-- codeblock_18&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>codeblock_18&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3838,-956.698C3838,-946.4229 3838,-932.2096 3838,-915.0592"/>
<polygon fill="#000000" stroke="#000000" points="3841.5001,-914.6295 3838,-904.6295 3834.5001,-914.6295 3841.5001,-914.6295"/>
</g>
</g>
</svg>