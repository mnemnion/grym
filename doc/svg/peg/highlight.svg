<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3527pt" height="4229pt"
 viewBox="0.00 0.00 3526.50 4228.56" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 4224.5552)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-4224.5552 3522.5,-4224.5552 3522.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1322.5" cy="-4202.5552" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1322.5" y="-4198.3552" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 196</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1322.5" cy="-4130.5552" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="1322.5" y="-4126.3552" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;196</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1322.5,-4184.3866C1322.5,-4176.6862 1322.5,-4167.5296 1322.5,-4158.9718"/>
<polygon fill="#000000" stroke="#000000" points="1326.0001,-4158.9684 1322.5,-4148.9685 1319.0001,-4158.9685 1326.0001,-4158.9684"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="420.5" cy="-2563.2784" rx="27" ry="18"/>
<text text-anchor="middle" x="420.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1256.9994,-4128.8672C1059.9096,-4123.476 484.1788,-4105.3205 456.5,-4076.5552 34.8466,-3638.3518 346.0651,-2755.8839 409.7571,-2590.364"/>
<polygon fill="#000000" stroke="#000000" points="413.0668,-2591.5098 413.4232,-2580.921 406.5413,-2588.9764 413.0668,-2591.5098"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="511.5" cy="-2563.2784" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="511.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;1</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1257.1822,-4128.2398C1077.9879,-4121.5788 590.3504,-4101.2548 566.5,-4076.5552 459.5238,-3965.7701 502.3021,-2789.9716 510.3149,-2591.6159"/>
<polygon fill="#000000" stroke="#000000" points="513.8199,-2591.5622 510.7308,-2581.4277 506.8257,-2591.2766 513.8199,-2591.5622"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="626.5" cy="-2563.2784" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="626.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 2&#45;14</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1257.234,-4128.0441C1127.5892,-4122.4237 847.3935,-4106.8798 816.5,-4076.5552 596.0265,-3860.1415 619.6209,-2780.9021 625.5213,-2591.6343"/>
<polygon fill="#000000" stroke="#000000" points="629.0272,-2591.5043 625.8508,-2581.3969 622.0308,-2591.2791 629.0272,-2591.5043"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="881.5" cy="-2563.2784" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="881.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 15&#45;63</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1257.4581,-4127.944C1178.1422,-4123.2939 1050.7569,-4110.6031 1019.5,-4076.5552 607.9401,-3628.2458 826.0478,-2759.1025 873.2081,-2591.5933"/>
<polygon fill="#000000" stroke="#000000" points="876.6851,-2592.1626 876.0587,-2581.5863 869.9529,-2590.2448 876.6851,-2592.1626"/>
</g>
<!-- block_6 -->
<g id="node7" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="1084.5" cy="-2563.2784" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1084.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 64&#45;66</text>
</g>
<!-- section_1&#45;&gt;block_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;block_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1292.301,-4114.5233C1278.112,-4105.3567 1262.3949,-4092.4952 1253.5,-4076.5552 957.893,-3546.8176 1056.4519,-2750.8329 1080.0472,-2591.5841"/>
<polygon fill="#000000" stroke="#000000" points="1083.5184,-2592.0366 1081.5492,-2581.6264 1076.5967,-2590.9925 1083.5184,-2592.0366"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="1322.5" cy="-2563.2784" rx="60.1864" ry="18"/>
<text text-anchor="middle" x="1322.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 67&#45;118</text>
</g>
<!-- section_1&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1322.5,-4112.412C1322.5,-3952.7621 1322.5,-2788.7168 1322.5,-2591.5996"/>
<polygon fill="#000000" stroke="#000000" points="1326.0001,-2591.4699 1322.5,-2581.4699 1319.0001,-2591.47 1326.0001,-2591.4699"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="1636.5" cy="-2563.2784" rx="65.0229" ry="18"/>
<text text-anchor="middle" x="1636.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 119&#45;127</text>
</g>
<!-- section_1&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1352.3687,-4114.3336C1366.4735,-4105.1187 1382.215,-4092.2712 1391.5,-4076.5552 1702.1782,-3550.6969 1652.7283,-2751.5401 1639.1566,-2591.679"/>
<polygon fill="#000000" stroke="#000000" points="1642.6056,-2590.943 1638.2469,-2581.2863 1635.6323,-2591.5535 1642.6056,-2590.943"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="2282.5" cy="-2563.2784" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="2282.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 128&#45;177</text>
</g>
<!-- section_1&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1385.6226,-4125.2983C1489.0289,-4116.1689 1685.5882,-4096.4482 1710.5,-4076.5552 2218.1209,-3671.2014 2275.401,-2763.0631 2281.7294,-2591.5242"/>
<polygon fill="#000000" stroke="#000000" points="2285.2277,-2591.6295 2282.0702,-2581.5161 2278.2318,-2591.3912 2285.2277,-2591.6295"/>
</g>
<!-- block_10 -->
<g id="node11" class="node">
<title>block_10</title>
<ellipse fill="none" stroke="#000000" cx="2664.5" cy="-2563.2784" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="2664.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 178&#45;182</text>
</g>
<!-- section_1&#45;&gt;block_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;block_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1388.099,-4129.3275C1609.9927,-4124.8912 2320.7227,-4108.255 2357.5,-4076.5552 2827.1445,-3671.7506 2698.7588,-2763.1691 2669.5983,-2591.5395"/>
<polygon fill="#000000" stroke="#000000" points="2673.0195,-2590.7831 2667.8659,-2581.5261 2666.1219,-2591.9764 2673.0195,-2590.7831"/>
</g>
<!-- block_11 -->
<g id="node12" class="node">
<title>block_11</title>
<ellipse fill="none" stroke="#000000" cx="2956.5" cy="-2563.2784" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="2956.5" y="-2559.0784" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 183&#45;196</text>
</g>
<!-- section_1&#45;&gt;block_11 -->
<g id="edge11" class="edge">
<title>section_1&#45;&gt;block_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1388.1587,-4130.3702C1660.4127,-4129.309 2688.7397,-4122.2776 2739.5,-4076.5552 2969.7031,-3869.1995 2960.5053,-2781.4404 2957.1028,-2591.5653"/>
<polygon fill="#000000" stroke="#000000" points="2960.6016,-2591.4674 2956.913,-2581.5354 2953.6029,-2591.5999 2960.6016,-2591.4674"/>
</g>
<!-- leaf_63 -->
<g id="node64" class="node">
<title>leaf_63</title>
<polygon fill="none" stroke="#c0c0c0" points="3518.5,-4076.3321 3040.5,-4076.3321 3040.5,-1050.2247 3518.5,-1050.2247 3518.5,-4076.3321"/>
<text text-anchor="middle" x="3279.5" y="-4061.3552" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3279.5" y="-4045.9552" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="3279.5" y="-4014.5551" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="3279.5" y="-3999.1551" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="3279.5" y="-3983.7551" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="3279.5" y="-3968.3551" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="3279.5" y="-3952.955" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
<text text-anchor="middle" x="3279.5" y="-3937.555" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="3279.5" y="-3906.155" font-family="Inconsolata" font-size="14.00" fill="#000000"> peg rules. Don&#39;t belong here, but this is the</text>
<text text-anchor="middle" x="3279.5" y="-3890.7549" font-family="Inconsolata" font-size="14.00" fill="#000000"> only parser we have for awhile.</text>
<text text-anchor="middle" x="3279.5" y="-3859.3549" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3279.5" y="-3843.9549" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="3279.5" y="-3812.5548" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3797.1548" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3781.7548" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3766.3547" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3750.9547" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3735.5547" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3720.1547" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3704.7546" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3689.3546" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3673.9546" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3658.5545" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3643.1545" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3627.7545" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3612.3544" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3596.9544" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3581.5544" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3566.1543" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="3279.5" y="-3550.7543" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="3279.5" y="-3503.3543" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="3279.5" y="-3487.9542" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="3279.5" y="-3472.5542" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="3279.5" y="-3457.1542" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="3279.5" y="-3441.7542" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="3279.5" y="-3426.3541" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="3279.5" y="-3410.9541" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="3279.5" y="-3395.5541" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="3279.5" y="-3380.154" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="3279.5" y="-3364.754" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="3279.5" y="-3349.354" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="3279.5" y="-3333.9539" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="3279.5" y="-3318.5539" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="3279.5" y="-3303.1539" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="3279.5" y="-3287.7538" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="3279.5" y="-3272.3538" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-3256.9538" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-3241.5537" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="3279.5" y="-3226.1537" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-3162.7537" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
<text text-anchor="middle" x="3279.5" y="-3147.3537" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="3279.5" y="-3099.9536" font-family="Inconsolata" font-size="14.00" fill="#000000"> wraps a value in a rule, or</text>
<text text-anchor="middle" x="3279.5" y="-3084.5536" font-family="Inconsolata" font-size="14.00" fill="#000000"> returns it if the rule is nil.</text>
<text text-anchor="middle" x="3279.5" y="-3053.1536" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3279.5" y="-3037.7535" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="3279.5" y="-3022.3535" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="3279.5" y="-3006.9535" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="3279.5" y="-2991.5534" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="3279.5" y="-2976.1534" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="3279.5" y="-2960.7534" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="3279.5" y="-2945.3533" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="3279.5" y="-2929.9533" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="3279.5" y="-2914.5533" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2899.1532" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2883.7532" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2868.3532" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="3279.5" y="-2852.9532" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="3279.5" y="-2837.5531" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2822.1531" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-2790.7531" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="3279.5" y="-2775.353" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="3279.5" y="-2759.953" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="3279.5" y="-2744.553" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="3279.5" y="-2729.1529" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="3279.5" y="-2713.7529" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="3279.5" y="-2698.3529" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="3279.5" y="-2682.9528" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="3279.5" y="-2667.5528" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2652.1528" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2636.7527" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2621.3527" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="3279.5" y="-2605.9527" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="3279.5" y="-2590.5527" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2575.1526" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-2543.7526" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="3279.5" y="-2528.3526" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="3279.5" y="-2512.9525" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="3279.5" y="-2497.5525" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="3279.5" y="-2482.1525" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2466.7524" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="3279.5" y="-2451.3524" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="3279.5" y="-2435.9524" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="3279.5" y="-2420.5523" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2405.1523" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2389.7523" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2374.3522" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="3279.5" y="-2358.9522" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-2343.5522" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-2328.1522" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-2296.7521" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
<text text-anchor="middle" x="3279.5" y="-2281.3521" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="3279.5" y="-2249.9521" font-family="Inconsolata" font-size="14.00" fill="#000000"> uses spans and the original string.</text>
<text text-anchor="middle" x="3279.5" y="-2234.552" font-family="Inconsolata" font-size="14.00" fill="#000000"> anything not collected by the grammar is </text>
<text text-anchor="middle" x="3279.5" y="-2219.152" font-family="Inconsolata" font-size="14.00" fill="#000000"> quoted verbatim, so if the context is Red,</text>
<text text-anchor="middle" x="3279.5" y="-2203.752" font-family="Inconsolata" font-size="14.00" fill="#000000"> it will be Red also. </text>
<text text-anchor="middle" x="3279.5" y="-2188.3519" font-family="Inconsolata" font-size="14.00" fill="#000000"> @function light</text>
<text text-anchor="middle" x="3279.5" y="-2172.9519" font-family="Inconsolata" font-size="14.00" fill="#000000"> @param ast the parsed string</text>
<text text-anchor="middle" x="3279.5" y="-2157.5519" font-family="Inconsolata" font-size="14.00" fill="#000000"> @param rules the rule table</text>
<text text-anchor="middle" x="3279.5" y="-2142.1518" font-family="Inconsolata" font-size="14.00" fill="#000000"> @return highlighted string</text>
<text text-anchor="middle" x="3279.5" y="-2110.7518" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3279.5" y="-2095.3518" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="3279.5" y="-2079.9517" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="3279.5" y="-2064.5517" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="3279.5" y="-2049.1517" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="3279.5" y="-2033.7517" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="3279.5" y="-2018.3516" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1986.9516" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="3279.5" y="-1971.5516" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="3279.5" y="-1956.1515" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-1940.7515" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="3279.5" y="-1925.3515" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="3279.5" y="-1909.9514" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="3279.5" y="-1894.5514" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="3279.5" y="-1879.1514" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="3279.5" y="-1863.7513" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="3279.5" y="-1848.3513" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="3279.5" y="-1832.9513" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="3279.5" y="-1817.5512" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="3279.5" y="-1802.1512" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="3279.5" y="-1786.7512" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="3279.5" y="-1771.3512" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="3279.5" y="-1755.9511" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="3279.5" y="-1740.5511" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="3279.5" y="-1725.1511" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="3279.5" y="-1709.751" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="3279.5" y="-1694.351" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1678.951" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="3279.5" y="-1663.5509" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="3279.5" y="-1648.1509" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1632.7509" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="3279.5" y="-1617.3508" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="3279.5" y="-1601.9508" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1586.5508" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="3279.5" y="-1571.1507" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="3279.5" y="-1555.7507" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="3279.5" y="-1540.3507" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="3279.5" y="-1524.9507" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="3279.5" y="-1509.5506" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="3279.5" y="-1494.1506" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="3279.5" y="-1478.7506" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1463.3505" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1447.9505" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="3279.5" y="-1432.5505" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="3279.5" y="-1417.1504" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-1385.7504" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
<text text-anchor="middle" x="3279.5" y="-1370.3504" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="3279.5" y="-1338.9503" font-family="Inconsolata" font-size="14.00" fill="#000000"> @function Highlighter</text>
<text text-anchor="middle" x="3279.5" y="-1323.5503" font-family="Inconsolata" font-size="14.00" fill="#000000"> @param parser a parser</text>
<text text-anchor="middle" x="3279.5" y="-1308.1503" font-family="Inconsolata" font-size="14.00" fill="#000000"> @param rules a palette</text>
<text text-anchor="middle" x="3279.5" y="-1292.7502" font-family="Inconsolata" font-size="14.00" fill="#000000"> @return a function: λ (string|Node) &#45;&gt; string </text>
<text text-anchor="middle" x="3279.5" y="-1259.002" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="3279.5" y="-1243.6019" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="3279.5" y="-1228.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="3279.5" y="-1212.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="3279.5" y="-1197.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="3279.5" y="-1182.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1166.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="3279.5" y="-1151.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3279.5" y="-1135.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="3279.5" y="-1120.4017" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3279.5" y="-1089.0017" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="3279.5" y="-1073.6016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
<text text-anchor="middle" x="3279.5" y="-1058.2016" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
</g>
<!-- section_1&#45;&gt;leaf_63 -->
<g id="edge63" class="edge">
<title>section_1&#45;&gt;leaf_63</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1388.1554,-4129.6131C1697.9693,-4125.0277 3000.0458,-4104.1412 3031.5,-4076.5552 3031.9691,-4076.1438 3032.4376,-4075.7319 3032.9054,-4075.3194"/>
<polygon fill="#000000" stroke="#000000" points="3035.3061,-4077.8679 3040.4272,-4068.593 3030.6399,-4072.65 3035.3061,-4077.8679"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="144.5,-997.2015 90.5,-997.2015 90.5,-961.2015 144.5,-961.2015 144.5,-997.2015"/>
</g>
<!-- block_3&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>block_3&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M512.2327,-2545.1635C518.6658,-2381.7645 562.819,-1165.4085 456.5,-1050.0016 410.557,-1000.1315 214.7512,-1043.0888 153.5,-1014.0016 148.396,-1011.5777 143.563,-1008.1413 139.1924,-1004.3626"/>
<polygon fill="#000000" stroke="#000000" points="141.5061,-1001.7321 131.8662,-997.3364 136.6609,-1006.7842 141.5061,-1001.7321"/>
</g>
<!-- codeblock_13 -->
<g id="node14" class="node">
<title>codeblock_13</title>
<ellipse fill="none" stroke="#000000" cx="235.5" cy="-979.2015" rx="72.5844" ry="18"/>
<text text-anchor="middle" x="235.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 2&#45;10</text>
</g>
<!-- block_4&#45;&gt;codeblock_13 -->
<g id="edge13" class="edge">
<title>block_4&#45;&gt;codeblock_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M633.222,-2545.0142C683.0278,-2406.1916 981.4387,-1510.4835 566.5,-1050.0016 529.0739,-1008.4676 371.3462,-1029.0472 317.5,-1014.0016 304.2066,-1010.2871 290.2156,-1004.9329 277.6291,-999.5337"/>
<polygon fill="#000000" stroke="#000000" points="278.8745,-996.2577 268.3127,-995.4225 276.0485,-1002.6619 278.8745,-996.2577"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="664.5,-1006.5019 326.5,-1006.5019 326.5,-951.9011 664.5,-951.9011 664.5,-1006.5019"/>
<text text-anchor="middle" x="495.5" y="-975.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> peg rules. Don&#39;t belong here, but this is the</text>
<text text-anchor="middle" x="495.5" y="-960.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> only parser we have for awhile.</text>
</g>
<!-- block_4&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>block_4&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M630.5405,-2544.9986C658.4321,-2414.6161 814.0876,-1614.6736 566.5,-1050.0016 560.5365,-1036.4006 550.6627,-1024.0019 540.147,-1013.5147"/>
<polygon fill="#000000" stroke="#000000" points="542.4743,-1010.8983 532.8046,-1006.5683 537.6636,-1015.9833 542.4743,-1010.8983"/>
</g>
<!-- codeblock_16 -->
<g id="node17" class="node">
<title>codeblock_16</title>
<ellipse fill="none" stroke="#000000" cx="759.5" cy="-979.2015" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="759.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 15&#45;61</text>
</g>
<!-- block_5&#45;&gt;codeblock_16 -->
<g id="edge16" class="edge">
<title>block_5&#45;&gt;codeblock_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M880.1089,-2545.2155C867.7577,-2384.8446 776.9711,-1206.0502 761.6827,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="765.1553,-1007.0504 760.8976,-997.3487 758.1759,-1007.588 765.1553,-1007.0504"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="908.5,-997.2015 854.5,-997.2015 854.5,-961.2015 908.5,-961.2015 908.5,-997.2015"/>
</g>
<!-- block_5&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>block_5&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M881.5,-2545.2155C881.5,-2384.8446 881.5,-1206.0502 881.5,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="885.0001,-1007.3487 881.5,-997.3487 878.0001,-1007.3487 885.0001,-1007.3487"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1160,-998.5021 927,-998.5021 927,-959.9009 1160,-959.9009 1160,-998.5021"/>
<text text-anchor="middle" x="1043.5" y="-983.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> wraps a value in a rule, or</text>
<text text-anchor="middle" x="1043.5" y="-968.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> returns it if the rule is nil.</text>
</g>
<!-- block_6&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>block_6&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1084.0325,-2545.2155C1079.8905,-2385.1849 1049.5008,-1211.0475 1044.2666,-1008.8194"/>
<polygon fill="#000000" stroke="#000000" points="1047.7612,-1008.5626 1044.0035,-998.6565 1040.7636,-1008.7437 1047.7612,-1008.5626"/>
</g>
<!-- codeblock_20 -->
<g id="node21" class="node">
<title>codeblock_20</title>
<ellipse fill="none" stroke="#000000" cx="1259.5" cy="-979.2015" rx="81.9542" ry="18"/>
<text text-anchor="middle" x="1259.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 67&#45;117</text>
</g>
<!-- block_7&#45;&gt;codeblock_20 -->
<g id="edge20" class="edge">
<title>block_7&#45;&gt;codeblock_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1321.7816,-2545.2155C1315.4035,-2384.8446 1268.522,-1206.0502 1260.6272,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1264.1165,-1007.2017 1260.2217,-997.3487 1257.122,-1007.4799 1264.1165,-1007.2017"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1413.5,-997.2015 1359.5,-997.2015 1359.5,-961.2015 1413.5,-961.2015 1413.5,-997.2015"/>
</g>
<!-- block_7&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>block_7&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1323.2298,-2545.2155C1329.7091,-2384.8446 1377.3348,-1206.0502 1385.355,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1388.8602,-1007.4819 1385.7668,-997.3487 1381.8659,-1007.1992 1388.8602,-1007.4819"/>
</g>
<!-- structure_23 -->
<g id="node24" class="node">
<title>structure_23</title>
<ellipse fill="none" stroke="#000000" cx="1476.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1476.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_23 -->
<g id="edge23" class="edge">
<title>block_8&#45;&gt;structure_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1634.6756,-2545.2155C1618.4773,-2384.8446 1499.4129,-1206.0502 1479.3626,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1482.8203,-1006.9463 1478.333,-997.3487 1475.8557,-1007.6498 1482.8203,-1006.9463"/>
</g>
<!-- structure_24 -->
<g id="node25" class="node">
<title>structure_24</title>
<ellipse fill="none" stroke="#000000" cx="1583.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1583.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_24 -->
<g id="edge24" class="edge">
<title>block_8&#45;&gt;structure_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1635.8957,-2545.2155C1630.53,-2384.8446 1591.0899,-1206.0502 1584.4482,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1587.9397,-1007.226 1584.1072,-997.3487 1580.9436,-1007.4602 1587.9397,-1007.226"/>
</g>
<!-- structure_25 -->
<g id="node26" class="node">
<title>structure_25</title>
<ellipse fill="none" stroke="#000000" cx="1690.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1690.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_25 -->
<g id="edge25" class="edge">
<title>block_8&#45;&gt;structure_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1637.1157,-2545.2155C1642.5827,-2384.8446 1682.7669,-1206.0502 1689.5339,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1693.0386,-1007.4622 1689.8814,-997.3487 1686.0426,-1007.2236 1693.0386,-1007.4622"/>
</g>
<!-- structure_26 -->
<g id="node27" class="node">
<title>structure_26</title>
<ellipse fill="none" stroke="#000000" cx="1797.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1797.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_26 -->
<g id="edge26" class="edge">
<title>block_8&#45;&gt;structure_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1638.3358,-2545.2155C1654.6354,-2384.8446 1774.4439,-1206.0502 1794.6195,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="1798.1264,-1007.6514 1795.6556,-997.3487 1791.1623,-1006.9435 1798.1264,-1007.6514"/>
</g>
<!-- leaf_39 -->
<g id="node40" class="node">
<title>leaf_39</title>
<polygon fill="none" stroke="#c0c0c0" points="2177,-1013.8028 1860,-1013.8028 1860,-944.6002 2177,-944.6002 2177,-1013.8028"/>
<text text-anchor="middle" x="2018.5" y="-998.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> uses spans and the original string.</text>
<text text-anchor="middle" x="2018.5" y="-983.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> anything not collected by the grammar is </text>
<text text-anchor="middle" x="2018.5" y="-968.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> quoted verbatim, so if the context is Red,</text>
<text text-anchor="middle" x="2018.5" y="-952.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> it will be Red also. </text>
</g>
<!-- block_8&#45;&gt;leaf_39 -->
<g id="edge39" class="edge">
<title>block_8&#45;&gt;leaf_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1640.8559,-2545.2155C1678.5838,-2388.7653 1950.0432,-1263.0778 2007.7378,-1023.83"/>
<polygon fill="#000000" stroke="#000000" points="2011.1484,-1024.6166 2010.0903,-1014.0748 2004.3435,-1022.9756 2011.1484,-1024.6166"/>
</g>
<!-- codeblock_40 -->
<g id="node41" class="node">
<title>codeblock_40</title>
<ellipse fill="none" stroke="#000000" cx="2282.5" cy="-979.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="2282.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 128&#45;176</text>
</g>
<!-- block_9&#45;&gt;codeblock_40 -->
<g id="edge40" class="edge">
<title>block_9&#45;&gt;codeblock_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2282.5,-2545.2155C2282.5,-2384.8446 2282.5,-1206.0502 2282.5,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2286.0001,-1007.3487 2282.5,-997.3487 2279.0001,-1007.3487 2286.0001,-1007.3487"/>
</g>
<!-- leaf_42 -->
<g id="node43" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="2441.5,-997.2015 2387.5,-997.2015 2387.5,-961.2015 2441.5,-961.2015 2441.5,-997.2015"/>
</g>
<!-- block_9&#45;&gt;leaf_42 -->
<g id="edge42" class="edge">
<title>block_9&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2284.0052,-2545.2155C2297.3688,-2384.8446 2395.5969,-1206.0502 2412.1383,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2415.6452,-1007.6048 2412.9878,-997.3487 2408.6694,-1007.0235 2415.6452,-1007.6048"/>
</g>
<!-- structure_43 -->
<g id="node44" class="node">
<title>structure_43</title>
<ellipse fill="none" stroke="#000000" cx="2504.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2504.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_43 -->
<g id="edge43" class="edge">
<title>block_10&#45;&gt;structure_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2662.6756,-2545.2155C2646.4773,-2384.8446 2527.4129,-1206.0502 2507.3626,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2510.8203,-1006.9463 2506.333,-997.3487 2503.8557,-1007.6498 2510.8203,-1006.9463"/>
</g>
<!-- structure_44 -->
<g id="node45" class="node">
<title>structure_44</title>
<ellipse fill="none" stroke="#000000" cx="2611.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2611.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_44 -->
<g id="edge44" class="edge">
<title>block_10&#45;&gt;structure_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2663.8957,-2545.2155C2658.53,-2384.8446 2619.0899,-1206.0502 2612.4482,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2615.9397,-1007.226 2612.1072,-997.3487 2608.9436,-1007.4602 2615.9397,-1007.226"/>
</g>
<!-- structure_45 -->
<g id="node46" class="node">
<title>structure_45</title>
<ellipse fill="none" stroke="#000000" cx="2718.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2718.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_45 -->
<g id="edge45" class="edge">
<title>block_10&#45;&gt;structure_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2665.1157,-2545.2155C2670.5827,-2384.8446 2710.7669,-1206.0502 2717.5339,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2721.0386,-1007.4622 2717.8814,-997.3487 2714.0426,-1007.2236 2721.0386,-1007.4622"/>
</g>
<!-- structure_46 -->
<g id="node47" class="node">
<title>structure_46</title>
<ellipse fill="none" stroke="#000000" cx="2825.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2825.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_46 -->
<g id="edge46" class="edge">
<title>block_10&#45;&gt;structure_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2666.3358,-2545.2155C2682.6354,-2384.8446 2802.4439,-1206.0502 2822.6195,-1007.5427"/>
<polygon fill="#000000" stroke="#000000" points="2826.1264,-1007.6514 2823.6556,-997.3487 2819.1623,-1006.9435 2826.1264,-1007.6514"/>
</g>
<!-- leaf_59 -->
<g id="node60" class="node">
<title>leaf_59</title>
<polygon fill="none" stroke="#c0c0c0" points="2942.5,-997.2015 2888.5,-997.2015 2888.5,-961.2015 2942.5,-961.2015 2942.5,-997.2015"/>
</g>
<!-- block_10&#45;&gt;leaf_59 -->
<g id="edge59" class="edge">
<title>block_10&#45;&gt;leaf_59</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2665.0178,-2545.2459C2669.0852,-2418.1413 2700.7024,-1644.8536 2881.5,-1050.0016 2886.0947,-1034.8842 2893.4959,-1018.9467 2900.2215,-1006.0287"/>
<polygon fill="#000000" stroke="#000000" points="2903.3086,-1007.6779 2904.9497,-997.211 2897.1395,-1004.37 2903.3086,-1007.6779"/>
</g>
<!-- codeblock_60 -->
<g id="node61" class="node">
<title>codeblock_60</title>
<ellipse fill="none" stroke="#000000" cx="3047.5" cy="-979.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="3047.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 183&#45;196</text>
</g>
<!-- block_11&#45;&gt;codeblock_60 -->
<g id="edge60" class="edge">
<title>block_11&#45;&gt;codeblock_60</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2956.219,-2545.1831C2954.5049,-2419.1777 2948.115,-1659.8506 3031.5,-1050.0016 3033.4532,-1035.7164 3036.8565,-1020.0581 3040.0235,-1007.1075"/>
<polygon fill="#000000" stroke="#000000" points="3043.425,-1007.9325 3042.4805,-997.3798 3036.6381,-1006.2182 3043.425,-1007.9325"/>
</g>
<!-- leaf_62 -->
<g id="node63" class="node">
<title>leaf_62</title>
<polygon fill="none" stroke="#c0c0c0" points="3206.5,-997.2015 3152.5,-997.2015 3152.5,-961.2015 3206.5,-961.2015 3206.5,-997.2015"/>
</g>
<!-- block_11&#45;&gt;leaf_62 -->
<g id="edge62" class="edge">
<title>block_11&#45;&gt;leaf_62</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2950.6096,-2545.1741C2907.6218,-2409.3219 2654.3121,-1541.3986 3031.5,-1050.0016 3063.3364,-1008.5254 3098.6464,-1040.8713 3143.5,-1014.0016 3148.0442,-1011.2793 3152.4648,-1007.8813 3156.5632,-1004.2834"/>
<polygon fill="#000000" stroke="#000000" points="3159.1423,-1006.6613 3163.9953,-997.2433 3154.3283,-1001.5794 3159.1423,-1006.6613"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="471,-584.6016 0,-584.6016 0,-467.7998 471,-467.7998 471,-584.6016"/>
<text text-anchor="middle" x="235.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="235.5" y="-537.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="235.5" y="-522.4007" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="235.5" y="-507.0007" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="235.5" y="-491.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="235.5" y="-476.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
</g>
<!-- codeblock_13&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>codeblock_13&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M235.5,-961.1638C235.5,-900.4272 235.5,-701.2187 235.5,-594.7466"/>
<polygon fill="#000000" stroke="#000000" points="239.0001,-594.7401 235.5,-584.7401 232.0001,-594.7402 239.0001,-594.7401"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="908,-878.302 493,-878.302 493,-174.0994 908,-174.0994 908,-878.302"/>
<text text-anchor="middle" x="700.5" y="-863.3013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="700.5" y="-831.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-816.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-801.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-785.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-770.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-754.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-739.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-724.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-708.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-693.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-677.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-662.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-647.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-631.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-616.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-600.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-585.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-570.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="700.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="700.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="700.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="700.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="700.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="700.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="700.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="700.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="700.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="700.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="700.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="700.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="700.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="700.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="700.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="700.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="700.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="700.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="700.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="700.5" y="-182.1001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
</g>
<!-- codeblock_16&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>codeblock_16&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M757.1507,-961.1638C755.0718,-945.2015 751.7471,-919.6751 747.7234,-888.7813"/>
<polygon fill="#000000" stroke="#000000" points="751.1555,-888.0318 746.3932,-878.5676 744.2141,-888.9359 751.1555,-888.0318"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="1404.5,-908.6023 926.5,-908.6023 926.5,-143.7992 1404.5,-143.7992 1404.5,-908.6023"/>
<text text-anchor="middle" x="1165.5" y="-893.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-877.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-862.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-847.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1165.5" y="-831.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="1165.5" y="-816.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="1165.5" y="-800.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="1165.5" y="-785.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="1165.5" y="-770.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="1165.5" y="-754.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-739.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-723.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1165.5" y="-708.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="1165.5" y="-693.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-677.601" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-646.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-630.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-615.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-600.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1165.5" y="-584.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="1165.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="1165.5" y="-553.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="1165.5" y="-538.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="1165.5" y="-523.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="1165.5" y="-507.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-492.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-476.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1165.5" y="-461.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="1165.5" y="-446.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-430.6005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-399.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-383.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-368.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-353.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="1165.5" y="-337.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-322.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="1165.5" y="-306.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="1165.5" y="-291.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="1165.5" y="-276.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="1165.5" y="-260.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-245.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-229.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="1165.5" y="-214.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-199.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-183.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-152.2" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
</g>
<!-- codeblock_20&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>codeblock_20&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1255.7571,-961.1638C1253.5819,-950.6811 1250.5507,-936.0735 1246.9103,-918.5297"/>
<polygon fill="#000000" stroke="#000000" points="1250.2856,-917.5689 1244.8267,-908.4886 1243.4316,-918.9912 1250.2856,-917.5689"/>
</g>
<!-- handleline_27 -->
<g id="node28" class="node">
<title>handleline_27</title>
<ellipse fill="none" stroke="#000000" cx="1472.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1472.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_23&#45;&gt;handleline_27 -->
<g id="edge27" class="edge">
<title>structure_23&#45;&gt;handleline_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1476.3407,-961.1638C1475.7255,-891.4843 1473.5009,-639.5533 1472.7498,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1476.248,-554.2586 1472.6597,-544.29 1469.2483,-554.3205 1476.248,-554.2586"/>
</g>
<!-- handleline_30 -->
<g id="node31" class="node">
<title>handleline_30</title>
<ellipse fill="none" stroke="#000000" cx="1591.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1591.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_24&#45;&gt;handleline_30 -->
<g id="edge30" class="edge">
<title>structure_24&#45;&gt;handleline_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1583.8185,-961.1638C1585.0491,-891.4843 1589.4982,-639.5533 1591.0005,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1594.5033,-554.3502 1591.1805,-544.29 1587.5044,-554.2266 1594.5033,-554.3502"/>
</g>
<!-- handleline_33 -->
<g id="node34" class="node">
<title>handleline_33</title>
<ellipse fill="none" stroke="#000000" cx="1710.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1710.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_25&#45;&gt;handleline_33 -->
<g id="edge33" class="edge">
<title>structure_25&#45;&gt;handleline_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1691.2964,-961.1638C1694.3727,-891.4843 1705.4955,-639.5533 1709.2512,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1712.7568,-554.4346 1709.7014,-544.29 1705.7636,-554.1258 1712.7568,-554.4346"/>
</g>
<!-- handleline_36 -->
<g id="node37" class="node">
<title>handleline_36</title>
<ellipse fill="none" stroke="#000000" cx="1829.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1829.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_26&#45;&gt;handleline_36 -->
<g id="edge36" class="edge">
<title>structure_26&#45;&gt;handleline_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1798.7742,-961.1638C1803.6963,-891.4843 1821.4928,-639.5533 1827.502,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1831.0087,-554.5118 1828.2222,-544.29 1824.0261,-554.0185 1831.0087,-554.5118"/>
</g>
<!-- handle_28 -->
<g id="node29" class="node">
<title>handle_28</title>
<ellipse fill="none" stroke="#000000" cx="1472.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1472.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_27&#45;&gt;handle_28 -->
<g id="edge28" class="edge">
<title>handleline_27&#45;&gt;handle_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1472.5,-508.0131C1472.5,-440.1164 1472.5,-201.1496 1472.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1476.0001,-118.2653 1472.5,-108.2653 1469.0001,-118.2653 1476.0001,-118.2653"/>
</g>
<!-- leaf_29 -->
<g id="node30" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="1499.5,-36 1445.5,-36 1445.5,0 1499.5,0 1499.5,-36"/>
</g>
<!-- handle_28&#45;&gt;leaf_29 -->
<g id="edge29" class="edge">
<title>handle_28&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1472.5,-71.8314C1472.5,-64.131 1472.5,-54.9743 1472.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1476.0001,-46.4132 1472.5,-36.4133 1469.0001,-46.4133 1476.0001,-46.4132"/>
</g>
<!-- handle_31 -->
<g id="node32" class="node">
<title>handle_31</title>
<ellipse fill="none" stroke="#000000" cx="1591.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1591.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_30&#45;&gt;handle_31 -->
<g id="edge31" class="edge">
<title>handleline_30&#45;&gt;handle_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1591.5,-508.0131C1591.5,-440.1164 1591.5,-201.1496 1591.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1595.0001,-118.2653 1591.5,-108.2653 1588.0001,-118.2653 1595.0001,-118.2653"/>
</g>
<!-- leaf_32 -->
<g id="node33" class="node">
<title>leaf_32</title>
<polygon fill="none" stroke="#c0c0c0" points="1618.5,-36 1564.5,-36 1564.5,0 1618.5,0 1618.5,-36"/>
</g>
<!-- handle_31&#45;&gt;leaf_32 -->
<g id="edge32" class="edge">
<title>handle_31&#45;&gt;leaf_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1591.5,-71.8314C1591.5,-64.131 1591.5,-54.9743 1591.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1595.0001,-46.4132 1591.5,-36.4133 1588.0001,-46.4133 1595.0001,-46.4132"/>
</g>
<!-- handle_34 -->
<g id="node35" class="node">
<title>handle_34</title>
<ellipse fill="none" stroke="#000000" cx="1710.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1710.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_33&#45;&gt;handle_34 -->
<g id="edge34" class="edge">
<title>handleline_33&#45;&gt;handle_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1710.5,-508.0131C1710.5,-440.1164 1710.5,-201.1496 1710.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1714.0001,-118.2653 1710.5,-108.2653 1707.0001,-118.2653 1714.0001,-118.2653"/>
</g>
<!-- leaf_35 -->
<g id="node36" class="node">
<title>leaf_35</title>
<polygon fill="none" stroke="#c0c0c0" points="1737.5,-36 1683.5,-36 1683.5,0 1737.5,0 1737.5,-36"/>
</g>
<!-- handle_34&#45;&gt;leaf_35 -->
<g id="edge35" class="edge">
<title>handle_34&#45;&gt;leaf_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1710.5,-71.8314C1710.5,-64.131 1710.5,-54.9743 1710.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1714.0001,-46.4132 1710.5,-36.4133 1707.0001,-46.4133 1714.0001,-46.4132"/>
</g>
<!-- handle_37 -->
<g id="node38" class="node">
<title>handle_37</title>
<ellipse fill="none" stroke="#000000" cx="1829.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1829.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_36&#45;&gt;handle_37 -->
<g id="edge37" class="edge">
<title>handleline_36&#45;&gt;handle_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1829.5,-508.0131C1829.5,-440.1164 1829.5,-201.1496 1829.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1833.0001,-118.2653 1829.5,-108.2653 1826.0001,-118.2653 1833.0001,-118.2653"/>
</g>
<!-- leaf_38 -->
<g id="node39" class="node">
<title>leaf_38</title>
<polygon fill="none" stroke="#c0c0c0" points="1856.5,-36 1802.5,-36 1802.5,0 1856.5,0 1856.5,-36"/>
</g>
<!-- handle_37&#45;&gt;leaf_38 -->
<g id="edge38" class="edge">
<title>handle_37&#45;&gt;leaf_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1829.5,-71.8314C1829.5,-64.131 1829.5,-54.9743 1829.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1833.0001,-46.4132 1829.5,-36.4133 1826.0001,-46.4133 1833.0001,-46.4132"/>
</g>
<!-- leaf_41 -->
<g id="node42" class="node">
<title>leaf_41</title>
<polygon fill="none" stroke="#c0c0c0" points="2418,-892.7021 1975,-892.7021 1975,-159.6993 2418,-159.6993 2418,-892.7021"/>
<text text-anchor="middle" x="2196.5" y="-877.5014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="2196.5" y="-862.1014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="2196.5" y="-846.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="2196.5" y="-831.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="2196.5" y="-815.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="2196.5" y="-800.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-769.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="2196.5" y="-753.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="2196.5" y="-738.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="2196.5" y="-722.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="2196.5" y="-707.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="2196.5" y="-692.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="2196.5" y="-676.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="2196.5" y="-661.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="2196.5" y="-645.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="2196.5" y="-630.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="2196.5" y="-615.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="2196.5" y="-599.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-584.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="2196.5" y="-568.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="2196.5" y="-553.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="2196.5" y="-538.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="2196.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="2196.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="2196.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="2196.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="2196.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="2196.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="2196.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="2196.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="2196.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="2196.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="2196.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="2196.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-230.1001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-214.7001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="2196.5" y="-199.3001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2196.5" y="-167.9" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
</g>
<!-- codeblock_40&#45;&gt;leaf_41 -->
<g id="edge41" class="edge">
<title>codeblock_40&#45;&gt;leaf_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2279.0756,-961.1638C2276.5246,-947.7261 2272.6867,-927.5103 2268.0374,-903.0204"/>
<polygon fill="#000000" stroke="#000000" points="2271.4479,-902.2194 2266.1441,-893.0477 2264.5707,-903.525 2271.4479,-902.2194"/>
</g>
<!-- handleline_47 -->
<g id="node48" class="node">
<title>handleline_47</title>
<ellipse fill="none" stroke="#000000" cx="2486.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2486.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_43&#45;&gt;handleline_47 -->
<g id="edge47" class="edge">
<title>structure_43&#45;&gt;handleline_47</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2503.7833,-961.1638C2501.0146,-891.4843 2491.0041,-639.5533 2487.6239,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2491.1131,-554.1431 2487.2188,-544.29 2484.1187,-554.4211 2491.1131,-554.1431"/>
</g>
<!-- handleline_50 -->
<g id="node51" class="node">
<title>handleline_50</title>
<ellipse fill="none" stroke="#000000" cx="2605.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2605.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_44&#45;&gt;handleline_50 -->
<g id="edge50" class="edge">
<title>structure_44&#45;&gt;handleline_50</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2611.2611,-961.1638C2610.3382,-891.4843 2607.0014,-639.5533 2605.8746,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2609.3718,-554.2427 2605.7396,-544.29 2602.3724,-554.3355 2609.3718,-554.2427"/>
</g>
<!-- handleline_53 -->
<g id="node54" class="node">
<title>handleline_53</title>
<ellipse fill="none" stroke="#000000" cx="2724.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2724.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_45&#45;&gt;handleline_53 -->
<g id="edge53" class="edge">
<title>structure_45&#45;&gt;handleline_53</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2718.7389,-961.1638C2719.6618,-891.4843 2722.9986,-639.5533 2724.1254,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2727.6276,-554.3355 2724.2604,-544.29 2720.6282,-554.2427 2727.6276,-554.3355"/>
</g>
<!-- handleline_56 -->
<g id="node57" class="node">
<title>handleline_56</title>
<ellipse fill="none" stroke="#000000" cx="2843.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2843.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_46&#45;&gt;handleline_56 -->
<g id="edge56" class="edge">
<title>structure_46&#45;&gt;handleline_56</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2826.2167,-961.1638C2828.9854,-891.4843 2838.9959,-639.5533 2842.3761,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2845.8813,-554.4211 2842.7812,-544.29 2838.8869,-554.1431 2845.8813,-554.4211"/>
</g>
<!-- handle_48 -->
<g id="node49" class="node">
<title>handle_48</title>
<ellipse fill="none" stroke="#000000" cx="2486.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2486.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_47&#45;&gt;handle_48 -->
<g id="edge48" class="edge">
<title>handleline_47&#45;&gt;handle_48</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2486.5,-508.0131C2486.5,-440.1164 2486.5,-201.1496 2486.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2490.0001,-118.2653 2486.5,-108.2653 2483.0001,-118.2653 2490.0001,-118.2653"/>
</g>
<!-- leaf_49 -->
<g id="node50" class="node">
<title>leaf_49</title>
<polygon fill="none" stroke="#c0c0c0" points="2513.5,-36 2459.5,-36 2459.5,0 2513.5,0 2513.5,-36"/>
</g>
<!-- handle_48&#45;&gt;leaf_49 -->
<g id="edge49" class="edge">
<title>handle_48&#45;&gt;leaf_49</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2486.5,-71.8314C2486.5,-64.131 2486.5,-54.9743 2486.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2490.0001,-46.4132 2486.5,-36.4133 2483.0001,-46.4133 2490.0001,-46.4132"/>
</g>
<!-- handle_51 -->
<g id="node52" class="node">
<title>handle_51</title>
<ellipse fill="none" stroke="#000000" cx="2605.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2605.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_50&#45;&gt;handle_51 -->
<g id="edge51" class="edge">
<title>handleline_50&#45;&gt;handle_51</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2605.5,-508.0131C2605.5,-440.1164 2605.5,-201.1496 2605.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2609.0001,-118.2653 2605.5,-108.2653 2602.0001,-118.2653 2609.0001,-118.2653"/>
</g>
<!-- leaf_52 -->
<g id="node53" class="node">
<title>leaf_52</title>
<polygon fill="none" stroke="#c0c0c0" points="2632.5,-36 2578.5,-36 2578.5,0 2632.5,0 2632.5,-36"/>
</g>
<!-- handle_51&#45;&gt;leaf_52 -->
<g id="edge52" class="edge">
<title>handle_51&#45;&gt;leaf_52</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2605.5,-71.8314C2605.5,-64.131 2605.5,-54.9743 2605.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2609.0001,-46.4132 2605.5,-36.4133 2602.0001,-46.4133 2609.0001,-46.4132"/>
</g>
<!-- handle_54 -->
<g id="node55" class="node">
<title>handle_54</title>
<ellipse fill="none" stroke="#000000" cx="2724.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2724.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_53&#45;&gt;handle_54 -->
<g id="edge54" class="edge">
<title>handleline_53&#45;&gt;handle_54</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2724.5,-508.0131C2724.5,-440.1164 2724.5,-201.1496 2724.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2728.0001,-118.2653 2724.5,-108.2653 2721.0001,-118.2653 2728.0001,-118.2653"/>
</g>
<!-- leaf_55 -->
<g id="node56" class="node">
<title>leaf_55</title>
<polygon fill="none" stroke="#c0c0c0" points="2751.5,-36 2697.5,-36 2697.5,0 2751.5,0 2751.5,-36"/>
</g>
<!-- handle_54&#45;&gt;leaf_55 -->
<g id="edge55" class="edge">
<title>handle_54&#45;&gt;leaf_55</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2724.5,-71.8314C2724.5,-64.131 2724.5,-54.9743 2724.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2728.0001,-46.4132 2724.5,-36.4133 2721.0001,-46.4133 2728.0001,-46.4132"/>
</g>
<!-- handle_57 -->
<g id="node58" class="node">
<title>handle_57</title>
<ellipse fill="none" stroke="#000000" cx="2843.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2843.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_56&#45;&gt;handle_57 -->
<g id="edge57" class="edge">
<title>handleline_56&#45;&gt;handle_57</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2843.5,-508.0131C2843.5,-440.1164 2843.5,-201.1496 2843.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2847.0001,-118.2653 2843.5,-108.2653 2840.0001,-118.2653 2847.0001,-118.2653"/>
</g>
<!-- leaf_58 -->
<g id="node59" class="node">
<title>leaf_58</title>
<polygon fill="none" stroke="#c0c0c0" points="2870.5,-36 2816.5,-36 2816.5,0 2870.5,0 2870.5,-36"/>
</g>
<!-- handle_57&#45;&gt;leaf_58 -->
<g id="edge58" class="edge">
<title>handle_57&#45;&gt;leaf_58</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2843.5,-71.8314C2843.5,-64.131 2843.5,-54.9743 2843.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2847.0001,-46.4132 2843.5,-36.4133 2840.0001,-46.4133 2847.0001,-46.4132"/>
</g>
<!-- leaf_61 -->
<g id="node62" class="node">
<title>leaf_61</title>
<polygon fill="none" stroke="#c0c0c0" points="3221.5,-623.1015 2911.5,-623.1015 2911.5,-429.3 3221.5,-429.3 3221.5,-623.1015"/>
<text text-anchor="middle" x="3066.5" y="-607.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="3066.5" y="-592.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="3066.5" y="-576.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="3066.5" y="-561.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="3066.5" y="-546.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3066.5" y="-530.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="3066.5" y="-515.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3066.5" y="-499.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="3066.5" y="-484.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3066.5" y="-453.1006" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="3066.5" y="-437.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
</g>
<!-- codeblock_60&#45;&gt;leaf_61 -->
<g id="edge61" class="edge">
<title>codeblock_60&#45;&gt;leaf_61</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3048.2565,-961.1638C3050.5221,-907.1479 3057.3813,-743.6092 3062.0128,-633.1841"/>
<polygon fill="#000000" stroke="#000000" points="3065.5177,-633.1404 3062.4399,-623.0024 3058.5238,-632.847 3065.5177,-633.1404"/>
</g>
</g>
</svg>