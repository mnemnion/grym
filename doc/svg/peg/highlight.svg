<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3254pt" height="1060pt"
 viewBox="0.00 0.00 3253.66 1060.40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1056.4014)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1056.4014 3249.6592,-1056.4014 3249.6592,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="65.6592" cy="-1034.4014" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="65.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 196</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="65.6592" cy="-598.2007" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="65.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;196</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M65.6592,-1016.2138C65.6592,-948.3171 65.6592,-709.3503 65.6592,-626.633"/>
<polygon fill="#000000" stroke="#000000" points="69.1593,-626.466 65.6592,-616.466 62.1593,-626.466 69.1593,-626.466"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="65.6592" cy="-162" rx="27" ry="18"/>
<text text-anchor="middle" x="65.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M65.6592,-580.0131C65.6592,-512.1164 65.6592,-273.1496 65.6592,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="69.1593,-190.2653 65.6592,-180.2653 62.1593,-190.2653 69.1593,-190.2653"/>
</g>
<!-- codeblock_3 -->
<g id="node4" class="node">
<title>codeblock_3</title>
<ellipse fill="none" stroke="#000000" cx="384.6592" cy="-1034.4014" rx="59.5308" ry="18"/>
<text text-anchor="middle" x="384.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">codeblock_3</text>
</g>
<!-- leaf_10 -->
<g id="node5" class="node">
<title>leaf_10</title>
<polygon fill="none" stroke="#c0c0c0" points="620.1592,-656.6016 149.1592,-656.6016 149.1592,-539.7998 620.1592,-539.7998 620.1592,-656.6016"/>
<text text-anchor="middle" x="384.6592" y="-641.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="384.6592" y="-609.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="384.6592" y="-594.4007" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="384.6592" y="-579.0007" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="384.6592" y="-563.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="384.6592" y="-548.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
</g>
<!-- codeblock_3&#45;&gt;leaf_10 -->
<g id="edge3" class="edge">
<title>codeblock_3&#45;&gt;leaf_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M384.6592,-1016.2138C384.6592,-957.2892 384.6592,-769.5186 384.6592,-666.8544"/>
<polygon fill="#000000" stroke="#000000" points="388.1593,-666.5866 384.6592,-656.5867 381.1593,-666.5867 388.1593,-666.5866"/>
</g>
<!-- codeblock_4 -->
<g id="node6" class="node">
<title>codeblock_4</title>
<ellipse fill="none" stroke="#000000" cx="845.6592" cy="-1034.4014" rx="59.5308" ry="18"/>
<text text-anchor="middle" x="845.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">codeblock_4</text>
</g>
<!-- leaf_11 -->
<g id="node7" class="node">
<title>leaf_11</title>
<polygon fill="none" stroke="#c0c0c0" points="1053.1592,-950.302 638.1592,-950.302 638.1592,-246.0994 1053.1592,-246.0994 1053.1592,-950.302"/>
<text text-anchor="middle" x="845.6592" y="-935.3013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="845.6592" y="-903.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-888.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-873.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-857.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-842.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-826.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-811.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-796.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-780.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-765.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-749.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-734.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-719.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-703.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-688.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-672.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-657.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="845.6592" y="-642.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="845.6592" y="-594.7007" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="845.6592" y="-579.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="845.6592" y="-563.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="845.6592" y="-548.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="845.6592" y="-533.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="845.6592" y="-517.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="845.6592" y="-502.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="845.6592" y="-486.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="845.6592" y="-471.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="845.6592" y="-456.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="845.6592" y="-440.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="845.6592" y="-425.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="845.6592" y="-409.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="845.6592" y="-394.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="845.6592" y="-379.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="845.6592" y="-363.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="845.6592" y="-348.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="845.6592" y="-332.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="845.6592" y="-317.5002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="845.6592" y="-254.1001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
</g>
<!-- codeblock_4&#45;&gt;leaf_11 -->
<g id="edge4" class="edge">
<title>codeblock_4&#45;&gt;leaf_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M845.6592,-1016.2138C845.6592,-1003.2341 845.6592,-984.0025 845.6592,-960.8058"/>
<polygon fill="#000000" stroke="#000000" points="849.1593,-960.6283 845.6592,-950.6283 842.1593,-960.6283 849.1593,-960.6283"/>
</g>
<!-- codeblock_5 -->
<g id="node8" class="node">
<title>codeblock_5</title>
<ellipse fill="none" stroke="#000000" cx="1310.6592" cy="-1034.4014" rx="59.5308" ry="18"/>
<text text-anchor="middle" x="1310.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">codeblock_5</text>
</g>
<!-- leaf_12 -->
<g id="node9" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="1549.6592,-980.6023 1071.6592,-980.6023 1071.6592,-215.7992 1549.6592,-215.7992 1549.6592,-980.6023"/>
<text text-anchor="middle" x="1310.6592" y="-965.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="1310.6592" y="-949.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1310.6592" y="-934.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1310.6592" y="-919.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1310.6592" y="-903.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="1310.6592" y="-888.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="1310.6592" y="-872.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="1310.6592" y="-857.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="1310.6592" y="-842.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-826.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-811.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-795.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1310.6592" y="-780.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="1310.6592" y="-765.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-749.601" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1310.6592" y="-718.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="1310.6592" y="-702.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1310.6592" y="-687.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1310.6592" y="-672.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1310.6592" y="-656.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="1310.6592" y="-641.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="1310.6592" y="-625.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="1310.6592" y="-610.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="1310.6592" y="-595.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-579.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-564.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-548.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1310.6592" y="-533.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="1310.6592" y="-518.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-502.6005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1310.6592" y="-471.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="1310.6592" y="-455.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1310.6592" y="-440.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1310.6592" y="-425.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="1310.6592" y="-409.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-394.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="1310.6592" y="-378.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="1310.6592" y="-363.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="1310.6592" y="-348.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-332.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-317.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-301.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="1310.6592" y="-286.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1310.6592" y="-271.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1310.6592" y="-255.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1310.6592" y="-224.2" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
</g>
<!-- codeblock_5&#45;&gt;leaf_12 -->
<g id="edge5" class="edge">
<title>codeblock_5&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1310.6592,-1016.2138C1310.6592,-1009.3101 1310.6592,-1000.6378 1310.6592,-990.541"/>
<polygon fill="#000000" stroke="#000000" points="1314.1593,-990.4352 1310.6592,-980.4352 1307.1593,-990.4353 1314.1593,-990.4352"/>
</g>
<!-- block_6 -->
<g id="node10" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="1787.6592" cy="-1034.4014" rx="40.6767" ry="18"/>
<text text-anchor="middle" x="1787.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block_6</text>
</g>
<!-- structure_13 -->
<g id="node11" class="node">
<title>structure_13</title>
<ellipse fill="none" stroke="#000000" cx="1612.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1612.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_6&#45;&gt;structure_13 -->
<g id="edge6" class="edge">
<title>block_6&#45;&gt;structure_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1751.6121,-1025.9688C1726.9311,-1018.2771 1695.5443,-1004.3504 1677.6592,-980.4014 1595.8499,-870.8554 1602.9444,-694.514 1609.3636,-626.3525"/>
<polygon fill="#000000" stroke="#000000" points="1612.8492,-626.6703 1610.3743,-616.3686 1605.8848,-625.9652 1612.8492,-626.6703"/>
</g>
<!-- structure_14 -->
<g id="node12" class="node">
<title>structure_14</title>
<ellipse fill="none" stroke="#000000" cx="1731.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1731.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_6&#45;&gt;structure_14 -->
<g id="edge7" class="edge">
<title>block_6&#45;&gt;structure_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1785.3242,-1016.2138C1776.6075,-948.3171 1745.9287,-709.3503 1735.3093,-626.633"/>
<polygon fill="#000000" stroke="#000000" points="1738.749,-625.9389 1734.0041,-616.466 1731.806,-626.8303 1738.749,-625.9389"/>
</g>
<!-- structure_15 -->
<g id="node13" class="node">
<title>structure_15</title>
<ellipse fill="none" stroke="#000000" cx="1844.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1844.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_6&#45;&gt;structure_15 -->
<g id="edge8" class="edge">
<title>block_6&#45;&gt;structure_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1790.0358,-1016.2138C1798.9081,-948.3171 1830.1348,-709.3503 1840.9438,-626.633"/>
<polygon fill="#000000" stroke="#000000" points="1844.4471,-626.8352 1842.2724,-616.466 1837.5061,-625.9282 1844.4471,-626.8352"/>
</g>
<!-- structure_16 -->
<g id="node14" class="node">
<title>structure_16</title>
<ellipse fill="none" stroke="#000000" cx="1957.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1957.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_6&#45;&gt;structure_16 -->
<g id="edge9" class="edge">
<title>block_6&#45;&gt;structure_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1823.8735,-1026.2213C1848.8699,-1018.6293 1880.721,-1004.7174 1898.6592,-980.4014 1979.6237,-870.6503 1969.2472,-694.4293 1961.5086,-626.3263"/>
<polygon fill="#000000" stroke="#000000" points="1964.9777,-625.8592 1960.3036,-616.3512 1958.0282,-626.6988 1964.9777,-625.8592"/>
</g>
<!-- handleline_17 -->
<g id="node15" class="node">
<title>handleline_17</title>
<ellipse fill="none" stroke="#000000" cx="1609.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1609.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_13&#45;&gt;handleline_17 -->
<g id="edge10" class="edge">
<title>structure_13&#45;&gt;handleline_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1612.5341,-580.0131C1612.0671,-512.1164 1610.4236,-273.1496 1609.8547,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="1613.3536,-190.241 1609.7848,-180.2653 1606.3537,-190.2892 1613.3536,-190.241"/>
</g>
<!-- handleline_20 -->
<g id="node18" class="node">
<title>handleline_20</title>
<ellipse fill="none" stroke="#000000" cx="1728.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1728.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_14&#45;&gt;handleline_20 -->
<g id="edge13" class="edge">
<title>structure_14&#45;&gt;handleline_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1731.5341,-580.0131C1731.0671,-512.1164 1729.4236,-273.1496 1728.8547,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="1732.3536,-190.241 1728.7848,-180.2653 1725.3537,-190.2892 1732.3536,-190.241"/>
</g>
<!-- handleline_23 -->
<g id="node21" class="node">
<title>handleline_23</title>
<ellipse fill="none" stroke="#000000" cx="1847.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1847.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_15&#45;&gt;handleline_23 -->
<g id="edge16" class="edge">
<title>structure_15&#45;&gt;handleline_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1844.7842,-580.0131C1845.2512,-512.1164 1846.8947,-273.1496 1847.4636,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="1850.9646,-190.2892 1847.5335,-180.2653 1843.9647,-190.241 1850.9646,-190.2892"/>
</g>
<!-- handleline_26 -->
<g id="node24" class="node">
<title>handleline_26</title>
<ellipse fill="none" stroke="#000000" cx="1966.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1966.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_16&#45;&gt;handleline_26 -->
<g id="edge19" class="edge">
<title>structure_16&#45;&gt;handleline_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1958.0344,-580.0131C1959.4353,-512.1164 1964.3658,-273.1496 1966.0725,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="1969.5752,-190.3354 1966.2823,-180.2653 1962.5767,-190.1909 1969.5752,-190.3354"/>
</g>
<!-- handle_18 -->
<g id="node16" class="node">
<title>handle_18</title>
<ellipse fill="none" stroke="#000000" cx="1609.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1609.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_17&#45;&gt;handle_18 -->
<g id="edge11" class="edge">
<title>handleline_17&#45;&gt;handle_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1609.6592,-143.8314C1609.6592,-136.131 1609.6592,-126.9743 1609.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="1613.1593,-118.4132 1609.6592,-108.4133 1606.1593,-118.4133 1613.1593,-118.4132"/>
</g>
<!-- leaf_19 -->
<g id="node17" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1636.6592,-36 1582.6592,-36 1582.6592,0 1636.6592,0 1636.6592,-36"/>
</g>
<!-- handle_18&#45;&gt;leaf_19 -->
<g id="edge12" class="edge">
<title>handle_18&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1609.6592,-71.8314C1609.6592,-64.131 1609.6592,-54.9743 1609.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1613.1593,-46.4132 1609.6592,-36.4133 1606.1593,-46.4133 1613.1593,-46.4132"/>
</g>
<!-- handle_21 -->
<g id="node19" class="node">
<title>handle_21</title>
<ellipse fill="none" stroke="#000000" cx="1728.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1728.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_20&#45;&gt;handle_21 -->
<g id="edge14" class="edge">
<title>handleline_20&#45;&gt;handle_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1728.6592,-143.8314C1728.6592,-136.131 1728.6592,-126.9743 1728.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="1732.1593,-118.4132 1728.6592,-108.4133 1725.1593,-118.4133 1732.1593,-118.4132"/>
</g>
<!-- leaf_22 -->
<g id="node20" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1755.6592,-36 1701.6592,-36 1701.6592,0 1755.6592,0 1755.6592,-36"/>
</g>
<!-- handle_21&#45;&gt;leaf_22 -->
<g id="edge15" class="edge">
<title>handle_21&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1728.6592,-71.8314C1728.6592,-64.131 1728.6592,-54.9743 1728.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1732.1593,-46.4132 1728.6592,-36.4133 1725.1593,-46.4133 1732.1593,-46.4132"/>
</g>
<!-- handle_24 -->
<g id="node22" class="node">
<title>handle_24</title>
<ellipse fill="none" stroke="#000000" cx="1847.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1847.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_23&#45;&gt;handle_24 -->
<g id="edge17" class="edge">
<title>handleline_23&#45;&gt;handle_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1847.6592,-143.8314C1847.6592,-136.131 1847.6592,-126.9743 1847.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="1851.1593,-118.4132 1847.6592,-108.4133 1844.1593,-118.4133 1851.1593,-118.4132"/>
</g>
<!-- leaf_25 -->
<g id="node23" class="node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="1874.6592,-36 1820.6592,-36 1820.6592,0 1874.6592,0 1874.6592,-36"/>
</g>
<!-- handle_24&#45;&gt;leaf_25 -->
<g id="edge18" class="edge">
<title>handle_24&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1847.6592,-71.8314C1847.6592,-64.131 1847.6592,-54.9743 1847.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1851.1593,-46.4132 1847.6592,-36.4133 1844.1593,-46.4133 1851.1593,-46.4132"/>
</g>
<!-- handle_27 -->
<g id="node25" class="node">
<title>handle_27</title>
<ellipse fill="none" stroke="#000000" cx="1966.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1966.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_26&#45;&gt;handle_27 -->
<g id="edge20" class="edge">
<title>handleline_26&#45;&gt;handle_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1966.6592,-143.8314C1966.6592,-136.131 1966.6592,-126.9743 1966.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="1970.1593,-118.4132 1966.6592,-108.4133 1963.1593,-118.4133 1970.1593,-118.4132"/>
</g>
<!-- leaf_28 -->
<g id="node26" class="node">
<title>leaf_28</title>
<polygon fill="none" stroke="#c0c0c0" points="1993.6592,-36 1939.6592,-36 1939.6592,0 1993.6592,0 1993.6592,-36"/>
</g>
<!-- handle_27&#45;&gt;leaf_28 -->
<g id="edge21" class="edge">
<title>handle_27&#45;&gt;leaf_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1966.6592,-71.8314C1966.6592,-64.131 1966.6592,-54.9743 1966.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1970.1593,-46.4132 1966.6592,-36.4133 1963.1593,-46.4133 1970.1593,-46.4132"/>
</g>
<!-- codeblock_7 -->
<g id="node27" class="node">
<title>codeblock_7</title>
<ellipse fill="none" stroke="#000000" cx="2241.6592" cy="-1034.4014" rx="59.5308" ry="18"/>
<text text-anchor="middle" x="2241.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">codeblock_7</text>
</g>
<!-- leaf_29 -->
<g id="node28" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="2463.1592,-964.7021 2020.1592,-964.7021 2020.1592,-231.6993 2463.1592,-231.6993 2463.1592,-964.7021"/>
<text text-anchor="middle" x="2241.6592" y="-949.5014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="2241.6592" y="-934.1014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="2241.6592" y="-918.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="2241.6592" y="-903.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="2241.6592" y="-887.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="2241.6592" y="-872.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-841.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="2241.6592" y="-825.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="2241.6592" y="-810.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="2241.6592" y="-794.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="2241.6592" y="-779.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="2241.6592" y="-764.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="2241.6592" y="-748.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="2241.6592" y="-733.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="2241.6592" y="-717.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="2241.6592" y="-702.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="2241.6592" y="-687.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="2241.6592" y="-671.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2241.6592" y="-656.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="2241.6592" y="-640.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="2241.6592" y="-625.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="2241.6592" y="-610.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="2241.6592" y="-594.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="2241.6592" y="-579.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="2241.6592" y="-563.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="2241.6592" y="-548.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-533.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="2241.6592" y="-517.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2241.6592" y="-502.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-486.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="2241.6592" y="-471.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="2241.6592" y="-456.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-440.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="2241.6592" y="-425.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="2241.6592" y="-409.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="2241.6592" y="-394.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="2241.6592" y="-379.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="2241.6592" y="-363.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="2241.6592" y="-348.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="2241.6592" y="-332.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-317.5002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2241.6592" y="-302.1001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="2241.6592" y="-286.7001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="2241.6592" y="-271.3001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2241.6592" y="-239.9" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
</g>
<!-- codeblock_7&#45;&gt;leaf_29 -->
<g id="edge22" class="edge">
<title>codeblock_7&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2241.6592,-1016.2138C2241.6592,-1006.0375 2241.6592,-992.0183 2241.6592,-975.2582"/>
<polygon fill="#000000" stroke="#000000" points="2245.1593,-975.0817 2241.6592,-965.0817 2238.1593,-975.0818 2245.1593,-975.0817"/>
</g>
<!-- block_8 -->
<g id="node29" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="2700.6592" cy="-1034.4014" rx="40.6767" ry="18"/>
<text text-anchor="middle" x="2700.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block_8</text>
</g>
<!-- structure_30 -->
<g id="node30" class="node">
<title>structure_30</title>
<ellipse fill="none" stroke="#000000" cx="2525.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2525.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_30 -->
<g id="edge23" class="edge">
<title>block_8&#45;&gt;structure_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2664.6121,-1025.9688C2639.9311,-1018.2771 2608.5443,-1004.3504 2590.6592,-980.4014 2508.8499,-870.8554 2515.9444,-694.514 2522.3636,-626.3525"/>
<polygon fill="#000000" stroke="#000000" points="2525.8492,-626.6703 2523.3743,-616.3686 2518.8848,-625.9652 2525.8492,-626.6703"/>
</g>
<!-- structure_31 -->
<g id="node31" class="node">
<title>structure_31</title>
<ellipse fill="none" stroke="#000000" cx="2644.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2644.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_31 -->
<g id="edge24" class="edge">
<title>block_8&#45;&gt;structure_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2698.3242,-1016.2138C2689.6075,-948.3171 2658.9287,-709.3503 2648.3093,-626.633"/>
<polygon fill="#000000" stroke="#000000" points="2651.749,-625.9389 2647.0041,-616.466 2644.806,-626.8303 2651.749,-625.9389"/>
</g>
<!-- structure_32 -->
<g id="node32" class="node">
<title>structure_32</title>
<ellipse fill="none" stroke="#000000" cx="2757.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2757.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_32 -->
<g id="edge25" class="edge">
<title>block_8&#45;&gt;structure_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2703.0358,-1016.2138C2711.9081,-948.3171 2743.1348,-709.3503 2753.9438,-626.633"/>
<polygon fill="#000000" stroke="#000000" points="2757.4471,-626.8352 2755.2724,-616.466 2750.5061,-625.9282 2757.4471,-626.8352"/>
</g>
<!-- structure_33 -->
<g id="node33" class="node">
<title>structure_33</title>
<ellipse fill="none" stroke="#000000" cx="2872.6592" cy="-598.2007" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2872.6592" y="-594.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_33 -->
<g id="edge26" class="edge">
<title>block_8&#45;&gt;structure_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2736.836,-1026.1935C2761.8141,-1018.5881 2793.659,-1004.6716 2811.6592,-980.4014 2892.9688,-870.7696 2883.649,-694.4786 2876.3321,-626.3415"/>
<polygon fill="#000000" stroke="#000000" points="2879.8043,-625.8981 2875.1892,-616.3613 2872.8497,-626.6946 2879.8043,-625.8981"/>
</g>
<!-- handleline_34 -->
<g id="node34" class="node">
<title>handleline_34</title>
<ellipse fill="none" stroke="#000000" cx="2522.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2522.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_30&#45;&gt;handleline_34 -->
<g id="edge27" class="edge">
<title>structure_30&#45;&gt;handleline_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2525.5341,-580.0131C2525.0671,-512.1164 2523.4236,-273.1496 2522.8547,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="2526.3536,-190.241 2522.7848,-180.2653 2519.3537,-190.2892 2526.3536,-190.241"/>
</g>
<!-- handleline_37 -->
<g id="node37" class="node">
<title>handleline_37</title>
<ellipse fill="none" stroke="#000000" cx="2641.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2641.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_31&#45;&gt;handleline_37 -->
<g id="edge30" class="edge">
<title>structure_31&#45;&gt;handleline_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2644.5341,-580.0131C2644.0671,-512.1164 2642.4236,-273.1496 2641.8547,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="2645.3536,-190.241 2641.7848,-180.2653 2638.3537,-190.2892 2645.3536,-190.241"/>
</g>
<!-- handleline_40 -->
<g id="node40" class="node">
<title>handleline_40</title>
<ellipse fill="none" stroke="#000000" cx="2760.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2760.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_32&#45;&gt;handleline_40 -->
<g id="edge33" class="edge">
<title>structure_32&#45;&gt;handleline_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2757.7842,-580.0131C2758.2512,-512.1164 2759.8947,-273.1496 2760.4636,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="2763.9646,-190.2892 2760.5335,-180.2653 2756.9647,-190.241 2763.9646,-190.2892"/>
</g>
<!-- handleline_43 -->
<g id="node43" class="node">
<title>handleline_43</title>
<ellipse fill="none" stroke="#000000" cx="2879.6592" cy="-162" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2879.6592" y="-157.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_33&#45;&gt;handleline_43 -->
<g id="edge36" class="edge">
<title>structure_33&#45;&gt;handleline_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2872.951,-580.0131C2874.0406,-512.1164 2877.8755,-273.1496 2879.2029,-190.4323"/>
<polygon fill="#000000" stroke="#000000" points="2882.705,-190.3202 2879.366,-180.2653 2875.7059,-190.2078 2882.705,-190.3202"/>
</g>
<!-- handle_35 -->
<g id="node35" class="node">
<title>handle_35</title>
<ellipse fill="none" stroke="#000000" cx="2522.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2522.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_34&#45;&gt;handle_35 -->
<g id="edge28" class="edge">
<title>handleline_34&#45;&gt;handle_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2522.6592,-143.8314C2522.6592,-136.131 2522.6592,-126.9743 2522.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="2526.1593,-118.4132 2522.6592,-108.4133 2519.1593,-118.4133 2526.1593,-118.4132"/>
</g>
<!-- leaf_36 -->
<g id="node36" class="node">
<title>leaf_36</title>
<polygon fill="none" stroke="#c0c0c0" points="2549.6592,-36 2495.6592,-36 2495.6592,0 2549.6592,0 2549.6592,-36"/>
</g>
<!-- handle_35&#45;&gt;leaf_36 -->
<g id="edge29" class="edge">
<title>handle_35&#45;&gt;leaf_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2522.6592,-71.8314C2522.6592,-64.131 2522.6592,-54.9743 2522.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2526.1593,-46.4132 2522.6592,-36.4133 2519.1593,-46.4133 2526.1593,-46.4132"/>
</g>
<!-- handle_38 -->
<g id="node38" class="node">
<title>handle_38</title>
<ellipse fill="none" stroke="#000000" cx="2641.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2641.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_37&#45;&gt;handle_38 -->
<g id="edge31" class="edge">
<title>handleline_37&#45;&gt;handle_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2641.6592,-143.8314C2641.6592,-136.131 2641.6592,-126.9743 2641.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="2645.1593,-118.4132 2641.6592,-108.4133 2638.1593,-118.4133 2645.1593,-118.4132"/>
</g>
<!-- leaf_39 -->
<g id="node39" class="node">
<title>leaf_39</title>
<polygon fill="none" stroke="#c0c0c0" points="2668.6592,-36 2614.6592,-36 2614.6592,0 2668.6592,0 2668.6592,-36"/>
</g>
<!-- handle_38&#45;&gt;leaf_39 -->
<g id="edge32" class="edge">
<title>handle_38&#45;&gt;leaf_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2641.6592,-71.8314C2641.6592,-64.131 2641.6592,-54.9743 2641.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2645.1593,-46.4132 2641.6592,-36.4133 2638.1593,-46.4133 2645.1593,-46.4132"/>
</g>
<!-- handle_41 -->
<g id="node41" class="node">
<title>handle_41</title>
<ellipse fill="none" stroke="#000000" cx="2760.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2760.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_40&#45;&gt;handle_41 -->
<g id="edge34" class="edge">
<title>handleline_40&#45;&gt;handle_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2760.6592,-143.8314C2760.6592,-136.131 2760.6592,-126.9743 2760.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="2764.1593,-118.4132 2760.6592,-108.4133 2757.1593,-118.4133 2764.1593,-118.4132"/>
</g>
<!-- leaf_42 -->
<g id="node42" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="2787.6592,-36 2733.6592,-36 2733.6592,0 2787.6592,0 2787.6592,-36"/>
</g>
<!-- handle_41&#45;&gt;leaf_42 -->
<g id="edge35" class="edge">
<title>handle_41&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2760.6592,-71.8314C2760.6592,-64.131 2760.6592,-54.9743 2760.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2764.1593,-46.4132 2760.6592,-36.4133 2757.1593,-46.4133 2764.1593,-46.4132"/>
</g>
<!-- handle_44 -->
<g id="node44" class="node">
<title>handle_44</title>
<ellipse fill="none" stroke="#000000" cx="2879.6592" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2879.6592" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_43&#45;&gt;handle_44 -->
<g id="edge37" class="edge">
<title>handleline_43&#45;&gt;handle_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2879.6592,-143.8314C2879.6592,-136.131 2879.6592,-126.9743 2879.6592,-118.4166"/>
<polygon fill="#000000" stroke="#000000" points="2883.1593,-118.4132 2879.6592,-108.4133 2876.1593,-118.4133 2883.1593,-118.4132"/>
</g>
<!-- leaf_45 -->
<g id="node45" class="node">
<title>leaf_45</title>
<polygon fill="none" stroke="#c0c0c0" points="2906.6592,-36 2852.6592,-36 2852.6592,0 2906.6592,0 2906.6592,-36"/>
</g>
<!-- handle_44&#45;&gt;leaf_45 -->
<g id="edge38" class="edge">
<title>handle_44&#45;&gt;leaf_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2879.6592,-71.8314C2879.6592,-64.131 2879.6592,-54.9743 2879.6592,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2883.1593,-46.4132 2879.6592,-36.4133 2876.1593,-46.4133 2883.1593,-46.4132"/>
</g>
<!-- codeblock_9 -->
<g id="node46" class="node">
<title>codeblock_9</title>
<ellipse fill="none" stroke="#000000" cx="3090.6592" cy="-1034.4014" rx="59.5308" ry="18"/>
<text text-anchor="middle" x="3090.6592" y="-1030.2014" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">codeblock_9</text>
</g>
<!-- leaf_46 -->
<g id="node47" class="node">
<title>leaf_46</title>
<polygon fill="none" stroke="#c0c0c0" points="3245.6592,-695.1015 2935.6592,-695.1015 2935.6592,-501.3 3245.6592,-501.3 3245.6592,-695.1015"/>
<text text-anchor="middle" x="3090.6592" y="-679.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="3090.6592" y="-664.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="3090.6592" y="-648.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="3090.6592" y="-633.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="3090.6592" y="-618.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3090.6592" y="-602.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="3090.6592" y="-587.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3090.6592" y="-571.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="3090.6592" y="-556.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3090.6592" y="-525.1006" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="3090.6592" y="-509.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
</g>
<!-- codeblock_9&#45;&gt;leaf_46 -->
<g id="edge39" class="edge">
<title>codeblock_9&#45;&gt;leaf_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3090.6592,-1016.2138C3090.6592,-964.0429 3090.6592,-810.8694 3090.6592,-705.1876"/>
<polygon fill="#000000" stroke="#000000" points="3094.1593,-705.1135 3090.6592,-695.1136 3087.1593,-705.1136 3094.1593,-705.1135"/>
</g>
</g>
</svg>