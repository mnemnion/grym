<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="2793pt" height="1254pt"
 viewBox="0.00 0.00 2792.50 1254.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1250.0016)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1250.0016 2788.5,-1250.0016 2788.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1260.5" cy="-1228.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="1260.5" y="-1223.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">96 &#160;</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1260.5" cy="-1156.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="1260.5" y="-1151.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">96 &#160;</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1260.5,-1209.8329C1260.5,-1202.1325 1260.5,-1192.9759 1260.5,-1184.4182"/>
<polygon fill="#000000" stroke="#000000" points="1264.0001,-1184.4148 1260.5,-1174.4148 1257.0001,-1184.4149 1264.0001,-1184.4148"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="654.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="654.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">: &#160;&#160;</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1233.4357,-1154.758C1134.7619,-1150.02 794.6564,-1131.8452 690.5,-1102.0016 688.3714,-1101.3917 686.2182,-1100.657 684.0791,-1099.8377"/>
<polygon fill="#000000" stroke="#000000" points="685.4757,-1096.6285 674.9111,-1095.8293 682.6715,-1103.0423 685.4757,-1096.6285"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="726.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="726.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">&#45;1 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1233.488,-1154.3384C1143.1637,-1148.5799 852.2988,-1128.3913 762.5,-1102.0016 760.3756,-1101.3773 758.2256,-1100.6317 756.0887,-1099.8045"/>
<polygon fill="#000000" stroke="#000000" points="757.4891,-1096.5969 746.926,-1095.7779 754.6728,-1103.0054 757.4891,-1096.5969"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="798.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="798.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">14 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1234.0015,-1151.8719C1155.6171,-1139.6562 924.7553,-1103.6777 834.8851,-1089.672"/>
<polygon fill="#000000" stroke="#000000" points="835.3111,-1086.1962 824.8914,-1088.1145 834.2332,-1093.1127 835.3111,-1086.1962"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="977.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="977.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">63 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1234.8865,-1149.4851C1184.0583,-1136.5535 1070.3795,-1107.6317 1012.6243,-1092.9378"/>
<polygon fill="#000000" stroke="#000000" points="1013.406,-1089.5252 1002.8517,-1090.4515 1011.68,-1096.3091 1013.406,-1089.5252"/>
</g>
<!-- block_6 -->
<g id="node7" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="1179.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="1179.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">66 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;block_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1244.1084,-1141.4313C1232.4707,-1131.0866 1216.6572,-1117.0302 1203.5881,-1105.4132"/>
<polygon fill="#000000" stroke="#000000" points="1205.6666,-1102.5779 1195.8672,-1098.5502 1201.016,-1107.8098 1205.6666,-1102.5779"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="1301.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="1301.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">18 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1270.2164,-1138.9386C1275.1693,-1130.2409 1281.2961,-1119.4815 1286.8113,-1109.7963"/>
<polygon fill="#000000" stroke="#000000" points="1289.9463,-1111.3639 1291.8533,-1100.9421 1283.8634,-1107.9 1289.9463,-1111.3639"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="1553.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="1553.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">27 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1285.9893,-1149.738C1338.3719,-1136.8658 1458.2198,-1107.4151 1518.0961,-1092.7015"/>
<polygon fill="#000000" stroke="#000000" points="1518.9852,-1096.0872 1527.861,-1090.3019 1517.3147,-1089.2895 1518.9852,-1096.0872"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="2069.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="2069.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">77 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1287.4169,-1153.606C1407.3926,-1142.9283 1893.5884,-1099.6575 2032.3565,-1087.3073"/>
<polygon fill="#000000" stroke="#000000" points="2032.8317,-1090.7789 2042.482,-1086.4061 2032.2111,-1083.8065 2032.8317,-1090.7789"/>
</g>
<!-- block_10 -->
<g id="node11" class="node">
<title>block_10</title>
<ellipse fill="none" stroke="#000000" cx="2321.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="2321.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">82 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;block_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1287.5096,-1154.466C1392.5174,-1148.4557 1783.7043,-1125.6897 2105.5,-1102.0016 2168.4257,-1097.3694 2241.585,-1091.0832 2284.5772,-1087.2969"/>
<polygon fill="#000000" stroke="#000000" points="2284.9206,-1090.7803 2294.5737,-1086.4136 2284.3045,-1083.8075 2284.9206,-1090.7803"/>
</g>
<!-- block_11 -->
<g id="node12" class="node">
<title>block_11</title>
<ellipse fill="none" stroke="#000000" cx="2601.5" cy="-1084.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="2601.5" y="-1079.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">96 &#160;</text>
</g>
<!-- section_1&#45;&gt;block_11 -->
<g id="edge11" class="edge">
<title>section_1&#45;&gt;block_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1287.6529,-1154.91C1411.0288,-1149.8988 1931.1775,-1128.2155 2357.5,-1102.0016 2430.8122,-1097.4937 2516.4125,-1090.8629 2564.2503,-1087.034"/>
<polygon fill="#000000" stroke="#000000" points="2564.7471,-1090.5054 2574.4346,-1086.2154 2564.1863,-1083.5279 2564.7471,-1090.5054"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="432.5,-1005.2015 378.5,-1005.2015 378.5,-969.2015 432.5,-969.2015 432.5,-1005.2015"/>
</g>
<!-- block_3&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>block_3&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M705.6509,-1072.1738C700.7994,-1069.8207 695.5678,-1067.5893 690.5,-1066.0016 583.797,-1032.5713 539.2224,-1084.3472 441.5,-1030.0016 434.2209,-1025.9535 427.7779,-1019.8127 422.428,-1013.4361"/>
<polygon fill="#000000" stroke="#000000" points="425.1132,-1011.1858 416.2554,-1005.3729 419.5548,-1015.4409 425.1132,-1011.1858"/>
</g>
<!-- codeblock_13 -->
<g id="node14" class="node">
<title>codeblock_13</title>
<ellipse fill="none" stroke="#000000" cx="477.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="477.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">10 &#160;</text>
</g>
<!-- block_4&#45;&gt;codeblock_13 -->
<g id="edge13" class="edge">
<title>block_4&#45;&gt;codeblock_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M777.6509,-1072.1738C772.7994,-1069.8207 767.5678,-1067.5893 762.5,-1066.0016 655.797,-1032.5713 611.2224,-1084.3472 513.5,-1030.0016 505.8629,-1025.7544 499.1462,-1019.2036 493.6466,-1012.4938"/>
<polygon fill="#000000" stroke="#000000" points="496.143,-1009.9874 487.3538,-1004.0712 490.5353,-1014.1771 496.143,-1009.9874"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="860.5,-1022.5018 522.5,-1022.5018 522.5,-951.9012 860.5,-951.9012 860.5,-1022.5018"/>
<text text-anchor="middle" x="691.5" y="-991.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> peg rules. Don&#39;t belong here, but this is the</text>
<text text-anchor="middle" x="691.5" y="-976.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> only parser we have for awhile.</text>
</g>
<!-- block_4&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>block_4&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M782.249,-1069.2997C770.4925,-1058.6639 753.9719,-1043.7182 738.2432,-1029.4888"/>
<polygon fill="#000000" stroke="#000000" points="740.3735,-1026.6963 730.6097,-1022.583 735.6773,-1031.8873 740.3735,-1026.6963"/>
</g>
<!-- codeblock_16 -->
<g id="node17" class="node">
<title>codeblock_16</title>
<ellipse fill="none" stroke="#000000" cx="905.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="905.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">61 &#160;</text>
</g>
<!-- block_5&#45;&gt;codeblock_16 -->
<g id="edge16" class="edge">
<title>block_5&#45;&gt;codeblock_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M965.2862,-1067.5807C953.8392,-1052.1909 936.5846,-1028.993 923.5495,-1011.4681"/>
<polygon fill="#000000" stroke="#000000" points="926.3099,-1009.3148 917.5334,-1003.3798 920.6933,-1013.4925 926.3099,-1009.3148"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="1004.5,-1007.2015 950.5,-1007.2015 950.5,-967.2015 1004.5,-967.2015 1004.5,-1007.2015"/>
</g>
<!-- block_5&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>block_5&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M977.5,-1065.7942C977.5,-1052.2668 977.5,-1033.5003 977.5,-1017.6978"/>
<polygon fill="#000000" stroke="#000000" points="981.0001,-1017.332 977.5,-1007.332 974.0001,-1017.332 981.0001,-1017.332"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1256,-1014.5019 1023,-1014.5019 1023,-959.9011 1256,-959.9011 1256,-1014.5019"/>
<text text-anchor="middle" x="1139.5" y="-999.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> wraps a value in a rule, or</text>
<text text-anchor="middle" x="1139.5" y="-984.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> returns it if the rule is nil.</text>
</g>
<!-- block_6&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>block_6&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1172.1634,-1066.2469C1167.279,-1054.4268 1160.6829,-1038.4641 1154.6969,-1023.978"/>
<polygon fill="#000000" stroke="#000000" points="1157.9292,-1022.6354 1150.8754,-1014.7301 1151.4598,-1025.3088 1157.9292,-1022.6354"/>
</g>
<!-- codeblock_20 -->
<g id="node21" class="node">
<title>codeblock_20</title>
<ellipse fill="none" stroke="#000000" cx="1301.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="1301.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">17 &#160;</text>
</g>
<!-- block_7&#45;&gt;codeblock_20 -->
<g id="edge20" class="edge">
<title>block_7&#45;&gt;codeblock_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1301.5,-1065.7942C1301.5,-1051.5976 1301.5,-1031.6308 1301.5,-1015.3754"/>
<polygon fill="#000000" stroke="#000000" points="1305.0001,-1015.3272 1301.5,-1005.3272 1298.0001,-1015.3272 1305.0001,-1015.3272"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1400.5,-1005.2015 1346.5,-1005.2015 1346.5,-969.2015 1400.5,-969.2015 1400.5,-1005.2015"/>
</g>
<!-- block_7&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>block_7&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1313.7138,-1067.5807C1324.7471,-1052.7471 1341.1757,-1030.6597 1354.021,-1013.39"/>
<polygon fill="#000000" stroke="#000000" points="1356.8398,-1015.4647 1359.9996,-1005.352 1351.2231,-1011.287 1356.8398,-1015.4647"/>
</g>
<!-- structure_23 -->
<g id="node24" class="node">
<title>structure_23</title>
<ellipse fill="none" stroke="#000000" cx="1445.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="1445.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_8&#45;&gt;structure_23 -->
<g id="edge23" class="edge">
<title>block_8&#45;&gt;structure_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1534.2243,-1071.3413C1519.1623,-1061.0357 1498.0747,-1045.676 1481.5,-1030.0016 1475.4485,-1024.2787 1469.4104,-1017.5855 1464.0562,-1011.2148"/>
<polygon fill="#000000" stroke="#000000" points="1466.7249,-1008.9493 1457.6904,-1003.415 1461.3018,-1013.3754 1466.7249,-1008.9493"/>
</g>
<!-- structure_24 -->
<g id="node25" class="node">
<title>structure_24</title>
<ellipse fill="none" stroke="#000000" cx="1517.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="1517.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_8&#45;&gt;structure_24 -->
<g id="edge24" class="edge">
<title>block_8&#45;&gt;structure_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1546.897,-1066.2469C1541.5179,-1051.783 1533.8319,-1031.1163 1527.6681,-1014.5423"/>
<polygon fill="#000000" stroke="#000000" points="1530.8274,-1012.9963 1524.0611,-1004.8436 1524.2664,-1015.4364 1530.8274,-1012.9963"/>
</g>
<!-- structure_25 -->
<g id="node26" class="node">
<title>structure_25</title>
<ellipse fill="none" stroke="#000000" cx="1589.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="1589.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_8&#45;&gt;structure_25 -->
<g id="edge25" class="edge">
<title>block_8&#45;&gt;structure_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1560.103,-1066.2469C1565.4821,-1051.783 1573.1681,-1031.1163 1579.3319,-1014.5423"/>
<polygon fill="#000000" stroke="#000000" points="1582.7336,-1015.4364 1582.9389,-1004.8436 1576.1726,-1012.9963 1582.7336,-1015.4364"/>
</g>
<!-- structure_26 -->
<g id="node27" class="node">
<title>structure_26</title>
<ellipse fill="none" stroke="#000000" cx="1661.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="1661.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_8&#45;&gt;structure_26 -->
<g id="edge26" class="edge">
<title>block_8&#45;&gt;structure_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1572.7757,-1071.3413C1587.8377,-1061.0357 1608.9253,-1045.676 1625.5,-1030.0016 1631.5515,-1024.2787 1637.5896,-1017.5855 1642.9438,-1011.2148"/>
<polygon fill="#000000" stroke="#000000" points="1645.6982,-1013.3754 1649.3096,-1003.415 1640.2751,-1008.9493 1645.6982,-1013.3754"/>
</g>
<!-- leaf_39 -->
<g id="node40" class="node">
<title>leaf_39</title>
<polygon fill="none" stroke="#c0c0c0" points="2024,-1029.8026 1707,-1029.8026 1707,-944.6004 2024,-944.6004 2024,-1029.8026"/>
<text text-anchor="middle" x="1865.5" y="-1014.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> uses spans and the original string.</text>
<text text-anchor="middle" x="1865.5" y="-999.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> anything not collected by the grammar is </text>
<text text-anchor="middle" x="1865.5" y="-984.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> quoted verbatim, so if the context is Red,</text>
<text text-anchor="middle" x="1865.5" y="-968.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> it will be Red also. </text>
</g>
<!-- block_8&#45;&gt;leaf_39 -->
<g id="edge39" class="edge">
<title>block_8&#45;&gt;leaf_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1577.9821,-1076.4058C1608.8124,-1066.8405 1664.3141,-1049.6208 1718.3872,-1032.8442"/>
<polygon fill="#000000" stroke="#000000" points="1719.5923,-1036.135 1728.106,-1029.8289 1717.5179,-1029.4494 1719.5923,-1036.135"/>
</g>
<!-- codeblock_40 -->
<g id="node41" class="node">
<title>codeblock_40</title>
<ellipse fill="none" stroke="#000000" cx="2069.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2069.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">76 &#160;</text>
</g>
<!-- block_9&#45;&gt;codeblock_40 -->
<g id="edge40" class="edge">
<title>block_9&#45;&gt;codeblock_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2069.5,-1065.7942C2069.5,-1051.5976 2069.5,-1031.6308 2069.5,-1015.3754"/>
<polygon fill="#000000" stroke="#000000" points="2073.0001,-1015.3272 2069.5,-1005.3272 2066.0001,-1015.3272 2073.0001,-1015.3272"/>
</g>
<!-- leaf_42 -->
<g id="node43" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="2168.5,-1005.2015 2114.5,-1005.2015 2114.5,-969.2015 2168.5,-969.2015 2168.5,-1005.2015"/>
</g>
<!-- block_9&#45;&gt;leaf_42 -->
<g id="edge42" class="edge">
<title>block_9&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2081.7138,-1067.5807C2092.7471,-1052.7471 2109.1757,-1030.6597 2122.021,-1013.39"/>
<polygon fill="#000000" stroke="#000000" points="2124.8398,-1015.4647 2127.9996,-1005.352 2119.2231,-1011.287 2124.8398,-1015.4647"/>
</g>
<!-- structure_43 -->
<g id="node44" class="node">
<title>structure_43</title>
<ellipse fill="none" stroke="#000000" cx="2213.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2213.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_10&#45;&gt;structure_43 -->
<g id="edge43" class="edge">
<title>block_10&#45;&gt;structure_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2302.2243,-1071.3413C2287.1623,-1061.0357 2266.0747,-1045.676 2249.5,-1030.0016 2243.4485,-1024.2787 2237.4104,-1017.5855 2232.0562,-1011.2148"/>
<polygon fill="#000000" stroke="#000000" points="2234.7249,-1008.9493 2225.6904,-1003.415 2229.3018,-1013.3754 2234.7249,-1008.9493"/>
</g>
<!-- structure_44 -->
<g id="node45" class="node">
<title>structure_44</title>
<ellipse fill="none" stroke="#000000" cx="2285.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2285.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_10&#45;&gt;structure_44 -->
<g id="edge44" class="edge">
<title>block_10&#45;&gt;structure_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2314.897,-1066.2469C2309.5179,-1051.783 2301.8319,-1031.1163 2295.6681,-1014.5423"/>
<polygon fill="#000000" stroke="#000000" points="2298.8274,-1012.9963 2292.0611,-1004.8436 2292.2664,-1015.4364 2298.8274,-1012.9963"/>
</g>
<!-- structure_45 -->
<g id="node46" class="node">
<title>structure_45</title>
<ellipse fill="none" stroke="#000000" cx="2357.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2357.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_10&#45;&gt;structure_45 -->
<g id="edge45" class="edge">
<title>block_10&#45;&gt;structure_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2328.103,-1066.2469C2333.4821,-1051.783 2341.1681,-1031.1163 2347.3319,-1014.5423"/>
<polygon fill="#000000" stroke="#000000" points="2350.7336,-1015.4364 2350.9389,-1004.8436 2344.1726,-1012.9963 2350.7336,-1015.4364"/>
</g>
<!-- structure_46 -->
<g id="node47" class="node">
<title>structure_46</title>
<ellipse fill="none" stroke="#000000" cx="2429.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2429.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">re &#160;</text>
</g>
<!-- block_10&#45;&gt;structure_46 -->
<g id="edge46" class="edge">
<title>block_10&#45;&gt;structure_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2340.7757,-1071.3413C2355.8377,-1061.0357 2376.9253,-1045.676 2393.5,-1030.0016 2399.5515,-1024.2787 2405.5896,-1017.5855 2410.9438,-1011.2148"/>
<polygon fill="#000000" stroke="#000000" points="2413.6982,-1013.3754 2417.3096,-1003.415 2408.2751,-1008.9493 2413.6982,-1013.3754"/>
</g>
<!-- leaf_59 -->
<g id="node60" class="node">
<title>leaf_59</title>
<polygon fill="none" stroke="#c0c0c0" points="2528.5,-1005.2015 2474.5,-1005.2015 2474.5,-969.2015 2528.5,-969.2015 2528.5,-1005.2015"/>
</g>
<!-- block_10&#45;&gt;leaf_59 -->
<g id="edge59" class="edge">
<title>block_10&#45;&gt;leaf_59</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2347.3208,-1078.5525C2377.696,-1071.2333 2428.648,-1056.0403 2465.5,-1030.0016 2471.9331,-1025.4561 2477.9041,-1019.4934 2483.06,-1013.4682"/>
<polygon fill="#000000" stroke="#000000" points="2486.0457,-1015.3383 2489.5522,-1005.3405 2480.5764,-1010.9695 2486.0457,-1015.3383"/>
</g>
<!-- codeblock_60 -->
<g id="node61" class="node">
<title>codeblock_60</title>
<ellipse fill="none" stroke="#000000" cx="2601.5" cy="-987.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="2601.5" y="-983.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">96 &#160;</text>
</g>
<!-- block_11&#45;&gt;codeblock_60 -->
<g id="edge60" class="edge">
<title>block_11&#45;&gt;codeblock_60</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2601.5,-1065.7942C2601.5,-1051.5976 2601.5,-1031.6308 2601.5,-1015.3754"/>
<polygon fill="#000000" stroke="#000000" points="2605.0001,-1015.3272 2601.5,-1005.3272 2598.0001,-1015.3272 2605.0001,-1015.3272"/>
</g>
<!-- leaf_62 -->
<g id="node63" class="node">
<title>leaf_62</title>
<polygon fill="none" stroke="#c0c0c0" points="2700.5,-1005.2015 2646.5,-1005.2015 2646.5,-969.2015 2700.5,-969.2015 2700.5,-1005.2015"/>
</g>
<!-- block_11&#45;&gt;leaf_62 -->
<g id="edge62" class="edge">
<title>block_11&#45;&gt;leaf_62</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2613.7138,-1067.5807C2624.7471,-1052.7471 2641.1757,-1030.6597 2654.021,-1013.39"/>
<polygon fill="#000000" stroke="#000000" points="2656.8398,-1015.4647 2659.9996,-1005.352 2651.2231,-1011.287 2656.8398,-1015.4647"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="471,-584.6016 0,-584.6016 0,-467.7998 471,-467.7998 471,-584.6016"/>
<text text-anchor="middle" x="235.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="235.5" y="-537.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="235.5" y="-522.4007" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="235.5" y="-507.0007" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="235.5" y="-491.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="235.5" y="-476.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
</g>
<!-- codeblock_13&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>codeblock_13&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M468.455,-969.9711C436.4898,-909.0785 327.7156,-701.868 270.8258,-593.4951"/>
<polygon fill="#000000" stroke="#000000" points="273.9008,-591.8224 266.1538,-584.595 267.7028,-595.076 273.9008,-591.8224"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="904,-878.302 489,-878.302 489,-174.0994 904,-174.0994 904,-878.302"/>
<text text-anchor="middle" x="696.5" y="-863.3013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="696.5" y="-831.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-816.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-801.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-785.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-770.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-754.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-739.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-724.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-708.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-693.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-677.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-662.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-647.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-631.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-616.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-600.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-585.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="696.5" y="-570.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="696.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="696.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="696.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="696.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="696.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="696.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="696.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="696.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="696.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="696.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="696.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="696.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="696.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="696.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="696.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="696.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="696.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="696.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="696.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="696.5" y="-182.1001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
</g>
<!-- codeblock_16&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>codeblock_16&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M897.6884,-969.9711C889.7979,-952.5667 876.4882,-923.2089 860.3545,-887.6221"/>
<polygon fill="#000000" stroke="#000000" points="863.5104,-886.1065 856.1935,-878.4439 857.135,-888.9969 863.5104,-886.1065"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="1400.5,-908.6023 922.5,-908.6023 922.5,-143.7992 1400.5,-143.7992 1400.5,-908.6023"/>
<text text-anchor="middle" x="1161.5" y="-893.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="1161.5" y="-877.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1161.5" y="-862.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1161.5" y="-847.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1161.5" y="-831.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="1161.5" y="-816.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="1161.5" y="-800.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="1161.5" y="-785.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="1161.5" y="-770.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="1161.5" y="-754.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1161.5" y="-739.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-723.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1161.5" y="-708.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="1161.5" y="-693.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-677.601" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1161.5" y="-646.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="1161.5" y="-630.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1161.5" y="-615.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1161.5" y="-600.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1161.5" y="-584.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="1161.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="1161.5" y="-553.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="1161.5" y="-538.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="1161.5" y="-523.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="1161.5" y="-507.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1161.5" y="-492.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-476.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1161.5" y="-461.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="1161.5" y="-446.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-430.6005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1161.5" y="-399.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="1161.5" y="-383.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1161.5" y="-368.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1161.5" y="-353.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="1161.5" y="-337.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1161.5" y="-322.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="1161.5" y="-306.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="1161.5" y="-291.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="1161.5" y="-276.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="1161.5" y="-260.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1161.5" y="-245.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-229.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="1161.5" y="-214.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1161.5" y="-199.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1161.5" y="-183.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1161.5" y="-152.2" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
</g>
<!-- codeblock_20&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>codeblock_20&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1296.0976,-969.4122C1292.4425,-957.3764 1287.1095,-939.8155 1280.649,-918.5421"/>
<polygon fill="#000000" stroke="#000000" points="1283.9635,-917.4112 1277.7086,-908.8598 1277.2656,-919.4454 1283.9635,-917.4112"/>
</g>
<!-- handleline_27 -->
<g id="node28" class="node">
<title>handleline_27</title>
<ellipse fill="none" stroke="#000000" cx="1445.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="1445.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_23&#45;&gt;handleline_27 -->
<g id="edge27" class="edge">
<title>structure_23&#45;&gt;handleline_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1445.5,-969.1297C1445.5,-898.4883 1445.5,-640.6842 1445.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="1449.0001,-554.3972 1445.5,-544.3973 1442.0001,-554.3973 1449.0001,-554.3972"/>
</g>
<!-- handleline_30 -->
<g id="node31" class="node">
<title>handleline_30</title>
<ellipse fill="none" stroke="#000000" cx="1517.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="1517.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_24&#45;&gt;handleline_30 -->
<g id="edge30" class="edge">
<title>structure_24&#45;&gt;handleline_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1517.5,-969.1297C1517.5,-898.4883 1517.5,-640.6842 1517.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="1521.0001,-554.3972 1517.5,-544.3973 1514.0001,-554.3973 1521.0001,-554.3972"/>
</g>
<!-- handleline_33 -->
<g id="node34" class="node">
<title>handleline_33</title>
<ellipse fill="none" stroke="#000000" cx="1589.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="1589.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_25&#45;&gt;handleline_33 -->
<g id="edge33" class="edge">
<title>structure_25&#45;&gt;handleline_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1589.5,-969.1297C1589.5,-898.4883 1589.5,-640.6842 1589.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="1593.0001,-554.3972 1589.5,-544.3973 1586.0001,-554.3973 1593.0001,-554.3972"/>
</g>
<!-- handleline_36 -->
<g id="node37" class="node">
<title>handleline_36</title>
<ellipse fill="none" stroke="#000000" cx="1661.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="1661.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_26&#45;&gt;handleline_36 -->
<g id="edge36" class="edge">
<title>structure_26&#45;&gt;handleline_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1661.5,-969.1297C1661.5,-898.4883 1661.5,-640.6842 1661.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="1665.0001,-554.3972 1661.5,-544.3973 1658.0001,-554.3973 1665.0001,-554.3972"/>
</g>
<!-- handle_28 -->
<g id="node29" class="node">
<title>handle_28</title>
<ellipse fill="none" stroke="#000000" cx="1445.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="1445.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_27&#45;&gt;handle_28 -->
<g id="edge28" class="edge">
<title>handleline_27&#45;&gt;handle_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1445.5,-508.0131C1445.5,-440.1164 1445.5,-201.1496 1445.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1449.0001,-118.2653 1445.5,-108.2653 1442.0001,-118.2653 1449.0001,-118.2653"/>
</g>
<!-- leaf_29 -->
<g id="node30" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="1472.5,-36 1418.5,-36 1418.5,0 1472.5,0 1472.5,-36"/>
</g>
<!-- handle_28&#45;&gt;leaf_29 -->
<g id="edge29" class="edge">
<title>handle_28&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1445.5,-71.8314C1445.5,-64.131 1445.5,-54.9743 1445.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1449.0001,-46.4132 1445.5,-36.4133 1442.0001,-46.4133 1449.0001,-46.4132"/>
</g>
<!-- handle_31 -->
<g id="node32" class="node">
<title>handle_31</title>
<ellipse fill="none" stroke="#000000" cx="1517.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="1517.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_30&#45;&gt;handle_31 -->
<g id="edge31" class="edge">
<title>handleline_30&#45;&gt;handle_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1517.5,-508.0131C1517.5,-440.1164 1517.5,-201.1496 1517.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1521.0001,-118.2653 1517.5,-108.2653 1514.0001,-118.2653 1521.0001,-118.2653"/>
</g>
<!-- leaf_32 -->
<g id="node33" class="node">
<title>leaf_32</title>
<polygon fill="none" stroke="#c0c0c0" points="1544.5,-36 1490.5,-36 1490.5,0 1544.5,0 1544.5,-36"/>
</g>
<!-- handle_31&#45;&gt;leaf_32 -->
<g id="edge32" class="edge">
<title>handle_31&#45;&gt;leaf_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1517.5,-71.8314C1517.5,-64.131 1517.5,-54.9743 1517.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1521.0001,-46.4132 1517.5,-36.4133 1514.0001,-46.4133 1521.0001,-46.4132"/>
</g>
<!-- handle_34 -->
<g id="node35" class="node">
<title>handle_34</title>
<ellipse fill="none" stroke="#000000" cx="1589.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="1589.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_33&#45;&gt;handle_34 -->
<g id="edge34" class="edge">
<title>handleline_33&#45;&gt;handle_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1589.5,-508.0131C1589.5,-440.1164 1589.5,-201.1496 1589.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1593.0001,-118.2653 1589.5,-108.2653 1586.0001,-118.2653 1593.0001,-118.2653"/>
</g>
<!-- leaf_35 -->
<g id="node36" class="node">
<title>leaf_35</title>
<polygon fill="none" stroke="#c0c0c0" points="1616.5,-36 1562.5,-36 1562.5,0 1616.5,0 1616.5,-36"/>
</g>
<!-- handle_34&#45;&gt;leaf_35 -->
<g id="edge35" class="edge">
<title>handle_34&#45;&gt;leaf_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1589.5,-71.8314C1589.5,-64.131 1589.5,-54.9743 1589.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1593.0001,-46.4132 1589.5,-36.4133 1586.0001,-46.4133 1593.0001,-46.4132"/>
</g>
<!-- handle_37 -->
<g id="node38" class="node">
<title>handle_37</title>
<ellipse fill="none" stroke="#000000" cx="1661.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="1661.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_36&#45;&gt;handle_37 -->
<g id="edge37" class="edge">
<title>handleline_36&#45;&gt;handle_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1661.5,-508.0131C1661.5,-440.1164 1661.5,-201.1496 1661.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1665.0001,-118.2653 1661.5,-108.2653 1658.0001,-118.2653 1665.0001,-118.2653"/>
</g>
<!-- leaf_38 -->
<g id="node39" class="node">
<title>leaf_38</title>
<polygon fill="none" stroke="#c0c0c0" points="1688.5,-36 1634.5,-36 1634.5,0 1688.5,0 1688.5,-36"/>
</g>
<!-- handle_37&#45;&gt;leaf_38 -->
<g id="edge38" class="edge">
<title>handle_37&#45;&gt;leaf_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1661.5,-71.8314C1661.5,-64.131 1661.5,-54.9743 1661.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1665.0001,-46.4132 1661.5,-36.4133 1658.0001,-46.4133 1665.0001,-46.4132"/>
</g>
<!-- leaf_41 -->
<g id="node42" class="node">
<title>leaf_41</title>
<polygon fill="none" stroke="#c0c0c0" points="2168,-892.7021 1725,-892.7021 1725,-159.6993 2168,-159.6993 2168,-892.7021"/>
<text text-anchor="middle" x="1946.5" y="-877.5014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="1946.5" y="-862.1014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="1946.5" y="-846.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="1946.5" y="-831.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1946.5" y="-815.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="1946.5" y="-800.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-769.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="1946.5" y="-753.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="1946.5" y="-738.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="1946.5" y="-722.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="1946.5" y="-707.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="1946.5" y="-692.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="1946.5" y="-676.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="1946.5" y="-661.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="1946.5" y="-645.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="1946.5" y="-630.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="1946.5" y="-615.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="1946.5" y="-599.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="1946.5" y="-584.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="1946.5" y="-568.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="1946.5" y="-553.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="1946.5" y="-538.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="1946.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="1946.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="1946.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="1946.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="1946.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="1946.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="1946.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="1946.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="1946.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="1946.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="1946.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="1946.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="1946.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="1946.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="1946.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1946.5" y="-230.1001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="1946.5" y="-214.7001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="1946.5" y="-199.3001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1946.5" y="-167.9" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
</g>
<!-- codeblock_40&#45;&gt;leaf_41 -->
<g id="edge41" class="edge">
<title>codeblock_40&#45;&gt;leaf_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2064.7536,-969.4122C2060.7871,-954.5456 2054.5713,-931.2492 2047.0179,-902.9392"/>
<polygon fill="#000000" stroke="#000000" points="2050.366,-901.9108 2044.4063,-893.1511 2043.6026,-903.7154 2050.366,-901.9108"/>
</g>
<!-- handleline_47 -->
<g id="node48" class="node">
<title>handleline_47</title>
<ellipse fill="none" stroke="#000000" cx="2213.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="2213.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_43&#45;&gt;handleline_47 -->
<g id="edge47" class="edge">
<title>structure_43&#45;&gt;handleline_47</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2213.5,-969.1297C2213.5,-898.4883 2213.5,-640.6842 2213.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="2217.0001,-554.3972 2213.5,-544.3973 2210.0001,-554.3973 2217.0001,-554.3972"/>
</g>
<!-- handleline_50 -->
<g id="node51" class="node">
<title>handleline_50</title>
<ellipse fill="none" stroke="#000000" cx="2285.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="2285.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_44&#45;&gt;handleline_50 -->
<g id="edge50" class="edge">
<title>structure_44&#45;&gt;handleline_50</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2285.5,-969.1297C2285.5,-898.4883 2285.5,-640.6842 2285.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="2289.0001,-554.3972 2285.5,-544.3973 2282.0001,-554.3973 2289.0001,-554.3972"/>
</g>
<!-- handleline_53 -->
<g id="node54" class="node">
<title>handleline_53</title>
<ellipse fill="none" stroke="#000000" cx="2357.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="2357.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_45&#45;&gt;handleline_53 -->
<g id="edge53" class="edge">
<title>structure_45&#45;&gt;handleline_53</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2357.5,-969.1297C2357.5,-898.4883 2357.5,-640.6842 2357.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="2361.0001,-554.3972 2357.5,-544.3973 2354.0001,-554.3973 2361.0001,-554.3972"/>
</g>
<!-- handleline_56 -->
<g id="node57" class="node">
<title>handleline_56</title>
<ellipse fill="none" stroke="#000000" cx="2429.5" cy="-526.2007" rx="27" ry="18"/>
<text text-anchor="middle" x="2429.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">ne &#160;</text>
</g>
<!-- structure_46&#45;&gt;handleline_56 -->
<g id="edge56" class="edge">
<title>structure_46&#45;&gt;handleline_56</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2429.5,-969.1297C2429.5,-898.4883 2429.5,-640.6842 2429.5,-554.4873"/>
<polygon fill="#000000" stroke="#000000" points="2433.0001,-554.3972 2429.5,-544.3973 2426.0001,-554.3973 2433.0001,-554.3972"/>
</g>
<!-- handle_48 -->
<g id="node49" class="node">
<title>handle_48</title>
<ellipse fill="none" stroke="#000000" cx="2213.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="2213.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_47&#45;&gt;handle_48 -->
<g id="edge48" class="edge">
<title>handleline_47&#45;&gt;handle_48</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2213.5,-508.0131C2213.5,-440.1164 2213.5,-201.1496 2213.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2217.0001,-118.2653 2213.5,-108.2653 2210.0001,-118.2653 2217.0001,-118.2653"/>
</g>
<!-- leaf_49 -->
<g id="node50" class="node">
<title>leaf_49</title>
<polygon fill="none" stroke="#c0c0c0" points="2240.5,-36 2186.5,-36 2186.5,0 2240.5,0 2240.5,-36"/>
</g>
<!-- handle_48&#45;&gt;leaf_49 -->
<g id="edge49" class="edge">
<title>handle_48&#45;&gt;leaf_49</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2213.5,-71.8314C2213.5,-64.131 2213.5,-54.9743 2213.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2217.0001,-46.4132 2213.5,-36.4133 2210.0001,-46.4133 2217.0001,-46.4132"/>
</g>
<!-- handle_51 -->
<g id="node52" class="node">
<title>handle_51</title>
<ellipse fill="none" stroke="#000000" cx="2285.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="2285.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_50&#45;&gt;handle_51 -->
<g id="edge51" class="edge">
<title>handleline_50&#45;&gt;handle_51</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2285.5,-508.0131C2285.5,-440.1164 2285.5,-201.1496 2285.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2289.0001,-118.2653 2285.5,-108.2653 2282.0001,-118.2653 2289.0001,-118.2653"/>
</g>
<!-- leaf_52 -->
<g id="node53" class="node">
<title>leaf_52</title>
<polygon fill="none" stroke="#c0c0c0" points="2312.5,-36 2258.5,-36 2258.5,0 2312.5,0 2312.5,-36"/>
</g>
<!-- handle_51&#45;&gt;leaf_52 -->
<g id="edge52" class="edge">
<title>handle_51&#45;&gt;leaf_52</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2285.5,-71.8314C2285.5,-64.131 2285.5,-54.9743 2285.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2289.0001,-46.4132 2285.5,-36.4133 2282.0001,-46.4133 2289.0001,-46.4132"/>
</g>
<!-- handle_54 -->
<g id="node55" class="node">
<title>handle_54</title>
<ellipse fill="none" stroke="#000000" cx="2357.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="2357.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_53&#45;&gt;handle_54 -->
<g id="edge54" class="edge">
<title>handleline_53&#45;&gt;handle_54</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2357.5,-508.0131C2357.5,-440.1164 2357.5,-201.1496 2357.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2361.0001,-118.2653 2357.5,-108.2653 2354.0001,-118.2653 2361.0001,-118.2653"/>
</g>
<!-- leaf_55 -->
<g id="node56" class="node">
<title>leaf_55</title>
<polygon fill="none" stroke="#c0c0c0" points="2384.5,-36 2330.5,-36 2330.5,0 2384.5,0 2384.5,-36"/>
</g>
<!-- handle_54&#45;&gt;leaf_55 -->
<g id="edge55" class="edge">
<title>handle_54&#45;&gt;leaf_55</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2357.5,-71.8314C2357.5,-64.131 2357.5,-54.9743 2357.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2361.0001,-46.4132 2357.5,-36.4133 2354.0001,-46.4133 2361.0001,-46.4132"/>
</g>
<!-- handle_57 -->
<g id="node58" class="node">
<title>handle_57</title>
<ellipse fill="none" stroke="#000000" cx="2429.5" cy="-90" rx="27" ry="18"/>
<text text-anchor="middle" x="2429.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">le &#160;</text>
</g>
<!-- handleline_56&#45;&gt;handle_57 -->
<g id="edge57" class="edge">
<title>handleline_56&#45;&gt;handle_57</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2429.5,-508.0131C2429.5,-440.1164 2429.5,-201.1496 2429.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2433.0001,-118.2653 2429.5,-108.2653 2426.0001,-118.2653 2433.0001,-118.2653"/>
</g>
<!-- leaf_58 -->
<g id="node59" class="node">
<title>leaf_58</title>
<polygon fill="none" stroke="#c0c0c0" points="2456.5,-36 2402.5,-36 2402.5,0 2456.5,0 2456.5,-36"/>
</g>
<!-- handle_57&#45;&gt;leaf_58 -->
<g id="edge58" class="edge">
<title>handle_57&#45;&gt;leaf_58</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2429.5,-71.8314C2429.5,-64.131 2429.5,-54.9743 2429.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2433.0001,-46.4132 2429.5,-36.4133 2426.0001,-46.4133 2433.0001,-46.4132"/>
</g>
<!-- leaf_61 -->
<g id="node62" class="node">
<title>leaf_61</title>
<polygon fill="none" stroke="#c0c0c0" points="2784.5,-623.1015 2474.5,-623.1015 2474.5,-429.3 2784.5,-429.3 2784.5,-623.1015"/>
<text text-anchor="middle" x="2629.5" y="-607.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="2629.5" y="-592.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="2629.5" y="-576.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="2629.5" y="-561.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="2629.5" y="-546.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2629.5" y="-530.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="2629.5" y="-515.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2629.5" y="-499.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="2629.5" y="-484.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2629.5" y="-453.1006" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="2629.5" y="-437.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
</g>
<!-- codeblock_60&#45;&gt;leaf_61 -->
<g id="edge61" class="edge">
<title>codeblock_60&#45;&gt;leaf_61</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2602.5976,-969.1297C2605.9395,-914.1075 2616.178,-745.538 2623.0161,-632.9534"/>
<polygon fill="#000000" stroke="#000000" points="2626.5129,-633.1111 2623.6257,-622.9173 2619.5258,-632.6867 2626.5129,-633.1111"/>
</g>
</g>
</svg>