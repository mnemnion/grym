<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="2651pt" height="1151pt"
 viewBox="0.00 0.00 2651.00 1151.20" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1147.2015)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1147.2015 2647,-1147.2015 2647,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="espalier/node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1198" cy="-1125.2015" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1198" y="-1121.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 196</text>
</g>
<!-- section_1 -->
<g id="node2" class="espalier/node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1198" cy="-1053.2015" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="1198" y="-1049.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;196</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1198,-1107.0329C1198,-1099.3325 1198,-1090.1758 1198,-1081.6181"/>
<polygon fill="#000000" stroke="#000000" points="1201.5001,-1081.6147 1198,-1071.6148 1194.5001,-1081.6148 1201.5001,-1081.6147"/>
</g>
<!-- header_2 -->
<g id="node3" class="espalier/node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="212" cy="-981.2015" rx="27" ry="18"/>
<text text-anchor="middle" x="212" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1132.5766,-1051.3429C986.9327,-1046.7274 625.0623,-1032.6138 324,-999.2015 298.4845,-996.3698 269.914,-991.7547 248.0156,-987.9067"/>
<polygon fill="#000000" stroke="#000000" points="248.6114,-984.4578 238.152,-986.1464 247.3815,-991.349 248.6114,-984.4578"/>
</g>
<!-- prose_3 -->
<g id="node4" class="espalier/node">
<title>prose_3</title>
<ellipse fill="none" stroke="#000000" cx="365" cy="-981.2015" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="365" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;prose_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1132.3285,-1051.8625C1000.9398,-1048.4435 696.6388,-1036.8054 444,-999.2015 430.9354,-997.2569 416.8265,-994.3172 404.197,-991.374"/>
<polygon fill="#000000" stroke="#000000" points="404.9743,-987.9612 394.4337,-989.0318 403.3413,-994.7681 404.9743,-987.9612"/>
</g>
<!-- codeblock_4 -->
<g id="node5" class="espalier/node">
<title>codeblock_4</title>
<ellipse fill="none" stroke="#000000" cx="526" cy="-981.2015" rx="72.5844" ry="18"/>
<text text-anchor="middle" x="526" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 2&#45;10</text>
</g>
<!-- section_1&#45;&gt;codeblock_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;codeblock_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1136.583,-1046.6211C1013.666,-1033.4514 737.685,-1003.882 602.9482,-989.4459"/>
<polygon fill="#000000" stroke="#000000" points="603.0264,-985.9344 592.7104,-988.349 602.2806,-992.8945 603.0264,-985.9344"/>
</g>
<!-- codeblock_5 -->
<g id="node6" class="espalier/node">
<title>codeblock_5</title>
<ellipse fill="none" stroke="#000000" cx="903" cy="-981.2015" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="903" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 15&#45;61</text>
</g>
<!-- section_1&#45;&gt;codeblock_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;codeblock_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1148.9556,-1041.2313C1098.9828,-1029.0346 1021.2617,-1010.0654 966.5887,-996.7215"/>
<polygon fill="#000000" stroke="#000000" points="967.2049,-993.2692 956.6602,-994.2982 965.5451,-1000.0696 967.2049,-993.2692"/>
</g>
<!-- prose_6 -->
<g id="node7" class="espalier/node">
<title>prose_6</title>
<ellipse fill="none" stroke="#000000" cx="1132" cy="-981.2015" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1132" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;prose_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1181.6854,-1035.4037C1173.2516,-1026.2032 1162.8446,-1014.8502 1153.7379,-1004.9155"/>
<polygon fill="#000000" stroke="#000000" points="1156.1131,-1002.327 1146.7757,-997.3205 1150.953,-1007.0571 1156.1131,-1002.327"/>
</g>
<!-- codeblock_7 -->
<g id="node8" class="espalier/node">
<title>codeblock_7</title>
<ellipse fill="none" stroke="#000000" cx="1340" cy="-981.2015" rx="81.9542" ry="18"/>
<text text-anchor="middle" x="1340" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 67&#45;117</text>
</g>
<!-- section_1&#45;&gt;codeblock_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;codeblock_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1229.5144,-1037.2224C1249.6758,-1026.9997 1276.0657,-1013.6189 1297.9979,-1002.4983"/>
<polygon fill="#000000" stroke="#000000" points="1299.7572,-1005.5306 1307.0934,-997.8866 1296.5915,-999.2873 1299.7572,-1005.5306"/>
</g>
<!-- structure_8 -->
<g id="node9" class="espalier/node">
<title>structure_8</title>
<ellipse fill="none" stroke="#000000" cx="1603" cy="-981.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1603" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- section_1&#45;&gt;structure_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;structure_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1253.4643,-1043.3412C1332.3536,-1029.3164 1475.8384,-1003.808 1552.1279,-990.2454"/>
<polygon fill="#000000" stroke="#000000" points="1552.7524,-993.6894 1561.9854,-988.493 1551.5271,-986.7974 1552.7524,-993.6894"/>
</g>
<!-- codeblock_9 -->
<g id="node10" class="espalier/node">
<title>codeblock_9</title>
<ellipse fill="none" stroke="#000000" cx="1883" cy="-981.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="1883" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 128&#45;176</text>
</g>
<!-- section_1&#45;&gt;codeblock_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;codeblock_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1259.392,-1046.7486C1381.2125,-1033.9441 1653.8761,-1005.2846 1794.8466,-990.4673"/>
<polygon fill="#000000" stroke="#000000" points="1795.5988,-993.9076 1805.1781,-989.3813 1794.867,-986.9459 1795.5988,-993.9076"/>
</g>
<!-- structure_10 -->
<g id="node11" class="espalier/node">
<title>structure_10</title>
<ellipse fill="none" stroke="#000000" cx="2168" cy="-981.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2168" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- section_1&#45;&gt;structure_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;structure_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1262.3308,-1049.3198C1395.9325,-1041.1334 1713.1649,-1021.0468 1979,-999.2015 2024.6413,-995.4509 2076.4112,-990.4695 2114.2138,-986.698"/>
<polygon fill="#000000" stroke="#000000" points="2114.8879,-990.148 2124.489,-985.6683 2114.1899,-983.1829 2114.8879,-990.148"/>
</g>
<!-- codeblock_11 -->
<g id="node12" class="espalier/node">
<title>codeblock_11</title>
<ellipse fill="none" stroke="#000000" cx="2422" cy="-981.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="2422" y="-977.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 183&#45;196</text>
</g>
<!-- section_1&#45;&gt;codeblock_11 -->
<g id="edge11" class="edge">
<title>section_1&#45;&gt;codeblock_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1263.0447,-1050.6093C1425.1192,-1043.9679 1859.9721,-1025.0295 2222,-999.2015 2258.3974,-996.6048 2298.4652,-993.1225 2333.1176,-989.9128"/>
<polygon fill="#000000" stroke="#000000" points="2333.5806,-993.3849 2343.2124,-988.9714 2332.9306,-986.4152 2333.5806,-993.3849"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="espalier/node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="54,-563.0008 0,-563.0008 0,-527.0008 54,-527.0008 54,-563.0008"/>
<text text-anchor="middle" x="27" y="-541.5008" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
</g>
<!-- header_2&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>header_2&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M186.3206,-975.3901C147.9255,-966.1514 78.406,-947.1131 63,-927.2015 -19.8466,-820.1256 6.1159,-642.3343 20.3722,-573.4686"/>
<polygon fill="#000000" stroke="#000000" points="23.8613,-573.8911 22.5413,-563.3788 17.0176,-572.4198 23.8613,-573.8911"/>
</g>
<!-- raw_13 -->
<g id="node14" class="espalier/node">
<title>raw_13</title>
<ellipse fill="none" stroke="#000000" cx="99" cy="-545.0008" rx="27" ry="18"/>
<text text-anchor="middle" x="99" y="-540.8008" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_3&#45;&gt;raw_13 -->
<g id="edge13" class="edge">
<title>prose_3&#45;&gt;raw_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M333.8253,-975.9522C274.0634,-965.5955 148.1066,-942.2344 135,-927.2015 45.4307,-824.4686 75.9907,-641.9721 91.9105,-572.7059"/>
<polygon fill="#000000" stroke="#000000" points="95.3196,-573.4983 94.2282,-562.9599 88.5095,-571.8787 95.3196,-573.4983"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="espalier/node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="615.5,-603.4017 144.5,-603.4017 144.5,-486.5999 615.5,-486.5999 615.5,-603.4017"/>
<text text-anchor="middle" x="380" y="-588.0009" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="380" y="-556.6008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="380" y="-541.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="380" y="-525.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="380" y="-510.4007" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="380" y="-495.0007" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
</g>
<!-- codeblock_4&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>codeblock_4&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M519.9124,-963.0138C500.15,-903.9702 437.0874,-715.5595 402.771,-613.0333"/>
<polygon fill="#000000" stroke="#000000" points="406.0354,-611.7587 399.5423,-603.3867 399.3973,-613.9806 406.0354,-611.7587"/>
</g>
<!-- leaf_16 -->
<g id="node17" class="espalier/node">
<title>leaf_16</title>
<polygon fill="none" stroke="#c0c0c0" points="1048.5,-897.1021 633.5,-897.1021 633.5,-192.8995 1048.5,-192.8995 1048.5,-897.1021"/>
<text text-anchor="middle" x="841" y="-882.1014" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="841" y="-850.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-835.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-819.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-804.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-789.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-773.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-758.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-742.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-727.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-712.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-696.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-681.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-665.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-650.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-635.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-619.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-604.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="841" y="-588.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="841" y="-541.5008" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="841" y="-526.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="841" y="-510.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="841" y="-495.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="841" y="-479.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="841" y="-464.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="841" y="-449.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="841" y="-433.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="841" y="-418.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="841" y="-402.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="841" y="-387.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="841" y="-372.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="841" y="-356.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="841" y="-341.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="841" y="-325.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="841" y="-310.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="841" y="-295.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="841" y="-279.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="841" y="-264.3002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="841" y="-200.9002" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
</g>
<!-- codeblock_5&#45;&gt;leaf_16 -->
<g id="edge16" class="edge">
<title>codeblock_5&#45;&gt;leaf_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M900.4149,-963.0138C898.57,-950.0341 895.8365,-930.8025 892.5394,-907.6059"/>
<polygon fill="#000000" stroke="#000000" points="895.9653,-906.8363 891.0928,-897.4284 889.0349,-907.8214 895.9653,-906.8363"/>
</g>
<!-- raw_17 -->
<g id="node18" class="espalier/node">
<title>raw_17</title>
<ellipse fill="none" stroke="#000000" cx="1094" cy="-545.0008" rx="27" ry="18"/>
<text text-anchor="middle" x="1094" y="-540.8008" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">raw</text>
</g>
<!-- prose_6&#45;&gt;raw_17 -->
<g id="edge17" class="edge">
<title>prose_6&#45;&gt;raw_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1130.4156,-963.0138C1124.5007,-895.1172 1103.6829,-656.1504 1096.4769,-573.4331"/>
<polygon fill="#000000" stroke="#000000" points="1099.946,-572.9246 1095.5912,-563.2661 1092.9724,-573.5321 1099.946,-572.9246"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="espalier/node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1617,-927.4023 1139,-927.4023 1139,-162.5992 1617,-162.5992 1617,-927.4023"/>
<text text-anchor="middle" x="1378" y="-912.0015" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="1378" y="-896.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1378" y="-881.2014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1378" y="-865.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1378" y="-850.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="1378" y="-835.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="1378" y="-819.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="1378" y="-804.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="1378" y="-788.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="1378" y="-773.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1378" y="-758.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-742.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1378" y="-727.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="1378" y="-711.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-696.4011" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1378" y="-665.001" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="1378" y="-649.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1378" y="-634.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1378" y="-618.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1378" y="-603.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="1378" y="-588.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="1378" y="-572.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="1378" y="-557.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="1378" y="-541.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="1378" y="-526.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1378" y="-511.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-495.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1378" y="-480.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="1378" y="-464.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-449.4006" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1378" y="-418.0006" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="1378" y="-402.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1378" y="-387.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1378" y="-371.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="1378" y="-356.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1378" y="-341.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="1378" y="-325.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="1378" y="-310.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="1378" y="-294.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="1378" y="-279.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1378" y="-264.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-248.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="1378" y="-233.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1378" y="-217.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1378" y="-202.4001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1378" y="-171.0001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
</g>
<!-- codeblock_7&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>codeblock_7&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1341.5844,-963.0138C1342.1859,-956.1102 1342.9413,-947.4379 1343.8209,-937.341"/>
<polygon fill="#000000" stroke="#000000" points="1347.3201,-937.5013 1344.7013,-927.2353 1340.3466,-936.8938 1347.3201,-937.5013"/>
</g>
<!-- handleline_20 -->
<g id="node21" class="espalier/node">
<title>handleline_20</title>
<ellipse fill="none" stroke="#000000" cx="1685" cy="-545.0008" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1685" y="-540.8008" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_8&#45;&gt;handleline_20 -->
<g id="edge20" class="edge">
<title>structure_8&#45;&gt;handleline_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1612.0445,-963.1204C1616.8509,-952.8226 1622.4776,-939.5482 1626,-927.2015 1662.8268,-798.116 1678.1177,-637.5377 1683.0489,-573.393"/>
<polygon fill="#000000" stroke="#000000" points="1686.5516,-573.4855 1683.8029,-563.2534 1679.5709,-572.9663 1686.5516,-573.4855"/>
</g>
<!-- leaf_23 -->
<g id="node24" class="espalier/node">
<title>leaf_23</title>
<polygon fill="none" stroke="#c0c0c0" points="2196.5,-911.5022 1753.5,-911.5022 1753.5,-178.4994 2196.5,-178.4994 2196.5,-911.5022"/>
<text text-anchor="middle" x="1975" y="-896.3015" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="1975" y="-880.9015" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="1975" y="-865.5014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="1975" y="-850.1014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1975" y="-834.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="1975" y="-819.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-787.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="1975" y="-772.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="1975" y="-757.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="1975" y="-741.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="1975" y="-726.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="1975" y="-710.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="1975" y="-695.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="1975" y="-680.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="1975" y="-664.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="1975" y="-649.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="1975" y="-633.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="1975" y="-618.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="1975" y="-603.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="1975" y="-587.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="1975" y="-572.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="1975" y="-556.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="1975" y="-541.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="1975" y="-526.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="1975" y="-510.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="1975" y="-495.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-479.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="1975" y="-464.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="1975" y="-449.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-433.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="1975" y="-418.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="1975" y="-402.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-387.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="1975" y="-372.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="1975" y="-356.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="1975" y="-341.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="1975" y="-325.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="1975" y="-310.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="1975" y="-295.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="1975" y="-279.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-264.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1975" y="-248.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="1975" y="-233.5002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="1975" y="-218.1001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1975" y="-186.7001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
</g>
<!-- codeblock_9&#45;&gt;leaf_23 -->
<g id="edge23" class="edge">
<title>codeblock_9&#45;&gt;leaf_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1886.836,-963.0138C1888.9823,-952.8375 1891.9391,-938.8183 1895.474,-922.0583"/>
<polygon fill="#000000" stroke="#000000" points="1898.9812,-922.3889 1897.6204,-911.8818 1892.1319,-920.9442 1898.9812,-922.3889"/>
</g>
<!-- handleline_24 -->
<g id="node25" class="espalier/node">
<title>handleline_24</title>
<ellipse fill="none" stroke="#000000" cx="2265" cy="-545.0008" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2265" y="-540.8008" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_10&#45;&gt;handleline_24 -->
<g id="edge24" class="edge">
<title>structure_10&#45;&gt;handleline_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2183.2675,-963.9326C2191.3099,-953.8889 2200.5997,-940.5981 2206,-927.2015 2256.3061,-802.4062 2264.0065,-638.7742 2264.9785,-573.5898"/>
<polygon fill="#000000" stroke="#000000" points="2268.4813,-573.3281 2265.0866,-563.2919 2261.4817,-573.2545 2268.4813,-573.3281"/>
</g>
<!-- leaf_27 -->
<g id="node28" class="espalier/node">
<title>leaf_27</title>
<polygon fill="none" stroke="#c0c0c0" points="2643,-641.9015 2333,-641.9015 2333,-448.1 2643,-448.1 2643,-641.9015"/>
<text text-anchor="middle" x="2488" y="-626.501" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="2488" y="-611.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="2488" y="-595.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="2488" y="-580.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="2488" y="-564.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2488" y="-549.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="2488" y="-534.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2488" y="-518.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="2488" y="-503.3007" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2488" y="-471.9007" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="2488" y="-456.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
</g>
<!-- codeblock_11&#45;&gt;leaf_27 -->
<g id="edge27" class="edge">
<title>codeblock_11&#45;&gt;leaf_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2424.7519,-963.0138C2432.6457,-910.843 2455.8218,-757.6695 2471.8122,-651.9877"/>
<polygon fill="#000000" stroke="#000000" points="2475.3009,-652.3247 2473.3365,-641.9136 2468.3797,-651.2775 2475.3009,-652.3247"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="espalier/node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="126,-117.4 72,-117.4 72,-81.4 126,-81.4 126,-117.4"/>
</g>
<!-- raw_13&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>raw_13&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M99,-526.9808C99,-458.1916 99,-211.7921 99,-127.7335"/>
<polygon fill="#000000" stroke="#000000" points="102.5001,-127.6442 99,-117.6442 95.5001,-127.6443 102.5001,-127.6442"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="espalier/node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="1210.5,-126.7005 977.5,-126.7005 977.5,-72.0996 1210.5,-72.0996 1210.5,-126.7005"/>
<text text-anchor="middle" x="1094" y="-95.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> wraps a value in a rule, or</text>
<text text-anchor="middle" x="1094" y="-80.2" font-family="Inconsolata" font-size="14.00" fill="#000000"> returns it if the rule is nil.</text>
</g>
<!-- raw_17&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>raw_17&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1094,-526.9808C1094,-460.5736 1094,-228.644 1094,-137.0358"/>
<polygon fill="#000000" stroke="#000000" points="1097.5001,-136.8333 1094,-126.8334 1090.5001,-136.8334 1097.5001,-136.8333"/>
</g>
<!-- handle_21 -->
<g id="node22" class="espalier/node">
<title>handle_21</title>
<ellipse fill="none" stroke="#000000" cx="1685" cy="-99.4" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1685" y="-95.2" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_20&#45;&gt;handle_21 -->
<g id="edge21" class="edge">
<title>handleline_20&#45;&gt;handle_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1685,-526.9808C1685,-458.1916 1685,-211.7921 1685,-127.7335"/>
<polygon fill="#000000" stroke="#000000" points="1688.5001,-127.6442 1685,-117.6442 1681.5001,-127.6443 1688.5001,-127.6442"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="espalier/node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1712,-36 1658,-36 1658,0 1712,0 1712,-36"/>
</g>
<!-- handle_21&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>handle_21&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1685,-81.3347C1685,-71.0069 1685,-57.828 1685,-46.1691"/>
<polygon fill="#000000" stroke="#000000" points="1688.5001,-46.0148 1685,-36.0148 1681.5001,-46.0148 1688.5001,-46.0148"/>
</g>
<!-- handle_25 -->
<g id="node26" class="espalier/node">
<title>handle_25</title>
<ellipse fill="none" stroke="#000000" cx="2265" cy="-99.4" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2265" y="-95.2" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_24&#45;&gt;handle_25 -->
<g id="edge25" class="edge">
<title>handleline_24&#45;&gt;handle_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2265,-526.9808C2265,-458.1916 2265,-211.7921 2265,-127.7335"/>
<polygon fill="#000000" stroke="#000000" points="2268.5001,-127.6442 2265,-117.6442 2261.5001,-127.6443 2268.5001,-127.6442"/>
</g>
<!-- leaf_26 -->
<g id="node27" class="espalier/node">
<title>leaf_26</title>
<polygon fill="none" stroke="#c0c0c0" points="2292,-36 2238,-36 2238,0 2292,0 2292,-36"/>
</g>
<!-- handle_25&#45;&gt;leaf_26 -->
<g id="edge26" class="edge">
<title>handle_25&#45;&gt;leaf_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2265,-81.3347C2265,-71.0069 2265,-57.828 2265,-46.1691"/>
<polygon fill="#000000" stroke="#000000" points="2268.5001,-46.0148 2265,-36.0148 2261.5001,-46.0148 2268.5001,-46.0148"/>
</g>
</g>
</svg>