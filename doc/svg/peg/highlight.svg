<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="3230pt" height="1238pt"
 viewBox="0.00 0.00 3229.50 1238.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1234.0016)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1234.0016 3225.5,-1234.0016 3225.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="1192.5" cy="-1212.0016" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="1192.5" y="-1207.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 196</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="1192.5" cy="-1140.0016" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="1192.5" y="-1135.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;196</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1192.5,-1193.8329C1192.5,-1186.1325 1192.5,-1176.9759 1192.5,-1168.4182"/>
<polygon fill="#000000" stroke="#000000" points="1196.0001,-1168.4148 1192.5,-1158.4148 1189.0001,-1168.4149 1196.0001,-1168.4148"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="420.5" cy="-1068.0016" rx="27" ry="18"/>
<text text-anchor="middle" x="420.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">0 : </text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1127.0458,-1138.4514C971.2138,-1134.2383 581.8856,-1120.4929 456.5,-1086.0016 454.3651,-1085.4143 452.2071,-1084.6966 450.0645,-1083.8898"/>
<polygon fill="#000000" stroke="#000000" points="451.4554,-1080.6781 440.8884,-1079.9101 448.6701,-1087.1001 451.4554,-1080.6781"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="511.5" cy="-1068.0016" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="511.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;1</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1127.9984,-1136.3267C990.5247,-1128.186 672.5827,-1107.6346 566.5,-1086.0016 562.6776,-1085.2221 558.7495,-1084.265 554.8356,-1083.202"/>
<polygon fill="#000000" stroke="#000000" points="555.7851,-1079.8332 545.2045,-1080.3828 553.8185,-1086.5513 555.7851,-1079.8332"/>
</g>
<!-- block_4 -->
<g id="node5" class="node">
<title>block_4</title>
<ellipse fill="none" stroke="#000000" cx="626.5" cy="-1068.0016" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="626.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 2&#45;14</text>
</g>
<!-- section_1&#45;&gt;block_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;block_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1132.7311,-1132.3985C1023.4427,-1118.496 792.7041,-1089.1441 684.6373,-1075.3971"/>
<polygon fill="#000000" stroke="#000000" points="684.9321,-1071.9065 674.5703,-1074.1165 684.0487,-1078.8505 684.9321,-1071.9065"/>
</g>
<!-- block_5 -->
<g id="node6" class="node">
<title>block_5</title>
<ellipse fill="none" stroke="#000000" cx="881.5" cy="-1068.0016" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="881.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 15&#45;63</text>
</g>
<!-- section_1&#45;&gt;block_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;block_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1142.1868,-1128.3535C1085.9577,-1115.3358 995.1842,-1094.3207 936.9489,-1080.8386"/>
<polygon fill="#000000" stroke="#000000" points="937.7133,-1077.4231 927.1816,-1078.5774 936.1345,-1084.2427 937.7133,-1077.4231"/>
</g>
<!-- block_6 -->
<g id="node7" class="node">
<title>block_6</title>
<ellipse fill="none" stroke="#000000" cx="1084.5" cy="-1068.0016" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="1084.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 64&#45;66</text>
</g>
<!-- section_1&#45;&gt;block_6 -->
<g id="edge6" class="edge">
<title>section_1&#45;&gt;block_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1167.4512,-1123.3023C1152.6246,-1113.4179 1133.6638,-1100.7774 1117.6134,-1090.0771"/>
<polygon fill="#000000" stroke="#000000" points="1119.3026,-1086.9968 1109.0406,-1084.362 1115.4197,-1092.8212 1119.3026,-1086.9968"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="1259.5" cy="-1068.0016" rx="60.1864" ry="18"/>
<text text-anchor="middle" x="1259.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 67&#45;118</text>
</g>
<!-- section_1&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_1&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1209.0618,-1122.2038C1217.3176,-1113.3319 1227.436,-1102.4584 1236.4374,-1092.7853"/>
<polygon fill="#000000" stroke="#000000" points="1239.1098,-1095.0512 1243.3599,-1085.3461 1233.9853,-1090.2825 1239.1098,-1095.0512"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="1636.5" cy="-1068.0016" rx="65.0229" ry="18"/>
<text text-anchor="middle" x="1636.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 119&#45;127</text>
</g>
<!-- section_1&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_1&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1249.1839,-1130.8096C1331.2648,-1117.4992 1482.9045,-1092.9089 1570.1069,-1078.768"/>
<polygon fill="#000000" stroke="#000000" points="1570.8428,-1082.1945 1580.1536,-1077.1388 1569.7223,-1075.2847 1570.8428,-1082.1945"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="2282.5" cy="-1068.0016" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="2282.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 128&#45;177</text>
</g>
<!-- section_1&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_1&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1256.6151,-1135.7664C1446.5739,-1123.2187 2005.754,-1086.282 2208.2315,-1072.9074"/>
<polygon fill="#000000" stroke="#000000" points="2208.7181,-1076.3829 2218.4656,-1072.2314 2208.2567,-1069.3982 2208.7181,-1076.3829"/>
</g>
<!-- block_10 -->
<g id="node11" class="node">
<title>block_10</title>
<ellipse fill="none" stroke="#000000" cx="2664.5" cy="-1068.0016" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="2664.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 178&#45;182</text>
</g>
<!-- section_1&#45;&gt;block_10 -->
<g id="edge10" class="edge">
<title>section_1&#45;&gt;block_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1257.562,-1137.2656C1434.3548,-1129.7707 1938.4493,-1107.9975 2357.5,-1086.0016 2437.0456,-1081.8262 2528.1452,-1076.404 2590.3146,-1072.6063"/>
<polygon fill="#000000" stroke="#000000" points="2590.6541,-1076.0922 2600.4215,-1071.9877 2590.2263,-1069.1053 2590.6541,-1076.0922"/>
</g>
<!-- block_11 -->
<g id="node12" class="node">
<title>block_11</title>
<ellipse fill="none" stroke="#000000" cx="3053.5" cy="-1068.0016" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="3053.5" y="-1063.8016" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 183&#45;196</text>
</g>
<!-- section_1&#45;&gt;block_11 -->
<g id="edge11" class="edge">
<title>section_1&#45;&gt;block_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1258.1134,-1138.2366C1471.5878,-1132.3817 2165.678,-1112.4604 2739.5,-1086.0016 2821.5246,-1082.2194 2915.5321,-1076.6696 2979.1414,-1072.7339"/>
<polygon fill="#000000" stroke="#000000" points="2979.7111,-1076.2054 2989.4749,-1072.0922 2979.2771,-1069.2189 2979.7111,-1076.2054"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="144.5,-997.2015 90.5,-997.2015 90.5,-961.2015 144.5,-961.2015 144.5,-997.2015"/>
</g>
<!-- block_3&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>block_3&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M477.4638,-1055.704C470.5916,-1053.5504 463.3675,-1051.5176 456.5,-1050.0016 324.0746,-1020.7678 276.0024,-1072.1761 153.5,-1014.0016 148.396,-1011.5777 143.563,-1008.1413 139.1924,-1004.3626"/>
<polygon fill="#000000" stroke="#000000" points="141.5061,-1001.7321 131.8662,-997.3364 136.6609,-1006.7842 141.5061,-1001.7321"/>
</g>
<!-- codeblock_13 -->
<g id="node14" class="node">
<title>codeblock_13</title>
<ellipse fill="none" stroke="#000000" cx="235.5" cy="-979.2015" rx="72.5844" ry="18"/>
<text text-anchor="middle" x="235.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 2&#45;10</text>
</g>
<!-- block_4&#45;&gt;codeblock_13 -->
<g id="edge13" class="edge">
<title>block_4&#45;&gt;codeblock_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M588.9558,-1055.8119C581.5633,-1053.6751 573.8271,-1051.621 566.5,-1050.0016 457.3176,-1025.8704 425.1923,-1044.0927 317.5,-1014.0016 304.2066,-1010.2871 290.2156,-1004.9329 277.6291,-999.5337"/>
<polygon fill="#000000" stroke="#000000" points="278.8745,-996.2577 268.3127,-995.4225 276.0485,-1002.6619 278.8745,-996.2577"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="664.5,-1006.5019 326.5,-1006.5019 326.5,-951.9011 664.5,-951.9011 664.5,-1006.5019"/>
<text text-anchor="middle" x="495.5" y="-975.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> peg rules. Don&#39;t belong here, but this is the</text>
<text text-anchor="middle" x="495.5" y="-960.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> only parser we have for awhile.</text>
</g>
<!-- block_4&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>block_4&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M602.7769,-1051.9205C586.5191,-1040.9 564.3677,-1025.8844 544.4145,-1012.3589"/>
<polygon fill="#000000" stroke="#000000" points="546.2627,-1009.3833 536.0213,-1006.6694 542.335,-1015.1776 546.2627,-1009.3833"/>
</g>
<!-- codeblock_16 -->
<g id="node17" class="node">
<title>codeblock_16</title>
<ellipse fill="none" stroke="#000000" cx="759.5" cy="-979.2015" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="759.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 15&#45;61</text>
</g>
<!-- block_5&#45;&gt;codeblock_16 -->
<g id="edge16" class="edge">
<title>block_5&#45;&gt;codeblock_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M858.8387,-1051.5071C839.9425,-1037.7531 812.792,-1017.9911 791.6493,-1002.602"/>
<polygon fill="#000000" stroke="#000000" points="793.4346,-999.5725 783.2898,-996.5173 789.3151,-1005.232 793.4346,-999.5725"/>
</g>
<!-- leaf_18 -->
<g id="node19" class="node">
<title>leaf_18</title>
<polygon fill="none" stroke="#c0c0c0" points="908.5,-997.2015 854.5,-997.2015 854.5,-961.2015 908.5,-961.2015 908.5,-997.2015"/>
</g>
<!-- block_5&#45;&gt;leaf_18 -->
<g id="edge18" class="edge">
<title>block_5&#45;&gt;leaf_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M881.5,-1049.6021C881.5,-1037.4964 881.5,-1021.4092 881.5,-1007.6689"/>
<polygon fill="#000000" stroke="#000000" points="885.0001,-1007.2735 881.5,-997.2735 878.0001,-1007.2736 885.0001,-1007.2735"/>
</g>
<!-- leaf_19 -->
<g id="node20" class="node">
<title>leaf_19</title>
<polygon fill="none" stroke="#c0c0c0" points="1160,-998.5021 927,-998.5021 927,-959.9009 1160,-959.9009 1160,-998.5021"/>
<text text-anchor="middle" x="1043.5" y="-983.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> wraps a value in a rule, or</text>
<text text-anchor="middle" x="1043.5" y="-968.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> returns it if the rule is nil.</text>
</g>
<!-- block_6&#45;&gt;leaf_19 -->
<g id="edge19" class="edge">
<title>block_6&#45;&gt;leaf_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1076.203,-1050.0315C1070.6136,-1037.9256 1063.1212,-1021.6981 1056.7181,-1007.83"/>
<polygon fill="#000000" stroke="#000000" points="1059.8656,-1006.2974 1052.496,-998.6856 1053.5103,-1009.2318 1059.8656,-1006.2974"/>
</g>
<!-- codeblock_20 -->
<g id="node21" class="node">
<title>codeblock_20</title>
<ellipse fill="none" stroke="#000000" cx="1259.5" cy="-979.2015" rx="81.9542" ry="18"/>
<text text-anchor="middle" x="1259.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 67&#45;117</text>
</g>
<!-- block_7&#45;&gt;codeblock_20 -->
<g id="edge20" class="edge">
<title>block_7&#45;&gt;codeblock_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1259.5,-1049.6021C1259.5,-1037.4964 1259.5,-1021.4092 1259.5,-1007.6689"/>
<polygon fill="#000000" stroke="#000000" points="1263.0001,-1007.2735 1259.5,-997.2735 1256.0001,-1007.2736 1263.0001,-1007.2735"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1413.5,-997.2015 1359.5,-997.2015 1359.5,-961.2015 1413.5,-961.2015 1413.5,-997.2015"/>
</g>
<!-- block_7&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>block_7&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1289.7185,-1052.3952C1307.9903,-1042.4022 1331.3709,-1028.6042 1350.5,-1014.0016 1354.3564,-1011.0577 1358.2425,-1007.7433 1361.9619,-1004.36"/>
<polygon fill="#000000" stroke="#000000" points="1364.4429,-1006.8309 1369.2997,-997.4148 1359.631,-1001.747 1364.4429,-1006.8309"/>
</g>
<!-- structure_23 -->
<g id="node24" class="node">
<title>structure_23</title>
<ellipse fill="none" stroke="#000000" cx="1476.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1476.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_23 -->
<g id="edge23" class="edge">
<title>block_8&#45;&gt;structure_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1603.2056,-1052.4071C1581.824,-1042.0984 1553.6389,-1027.9572 1529.5,-1014.0016 1522.3305,-1009.8566 1514.7975,-1005.1422 1507.7338,-1000.5512"/>
<polygon fill="#000000" stroke="#000000" points="1509.3746,-997.4406 1499.1003,-994.8541 1505.5191,-1003.2832 1509.3746,-997.4406"/>
</g>
<!-- structure_24 -->
<g id="node25" class="node">
<title>structure_24</title>
<ellipse fill="none" stroke="#000000" cx="1583.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1583.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_24 -->
<g id="edge24" class="edge">
<title>block_8&#45;&gt;structure_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1625.7747,-1050.0315C1618.182,-1037.3103 1607.8731,-1020.038 1599.3362,-1005.7346"/>
<polygon fill="#000000" stroke="#000000" points="1602.159,-1003.6348 1594.0285,-996.8417 1596.1482,-1007.2224 1602.159,-1003.6348"/>
</g>
<!-- structure_25 -->
<g id="node26" class="node">
<title>structure_25</title>
<ellipse fill="none" stroke="#000000" cx="1690.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1690.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_25 -->
<g id="edge25" class="edge">
<title>block_8&#45;&gt;structure_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1647.4277,-1050.0315C1655.1636,-1037.3103 1665.667,-1020.038 1674.365,-1005.7346"/>
<polygon fill="#000000" stroke="#000000" points="1677.5675,-1007.2045 1679.7728,-996.8417 1671.5865,-1003.5674 1677.5675,-1007.2045"/>
</g>
<!-- structure_26 -->
<g id="node27" class="node">
<title>structure_26</title>
<ellipse fill="none" stroke="#000000" cx="1797.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="1797.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_8&#45;&gt;structure_26 -->
<g id="edge26" class="edge">
<title>block_8&#45;&gt;structure_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1670.1188,-1052.4471C1691.7056,-1042.1543 1720.155,-1028.0159 1744.5,-1014.0016 1751.6773,-1009.8699 1759.2135,-1005.1611 1766.2777,-1000.5713"/>
<polygon fill="#000000" stroke="#000000" points="1768.4927,-1003.303 1774.9109,-994.8734 1764.6368,-997.4607 1768.4927,-1003.303"/>
</g>
<!-- leaf_39 -->
<g id="node40" class="node">
<title>leaf_39</title>
<polygon fill="none" stroke="#c0c0c0" points="2177,-1013.8028 1860,-1013.8028 1860,-944.6002 2177,-944.6002 2177,-1013.8028"/>
<text text-anchor="middle" x="2018.5" y="-998.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> uses spans and the original string.</text>
<text text-anchor="middle" x="2018.5" y="-983.4015" font-family="Inconsolata" font-size="14.00" fill="#000000"> anything not collected by the grammar is </text>
<text text-anchor="middle" x="2018.5" y="-968.0015" font-family="Inconsolata" font-size="14.00" fill="#000000"> quoted verbatim, so if the context is Red,</text>
<text text-anchor="middle" x="2018.5" y="-952.6015" font-family="Inconsolata" font-size="14.00" fill="#000000"> it will be Red also. </text>
</g>
<!-- block_8&#45;&gt;leaf_39 -->
<g id="edge39" class="edge">
<title>block_8&#45;&gt;leaf_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1686.4398,-1056.3925C1730.5924,-1046.1288 1797.4672,-1030.583 1859.6584,-1016.126"/>
<polygon fill="#000000" stroke="#000000" points="1860.6475,-1019.4894 1869.5953,-1013.816 1859.0625,-1012.6712 1860.6475,-1019.4894"/>
</g>
<!-- codeblock_40 -->
<g id="node41" class="node">
<title>codeblock_40</title>
<ellipse fill="none" stroke="#000000" cx="2282.5" cy="-979.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="2282.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 128&#45;176</text>
</g>
<!-- block_9&#45;&gt;codeblock_40 -->
<g id="edge40" class="edge">
<title>block_9&#45;&gt;codeblock_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2282.5,-1049.6021C2282.5,-1037.4964 2282.5,-1021.4092 2282.5,-1007.6689"/>
<polygon fill="#000000" stroke="#000000" points="2286.0001,-1007.2735 2282.5,-997.2735 2279.0001,-1007.2736 2286.0001,-1007.2735"/>
</g>
<!-- leaf_42 -->
<g id="node43" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="2441.5,-997.2015 2387.5,-997.2015 2387.5,-961.2015 2441.5,-961.2015 2441.5,-997.2015"/>
</g>
<!-- block_9&#45;&gt;leaf_42 -->
<g id="edge42" class="edge">
<title>block_9&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2315.3335,-1052.2008C2334.4982,-1042.3381 2358.7201,-1028.7415 2378.5,-1014.0016 2382.3903,-1011.1025 2386.2954,-1007.8135 2390.024,-1004.4423"/>
<polygon fill="#000000" stroke="#000000" points="2392.5015,-1006.9166 2397.3681,-997.5056 2387.6949,-1001.8277 2392.5015,-1006.9166"/>
</g>
<!-- structure_43 -->
<g id="node44" class="node">
<title>structure_43</title>
<ellipse fill="none" stroke="#000000" cx="2504.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2504.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_43 -->
<g id="edge43" class="edge">
<title>block_10&#45;&gt;structure_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2631.2056,-1052.4071C2609.824,-1042.0984 2581.6389,-1027.9572 2557.5,-1014.0016 2550.3305,-1009.8566 2542.7975,-1005.1422 2535.7338,-1000.5512"/>
<polygon fill="#000000" stroke="#000000" points="2537.3746,-997.4406 2527.1003,-994.8541 2533.5191,-1003.2832 2537.3746,-997.4406"/>
</g>
<!-- structure_44 -->
<g id="node45" class="node">
<title>structure_44</title>
<ellipse fill="none" stroke="#000000" cx="2611.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2611.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_44 -->
<g id="edge44" class="edge">
<title>block_10&#45;&gt;structure_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2653.7747,-1050.0315C2646.182,-1037.3103 2635.8731,-1020.038 2627.3362,-1005.7346"/>
<polygon fill="#000000" stroke="#000000" points="2630.159,-1003.6348 2622.0285,-996.8417 2624.1482,-1007.2224 2630.159,-1003.6348"/>
</g>
<!-- structure_45 -->
<g id="node46" class="node">
<title>structure_45</title>
<ellipse fill="none" stroke="#000000" cx="2718.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2718.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_45 -->
<g id="edge45" class="edge">
<title>block_10&#45;&gt;structure_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2675.4277,-1050.0315C2683.1636,-1037.3103 2693.667,-1020.038 2702.365,-1005.7346"/>
<polygon fill="#000000" stroke="#000000" points="2705.5675,-1007.2045 2707.7728,-996.8417 2699.5865,-1003.5674 2705.5675,-1007.2045"/>
</g>
<!-- structure_46 -->
<g id="node47" class="node">
<title>structure_46</title>
<ellipse fill="none" stroke="#000000" cx="2825.5" cy="-979.2015" rx="44.5182" ry="18"/>
<text text-anchor="middle" x="2825.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">structure</text>
</g>
<!-- block_10&#45;&gt;structure_46 -->
<g id="edge46" class="edge">
<title>block_10&#45;&gt;structure_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2698.1188,-1052.4471C2719.7056,-1042.1543 2748.155,-1028.0159 2772.5,-1014.0016 2779.6773,-1009.8699 2787.2135,-1005.1611 2794.2777,-1000.5713"/>
<polygon fill="#000000" stroke="#000000" points="2796.4927,-1003.303 2802.9109,-994.8734 2792.6368,-997.4607 2796.4927,-1003.303"/>
</g>
<!-- leaf_59 -->
<g id="node60" class="node">
<title>leaf_59</title>
<polygon fill="none" stroke="#c0c0c0" points="2942.5,-997.2015 2888.5,-997.2015 2888.5,-961.2015 2942.5,-961.2015 2942.5,-997.2015"/>
</g>
<!-- block_10&#45;&gt;leaf_59 -->
<g id="edge59" class="edge">
<title>block_10&#45;&gt;leaf_59</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2725.5434,-1061.2804C2770.3765,-1054.3569 2831.5637,-1040.6431 2879.5,-1014.0016 2884.1301,-1011.4283 2888.5958,-1008.1082 2892.7129,-1004.5428"/>
<polygon fill="#000000" stroke="#000000" points="2895.2861,-1006.9267 2900.1524,-997.5156 2890.4794,-1001.838 2895.2861,-1006.9267"/>
</g>
<!-- codeblock_60 -->
<g id="node61" class="node">
<title>codeblock_60</title>
<ellipse fill="none" stroke="#000000" cx="3053.5" cy="-979.2015" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="3053.5" y="-975.0015" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 183&#45;196</text>
</g>
<!-- block_11&#45;&gt;codeblock_60 -->
<g id="edge60" class="edge">
<title>block_11&#45;&gt;codeblock_60</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3053.5,-1049.6021C3053.5,-1037.4964 3053.5,-1021.4092 3053.5,-1007.6689"/>
<polygon fill="#000000" stroke="#000000" points="3057.0001,-1007.2735 3053.5,-997.2735 3050.0001,-1007.2736 3057.0001,-1007.2735"/>
</g>
<!-- leaf_62 -->
<g id="node63" class="node">
<title>leaf_62</title>
<polygon fill="none" stroke="#c0c0c0" points="3212.5,-997.2015 3158.5,-997.2015 3158.5,-961.2015 3212.5,-961.2015 3212.5,-997.2015"/>
</g>
<!-- block_11&#45;&gt;leaf_62 -->
<g id="edge62" class="edge">
<title>block_11&#45;&gt;leaf_62</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3086.3335,-1052.2008C3105.4982,-1042.3381 3129.7201,-1028.7415 3149.5,-1014.0016 3153.3903,-1011.1025 3157.2954,-1007.8135 3161.024,-1004.4423"/>
<polygon fill="#000000" stroke="#000000" points="3163.5015,-1006.9166 3168.3681,-997.5056 3158.6949,-1001.8277 3163.5015,-1006.9166"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="471,-584.6016 0,-584.6016 0,-467.7998 471,-467.7998 471,-584.6016"/>
<text text-anchor="middle" x="235.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; Generates a terminal syntax highlighter for a given grammar. </text>
<text text-anchor="middle" x="235.5" y="-537.8008" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local clu = require &quot;clu/prelude&quot;</text>
<text text-anchor="middle" x="235.5" y="-522.4007" font-family="Inconsolata" font-size="14.00" fill="#000000">local lpeg = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="235.5" y="-507.0007" font-family="Inconsolata" font-size="14.00" fill="#000000">local ast = require &quot;peg/ast&quot;</text>
<text text-anchor="middle" x="235.5" y="-491.6007" font-family="Inconsolata" font-size="14.00" fill="#000000">local util = require &quot;lib/util&quot;</text>
<text text-anchor="middle" x="235.5" y="-476.2007" font-family="Inconsolata" font-size="14.00" fill="#000000">local tableand = util.tableand</text>
</g>
<!-- codeblock_13&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>codeblock_13&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M235.5,-961.1638C235.5,-900.4272 235.5,-701.2187 235.5,-594.7466"/>
<polygon fill="#000000" stroke="#000000" points="239.0001,-594.7401 235.5,-584.7401 232.0001,-594.7402 239.0001,-594.7401"/>
</g>
<!-- leaf_17 -->
<g id="node18" class="node">
<title>leaf_17</title>
<polygon fill="none" stroke="#c0c0c0" points="908,-878.302 493,-878.302 493,-174.0994 908,-174.0994 908,-878.302"/>
<text text-anchor="middle" x="700.5" y="-863.3013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local p = clu.env.palette</text>
<text text-anchor="middle" x="700.5" y="-831.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> testrules = { atom &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;White&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-816.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;pattern &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Blue&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-801.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;optional &#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-785.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;more_than_one &#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-770.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_number &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-754.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;some_suffix &#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-739.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;which_suffix &#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-724.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;maybe &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Green&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-708.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;set &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-693.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;range &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-677.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;literal &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Yellow&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-662.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PEL &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-647.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;PER &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-631.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_rule &#160;&#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-616.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_pattern = {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-600.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;hidden_match &#160;&#160;= {&quot;Cyan&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-585.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;repeats &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Red&quot;,&quot;Clear&quot;},</text>
<text text-anchor="middle" x="700.5" y="-570.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;comment &#160;&#160;&#160;&#160;&#160;&#160;&#160;= {&quot;Grey&quot;,&quot;Clear&quot;}}</text>
<text text-anchor="middle" x="700.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000">function makerules(rules)</text>
<text text-anchor="middle" x="700.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local rule_table = {}</text>
<text text-anchor="middle" x="700.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local p = nil</text>
<text text-anchor="middle" x="700.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#45;&#45; this logic belongs in a palette </text>
<text text-anchor="middle" x="700.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#45;&#45; object which may be called. </text>
<text text-anchor="middle" x="700.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if clu.env.ansi then </text>
<text text-anchor="middle" x="700.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.default</text>
<text text-anchor="middle" x="700.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="700.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;p = clu.env.palette.no_color</text>
<text text-anchor="middle" x="700.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end </text>
<text text-anchor="middle" x="700.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for k,v in pairs(rules) do</text>
<text text-anchor="middle" x="700.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(v) == &quot;table&quot; then </text>
<text text-anchor="middle" x="700.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rule_table[k] = { p[v[1]] , p[v[2]] }</text>
<text text-anchor="middle" x="700.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else &#45;&#45; string or function</text>
<text text-anchor="middle" x="700.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;error &quot;error in makerules, non&#45;table values NYI&quot;</text>
<text text-anchor="middle" x="700.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="700.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="700.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return rule_table</text>
<text text-anchor="middle" x="700.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="700.5" y="-182.1001" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;local testrules = { atom = {&quot;&quot;,&quot;&quot;}, lhs = {&quot;&quot;,&quot;&quot;}}</text>
</g>
<!-- codeblock_16&#45;&gt;leaf_17 -->
<g id="edge17" class="edge">
<title>codeblock_16&#45;&gt;leaf_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M757.1507,-961.1638C755.0718,-945.2015 751.7471,-919.6751 747.7234,-888.7813"/>
<polygon fill="#000000" stroke="#000000" points="751.1555,-888.0318 746.3932,-878.5676 744.2141,-888.9359 751.1555,-888.0318"/>
</g>
<!-- leaf_21 -->
<g id="node22" class="node">
<title>leaf_21</title>
<polygon fill="none" stroke="#c0c0c0" points="1404.5,-908.6023 926.5,-908.6023 926.5,-143.7992 1404.5,-143.7992 1404.5,-908.6023"/>
<text text-anchor="middle" x="1165.5" y="-893.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_value(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-877.8014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-862.4014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-847.0013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;if type (rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1165.5" y="-831.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule..ast.val..p.Clear</text>
<text text-anchor="middle" x="1165.5" y="-816.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;table&quot; then &#45;&#45; pre and post</text>
<text text-anchor="middle" x="1165.5" y="-800.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]..ast.val..rule[2]</text>
<text text-anchor="middle" x="1165.5" y="-785.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type (rule) == &quot;function&quot; then &#45;&#45; function over value</text>
<text text-anchor="middle" x="1165.5" y="-770.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_value&quot;</text>
<text text-anchor="middle" x="1165.5" y="-754.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-739.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-723.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1165.5" y="-708.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;return ast.val</text>
<text text-anchor="middle" x="1165.5" y="-693.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-677.601" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-646.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_open(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-630.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-615.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-600.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then &#45;&#45; pre only</text>
<text text-anchor="middle" x="1165.5" y="-584.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule</text>
<text text-anchor="middle" x="1165.5" y="-569.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then &#45;&#45; use pre</text>
<text text-anchor="middle" x="1165.5" y="-553.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[1]</text>
<text text-anchor="middle" x="1165.5" y="-538.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then &#45;&#45; fn over span</text>
<text text-anchor="middle" x="1165.5" y="-523.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_start&quot;</text>
<text text-anchor="middle" x="1165.5" y="-507.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-492.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-476.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="1165.5" y="-461.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot; </text>
<text text-anchor="middle" x="1165.5" y="-446.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-430.6005" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-399.2005" font-family="Inconsolata" font-size="14.00" fill="#000000">local function rulewrap_close(ast,rules)</text>
<text text-anchor="middle" x="1165.5" y="-383.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules[ast.id] then</text>
<text text-anchor="middle" x="1165.5" y="-368.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local rule = rules[ast.id]</text>
<text text-anchor="middle" x="1165.5" y="-353.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(rule) == &quot;string&quot; then </text>
<text text-anchor="middle" x="1165.5" y="-337.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-322.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;table&quot; then</text>
<text text-anchor="middle" x="1165.5" y="-306.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return rule[2]</text>
<text text-anchor="middle" x="1165.5" y="-291.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif type(rule) == &quot;function&quot; then</text>
<text text-anchor="middle" x="1165.5" y="-276.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;print &quot;function reached in rulewrap_close&quot;</text>
<text text-anchor="middle" x="1165.5" y="-260.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-245.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-229.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="1165.5" y="-214.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return &quot;&quot;</text>
<text text-anchor="middle" x="1165.5" y="-199.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="1165.5" y="-183.6001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1165.5" y="-152.2" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; highlights a Node.</text>
</g>
<!-- codeblock_20&#45;&gt;leaf_21 -->
<g id="edge21" class="edge">
<title>codeblock_20&#45;&gt;leaf_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1255.7571,-961.1638C1253.5819,-950.6811 1250.5507,-936.0735 1246.9103,-918.5297"/>
<polygon fill="#000000" stroke="#000000" points="1250.2856,-917.5689 1244.8267,-908.4886 1243.4316,-918.9912 1250.2856,-917.5689"/>
</g>
<!-- handleline_27 -->
<g id="node28" class="node">
<title>handleline_27</title>
<ellipse fill="none" stroke="#000000" cx="1472.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1472.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_23&#45;&gt;handleline_27 -->
<g id="edge27" class="edge">
<title>structure_23&#45;&gt;handleline_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1476.3407,-961.1638C1475.7255,-891.4843 1473.5009,-639.5533 1472.7498,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1476.248,-554.2586 1472.6597,-544.29 1469.2483,-554.3205 1476.248,-554.2586"/>
</g>
<!-- handleline_30 -->
<g id="node31" class="node">
<title>handleline_30</title>
<ellipse fill="none" stroke="#000000" cx="1591.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1591.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_24&#45;&gt;handleline_30 -->
<g id="edge30" class="edge">
<title>structure_24&#45;&gt;handleline_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1583.8185,-961.1638C1585.0491,-891.4843 1589.4982,-639.5533 1591.0005,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1594.5033,-554.3502 1591.1805,-544.29 1587.5044,-554.2266 1594.5033,-554.3502"/>
</g>
<!-- handleline_33 -->
<g id="node34" class="node">
<title>handleline_33</title>
<ellipse fill="none" stroke="#000000" cx="1710.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1710.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_25&#45;&gt;handleline_33 -->
<g id="edge33" class="edge">
<title>structure_25&#45;&gt;handleline_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1691.2964,-961.1638C1694.3727,-891.4843 1705.4955,-639.5533 1709.2512,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1712.7568,-554.4346 1709.7014,-544.29 1705.7636,-554.1258 1712.7568,-554.4346"/>
</g>
<!-- handleline_36 -->
<g id="node37" class="node">
<title>handleline_36</title>
<ellipse fill="none" stroke="#000000" cx="1829.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="1829.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_26&#45;&gt;handleline_36 -->
<g id="edge36" class="edge">
<title>structure_26&#45;&gt;handleline_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1798.7742,-961.1638C1803.6963,-891.4843 1821.4928,-639.5533 1827.502,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="1831.0087,-554.5118 1828.2222,-544.29 1824.0261,-554.0185 1831.0087,-554.5118"/>
</g>
<!-- handle_28 -->
<g id="node29" class="node">
<title>handle_28</title>
<ellipse fill="none" stroke="#000000" cx="1472.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1472.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_27&#45;&gt;handle_28 -->
<g id="edge28" class="edge">
<title>handleline_27&#45;&gt;handle_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1472.5,-508.0131C1472.5,-440.1164 1472.5,-201.1496 1472.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1476.0001,-118.2653 1472.5,-108.2653 1469.0001,-118.2653 1476.0001,-118.2653"/>
</g>
<!-- leaf_29 -->
<g id="node30" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="1499.5,-36 1445.5,-36 1445.5,0 1499.5,0 1499.5,-36"/>
</g>
<!-- handle_28&#45;&gt;leaf_29 -->
<g id="edge29" class="edge">
<title>handle_28&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1472.5,-71.8314C1472.5,-64.131 1472.5,-54.9743 1472.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1476.0001,-46.4132 1472.5,-36.4133 1469.0001,-46.4133 1476.0001,-46.4132"/>
</g>
<!-- handle_31 -->
<g id="node32" class="node">
<title>handle_31</title>
<ellipse fill="none" stroke="#000000" cx="1591.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1591.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_30&#45;&gt;handle_31 -->
<g id="edge31" class="edge">
<title>handleline_30&#45;&gt;handle_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1591.5,-508.0131C1591.5,-440.1164 1591.5,-201.1496 1591.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1595.0001,-118.2653 1591.5,-108.2653 1588.0001,-118.2653 1595.0001,-118.2653"/>
</g>
<!-- leaf_32 -->
<g id="node33" class="node">
<title>leaf_32</title>
<polygon fill="none" stroke="#c0c0c0" points="1618.5,-36 1564.5,-36 1564.5,0 1618.5,0 1618.5,-36"/>
</g>
<!-- handle_31&#45;&gt;leaf_32 -->
<g id="edge32" class="edge">
<title>handle_31&#45;&gt;leaf_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1591.5,-71.8314C1591.5,-64.131 1591.5,-54.9743 1591.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1595.0001,-46.4132 1591.5,-36.4133 1588.0001,-46.4133 1595.0001,-46.4132"/>
</g>
<!-- handle_34 -->
<g id="node35" class="node">
<title>handle_34</title>
<ellipse fill="none" stroke="#000000" cx="1710.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1710.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_33&#45;&gt;handle_34 -->
<g id="edge34" class="edge">
<title>handleline_33&#45;&gt;handle_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1710.5,-508.0131C1710.5,-440.1164 1710.5,-201.1496 1710.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1714.0001,-118.2653 1710.5,-108.2653 1707.0001,-118.2653 1714.0001,-118.2653"/>
</g>
<!-- leaf_35 -->
<g id="node36" class="node">
<title>leaf_35</title>
<polygon fill="none" stroke="#c0c0c0" points="1737.5,-36 1683.5,-36 1683.5,0 1737.5,0 1737.5,-36"/>
</g>
<!-- handle_34&#45;&gt;leaf_35 -->
<g id="edge35" class="edge">
<title>handle_34&#45;&gt;leaf_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1710.5,-71.8314C1710.5,-64.131 1710.5,-54.9743 1710.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1714.0001,-46.4132 1710.5,-36.4133 1707.0001,-46.4133 1714.0001,-46.4132"/>
</g>
<!-- handle_37 -->
<g id="node38" class="node">
<title>handle_37</title>
<ellipse fill="none" stroke="#000000" cx="1829.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="1829.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_36&#45;&gt;handle_37 -->
<g id="edge37" class="edge">
<title>handleline_36&#45;&gt;handle_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1829.5,-508.0131C1829.5,-440.1164 1829.5,-201.1496 1829.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="1833.0001,-118.2653 1829.5,-108.2653 1826.0001,-118.2653 1833.0001,-118.2653"/>
</g>
<!-- leaf_38 -->
<g id="node39" class="node">
<title>leaf_38</title>
<polygon fill="none" stroke="#c0c0c0" points="1856.5,-36 1802.5,-36 1802.5,0 1856.5,0 1856.5,-36"/>
</g>
<!-- handle_37&#45;&gt;leaf_38 -->
<g id="edge38" class="edge">
<title>handle_37&#45;&gt;leaf_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1829.5,-71.8314C1829.5,-64.131 1829.5,-54.9743 1829.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="1833.0001,-46.4132 1829.5,-36.4133 1826.0001,-46.4133 1833.0001,-46.4132"/>
</g>
<!-- leaf_41 -->
<g id="node42" class="node">
<title>leaf_41</title>
<polygon fill="none" stroke="#c0c0c0" points="2418,-892.7021 1975,-892.7021 1975,-159.6993 2418,-159.6993 2418,-892.7021"/>
<text text-anchor="middle" x="2196.5" y="-877.5014" font-family="Inconsolata" font-size="14.00" fill="#000000">local function light(ast, rules)</text>
<text text-anchor="middle" x="2196.5" y="-862.1014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if rules then </text>
<text text-anchor="middle" x="2196.5" y="-846.7014" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(rules)</text>
<text text-anchor="middle" x="2196.5" y="-831.3013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else </text>
<text text-anchor="middle" x="2196.5" y="-815.9013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;rules = makerules(testrules) </text>
<text text-anchor="middle" x="2196.5" y="-800.5013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-769.1012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local source = ast:root().str</text>
<text text-anchor="middle" x="2196.5" y="-753.7012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local queue = {}</text>
<text text-anchor="middle" x="2196.5" y="-738.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local phrase = &quot;&quot;</text>
<text text-anchor="middle" x="2196.5" y="-722.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local cursor = 1</text>
<text text-anchor="middle" x="2196.5" y="-707.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local gap = &quot;&quot;</text>
<text text-anchor="middle" x="2196.5" y="-692.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local ndx, first, last = ast:range()</text>
<text text-anchor="middle" x="2196.5" y="-676.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local new = true</text>
<text text-anchor="middle" x="2196.5" y="-661.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;for i = first, last do</text>
<text text-anchor="middle" x="2196.5" y="-645.901" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local node, close, _ = ndx(i)</text>
<text text-anchor="middle" x="2196.5" y="-630.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if rules[node.id] </text>
<text text-anchor="middle" x="2196.5" y="-615.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;and node.val == nil then &#45;&#45; open regional rule</text>
<text text-anchor="middle" x="2196.5" y="-599.7009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-584.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.first</text>
<text text-anchor="middle" x="2196.5" y="-568.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;queue[close] = node</text>
<text text-anchor="middle" x="2196.5" y="-553.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_open(node,rules)</text>
<text text-anchor="middle" x="2196.5" y="-538.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;elseif node.id and node.val then &#45;&#45; wrap values in rule</text>
<text text-anchor="middle" x="2196.5" y="-522.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if new then </text>
<text text-anchor="middle" x="2196.5" y="-507.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..source:sub(1,ndx[1].first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-491.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;new = false</text>
<text text-anchor="middle" x="2196.5" y="-476.5006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-461.1006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;if cursor &lt;= node.first then</text>
<text text-anchor="middle" x="2196.5" y="-445.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,node.first&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-430.3005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-414.9005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = node.last+1</text>
<text text-anchor="middle" x="2196.5" y="-399.5005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase..gap..rulewrap_value(node,rules)</text>
<text text-anchor="middle" x="2196.5" y="-384.1005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-368.7004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if queue[i] then &#45;&#45; close regional rule</text>
<text text-anchor="middle" x="2196.5" y="-353.3004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;gap = source:sub(cursor,queue[i].last&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-337.9004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;cursor = queue[i].last</text>
<text text-anchor="middle" x="2196.5" y="-322.5003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;phrase = phrase</text>
<text text-anchor="middle" x="2196.5" y="-307.1003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_open(queue[i],rules)</text>
<text text-anchor="middle" x="2196.5" y="-291.7003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..gap</text>
<text text-anchor="middle" x="2196.5" y="-276.3002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;..rulewrap_close(queue[i],rules)</text>
<text text-anchor="middle" x="2196.5" y="-260.9002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-245.5002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="2196.5" y="-230.1001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;phrase = phrase..source:sub(cursor,&#45;1)</text>
<text text-anchor="middle" x="2196.5" y="-214.7001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return phrase</text>
<text text-anchor="middle" x="2196.5" y="-199.3001" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="2196.5" y="-167.9" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45;&#45; generates a highlighter from a rule table</text>
</g>
<!-- codeblock_40&#45;&gt;leaf_41 -->
<g id="edge41" class="edge">
<title>codeblock_40&#45;&gt;leaf_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2279.0756,-961.1638C2276.5246,-947.7261 2272.6867,-927.5103 2268.0374,-903.0204"/>
<polygon fill="#000000" stroke="#000000" points="2271.4479,-902.2194 2266.1441,-893.0477 2264.5707,-903.525 2271.4479,-902.2194"/>
</g>
<!-- handleline_47 -->
<g id="node48" class="node">
<title>handleline_47</title>
<ellipse fill="none" stroke="#000000" cx="2486.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2486.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_43&#45;&gt;handleline_47 -->
<g id="edge47" class="edge">
<title>structure_43&#45;&gt;handleline_47</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2503.7833,-961.1638C2501.0146,-891.4843 2491.0041,-639.5533 2487.6239,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2491.1131,-554.1431 2487.2188,-544.29 2484.1187,-554.4211 2491.1131,-554.1431"/>
</g>
<!-- handleline_50 -->
<g id="node51" class="node">
<title>handleline_50</title>
<ellipse fill="none" stroke="#000000" cx="2605.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2605.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_44&#45;&gt;handleline_50 -->
<g id="edge50" class="edge">
<title>structure_44&#45;&gt;handleline_50</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2611.2611,-961.1638C2610.3382,-891.4843 2607.0014,-639.5533 2605.8746,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2609.3718,-554.2427 2605.7396,-544.29 2602.3724,-554.3355 2609.3718,-554.2427"/>
</g>
<!-- handleline_53 -->
<g id="node54" class="node">
<title>handleline_53</title>
<ellipse fill="none" stroke="#000000" cx="2724.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2724.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_45&#45;&gt;handleline_53 -->
<g id="edge53" class="edge">
<title>structure_45&#45;&gt;handleline_53</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2718.7389,-961.1638C2719.6618,-891.4843 2722.9986,-639.5533 2724.1254,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2727.6276,-554.3355 2724.2604,-544.29 2720.6282,-554.2427 2727.6276,-554.3355"/>
</g>
<!-- handleline_56 -->
<g id="node57" class="node">
<title>handleline_56</title>
<ellipse fill="none" stroke="#000000" cx="2843.5" cy="-526.2007" rx="50.3585" ry="18"/>
<text text-anchor="middle" x="2843.5" y="-522.0007" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handleline</text>
</g>
<!-- structure_46&#45;&gt;handleline_56 -->
<g id="edge56" class="edge">
<title>structure_46&#45;&gt;handleline_56</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2826.2167,-961.1638C2828.9854,-891.4843 2838.9959,-639.5533 2842.3761,-554.4851"/>
<polygon fill="#000000" stroke="#000000" points="2845.8813,-554.4211 2842.7812,-544.29 2838.8869,-554.1431 2845.8813,-554.4211"/>
</g>
<!-- handle_48 -->
<g id="node49" class="node">
<title>handle_48</title>
<ellipse fill="none" stroke="#000000" cx="2486.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2486.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_47&#45;&gt;handle_48 -->
<g id="edge48" class="edge">
<title>handleline_47&#45;&gt;handle_48</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2486.5,-508.0131C2486.5,-440.1164 2486.5,-201.1496 2486.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2490.0001,-118.2653 2486.5,-108.2653 2483.0001,-118.2653 2490.0001,-118.2653"/>
</g>
<!-- leaf_49 -->
<g id="node50" class="node">
<title>leaf_49</title>
<polygon fill="none" stroke="#c0c0c0" points="2513.5,-36 2459.5,-36 2459.5,0 2513.5,0 2513.5,-36"/>
</g>
<!-- handle_48&#45;&gt;leaf_49 -->
<g id="edge49" class="edge">
<title>handle_48&#45;&gt;leaf_49</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2486.5,-71.8314C2486.5,-64.131 2486.5,-54.9743 2486.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2490.0001,-46.4132 2486.5,-36.4133 2483.0001,-46.4133 2490.0001,-46.4132"/>
</g>
<!-- handle_51 -->
<g id="node52" class="node">
<title>handle_51</title>
<ellipse fill="none" stroke="#000000" cx="2605.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2605.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_50&#45;&gt;handle_51 -->
<g id="edge51" class="edge">
<title>handleline_50&#45;&gt;handle_51</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2605.5,-508.0131C2605.5,-440.1164 2605.5,-201.1496 2605.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2609.0001,-118.2653 2605.5,-108.2653 2602.0001,-118.2653 2609.0001,-118.2653"/>
</g>
<!-- leaf_52 -->
<g id="node53" class="node">
<title>leaf_52</title>
<polygon fill="none" stroke="#c0c0c0" points="2632.5,-36 2578.5,-36 2578.5,0 2632.5,0 2632.5,-36"/>
</g>
<!-- handle_51&#45;&gt;leaf_52 -->
<g id="edge52" class="edge">
<title>handle_51&#45;&gt;leaf_52</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2605.5,-71.8314C2605.5,-64.131 2605.5,-54.9743 2605.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2609.0001,-46.4132 2605.5,-36.4133 2602.0001,-46.4133 2609.0001,-46.4132"/>
</g>
<!-- handle_54 -->
<g id="node55" class="node">
<title>handle_54</title>
<ellipse fill="none" stroke="#000000" cx="2724.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2724.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_53&#45;&gt;handle_54 -->
<g id="edge54" class="edge">
<title>handleline_53&#45;&gt;handle_54</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2724.5,-508.0131C2724.5,-440.1164 2724.5,-201.1496 2724.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2728.0001,-118.2653 2724.5,-108.2653 2721.0001,-118.2653 2728.0001,-118.2653"/>
</g>
<!-- leaf_55 -->
<g id="node56" class="node">
<title>leaf_55</title>
<polygon fill="none" stroke="#c0c0c0" points="2751.5,-36 2697.5,-36 2697.5,0 2751.5,0 2751.5,-36"/>
</g>
<!-- handle_54&#45;&gt;leaf_55 -->
<g id="edge55" class="edge">
<title>handle_54&#45;&gt;leaf_55</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2724.5,-71.8314C2724.5,-64.131 2724.5,-54.9743 2724.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2728.0001,-46.4132 2724.5,-36.4133 2721.0001,-46.4133 2728.0001,-46.4132"/>
</g>
<!-- handle_57 -->
<g id="node58" class="node">
<title>handle_57</title>
<ellipse fill="none" stroke="#000000" cx="2843.5" cy="-90" rx="36.827" ry="18"/>
<text text-anchor="middle" x="2843.5" y="-85.8" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">handle</text>
</g>
<!-- handleline_56&#45;&gt;handle_57 -->
<g id="edge57" class="edge">
<title>handleline_56&#45;&gt;handle_57</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2843.5,-508.0131C2843.5,-440.1164 2843.5,-201.1496 2843.5,-118.4323"/>
<polygon fill="#000000" stroke="#000000" points="2847.0001,-118.2653 2843.5,-108.2653 2840.0001,-118.2653 2847.0001,-118.2653"/>
</g>
<!-- leaf_58 -->
<g id="node59" class="node">
<title>leaf_58</title>
<polygon fill="none" stroke="#c0c0c0" points="2870.5,-36 2816.5,-36 2816.5,0 2870.5,0 2870.5,-36"/>
</g>
<!-- handle_57&#45;&gt;leaf_58 -->
<g id="edge58" class="edge">
<title>handle_57&#45;&gt;leaf_58</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2843.5,-71.8314C2843.5,-64.131 2843.5,-54.9743 2843.5,-46.4166"/>
<polygon fill="#000000" stroke="#000000" points="2847.0001,-46.4132 2843.5,-36.4133 2840.0001,-46.4133 2847.0001,-46.4132"/>
</g>
<!-- leaf_61 -->
<g id="node62" class="node">
<title>leaf_61</title>
<polygon fill="none" stroke="#c0c0c0" points="3221.5,-623.1015 2911.5,-623.1015 2911.5,-429.3 3221.5,-429.3 3221.5,-623.1015"/>
<text text-anchor="middle" x="3066.5" y="-607.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">local function Highlighter(parser, rules)</text>
<text text-anchor="middle" x="3066.5" y="-592.3009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local function lighter(source)</text>
<text text-anchor="middle" x="3066.5" y="-576.9008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if type(source) == &quot;string&quot; then</text>
<text text-anchor="middle" x="3066.5" y="-561.5008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;source = ast.parse(parser,source)</text>
<text text-anchor="middle" x="3066.5" y="-546.1008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="3066.5" y="-530.7007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return light(source, rules)</text>
<text text-anchor="middle" x="3066.5" y="-515.3007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="3066.5" y="-499.9007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return lighter</text>
<text text-anchor="middle" x="3066.5" y="-484.5006" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="3066.5" y="-453.1006" font-family="Inconsolata" font-size="14.00" fill="#000000">return {Highlighter = Highlighter,</text>
<text text-anchor="middle" x="3066.5" y="-437.7006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;light = light}</text>
</g>
<!-- codeblock_60&#45;&gt;leaf_61 -->
<g id="edge61" class="edge">
<title>codeblock_60&#45;&gt;leaf_61</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M3054.0176,-961.1638C3055.5678,-907.1479 3060.2609,-743.6092 3063.4298,-633.1841"/>
<polygon fill="#000000" stroke="#000000" points="3066.9336,-633.0988 3063.722,-623.0024 3059.9365,-632.8979 3066.9336,-633.0988"/>
</g>
</g>
</svg>