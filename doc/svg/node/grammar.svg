<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="2516pt" height="1404pt"
 viewBox="0.00 0.00 2516.00 1404.40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 1400.4021)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-1400.4021 2512,-1400.4021 2512,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="318" cy="-1378.4021" rx="46.9581" ry="18"/>
<text text-anchor="middle" x="318" y="-1374.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 142</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="318" cy="-1306.4021" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="318" y="-1302.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;36</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M318,-1360.2334C318,-1352.533 318,-1343.3764 318,-1334.8187"/>
<polygon fill="#000000" stroke="#000000" points="321.5001,-1334.8153 318,-1324.8153 314.5001,-1334.8154 321.5001,-1334.8153"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="122" cy="-1234.4021" rx="91.3932" ry="18"/>
<text text-anchor="middle" x="122" y="-1230.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Grammar Module</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M279.7439,-1292.3488C249.832,-1281.3608 207.9122,-1265.9616 174.8043,-1253.7996"/>
<polygon fill="#000000" stroke="#000000" points="175.8711,-1250.4628 165.2775,-1250.2999 173.4573,-1257.0335 175.8711,-1250.4628"/>
</g>
<!-- prose_3 -->
<g id="node4" class="node">
<title>prose_3</title>
<ellipse fill="none" stroke="#000000" cx="263" cy="-1234.4021" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="263" y="-1230.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_1&#45;&gt;prose_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;prose_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M304.4045,-1288.6043C297.6139,-1279.7148 289.2883,-1268.8159 281.8881,-1259.1284"/>
<polygon fill="#000000" stroke="#000000" points="284.5368,-1256.83 275.685,-1251.0079 278.9741,-1261.0793 284.5368,-1256.83"/>
</g>
<!-- section_4 -->
<g id="node5" class="node">
<title>section_4</title>
<ellipse fill="none" stroke="#000000" cx="374" cy="-1234.4021" rx="60.9826" ry="18"/>
<text text-anchor="middle" x="374" y="-1230.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 4&#45;36</text>
</g>
<!-- section_1&#45;&gt;section_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;section_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M331.8427,-1288.6043C338.5563,-1279.9725 346.7436,-1269.446 354.1109,-1259.9737"/>
<polygon fill="#000000" stroke="#000000" points="356.9398,-1262.0374 360.3165,-1251.9951 351.4143,-1257.7398 356.9398,-1262.0374"/>
</g>
<!-- section_5 -->
<g id="node6" class="node">
<title>section_5</title>
<ellipse fill="none" stroke="#000000" cx="1438" cy="-1234.4021" rx="70.655" ry="18"/>
<text text-anchor="middle" x="1438" y="-1230.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 37&#45;142</text>
</g>
<!-- section_1&#45;&gt;section_5 -->
<g id="edge5" class="edge">
<title>section_1&#45;&gt;section_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M377.4253,-1302.5819C565.3054,-1290.5039 1146.5688,-1253.1369 1359.1185,-1239.473"/>
<polygon fill="#000000" stroke="#000000" points="1359.5065,-1242.9554 1369.2614,-1238.821 1359.0574,-1235.9698 1359.5065,-1242.9554"/>
</g>
<!-- leaf_6 -->
<g id="node7" class="node">
<title>leaf_6</title>
<polygon fill="none" stroke="#c0c0c0" points="74,-1180.4021 20,-1180.4021 20,-1140.4021 74,-1140.4021 74,-1180.4021"/>
</g>
<!-- prose_3&#45;&gt;leaf_6 -->
<g id="edge6" class="edge">
<title>prose_3&#45;&gt;leaf_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M238.1016,-1222.7127C232.8456,-1220.4602 227.2887,-1218.2346 222,-1216.4021 164.6455,-1196.5285 144.2538,-1203.3206 83.8021,-1180.2303"/>
<polygon fill="#000000" stroke="#000000" points="84.752,-1176.8427 74.1652,-1176.4304 82.1842,-1183.3547 84.752,-1176.8427"/>
</g>
<!-- header_7 -->
<g id="node8" class="node">
<title>header_7</title>
<ellipse fill="none" stroke="#000000" cx="147" cy="-1160.4021" rx="54.6851" ry="18"/>
<text text-anchor="middle" x="147" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : includes</text>
</g>
<!-- section_4&#45;&gt;header_7 -->
<g id="edge7" class="edge">
<title>section_4&#45;&gt;header_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M332.892,-1221.0012C294.4136,-1208.4576 236.8838,-1189.7034 196.0289,-1176.385"/>
<polygon fill="#000000" stroke="#000000" points="196.8756,-1172.9799 186.2833,-1173.2081 194.706,-1179.6352 196.8756,-1172.9799"/>
</g>
<!-- prose_8 -->
<g id="node9" class="node">
<title>prose_8</title>
<ellipse fill="none" stroke="#000000" cx="252" cy="-1160.4021" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="252" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_4&#45;&gt;prose_8 -->
<g id="edge8" class="edge">
<title>section_4&#45;&gt;prose_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M347.2266,-1218.1624C328.2488,-1206.6513 302.7362,-1191.1765 282.8949,-1179.1416"/>
<polygon fill="#000000" stroke="#000000" points="284.5868,-1176.0743 274.2215,-1173.8807 280.9565,-1182.0594 284.5868,-1176.0743"/>
</g>
<!-- codeblock_9 -->
<g id="node10" class="node">
<title>codeblock_9</title>
<ellipse fill="none" stroke="#000000" cx="374" cy="-1160.4021" rx="71.7805" ry="18"/>
<text text-anchor="middle" x="374" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 6&#45;11</text>
</g>
<!-- section_4&#45;&gt;codeblock_9 -->
<g id="edge9" class="edge">
<title>section_4&#45;&gt;codeblock_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M374,-1216.1099C374,-1207.8656 374,-1197.9396 374,-1188.7643"/>
<polygon fill="#000000" stroke="#000000" points="377.5001,-1188.4837 374,-1178.4838 370.5001,-1188.4838 377.5001,-1188.4837"/>
</g>
<!-- prose_10 -->
<g id="node11" class="node">
<title>prose_10</title>
<ellipse fill="none" stroke="#000000" cx="496" cy="-1160.4021" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="496" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_4&#45;&gt;prose_10 -->
<g id="edge10" class="edge">
<title>section_4&#45;&gt;prose_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M400.7734,-1218.1624C419.7512,-1206.6513 445.2638,-1191.1765 465.1051,-1179.1416"/>
<polygon fill="#000000" stroke="#000000" points="467.0435,-1182.0594 473.7785,-1173.8807 463.4132,-1176.0743 467.0435,-1182.0594"/>
</g>
<!-- codeblock_11 -->
<g id="node12" class="node">
<title>codeblock_11</title>
<ellipse fill="none" stroke="#000000" cx="742" cy="-1160.4021" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="742" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 17&#45;34</text>
</g>
<!-- section_4&#45;&gt;codeblock_11 -->
<g id="edge11" class="edge">
<title>section_4&#45;&gt;codeblock_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M424.3972,-1224.2678C488.9769,-1211.2817 601.1958,-1188.716 673.4885,-1174.1788"/>
<polygon fill="#000000" stroke="#000000" points="674.3015,-1177.5855 683.4152,-1172.1827 672.9215,-1170.7229 674.3015,-1177.5855"/>
</g>
<!-- header_16 -->
<g id="node17" class="node">
<title>header_16</title>
<ellipse fill="none" stroke="#000000" cx="1210" cy="-1160.4021" rx="46.4822" ry="18"/>
<text text-anchor="middle" x="1210" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : define</text>
</g>
<!-- section_5&#45;&gt;header_16 -->
<g id="edge16" class="edge">
<title>section_5&#45;&gt;header_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1392.2147,-1220.5569C1357.4698,-1209.9222 1308.5815,-1194.6842 1266,-1180.4021 1261.9809,-1179.054 1257.8103,-1177.6239 1253.6403,-1176.1726"/>
<polygon fill="#000000" stroke="#000000" points="1254.5776,-1172.7922 1243.9828,-1172.7768 1252.2556,-1179.3959 1254.5776,-1172.7922"/>
</g>
<!-- prose_17 -->
<g id="node18" class="node">
<title>prose_17</title>
<ellipse fill="none" stroke="#000000" cx="1307" cy="-1160.4021" rx="32.4585" ry="18"/>
<text text-anchor="middle" x="1307" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">prose</text>
</g>
<!-- section_5&#45;&gt;prose_17 -->
<g id="edge17" class="edge">
<title>section_5&#45;&gt;prose_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1408.9269,-1217.9791C1388.0848,-1206.2057 1360.0276,-1190.3566 1338.6266,-1178.2675"/>
<polygon fill="#000000" stroke="#000000" points="1340.3311,-1175.2105 1329.9027,-1173.3395 1336.8882,-1181.3053 1340.3311,-1175.2105"/>
</g>
<!-- codeblock_18 -->
<g id="node19" class="node">
<title>codeblock_18</title>
<ellipse fill="none" stroke="#000000" cx="1438" cy="-1160.4021" rx="81.1496" ry="18"/>
<text text-anchor="middle" x="1438" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 39&#45;111</text>
</g>
<!-- section_5&#45;&gt;codeblock_18 -->
<g id="edge18" class="edge">
<title>section_5&#45;&gt;codeblock_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1438,-1216.1099C1438,-1207.8656 1438,-1197.9396 1438,-1188.7643"/>
<polygon fill="#000000" stroke="#000000" points="1441.5001,-1188.4837 1438,-1178.4838 1434.5001,-1188.4838 1441.5001,-1188.4837"/>
</g>
<!-- codeblock_19 -->
<g id="node20" class="node">
<title>codeblock_19</title>
<ellipse fill="none" stroke="#000000" cx="1735" cy="-1160.4021" rx="86.7905" ry="18"/>
<text text-anchor="middle" x="1735" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 113&#45;122</text>
</g>
<!-- section_5&#45;&gt;codeblock_19 -->
<g id="edge19" class="edge">
<title>section_5&#45;&gt;codeblock_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1488.7187,-1221.7651C1538.6289,-1209.3295 1615.067,-1190.2844 1669.5376,-1176.7126"/>
<polygon fill="#000000" stroke="#000000" points="1670.5843,-1180.0588 1679.4415,-1174.2449 1668.8919,-1173.2665 1670.5843,-1180.0588"/>
</g>
<!-- codeblock_20 -->
<g id="node21" class="node">
<title>codeblock_20</title>
<ellipse fill="none" stroke="#000000" cx="2079" cy="-1160.4021" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="2079" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 125&#45;138</text>
</g>
<!-- section_5&#45;&gt;codeblock_20 -->
<g id="edge20" class="edge">
<title>section_5&#45;&gt;codeblock_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1502.3964,-1226.9678C1618.4279,-1213.5726 1862.6133,-1185.3827 1992.8702,-1170.3453"/>
<polygon fill="#000000" stroke="#000000" points="1993.2817,-1173.8211 2002.8143,-1169.1973 1992.4789,-1166.8673 1993.2817,-1173.8211"/>
</g>
<!-- codeblock_21 -->
<g id="node22" class="node">
<title>codeblock_21</title>
<ellipse fill="none" stroke="#000000" cx="2396" cy="-1160.4021" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="2396" y="-1156.2021" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 140&#45;142</text>
</g>
<!-- section_5&#45;&gt;codeblock_21 -->
<g id="edge21" class="edge">
<title>section_5&#45;&gt;codeblock_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1506.3612,-1229.7856C1636.5456,-1220.9071 1929.0168,-1200.5426 2175,-1180.4021 2218.2724,-1176.859 2266.2757,-1172.5594 2306.4581,-1168.856"/>
<polygon fill="#000000" stroke="#000000" points="2306.8624,-1172.3337 2316.4978,-1167.9282 2306.2181,-1165.3634 2306.8624,-1172.3337"/>
</g>
<!-- leaf_12 -->
<g id="node13" class="node">
<title>leaf_12</title>
<polygon fill="none" stroke="#c0c0c0" points="54,-570.201 0,-570.201 0,-534.201 54,-534.201 54,-570.201"/>
</g>
<!-- prose_8&#45;&gt;leaf_12 -->
<g id="edge12" class="edge">
<title>prose_8&#45;&gt;leaf_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M228.5272,-1147.8812C222.8869,-1145.1739 216.8109,-1142.4984 211,-1140.4021 147.3213,-1117.4294 106.5406,-1156.2377 63,-1104.4021 -4.2205,-1024.3751 16.8159,-681.5131 24.646,-580.3834"/>
<polygon fill="#000000" stroke="#000000" points="28.1428,-580.5614 25.4445,-570.316 21.1647,-580.0079 28.1428,-580.5614"/>
</g>
<!-- leaf_13 -->
<g id="node14" class="node">
<title>leaf_13</title>
<polygon fill="none" stroke="#c0c0c0" points="312,-587.4014 72,-587.4014 72,-517.0007 312,-517.0007 312,-587.4014"/>
<text text-anchor="middle" x="192" y="-572.1011" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="192" y="-540.701" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require &quot;status&quot; </text>
<text text-anchor="middle" x="192" y="-525.301" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
</g>
<!-- codeblock_9&#45;&gt;leaf_13 -->
<g id="edge13" class="edge">
<title>codeblock_9&#45;&gt;leaf_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M352.7975,-1142.9929C341.7512,-1132.8334 328.9292,-1119.1366 321,-1104.4021 228.4987,-932.5098 201.901,-695.634 194.6094,-597.549"/>
<polygon fill="#000000" stroke="#000000" points="198.0875,-597.1163 193.8869,-587.3898 191.1052,-597.6129 198.0875,-597.1163"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="661.5,-572.1031 330.5,-572.1031 330.5,-532.2989 661.5,-532.2989 661.5,-572.1031"/>
<text text-anchor="middle" x="496" y="-540.701" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s the kind of thing I&#39;d like to automate. </text>
</g>
<!-- prose_10&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>prose_10&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M496,-1142.1998C496,-1056.2101 496,-690.3583 496,-582.3425"/>
<polygon fill="#000000" stroke="#000000" points="499.5001,-582.1477 496,-572.1477 492.5001,-582.1478 499.5001,-582.1477"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="1038.5,-679.6018 679.5,-679.6018 679.5,-424.8002 1038.5,-424.8002 1038.5,-679.6018"/>
<text text-anchor="middle" x="859" y="-664.2013" font-family="Inconsolata" font-size="14.00" fill="#000000">local assert = assert</text>
<text text-anchor="middle" x="859" y="-648.8012" font-family="Inconsolata" font-size="14.00" fill="#000000">local string, io = assert( string ), assert( io )</text>
<text text-anchor="middle" x="859" y="-633.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = string.sub( assert( _VERSION ), &#45;4 )</text>
<text text-anchor="middle" x="859" y="-618.0012" font-family="Inconsolata" font-size="14.00" fill="#000000">local _G = assert( _G )</text>
<text text-anchor="middle" x="859" y="-602.6012" font-family="Inconsolata" font-size="14.00" fill="#000000">local error = assert( error )</text>
<text text-anchor="middle" x="859" y="-587.2011" font-family="Inconsolata" font-size="14.00" fill="#000000">local pairs = assert( pairs )</text>
<text text-anchor="middle" x="859" y="-571.8011" font-family="Inconsolata" font-size="14.00" fill="#000000">local next = assert( next )</text>
<text text-anchor="middle" x="859" y="-556.4011" font-family="Inconsolata" font-size="14.00" fill="#000000">local type = assert( type )</text>
<text text-anchor="middle" x="859" y="-541.001" font-family="Inconsolata" font-size="14.00" fill="#000000">local tostring = assert( tostring )</text>
<text text-anchor="middle" x="859" y="-525.601" font-family="Inconsolata" font-size="14.00" fill="#000000">local setmetatable = assert( setmetatable )</text>
<text text-anchor="middle" x="859" y="-510.201" font-family="Inconsolata" font-size="14.00" fill="#000000">local setfenv = setfenv</text>
<text text-anchor="middle" x="859" y="-494.8009" font-family="Inconsolata" font-size="14.00" fill="#000000">local getfenv = getfenv</text>
<text text-anchor="middle" x="859" y="-479.4009" font-family="Inconsolata" font-size="14.00" fill="#000000">if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="859" y="-464.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert( setfenv )</text>
<text text-anchor="middle" x="859" y="-448.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert( getfenv )</text>
<text text-anchor="middle" x="859" y="-433.2008" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_11&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>codeblock_11&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M745.5016,-1142.1998C758.2909,-1075.7171 803.2619,-841.9444 832.6104,-689.3821"/>
<polygon fill="#000000" stroke="#000000" points="836.0683,-689.9344 834.5204,-679.4532 829.1943,-688.612 836.0683,-689.9344"/>
</g>
<!-- leaf_22 -->
<g id="node23" class="node">
<title>leaf_22</title>
<polygon fill="none" stroke="#c0c0c0" points="1111,-570.201 1057,-570.201 1057,-534.201 1111,-534.201 1111,-570.201"/>
</g>
<!-- prose_17&#45;&gt;leaf_22 -->
<g id="edge22" class="edge">
<title>prose_17&#45;&gt;leaf_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1283.3662,-1148.1295C1277.4652,-1145.3504 1271.0827,-1142.5804 1265,-1140.4021 1202.4867,-1118.015 1162.587,-1155.3475 1120,-1104.4021 1052.9696,-1024.2158 1073.873,-681.4653 1081.6589,-580.3726"/>
<polygon fill="#000000" stroke="#000000" points="1085.1554,-580.5533 1082.4528,-570.3089 1078.1771,-580.0027 1085.1554,-580.5533"/>
</g>
<!-- leaf_23 -->
<g id="node24" class="node">
<title>leaf_23</title>
<polygon fill="none" stroke="#c0c0c0" points="1635,-1104.6032 1129,-1104.6032 1129,.2011 1635,.2011 1635,-1104.6032"/>
<text text-anchor="middle" x="1382" y="-1089.2021" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_ast_node( id, first, t, last, str, metas)</text>
<text text-anchor="middle" x="1382" y="-1073.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;t.first = first</text>
<text text-anchor="middle" x="1382" y="-1058.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;t.last &#160;= last</text>
<text text-anchor="middle" x="1382" y="-1043.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;t.str &#160;&#160;= str</text>
<text text-anchor="middle" x="1382" y="-1027.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if metas[id] then</text>
<text text-anchor="middle" x="1382" y="-1012.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;io.write(&quot;metatable detected: &quot; .. id .. &quot;\n&quot;)</text>
<text text-anchor="middle" x="1382" y="-996.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;t = metas[id](t, str)</text>
<text text-anchor="middle" x="1382" y="-981.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;assert(t.id == id)</text>
<text text-anchor="middle" x="1382" y="-966.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;else</text>
<text text-anchor="middle" x="1382" y="-950.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;t.id = id</text>
<text text-anchor="middle" x="1382" y="-935.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;setmetatable(t, {__index = Node,</text>
<text text-anchor="middle" x="1382" y="-919.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;__tostring = Node.toString})</text>
<text text-anchor="middle" x="1382" y="-904.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;</text>
<text text-anchor="middle" x="1382" y="-889.0017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="1382" y="-873.6016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert(t.isNode)</text>
<text text-anchor="middle" x="1382" y="-858.2016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert(t.str)</text>
<text text-anchor="middle" x="1382" y="-842.8016" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return t</text>
<text text-anchor="middle" x="1382" y="-827.4015" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="1382" y="-780.0015" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; some useful/common lpeg patterns</text>
<text text-anchor="middle" x="1382" y="-764.6015" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cp = L.Cp</text>
<text text-anchor="middle" x="1382" y="-749.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cc = L.Cc</text>
<text text-anchor="middle" x="1382" y="-733.8014" font-family="Inconsolata" font-size="14.00" fill="#000000">local Ct = L.Ct</text>
<text text-anchor="middle" x="1382" y="-718.4014" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg1_str = L.Carg(1)</text>
<text text-anchor="middle" x="1382" y="-703.0013" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg2_metas = L.Carg(2)</text>
<text text-anchor="middle" x="1382" y="-655.6013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; setup an environment where you can easily define lpeg grammars</text>
<text text-anchor="middle" x="1382" y="-640.2013" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; with lots of syntax sugar</text>
<text text-anchor="middle" x="1382" y="-624.8012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function define(func, g, e)</text>
<text text-anchor="middle" x="1382" y="-609.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;g = g or {}</text>
<text text-anchor="middle" x="1382" y="-594.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if e == nil then</text>
<text text-anchor="middle" x="1382" y="-578.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;e = V == &quot; 5.1&quot; and getfenv(func) or _G</text>
<text text-anchor="middle" x="1382" y="-563.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="1382" y="-547.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local suppressed = {}</text>
<text text-anchor="middle" x="1382" y="-532.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env = {}</text>
<text text-anchor="middle" x="1382" y="-517.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env_index = {</text>
<text text-anchor="middle" x="1382" y="-501.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;START = function(name) g[1] = name end,</text>
<text text-anchor="middle" x="1382" y="-486.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;SUPPRESS = function(...)</text>
<text text-anchor="middle" x="1382" y="-470.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;suppressed = {}</text>
<text text-anchor="middle" x="1382" y="-455.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;for i = 1, select(&#39;#&#39;, ...) do</text>
<text text-anchor="middle" x="1382" y="-440.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;suppressed[select(i, ... )] = true</text>
<text text-anchor="middle" x="1382" y="-424.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1382" y="-409.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end,</text>
<text text-anchor="middle" x="1382" y="-393.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;}</text>
<text text-anchor="middle" x="1382" y="-362.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env_index, { __index = e })</text>
<text text-anchor="middle" x="1382" y="-347.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env, {</text>
<text text-anchor="middle" x="1382" y="-331.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__index = env_index,</text>
<text text-anchor="middle" x="1382" y="-316.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__newindex = function( _, name, val )</text>
<text text-anchor="middle" x="1382" y="-300.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if suppressed[ name ] then</text>
<text text-anchor="middle" x="1382" y="-285.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = val</text>
<text text-anchor="middle" x="1382" y="-270.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else</text>
<text text-anchor="middle" x="1382" y="-254.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = (Cc(name) </text>
<text text-anchor="middle" x="1382" y="-239.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Cp() </text>
<text text-anchor="middle" x="1382" y="-223.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Ct(val)</text>
<text text-anchor="middle" x="1382" y="-208.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Cp()</text>
<text text-anchor="middle" x="1382" y="-193.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* arg1_str</text>
<text text-anchor="middle" x="1382" y="-177.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* arg2_metas) / make_ast_node</text>
<text text-anchor="middle" x="1382" y="-162.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1382" y="-146.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1382" y="-131.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;})</text>
<text text-anchor="middle" x="1382" y="-116.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45;&#45; call passed function with custom environment (5.1&#45; and 5.2&#45;style)</text>
<text text-anchor="middle" x="1382" y="-100.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="1382" y="-85.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;setfenv( func, env )</text>
<text text-anchor="middle" x="1382" y="-69.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="1382" y="-54.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;func( env )</text>
<text text-anchor="middle" x="1382" y="-39.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert( g[ 1 ] and g[ g[ 1 ] ], &quot;no start rule defined&quot; )</text>
<text text-anchor="middle" x="1382" y="-23.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return g</text>
<text text-anchor="middle" x="1382" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_18&#45;&gt;leaf_23 -->
<g id="edge23" class="edge">
<title>codeblock_18&#45;&gt;leaf_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1436.324,-1142.1998C1435.6554,-1134.9385 1434.8031,-1125.6815 1433.7968,-1114.7526"/>
<polygon fill="#000000" stroke="#000000" points="1437.2759,-1114.3631 1432.8737,-1104.7261 1430.3054,-1115.005 1437.2759,-1114.3631"/>
</g>
<!-- leaf_24 -->
<g id="node25" class="node">
<title>leaf_24</title>
<polygon fill="none" stroke="#c0c0c0" points="1928.5,-617.9014 1653.5,-617.9014 1653.5,-486.5006 1928.5,-486.5006 1928.5,-617.9014"/>
<text text-anchor="middle" x="1791" y="-602.6012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function refineMetas(metas)</text>
<text text-anchor="middle" x="1791" y="-587.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;for _,v in pairs(metas) do</text>
<text text-anchor="middle" x="1791" y="-571.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if not v[&quot;__tostring&quot;] then</text>
<text text-anchor="middle" x="1791" y="-556.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;v[&quot;__tostring&quot;] = Node.toString</text>
<text text-anchor="middle" x="1791" y="-541.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="1791" y="-525.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="1791" y="-510.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return metas</text>
<text text-anchor="middle" x="1791" y="-494.8009" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_19&#45;&gt;leaf_24 -->
<g id="edge24" class="edge">
<title>codeblock_19&#45;&gt;leaf_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M1736.676,-1142.1998C1743.6934,-1065.9856 1770.9533,-769.9229 1783.9852,-628.3873"/>
<polygon fill="#000000" stroke="#000000" points="1787.5046,-628.3365 1784.9363,-618.0577 1780.534,-627.6946 1787.5046,-628.3365"/>
</g>
<!-- leaf_25 -->
<g id="node26" class="node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="2403.5,-648.5015 1946.5,-648.5015 1946.5,-455.9006 2403.5,-455.9006 2403.5,-648.5015"/>
<text text-anchor="middle" x="2175" y="-633.4012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function new(grammar_template, metas)</text>
<text text-anchor="middle" x="2175" y="-618.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if type(grammar_template) == &#39;function&#39; then</text>
<text text-anchor="middle" x="2175" y="-602.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local metas = metas or {}</text>
<text text-anchor="middle" x="2175" y="-587.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local grammar = define(grammar_template, nil, metas)</text>
<text text-anchor="middle" x="2175" y="-571.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local parse = function(str)</text>
<text text-anchor="middle" x="2175" y="-556.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return L.match(grammar, str, 1, str, metas) &#45;&#45; other </text>
<text text-anchor="middle" x="2175" y="-541.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="2175" y="-525.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return parse</text>
<text text-anchor="middle" x="2175" y="-510.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;else</text>
<text text-anchor="middle" x="2175" y="-494.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;s:halt(&quot;no way to build grammar out of &quot; .. type(template))</text>
<text text-anchor="middle" x="2175" y="-479.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="2175" y="-464.0009" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_20&#45;&gt;leaf_25 -->
<g id="edge25" class="edge">
<title>codeblock_20&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2081.8731,-1142.1998C2093.096,-1071.098 2134.5209,-808.6532 2158.1674,-658.8428"/>
<polygon fill="#000000" stroke="#000000" points="2161.6666,-659.1217 2159.7686,-648.6983 2154.7522,-658.0302 2161.6666,-659.1217"/>
</g>
<!-- leaf_26 -->
<g id="node27" class="node">
<title>leaf_26</title>
<polygon fill="none" stroke="#c0c0c0" points="2508,-570.201 2422,-570.201 2422,-534.201 2508,-534.201 2508,-570.201"/>
<text text-anchor="middle" x="2465" y="-548.701" font-family="Inconsolata" font-size="14.00" fill="#000000">return new</text>
</g>
<!-- codeblock_21&#45;&gt;leaf_26 -->
<g id="edge26" class="edge">
<title>codeblock_21&#45;&gt;leaf_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2402.6166,-1141.9724C2406.2388,-1131.1625 2410.4888,-1117.1625 2413,-1104.4021 2451.9693,-906.3811 2461.9844,-662.4708 2464.3349,-580.5421"/>
<polygon fill="#000000" stroke="#000000" points="2467.8346,-580.5964 2464.607,-570.5052 2460.8372,-580.4066 2467.8346,-580.5964"/>
</g>
</g>
</svg>