<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: hierarchy Pages: 1 -->
<svg width="9195pt" height="4907pt"
 viewBox="0.00 0.00 9194.50 4906.61" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 4902.6078)">
<title>hierarchy</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-4902.6078 9190.5,-4902.6078 9190.5,4 -4,4"/>
<!-- doc_0 -->
<g id="node1" class="node">
<title>doc_0</title>
<ellipse fill="none" stroke="#000000" cx="2511" cy="-4880.6078" rx="46.1547" ry="18"/>
<text text-anchor="middle" x="2511" y="-4876.4078" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">doc &#45; 211</text>
</g>
<!-- section_1 -->
<g id="node2" class="node">
<title>section_1</title>
<ellipse fill="none" stroke="#000000" cx="2511" cy="-4808.6078" rx="55.6456" ry="18"/>
<text text-anchor="middle" x="2511" y="-4804.4078" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 1&#45;6</text>
</g>
<!-- doc_0&#45;&gt;section_1 -->
<g id="edge1" class="edge">
<title>doc_0&#45;&gt;section_1</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2511,-4862.4391C2511,-4854.7387 2511,-4845.5821 2511,-4837.0244"/>
<polygon fill="#000000" stroke="#000000" points="2514.5001,-4837.021 2511,-4827.021 2507.5001,-4837.0211 2514.5001,-4837.021"/>
</g>
<!-- header_2 -->
<g id="node3" class="node">
<title>header_2</title>
<ellipse fill="none" stroke="#000000" cx="2291" cy="-4695.8077" rx="91.3932" ry="18"/>
<text text-anchor="middle" x="2291" y="-4691.6077" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">1 : Grammar Module</text>
</g>
<!-- section_1&#45;&gt;header_2 -->
<g id="edge2" class="edge">
<title>section_1&#45;&gt;header_2</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2476.6523,-4794.3308C2452.3986,-4783.965 2419.3092,-4769.2453 2391,-4754.6078 2369.3782,-4743.428 2345.8836,-4729.6987 2327.1035,-4718.319"/>
<polygon fill="#000000" stroke="#000000" points="2328.9216,-4715.3282 2318.5618,-4713.1085 2325.2762,-4721.3041 2328.9216,-4715.3282"/>
</g>
<!-- block_3 -->
<g id="node4" class="node">
<title>block_3</title>
<ellipse fill="none" stroke="#000000" cx="2446" cy="-4695.8077" rx="45.9804" ry="18"/>
<text text-anchor="middle" x="2446" y="-4691.6077" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 1&#45;6</text>
</g>
<!-- section_1&#45;&gt;block_3 -->
<g id="edge3" class="edge">
<title>section_1&#45;&gt;block_3</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2500.7006,-4790.7343C2490.0984,-4772.3354 2473.4584,-4743.4586 2461.3135,-4722.3825"/>
<polygon fill="#000000" stroke="#000000" points="2464.2766,-4720.5145 2456.2513,-4713.5976 2458.2115,-4724.0095 2464.2766,-4720.5145"/>
</g>
<!-- section_4 -->
<g id="node5" class="node">
<title>section_4</title>
<ellipse fill="none" stroke="#000000" cx="2576" cy="-4695.8077" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="2576" y="-4691.6077" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 7&#45;101</text>
</g>
<!-- section_1&#45;&gt;section_4 -->
<g id="edge4" class="edge">
<title>section_1&#45;&gt;section_4</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2521.2994,-4790.7343C2531.9016,-4772.3354 2548.5416,-4743.4586 2560.6865,-4722.3825"/>
<polygon fill="#000000" stroke="#000000" points="2563.7885,-4724.0095 2565.7487,-4713.5976 2557.7234,-4720.5145 2563.7885,-4724.0095"/>
</g>
<!-- leaf_80 -->
<g id="node81" class="node">
<title>leaf_80</title>
<polygon fill="none" stroke="#c0c0c0" points="3082,-4754.4085 2660,-4754.4085 2660,-4637.2069 3082,-4637.2069 3082,-4754.4085"/>
<text text-anchor="middle" x="2871" y="-4739.4078" font-family="Inconsolata" font-size="14.00" fill="#000000">* Grammar Module</text>
<text text-anchor="middle" x="2871" y="-4692.0077" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The grammar module returns one function, which generates</text>
<text text-anchor="middle" x="2871" y="-4676.6077" font-family="Inconsolata" font-size="14.00" fill="#000000">a grammar. </text>
<text text-anchor="middle" x="2871" y="-4645.2077" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_1&#45;&gt;leaf_80 -->
<g id="edge80" class="edge">
<title>section_1&#45;&gt;leaf_80</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2551.2487,-4795.9965C2582.1461,-4786.3153 2627.3088,-4772.1643 2674.0107,-4757.5311"/>
<polygon fill="#000000" stroke="#000000" points="2675.1848,-4760.831 2683.6808,-4754.5011 2673.0917,-4754.1513 2675.1848,-4760.831"/>
</g>
<!-- leaf_5 -->
<g id="node6" class="node">
<title>leaf_5</title>
<polygon fill="none" stroke="#c0c0c0" points="2023,-3884.7069 1601,-3884.7069 1601,-3814.1062 2023,-3814.1062 2023,-3884.7069"/>
<text text-anchor="middle" x="1812" y="-3837.6066" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The grammar module returns one function, which generates</text>
<text text-anchor="middle" x="1812" y="-3822.2066" font-family="Inconsolata" font-size="14.00" fill="#000000">a grammar. </text>
</g>
<!-- block_3&#45;&gt;leaf_5 -->
<g id="edge5" class="edge">
<title>block_3&#45;&gt;leaf_5</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2434.7936,-4678.1397C2425.0282,-4664.3995 2409.543,-4646.18 2391,-4637.0076 2319.1337,-4601.4587 2093.6838,-4652.2287 2032,-4601.0076 1812.021,-4418.3413 1804.998,-4028.5662 1809.4997,-3895.2386"/>
<polygon fill="#000000" stroke="#000000" points="1813.0071,-3895.1049 1809.8867,-3884.98 1806.0121,-3894.8409 1813.0071,-3895.1049"/>
</g>
<!-- header_6 -->
<g id="node7" class="node">
<title>header_6</title>
<ellipse fill="none" stroke="#000000" cx="2109" cy="-3849.4066" rx="68.2066" ry="18"/>
<text text-anchor="middle" x="2109" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">2 : Parameters</text>
</g>
<!-- section_4&#45;&gt;header_6 -->
<g id="edge6" class="edge">
<title>section_4&#45;&gt;header_6</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2559.3136,-4678.2052C2545.1819,-4664.503 2523.6546,-4646.3027 2501,-4637.0076 2435.8175,-4610.2636 2235.5274,-4651.1179 2186,-4601.0076 1982.7855,-4395.4015 2072.3975,-3986.759 2101.2593,-3877.0536"/>
<polygon fill="#000000" stroke="#000000" points="2104.6419,-3877.9522 2103.8509,-3867.387 2097.8807,-3876.1395 2104.6419,-3877.9522"/>
</g>
<!-- block_7 -->
<g id="node8" class="node">
<title>block_7</title>
<ellipse fill="none" stroke="#000000" cx="2246" cy="-3849.4066" rx="50.8172" ry="18"/>
<text text-anchor="middle" x="2246" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 7&#45;10</text>
</g>
<!-- section_4&#45;&gt;block_7 -->
<g id="edge7" class="edge">
<title>section_4&#45;&gt;block_7</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2558.8463,-4678.3446C2544.6094,-4664.9115 2523.1708,-4647.008 2501,-4637.0076 2420.6631,-4600.771 2365.0309,-4666.4482 2306,-4601.0076 2113.1714,-4387.2414 2207.3743,-3986.0575 2237.7518,-3877.2387"/>
<polygon fill="#000000" stroke="#000000" points="2241.1928,-3877.9341 2240.5612,-3867.3581 2234.4597,-3876.0196 2241.1928,-3877.9341"/>
</g>
<!-- block_8 -->
<g id="node9" class="node">
<title>block_8</title>
<ellipse fill="none" stroke="#000000" cx="2370" cy="-3849.4066" rx="55.3502" ry="18"/>
<text text-anchor="middle" x="2370" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 11&#45;13</text>
</g>
<!-- section_4&#45;&gt;block_8 -->
<g id="edge8" class="edge">
<title>section_4&#45;&gt;block_8</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2556.0147,-4678.599C2541.2957,-4666.3138 2520.527,-4649.7726 2501,-4637.0076 2472.7053,-4618.5111 2452.5635,-4629.2585 2434,-4601.0076 2276.693,-4361.6096 2341.4814,-3982.5908 2363.6748,-3877.3262"/>
<polygon fill="#000000" stroke="#000000" points="2367.1143,-3877.9792 2365.7999,-3867.4662 2360.2715,-3876.5043 2367.1143,-3877.9792"/>
</g>
<!-- block_9 -->
<g id="node10" class="node">
<title>block_9</title>
<ellipse fill="none" stroke="#000000" cx="2504" cy="-3849.4066" rx="60.9913" ry="18"/>
<text text-anchor="middle" x="2504" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 14&#45;101</text>
</g>
<!-- section_4&#45;&gt;block_9 -->
<g id="edge9" class="edge">
<title>section_4&#45;&gt;block_9</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2574.4629,-4677.7378C2565.2849,-4569.8457 2517.7391,-4010.9179 2506.4204,-3877.8594"/>
<polygon fill="#000000" stroke="#000000" points="2509.8884,-3877.3341 2505.5533,-3867.6668 2502.9136,-3877.9275 2509.8884,-3877.3341"/>
</g>
<!-- section_10 -->
<g id="node11" class="node">
<title>section_10</title>
<ellipse fill="none" stroke="#000000" cx="2648" cy="-3849.4066" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="2648" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 17&#45;46</text>
</g>
<!-- section_4&#45;&gt;section_10 -->
<g id="edge10" class="edge">
<title>section_4&#45;&gt;section_10</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2577.5371,-4677.7378C2586.7151,-4569.8457 2634.2609,-4010.9179 2645.5796,-3877.8594"/>
<polygon fill="#000000" stroke="#000000" points="2649.0864,-3877.9275 2646.4467,-3867.6668 2642.1116,-3877.3341 2649.0864,-3877.9275"/>
</g>
<!-- section_11 -->
<g id="node12" class="node">
<title>section_11</title>
<ellipse fill="none" stroke="#000000" cx="4710" cy="-3849.4066" rx="65.8187" ry="18"/>
<text text-anchor="middle" x="4710" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 47&#45;70</text>
</g>
<!-- section_4&#45;&gt;section_11 -->
<g id="edge11" class="edge">
<title>section_4&#45;&gt;section_11</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2594.9033,-4678.3651C2609.4212,-4665.6449 2630.4103,-4648.6636 2651,-4637.0076 2843.3425,-4528.1209 4365.0713,-3974.4508 4660.4346,-3867.356"/>
<polygon fill="#000000" stroke="#000000" points="4661.812,-3870.5796 4670.0204,-3863.881 4659.4263,-3863.9987 4661.812,-3870.5796"/>
</g>
<!-- section_12 -->
<g id="node13" class="node">
<title>section_12</title>
<ellipse fill="none" stroke="#000000" cx="6880" cy="-3849.4066" rx="70.655" ry="18"/>
<text text-anchor="middle" x="6880" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 71&#45;101</text>
</g>
<!-- section_4&#45;&gt;section_12 -->
<g id="edge12" class="edge">
<title>section_4&#45;&gt;section_12</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2591.8967,-4678.1804C2605.8809,-4664.0663 2627.6099,-4645.305 2651,-4637.0076 2874.4991,-4557.7243 4551.7147,-4643.6182 4785,-4601.0076 5647.9248,-4443.3909 6627.8277,-3974.2925 6838.6877,-3870.0737"/>
<polygon fill="#000000" stroke="#000000" points="6840.4544,-3873.1045 6847.8618,-3865.5294 6837.3473,-3866.8318 6840.4544,-3873.1045"/>
</g>
<!-- section_13 -->
<g id="node14" class="node">
<title>section_13</title>
<ellipse fill="none" stroke="#000000" cx="7964" cy="-3849.4066" rx="74.6878" ry="18"/>
<text text-anchor="middle" x="7964" y="-3845.2066" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">section: 102&#45;211</text>
</g>
<!-- section_4&#45;&gt;section_13 -->
<g id="edge13" class="edge">
<title>section_4&#45;&gt;section_13</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2591.8786,-4678.1292C2605.8518,-4663.9838 2627.5748,-4645.2053 2651,-4637.0076 2876.9605,-4557.9324 6733.1719,-4677.5585 6960,-4601.0076 7421.4063,-4445.2904 7842.9104,-3987.9928 7942.0623,-3874.9151"/>
<polygon fill="#000000" stroke="#000000" points="7944.959,-3876.9188 7948.8961,-3867.0826 7939.6844,-3872.3167 7944.959,-3876.9188"/>
</g>
<!-- leaf_79 -->
<g id="node80" class="node">
<title>leaf_79</title>
<polygon fill="none" stroke="#c0c0c0" points="8653.5,-4601.1087 8056.5,-4601.1087 8056.5,-3097.7044 8653.5,-3097.7044 8653.5,-4601.1087"/>
<text text-anchor="middle" x="8355" y="-4585.8076" font-family="Inconsolata" font-size="14.00" fill="#000000">** Parameters</text>
<text text-anchor="middle" x="8355" y="-4554.4076" font-family="Inconsolata" font-size="14.00" fill="#000000">This function takes two parameters, namely:</text>
<text text-anchor="middle" x="8355" y="-4523.0076" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; grammar_template : &#160;A function with one parameter, which must be =_ENV=.</text>
<text text-anchor="middle" x="8355" y="-4507.6076" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; metas : &#160;A map with keys of string and values of Node subclass constructors.</text>
<text text-anchor="middle" x="8355" y="-4476.2075" font-family="Inconsolata" font-size="14.00" fill="#000000">Both of these are reasonably complex.</text>
<text text-anchor="middle" x="8355" y="-4428.8075" font-family="Inconsolata" font-size="14.00" fill="#000000">*** grammar_template</text>
<text text-anchor="middle" x="8355" y="-4397.4075" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The internal function @define creates a custom environment variable, neatly</text>
<text text-anchor="middle" x="8355" y="-4382.0074" font-family="Inconsolata" font-size="14.00" fill="#000000">sidestepping lua&#39;s pedantic insistance on prepending =local= to all values of </text>
<text text-anchor="middle" x="8355" y="-4366.6074" font-family="Inconsolata" font-size="14.00" fill="#000000">significance. </text>
<text text-anchor="middle" x="8355" y="-4335.2074" font-family="Inconsolata" font-size="14.00" fill="#000000">More relevantly, it constructs a full grammar, which will return a table of</text>
<text text-anchor="middle" x="8355" y="-4319.8073" font-family="Inconsolata" font-size="14.00" fill="#000000">type Node. </text>
<text text-anchor="middle" x="8355" y="-4288.4073" font-family="Inconsolata" font-size="14.00" fill="#000000">If you stick to =lpeg= patterns, as you should, all array values will be of</text>
<text text-anchor="middle" x="8355" y="-4273.0073" font-family="Inconsolata" font-size="14.00" fill="#000000">Node, as is intended. &#160;Captures will interpolate various other sorts of Lua</text>
<text text-anchor="middle" x="8355" y="-4257.6072" font-family="Inconsolata" font-size="14.00" fill="#000000">values, which will induce halting in some places and silently corrupt</text>
<text text-anchor="middle" x="8355" y="-4242.2072" font-family="Inconsolata" font-size="14.00" fill="#000000">execution in others. </text>
<text text-anchor="middle" x="8355" y="-4210.8072" font-family="Inconsolata" font-size="14.00" fill="#000000">Though as yet poorly thought through, the [[elpatt module][./elpatt]] is</text>
<text text-anchor="middle" x="8355" y="-4195.4071" font-family="Inconsolata" font-size="14.00" fill="#000000">intended to provide only those patterns which are allowed in Grammars, while</text>
<text text-anchor="middle" x="8355" y="-4180.0071" font-family="Inconsolata" font-size="14.00" fill="#000000">expanding the scope of some favorites to properly respect utf&#45;8 and otherwise</text>
<text text-anchor="middle" x="8355" y="-4164.6071" font-family="Inconsolata" font-size="14.00" fill="#000000">behave. </text>
<text text-anchor="middle" x="8355" y="-4133.2071" font-family="Inconsolata" font-size="14.00" fill="#000000">There are examples of the format in the [[spec module][./spec]].</text>
<text text-anchor="middle" x="8355" y="-4101.807" font-family="Inconsolata" font-size="14.00" fill="#000000">Special fields include:</text>
<text text-anchor="middle" x="8355" y="-4070.407" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;START : &#160;a string which must be the same as the starting rule.</text>
<text text-anchor="middle" x="8355" y="-4055.007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;SUPPRESS : &#160;either a string or an array of strings. These rules will be</text>
<text text-anchor="middle" x="8355" y="-4039.6069" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;removed from the Node. </text>
<text text-anchor="middle" x="8355" y="-4024.2069" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;P : &#160;The lpeg P function. &#160;Recognizes a certain pattern.</text>
<text text-anchor="middle" x="8355" y="-4008.8069" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;V : &#160;The lpeg V function. &#160;Used for non&#45;terminal rvalues in a grammar. </text>
<text text-anchor="middle" x="8355" y="-3961.4068" font-family="Inconsolata" font-size="14.00" fill="#000000">*** metas</text>
<text text-anchor="middle" x="8355" y="-3930.0068" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;By default a node will inherit from the Node class. &#160;If you want custom behavior,</text>
<text text-anchor="middle" x="8355" y="-3914.6068" font-family="Inconsolata" font-size="14.00" fill="#000000">you must pass in a table of metatable constructors.</text>
<text text-anchor="middle" x="8355" y="-3883.2067" font-family="Inconsolata" font-size="14.00" fill="#000000">That&#39;s a fairly specific beast. &#160;Any rule defined above will have an =id=</text>
<text text-anchor="middle" x="8355" y="-3867.8067" font-family="Inconsolata" font-size="14.00" fill="#000000">corresonding to the name of the rule. &#160;Unless =SUPPRESS=ed, this will become</text>
<text text-anchor="middle" x="8355" y="-3852.4067" font-family="Inconsolata" font-size="14.00" fill="#000000">a Node. &#160;If the =metas= parameter has a key corresponding to =id=, then it</text>
<text text-anchor="middle" x="8355" y="-3837.0066" font-family="Inconsolata" font-size="14.00" fill="#000000">must return a function taking two parameters:</text>
<text text-anchor="middle" x="8355" y="-3821.6066" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;</text>
<text text-anchor="middle" x="8355" y="-3806.2066" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; node : &#160;The node under construction, which under normal circumstances will</text>
<text text-anchor="middle" x="8355" y="-3790.8066" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;already have the =first= and =last= fields.</text>
<text text-anchor="middle" x="8355" y="-3775.4065" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; str &#160;: &#160;The entire str the grammar is parsing.</text>
<text text-anchor="middle" x="8355" y="-3744.0065" font-family="Inconsolata" font-size="14.00" fill="#000000">Which must return that same node, decorated in whatever fashion is appropriate.</text>
<text text-anchor="middle" x="8355" y="-3712.6065" font-family="Inconsolata" font-size="14.00" fill="#000000">The node will not have a metatable at this point, and the function must attach a</text>
<text text-anchor="middle" x="8355" y="-3697.2064" font-family="Inconsolata" font-size="14.00" fill="#000000">metatable with =__index= equal to some table which itself has the =__index=</text>
<text text-anchor="middle" x="8355" y="-3681.8064" font-family="Inconsolata" font-size="14.00" fill="#000000">Node as some recursive backstop.</text>
<text text-anchor="middle" x="8355" y="-3650.4064" font-family="Inconsolata" font-size="14.00" fill="#000000">You might say the return value must /inherit/ from Node, if we were using</text>
<text text-anchor="middle" x="8355" y="-3635.0063" font-family="Inconsolata" font-size="14.00" fill="#000000">a language that did that sort of thing. </text>
<text text-anchor="middle" x="8355" y="-3587.6063" font-family="Inconsolata" font-size="14.00" fill="#000000">*** includes</text>
<text text-anchor="middle" x="8355" y="-3556.2063" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8355" y="-3540.8062" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="8355" y="-3509.4062" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require &quot;status&quot; </text>
<text text-anchor="middle" x="8355" y="-3494.0062" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
<text text-anchor="middle" x="8355" y="-3478.6061" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="8355" y="-3447.2061" font-family="Inconsolata" font-size="14.00" fill="#000000">I like the dedication shown in this style of import.</text>
<text text-anchor="middle" x="8355" y="-3415.8061" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s the kind of thing I&#39;d like to automate. </text>
<text text-anchor="middle" x="8355" y="-3384.4061" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8355" y="-3369.006" font-family="Inconsolata" font-size="14.00" fill="#000000">local assert = assert</text>
<text text-anchor="middle" x="8355" y="-3353.606" font-family="Inconsolata" font-size="14.00" fill="#000000">local string, io = assert( string ), assert( io )</text>
<text text-anchor="middle" x="8355" y="-3338.206" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = string.sub( assert( _VERSION ), &#45;4 )</text>
<text text-anchor="middle" x="8355" y="-3322.8059" font-family="Inconsolata" font-size="14.00" fill="#000000">local _G = assert( _G )</text>
<text text-anchor="middle" x="8355" y="-3307.4059" font-family="Inconsolata" font-size="14.00" fill="#000000">local error = assert( error )</text>
<text text-anchor="middle" x="8355" y="-3292.0059" font-family="Inconsolata" font-size="14.00" fill="#000000">local pairs = assert( pairs )</text>
<text text-anchor="middle" x="8355" y="-3276.6058" font-family="Inconsolata" font-size="14.00" fill="#000000">local next = assert( next )</text>
<text text-anchor="middle" x="8355" y="-3261.2058" font-family="Inconsolata" font-size="14.00" fill="#000000">local type = assert( type )</text>
<text text-anchor="middle" x="8355" y="-3245.8058" font-family="Inconsolata" font-size="14.00" fill="#000000">local tostring = assert( tostring )</text>
<text text-anchor="middle" x="8355" y="-3230.4057" font-family="Inconsolata" font-size="14.00" fill="#000000">local setmetatable = assert( setmetatable )</text>
<text text-anchor="middle" x="8355" y="-3215.0057" font-family="Inconsolata" font-size="14.00" fill="#000000">if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="8355" y="-3199.6057" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local setfenv = assert( setfenv )</text>
<text text-anchor="middle" x="8355" y="-3184.2056" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local getfenv = assert( getfenv )</text>
<text text-anchor="middle" x="8355" y="-3168.8056" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="8355" y="-3153.4056" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="8355" y="-3106.0056" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_4&#45;&gt;leaf_79 -->
<g id="edge79" class="edge">
<title>section_4&#45;&gt;leaf_79</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2591.8751,-4678.119C2605.8461,-4663.9674 2627.5679,-4645.1856 2651,-4637.0076 2792.547,-4587.6068 7923.8308,-4685.0197 8048,-4601.0076 8048.0866,-4600.949 8048.1733,-4600.8904 8048.2599,-4600.8317"/>
<polygon fill="#000000" stroke="#000000" points="8050.0234,-4603.8681 8056.243,-4595.2909 8046.0321,-4598.1175 8050.0234,-4603.8681"/>
</g>
<!-- leaf_14 -->
<g id="node15" class="node">
<title>leaf_14</title>
<polygon fill="none" stroke="#c0c0c0" points="1020.5,-2227.706 703.5,-2227.706 703.5,-2187.9019 1020.5,-2187.9019 1020.5,-2227.706"/>
<text text-anchor="middle" x="862" y="-2196.304" font-family="Inconsolata" font-size="14.00" fill="#000000">This function takes two parameters, namely:</text>
</g>
<!-- block_7&#45;&gt;leaf_14 -->
<g id="edge14" class="edge">
<title>block_7&#45;&gt;leaf_14</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2247.6129,-3831.2783C2256.4876,-3726.7206 2295.1152,-3201.7499 2186,-3097.8055 2092.9541,-3009.1689 1127.9684,-3144.969 1030,-3061.8055 774.2294,-2844.6868 835.7473,-2361.7943 856.5781,-2237.4579"/>
<polygon fill="#000000" stroke="#000000" points="860.0424,-2237.9639 858.287,-2227.5155 853.1436,-2236.7781 860.0424,-2237.9639"/>
</g>
<!-- leaf_15 -->
<g id="node16" class="node">
<title>leaf_15</title>
<polygon fill="none" stroke="#c0c0c0" points="1615,-2227.1045 1039,-2227.1045 1039,-2188.5034 1615,-2188.5034 1615,-2227.1045"/>
<text text-anchor="middle" x="1327" y="-2212.004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; grammar_template : &#160;A function with one parameter, which must be =_ENV=.</text>
<text text-anchor="middle" x="1327" y="-2196.604" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; metas : &#160;A map with keys of string and values of Node subclass constructors.</text>
</g>
<!-- block_8&#45;&gt;leaf_15 -->
<g id="edge15" class="edge">
<title>block_8&#45;&gt;leaf_15</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2375.7552,-3831.2407C2404.1992,-3737.5185 2520.0341,-3305.0543 2306,-3097.8055 2251.4853,-3045.019 1684.6647,-3107.3913 1624,-3061.8055 1345.065,-2852.203 1326.6047,-2362.7804 1326.5823,-2237.4549"/>
<polygon fill="#000000" stroke="#000000" points="1330.0822,-2237.4542 1326.6213,-2227.4406 1323.0823,-2237.4268 1330.0822,-2237.4542"/>
</g>
<!-- leaf_16 -->
<g id="node17" class="node">
<title>leaf_16</title>
<polygon fill="none" stroke="#c0c0c0" points="1908.5,-2227.706 1633.5,-2227.706 1633.5,-2187.9019 1908.5,-2187.9019 1908.5,-2227.706"/>
<text text-anchor="middle" x="1771" y="-2212.304" font-family="Inconsolata" font-size="14.00" fill="#000000">Both of these are reasonably complex.</text>
</g>
<!-- block_9&#45;&gt;leaf_16 -->
<g id="edge16" class="edge">
<title>block_9&#45;&gt;leaf_16</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2509.52,-3831.2813C2536.7662,-3737.7619 2647.264,-3306.1478 2434,-3097.8055 2351.6195,-3017.3262 2002.3961,-3139.0775 1917,-3061.8055 1669.6366,-2837.9749 1741.2979,-2360.993 1764.8713,-2237.4949"/>
<polygon fill="#000000" stroke="#000000" points="1768.3196,-2238.0979 1766.8008,-2227.6124 1761.4493,-2236.7564 1768.3196,-2238.0979"/>
</g>
<!-- header_17 -->
<g id="node18" class="node">
<title>header_17</title>
<ellipse fill="none" stroke="#000000" cx="2023" cy="-2207.804" rx="96.7227" ry="18"/>
<text text-anchor="middle" x="2023" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : grammar_template</text>
</g>
<!-- section_10&#45;&gt;header_17 -->
<g id="edge17" class="edge">
<title>section_10&#45;&gt;header_17</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2653.364,-3831.308C2679.8155,-3737.9217 2786.7717,-3306.8656 2574,-3097.8055 2503.074,-3028.1168 2199.7639,-3130.6311 2128,-3061.8055 1888.0817,-2831.7105 1985.9304,-2356.3331 2015.6137,-2235.9753"/>
<polygon fill="#000000" stroke="#000000" points="2019.0615,-2236.6159 2018.1039,-2226.0644 2012.2725,-2234.91 2019.0615,-2236.6159"/>
</g>
<!-- block_18 -->
<g id="node19" class="node">
<title>block_18</title>
<ellipse fill="none" stroke="#000000" cx="2193" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2193" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 17&#45;22</text>
</g>
<!-- section_10&#45;&gt;block_18 -->
<g id="edge18" class="edge">
<title>section_10&#45;&gt;block_18</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2653.2351,-3831.4371C2679.0436,-3738.6946 2783.3049,-3310.3364 2574,-3097.8055 2474.8157,-2997.0925 2356.0616,-3163.612 2258,-3061.8055 2141.739,-2941.1047 2179.8228,-2370.8424 2190.5829,-2236.2954"/>
<polygon fill="#000000" stroke="#000000" points="2194.098,-2236.252 2191.4216,-2226.0008 2187.1211,-2235.6836 2194.098,-2236.252"/>
</g>
<!-- block_19 -->
<g id="node20" class="node">
<title>block_19</title>
<ellipse fill="none" stroke="#000000" cx="2323" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2323" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 23&#45;25</text>
</g>
<!-- section_10&#45;&gt;block_19 -->
<g id="edge19" class="edge">
<title>section_10&#45;&gt;block_19</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2653.0023,-3831.4315C2677.3837,-3739.5424 2774.666,-3318.0682 2574,-3097.8055 2517.2943,-3035.5621 2444.0121,-3124.6738 2388,-3061.8055 2276.5179,-2936.6774 2310.9647,-2369.7844 2320.7876,-2236.1058"/>
<polygon fill="#000000" stroke="#000000" points="2324.2969,-2236.1119 2321.5539,-2225.8783 2317.3164,-2235.5888 2324.2969,-2236.1119"/>
</g>
<!-- block_20 -->
<g id="node21" class="node">
<title>block_20</title>
<ellipse fill="none" stroke="#000000" cx="2453" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2453" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 26&#45;30</text>
</g>
<!-- section_10&#45;&gt;block_20 -->
<g id="edge20" class="edge">
<title>section_10&#45;&gt;block_20</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2651.5581,-3831.2762C2667.9026,-3742.8241 2728.5819,-3350.6155 2574,-3097.8055 2558.565,-3072.5624 2533.1542,-3087.2182 2518,-3061.8055 2349.7894,-2779.7264 2423.4539,-2348.6703 2446.8352,-2235.6928"/>
<polygon fill="#000000" stroke="#000000" points="2450.2892,-2236.2755 2448.9311,-2225.7681 2443.4403,-2234.8291 2450.2892,-2236.2755"/>
</g>
<!-- block_21 -->
<g id="node22" class="node">
<title>block_21</title>
<ellipse fill="none" stroke="#000000" cx="2583" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2583" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 31&#45;35</text>
</g>
<!-- section_10&#45;&gt;block_21 -->
<g id="edge21" class="edge">
<title>section_10&#45;&gt;block_21</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2647.2811,-3831.2514C2640.7757,-3666.9528 2592.1263,-2438.2916 2584.1152,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="2587.6078,-2235.709 2583.7148,-2225.8554 2580.6132,-2235.986 2587.6078,-2235.709"/>
</g>
<!-- block_22 -->
<g id="node23" class="node">
<title>block_22</title>
<ellipse fill="none" stroke="#000000" cx="2713" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2713" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 36&#45;37</text>
</g>
<!-- section_10&#45;&gt;block_22 -->
<g id="edge22" class="edge">
<title>section_10&#45;&gt;block_22</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2648.7189,-3831.2514C2655.2243,-3666.9528 2703.8737,-2438.2916 2711.8848,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="2715.3868,-2235.986 2712.2852,-2225.8554 2708.3922,-2235.709 2715.3868,-2235.986"/>
</g>
<!-- block_23 -->
<g id="node24" class="node">
<title>block_23</title>
<ellipse fill="none" stroke="#000000" cx="2843" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2843" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 38&#45;39</text>
</g>
<!-- section_10&#45;&gt;block_23 -->
<g id="edge23" class="edge">
<title>section_10&#45;&gt;block_23</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2651.6181,-3831.1752C2668.5545,-3745.1863 2740.7412,-3371.391 2778,-3061.8055 2816.9063,-2738.5311 2836.8124,-2343.4431 2841.7561,-2235.9351"/>
<polygon fill="#000000" stroke="#000000" points="2845.2549,-2236.0393 2842.2127,-2225.8906 2838.2621,-2235.7213 2845.2549,-2236.0393"/>
</g>
<!-- block_24 -->
<g id="node25" class="node">
<title>block_24</title>
<ellipse fill="none" stroke="#000000" cx="2973" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="2973" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 40&#45;46</text>
</g>
<!-- section_10&#45;&gt;block_24 -->
<g id="edge24" class="edge">
<title>section_10&#45;&gt;block_24</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2655.8396,-3831.2496C2692.106,-3746.3333 2844.5272,-3379.147 2908,-3061.8055 2971.8612,-2742.5223 2974.0299,-2344.5974 2973.3217,-2236.1855"/>
<polygon fill="#000000" stroke="#000000" points="2976.8206,-2236.0268 2973.2409,-2226.0551 2969.8209,-2236.0827 2976.8206,-2236.0268"/>
</g>
<!-- leaf_32 -->
<g id="node33" class="node">
<title>leaf_32</title>
<polygon fill="none" stroke="#c0c0c0" points="3609,-2453.1047 3047,-2453.1047 3047,-1962.5032 3609,-1962.5032 3609,-2453.1047"/>
<text text-anchor="middle" x="3328" y="-2438.0043" font-family="Inconsolata" font-size="14.00" fill="#000000">*** grammar_template</text>
<text text-anchor="middle" x="3328" y="-2406.6043" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The internal function @define creates a custom environment variable, neatly</text>
<text text-anchor="middle" x="3328" y="-2391.2042" font-family="Inconsolata" font-size="14.00" fill="#000000">sidestepping lua&#39;s pedantic insistance on prepending =local= to all values of </text>
<text text-anchor="middle" x="3328" y="-2375.8042" font-family="Inconsolata" font-size="14.00" fill="#000000">significance. </text>
<text text-anchor="middle" x="3328" y="-2344.4042" font-family="Inconsolata" font-size="14.00" fill="#000000">More relevantly, it constructs a full grammar, which will return a table of</text>
<text text-anchor="middle" x="3328" y="-2329.0042" font-family="Inconsolata" font-size="14.00" fill="#000000">type Node. </text>
<text text-anchor="middle" x="3328" y="-2297.6041" font-family="Inconsolata" font-size="14.00" fill="#000000">If you stick to =lpeg= patterns, as you should, all array values will be of</text>
<text text-anchor="middle" x="3328" y="-2282.2041" font-family="Inconsolata" font-size="14.00" fill="#000000">Node, as is intended. &#160;Captures will interpolate various other sorts of Lua</text>
<text text-anchor="middle" x="3328" y="-2266.8041" font-family="Inconsolata" font-size="14.00" fill="#000000">values, which will induce halting in some places and silently corrupt</text>
<text text-anchor="middle" x="3328" y="-2251.404" font-family="Inconsolata" font-size="14.00" fill="#000000">execution in others. </text>
<text text-anchor="middle" x="3328" y="-2220.004" font-family="Inconsolata" font-size="14.00" fill="#000000">Though as yet poorly thought through, the [[elpatt module][./elpatt]] is</text>
<text text-anchor="middle" x="3328" y="-2204.604" font-family="Inconsolata" font-size="14.00" fill="#000000">intended to provide only those patterns which are allowed in Grammars, while</text>
<text text-anchor="middle" x="3328" y="-2189.2039" font-family="Inconsolata" font-size="14.00" fill="#000000">expanding the scope of some favorites to properly respect utf&#45;8 and otherwise</text>
<text text-anchor="middle" x="3328" y="-2173.8039" font-family="Inconsolata" font-size="14.00" fill="#000000">behave. </text>
<text text-anchor="middle" x="3328" y="-2142.4039" font-family="Inconsolata" font-size="14.00" fill="#000000">There are examples of the format in the [[spec module][./spec]].</text>
<text text-anchor="middle" x="3328" y="-2111.0038" font-family="Inconsolata" font-size="14.00" fill="#000000">Special fields include:</text>
<text text-anchor="middle" x="3328" y="-2079.6038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;START : &#160;a string which must be the same as the starting rule.</text>
<text text-anchor="middle" x="3328" y="-2064.2038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;SUPPRESS : &#160;either a string or an array of strings. These rules will be</text>
<text text-anchor="middle" x="3328" y="-2048.8037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;removed from the Node. </text>
<text text-anchor="middle" x="3328" y="-2033.4037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;P : &#160;The lpeg P function. &#160;Recognizes a certain pattern.</text>
<text text-anchor="middle" x="3328" y="-2018.0037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;V : &#160;The lpeg V function. &#160;Used for non&#45;terminal rvalues in a grammar. </text>
<text text-anchor="middle" x="3328" y="-1970.6037" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_10&#45;&gt;leaf_32 -->
<g id="edge32" class="edge">
<title>section_10&#45;&gt;leaf_32</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2657.9798,-3831.5041C2704.8491,-3746.997 2906.3451,-3378.8674 3038,-3061.8055 3119.9894,-2864.3522 3197.0181,-2634.5791 3251.053,-2463.1362"/>
<polygon fill="#000000" stroke="#000000" points="3254.4298,-2464.0652 3254.0929,-2453.4757 3247.7526,-2461.964 3254.4298,-2464.0652"/>
</g>
<!-- header_33 -->
<g id="node34" class="node">
<title>header_33</title>
<ellipse fill="none" stroke="#000000" cx="4395" cy="-2207.804" rx="46.4563" ry="18"/>
<text text-anchor="middle" x="4395" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : metas</text>
</g>
<!-- section_11&#45;&gt;header_33 -->
<g id="edge33" class="edge">
<title>section_11&#45;&gt;header_33</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4702.0777,-3831.2659C4665.4424,-3746.4223 4511.6229,-3379.5114 4450,-3061.8055 4388.0508,-2742.4172 4391.8399,-2344.567 4394.2314,-2236.1789"/>
<polygon fill="#000000" stroke="#000000" points="4397.7334,-2236.1305 4394.4701,-2226.0507 4390.7353,-2235.9655 4397.7334,-2236.1305"/>
</g>
<!-- block_34 -->
<g id="node35" class="node">
<title>block_34</title>
<ellipse fill="none" stroke="#000000" cx="4515" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="4515" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 47&#45;51</text>
</g>
<!-- section_11&#45;&gt;block_34 -->
<g id="edge34" class="edge">
<title>section_11&#45;&gt;block_34</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4706.3819,-3831.1752C4689.4455,-3745.1863 4617.2588,-3371.391 4580,-3061.8055 4541.0937,-2738.5311 4521.1876,-2343.4431 4516.2439,-2235.9351"/>
<polygon fill="#000000" stroke="#000000" points="4519.7379,-2235.7213 4515.7873,-2225.8906 4512.7451,-2236.0393 4519.7379,-2235.7213"/>
</g>
<!-- block_35 -->
<g id="node36" class="node">
<title>block_35</title>
<ellipse fill="none" stroke="#000000" cx="4645" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="4645" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 52&#45;60</text>
</g>
<!-- section_11&#45;&gt;block_35 -->
<g id="edge35" class="edge">
<title>section_11&#45;&gt;block_35</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4709.2811,-3831.2514C4702.7757,-3666.9528 4654.1263,-2438.2916 4646.1152,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="4649.6078,-2235.709 4645.7148,-2225.8554 4642.6132,-2235.986 4649.6078,-2235.709"/>
</g>
<!-- block_36 -->
<g id="node37" class="node">
<title>block_36</title>
<ellipse fill="none" stroke="#000000" cx="4775" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="4775" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 61&#45;62</text>
</g>
<!-- section_11&#45;&gt;block_36 -->
<g id="edge36" class="edge">
<title>section_11&#45;&gt;block_36</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4710.7189,-3831.2514C4717.2243,-3666.9528 4765.8737,-2438.2916 4773.8848,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="4777.3868,-2235.986 4774.2852,-2225.8554 4770.3922,-2235.709 4777.3868,-2235.986"/>
</g>
<!-- block_37 -->
<g id="node38" class="node">
<title>block_37</title>
<ellipse fill="none" stroke="#000000" cx="4905" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="4905" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 63&#45;66</text>
</g>
<!-- section_11&#45;&gt;block_37 -->
<g id="edge37" class="edge">
<title>section_11&#45;&gt;block_37</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4713.6181,-3831.1752C4730.5545,-3745.1863 4802.7412,-3371.391 4840,-3061.8055 4878.9063,-2738.5311 4898.8124,-2343.4431 4903.7561,-2235.9351"/>
<polygon fill="#000000" stroke="#000000" points="4907.2549,-2236.0393 4904.2127,-2225.8906 4900.2621,-2235.7213 4907.2549,-2236.0393"/>
</g>
<!-- block_38 -->
<g id="node39" class="node">
<title>block_38</title>
<ellipse fill="none" stroke="#000000" cx="5035" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="5035" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 67&#45;70</text>
</g>
<!-- section_11&#45;&gt;block_38 -->
<g id="edge38" class="edge">
<title>section_11&#45;&gt;block_38</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4717.8396,-3831.2496C4754.106,-3746.3333 4906.5272,-3379.147 4970,-3061.8055 5033.8612,-2742.5223 5036.0299,-2344.5974 5035.3217,-2236.1855"/>
<polygon fill="#000000" stroke="#000000" points="5038.8206,-2236.0268 5035.2409,-2226.0551 5031.8209,-2236.0827 5038.8206,-2236.0268"/>
</g>
<!-- leaf_44 -->
<g id="node45" class="node">
<title>leaf_44</title>
<polygon fill="none" stroke="#c0c0c0" points="5705.5,-2406.5046 5108.5,-2406.5046 5108.5,-2009.1034 5705.5,-2009.1034 5705.5,-2406.5046"/>
<text text-anchor="middle" x="5407" y="-2391.2042" font-family="Inconsolata" font-size="14.00" fill="#000000">*** metas</text>
<text text-anchor="middle" x="5407" y="-2359.8042" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;By default a node will inherit from the Node class. &#160;If you want custom behavior,</text>
<text text-anchor="middle" x="5407" y="-2344.4042" font-family="Inconsolata" font-size="14.00" fill="#000000">you must pass in a table of metatable constructors.</text>
<text text-anchor="middle" x="5407" y="-2313.0042" font-family="Inconsolata" font-size="14.00" fill="#000000">That&#39;s a fairly specific beast. &#160;Any rule defined above will have an =id=</text>
<text text-anchor="middle" x="5407" y="-2297.6041" font-family="Inconsolata" font-size="14.00" fill="#000000">corresonding to the name of the rule. &#160;Unless =SUPPRESS=ed, this will become</text>
<text text-anchor="middle" x="5407" y="-2282.2041" font-family="Inconsolata" font-size="14.00" fill="#000000">a Node. &#160;If the =metas= parameter has a key corresponding to =id=, then it</text>
<text text-anchor="middle" x="5407" y="-2266.8041" font-family="Inconsolata" font-size="14.00" fill="#000000">must return a function taking two parameters:</text>
<text text-anchor="middle" x="5407" y="-2251.404" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;</text>
<text text-anchor="middle" x="5407" y="-2236.004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; node : &#160;The node under construction, which under normal circumstances will</text>
<text text-anchor="middle" x="5407" y="-2220.604" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;already have the =first= and =last= fields.</text>
<text text-anchor="middle" x="5407" y="-2205.2039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; str &#160;: &#160;The entire str the grammar is parsing.</text>
<text text-anchor="middle" x="5407" y="-2173.8039" font-family="Inconsolata" font-size="14.00" fill="#000000">Which must return that same node, decorated in whatever fashion is appropriate.</text>
<text text-anchor="middle" x="5407" y="-2142.4039" font-family="Inconsolata" font-size="14.00" fill="#000000">The node will not have a metatable at this point, and the function must attach a</text>
<text text-anchor="middle" x="5407" y="-2127.0038" font-family="Inconsolata" font-size="14.00" fill="#000000">metatable with =__index= equal to some table which itself has the =__index=</text>
<text text-anchor="middle" x="5407" y="-2111.6038" font-family="Inconsolata" font-size="14.00" fill="#000000">Node as some recursive backstop.</text>
<text text-anchor="middle" x="5407" y="-2080.2038" font-family="Inconsolata" font-size="14.00" fill="#000000">You might say the return value must /inherit/ from Node, if we were using</text>
<text text-anchor="middle" x="5407" y="-2064.8037" font-family="Inconsolata" font-size="14.00" fill="#000000">a language that did that sort of thing. </text>
<text text-anchor="middle" x="5407" y="-2017.4037" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_11&#45;&gt;leaf_44 -->
<g id="edge44" class="edge">
<title>section_11&#45;&gt;leaf_44</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4719.8564,-3831.4522C4766.1693,-3746.7112 4965.5381,-3377.6872 5100,-3061.8055 5192.1772,-2845.2602 5281.309,-2590.658 5339.5654,-2416.1398"/>
<polygon fill="#000000" stroke="#000000" points="5342.907,-2417.1828 5342.7494,-2406.5891 5336.2663,-2414.9688 5342.907,-2417.1828"/>
</g>
<!-- header_45 -->
<g id="node46" class="node">
<title>header_45</title>
<ellipse fill="none" stroke="#000000" cx="6621" cy="-2207.804" rx="54.6851" ry="18"/>
<text text-anchor="middle" x="6621" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : includes</text>
</g>
<!-- section_12&#45;&gt;header_45 -->
<g id="edge45" class="edge">
<title>section_12&#45;&gt;header_45</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6874.3184,-3831.3237C6847.7678,-3746.0037 6735.1054,-3374.766 6685,-3061.8055 6633.5299,-2740.3211 6623.2855,-2343.9608 6621.399,-2236.0474"/>
<polygon fill="#000000" stroke="#000000" points="6624.8972,-2235.9053 6621.2329,-2225.9644 6617.8982,-2236.0207 6624.8972,-2235.9053"/>
</g>
<!-- block_46 -->
<g id="node47" class="node">
<title>block_46</title>
<ellipse fill="none" stroke="#000000" cx="6750" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="6750" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 71&#45;72</text>
</g>
<!-- section_12&#45;&gt;block_46 -->
<g id="edge46" class="edge">
<title>section_12&#45;&gt;block_46</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6878.4695,-3831.3806C6871.1931,-3745.5723 6839.4367,-3369.8835 6815,-3061.8055 6789.2537,-2737.2179 6759.9938,-2343.0632 6752.0695,-2235.8527"/>
<polygon fill="#000000" stroke="#000000" points="6755.5569,-2235.5514 6751.3296,-2225.8365 6748.5759,-2236.0672 6755.5569,-2235.5514"/>
</g>
<!-- block_47 -->
<g id="node48" class="node">
<title>block_47</title>
<ellipse fill="none" stroke="#000000" cx="6880" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="6880" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 73&#45;81</text>
</g>
<!-- section_12&#45;&gt;block_47 -->
<g id="edge47" class="edge">
<title>section_12&#45;&gt;block_47</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6880,-3831.2514C6880,-3666.9528 6880,-2438.2916 6880,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="6883.5001,-2235.8553 6880,-2225.8554 6876.5001,-2235.8554 6883.5001,-2235.8553"/>
</g>
<!-- block_48 -->
<g id="node49" class="node">
<title>block_48</title>
<ellipse fill="none" stroke="#000000" cx="7021" cy="-2207.804" rx="55.6542" ry="18"/>
<text text-anchor="middle" x="7021" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 82&#45;83</text>
</g>
<!-- section_12&#45;&gt;block_48 -->
<g id="edge48" class="edge">
<title>section_12&#45;&gt;block_48</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6881.5594,-3831.2514C6895.6713,-3666.9528 7001.203,-2438.2916 7018.581,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="7022.0808,-2236.1182 7019.4495,-2225.8554 7015.1065,-2235.5191 7022.0808,-2236.1182"/>
</g>
<!-- block_49 -->
<g id="node50" class="node">
<title>block_49</title>
<ellipse fill="none" stroke="#000000" cx="7160" cy="-2207.804" rx="60.9913" ry="18"/>
<text text-anchor="middle" x="7160" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 84&#45;101</text>
</g>
<!-- section_12&#45;&gt;block_49 -->
<g id="edge49" class="edge">
<title>section_12&#45;&gt;block_49</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6885.9483,-3831.3413C6913.7543,-3746.1007 7031.8452,-3375.1665 7086,-3061.8055 7141.4965,-2740.681 7156.1959,-2344.0648 7159.2867,-2236.0699"/>
<polygon fill="#000000" stroke="#000000" points="7162.7879,-2236.072 7159.5653,-2225.9792 7155.7906,-2235.8788 7162.7879,-2236.072"/>
</g>
<!-- leaf_58 -->
<g id="node59" class="node">
<title>leaf_58</title>
<polygon fill="none" stroke="#c0c0c0" points="7619,-2460.3047 7239,-2460.3047 7239,-1955.3032 7619,-1955.3032 7619,-2460.3047"/>
<text text-anchor="middle" x="7429" y="-2445.1044" font-family="Inconsolata" font-size="14.00" fill="#000000">*** includes</text>
<text text-anchor="middle" x="7429" y="-2413.7043" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="7429" y="-2398.3043" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="7429" y="-2366.9043" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require &quot;status&quot; </text>
<text text-anchor="middle" x="7429" y="-2351.5042" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
<text text-anchor="middle" x="7429" y="-2336.1042" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="7429" y="-2304.7042" font-family="Inconsolata" font-size="14.00" fill="#000000">I like the dedication shown in this style of import.</text>
<text text-anchor="middle" x="7429" y="-2273.3041" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s the kind of thing I&#39;d like to automate. </text>
<text text-anchor="middle" x="7429" y="-2241.9041" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="7429" y="-2226.5041" font-family="Inconsolata" font-size="14.00" fill="#000000">local assert = assert</text>
<text text-anchor="middle" x="7429" y="-2211.104" font-family="Inconsolata" font-size="14.00" fill="#000000">local string, io = assert( string ), assert( io )</text>
<text text-anchor="middle" x="7429" y="-2195.704" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = string.sub( assert( _VERSION ), &#45;4 )</text>
<text text-anchor="middle" x="7429" y="-2180.304" font-family="Inconsolata" font-size="14.00" fill="#000000">local _G = assert( _G )</text>
<text text-anchor="middle" x="7429" y="-2164.9039" font-family="Inconsolata" font-size="14.00" fill="#000000">local error = assert( error )</text>
<text text-anchor="middle" x="7429" y="-2149.5039" font-family="Inconsolata" font-size="14.00" fill="#000000">local pairs = assert( pairs )</text>
<text text-anchor="middle" x="7429" y="-2134.1039" font-family="Inconsolata" font-size="14.00" fill="#000000">local next = assert( next )</text>
<text text-anchor="middle" x="7429" y="-2118.7039" font-family="Inconsolata" font-size="14.00" fill="#000000">local type = assert( type )</text>
<text text-anchor="middle" x="7429" y="-2103.3038" font-family="Inconsolata" font-size="14.00" fill="#000000">local tostring = assert( tostring )</text>
<text text-anchor="middle" x="7429" y="-2087.9038" font-family="Inconsolata" font-size="14.00" fill="#000000">local setmetatable = assert( setmetatable )</text>
<text text-anchor="middle" x="7429" y="-2072.5038" font-family="Inconsolata" font-size="14.00" fill="#000000">if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="7429" y="-2057.1037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local setfenv = assert( setfenv )</text>
<text text-anchor="middle" x="7429" y="-2041.7037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local getfenv = assert( getfenv )</text>
<text text-anchor="middle" x="7429" y="-2026.3037" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="7429" y="-2010.9036" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="7429" y="-1963.5036" font-family="Inconsolata" font-size="14.00" fill="#000000">*</text>
</g>
<!-- section_12&#45;&gt;leaf_58 -->
<g id="edge58" class="edge">
<title>section_12&#45;&gt;leaf_58</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6889.5932,-3831.3167C6934.1301,-3746.6998 7123.079,-3380.6484 7230,-3061.8055 7295.1667,-2867.4757 7346.8305,-2641.3382 7381.1696,-2470.6006"/>
<polygon fill="#000000" stroke="#000000" points="7384.6163,-2471.2133 7383.1498,-2460.7205 7377.7528,-2469.8376 7384.6163,-2471.2133"/>
</g>
<!-- header_59 -->
<g id="node60" class="node">
<title>header_59</title>
<ellipse fill="none" stroke="#000000" cx="7685" cy="-2207.804" rx="46.4822" ry="18"/>
<text text-anchor="middle" x="7685" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">3 : define</text>
</g>
<!-- section_13&#45;&gt;header_59 -->
<g id="edge59" class="edge">
<title>section_13&#45;&gt;header_59</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7957.3318,-3831.4226C7926.1941,-3746.5482 7794.3358,-3377.0142 7740,-3061.8055 7684.7328,-2741.1934 7683.7725,-2344.2131 7684.6506,-2236.1021"/>
<polygon fill="#000000" stroke="#000000" points="7688.1513,-2236.0328 7684.7454,-2226.0003 7681.1516,-2235.967 7688.1513,-2236.0328"/>
</g>
<!-- block_60 -->
<g id="node61" class="node">
<title>block_60</title>
<ellipse fill="none" stroke="#000000" cx="7815" cy="-2207.804" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="7815" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 102&#45;103</text>
</g>
<!-- section_13&#45;&gt;block_60 -->
<g id="edge60" class="edge">
<title>section_13&#45;&gt;block_60</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7962.2264,-3831.3825C7953.7958,-3745.5825 7917.0195,-3369.926 7889,-3061.8055 7859.4869,-2737.26 7826.3191,-2343.0754 7817.3434,-2235.8553"/>
<polygon fill="#000000" stroke="#000000" points="7820.827,-2235.5116 7816.5054,-2225.8382 7813.8513,-2236.0953 7820.827,-2235.5116"/>
</g>
<!-- block_61 -->
<g id="node62" class="node">
<title>block_61</title>
<ellipse fill="none" stroke="#000000" cx="7964" cy="-2207.804" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="7964" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 104&#45;180</text>
</g>
<!-- section_13&#45;&gt;block_61 -->
<g id="edge61" class="edge">
<title>section_13&#45;&gt;block_61</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7964,-3831.2514C7964,-3666.9528 7964,-2438.2916 7964,-2235.9676"/>
<polygon fill="#000000" stroke="#000000" points="7967.5001,-2235.8553 7964,-2225.8554 7960.5001,-2235.8554 7967.5001,-2235.8553"/>
</g>
<!-- block_62 -->
<g id="node63" class="node">
<title>block_62</title>
<ellipse fill="none" stroke="#000000" cx="8113" cy="-2207.804" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="8113" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 181&#45;192</text>
</g>
<!-- section_13&#45;&gt;block_62 -->
<g id="edge62" class="edge">
<title>section_13&#45;&gt;block_62</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7965.7736,-3831.3825C7974.2042,-3745.5825 8010.9805,-3369.926 8039,-3061.8055 8068.5131,-2737.26 8101.6809,-2343.0754 8110.6566,-2235.8553"/>
<polygon fill="#000000" stroke="#000000" points="8114.1487,-2236.0953 8111.4946,-2225.8382 8107.173,-2235.5116 8114.1487,-2236.0953"/>
</g>
<!-- block_63 -->
<g id="node64" class="node">
<title>block_63</title>
<ellipse fill="none" stroke="#000000" cx="8369" cy="-2207.804" rx="65.8274" ry="18"/>
<text text-anchor="middle" x="8369" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 193&#45;208</text>
</g>
<!-- section_13&#45;&gt;block_63 -->
<g id="edge63" class="edge">
<title>section_13&#45;&gt;block_63</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7959.4289,-3831.3165C7937.454,-3739.7306 7851.5327,-3322.7483 8047,-3097.8055 8089.423,-3048.9854 8143.2165,-3108.4697 8188,-3061.8055 8421.0402,-2818.9787 8385.9758,-2354.8213 8372.586,-2236.0401"/>
<polygon fill="#000000" stroke="#000000" points="8376.043,-2235.4679 8371.4041,-2225.9427 8369.0904,-2236.2818 8376.043,-2235.4679"/>
</g>
<!-- block_64 -->
<g id="node65" class="node">
<title>block_64</title>
<ellipse fill="none" stroke="#000000" cx="8576" cy="-2207.804" rx="65.0229" ry="18"/>
<text text-anchor="middle" x="8576" y="-2203.604" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">block 209&#45;211</text>
</g>
<!-- section_13&#45;&gt;block_64 -->
<g id="edge64" class="edge">
<title>section_13&#45;&gt;block_64</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7958.9284,-3831.3099C7933.9726,-3737.933 7833.7604,-3306.916 8047,-3097.8055 8110.2479,-3035.7824 8379.4222,-3122.4427 8444,-3061.8055 8687.6458,-2833.0271 8607.202,-2355.7029 8582.2184,-2235.662"/>
<polygon fill="#000000" stroke="#000000" points="8585.6218,-2234.8394 8580.1182,-2225.7862 8578.7749,-2236.2955 8585.6218,-2234.8394"/>
</g>
<!-- leaf_78 -->
<g id="node79" class="node">
<title>leaf_78</title>
<polygon fill="none" stroke="#c0c0c0" points="9186.5,-3061.8071 8659.5,-3061.8071 8659.5,-1353.8008 9186.5,-1353.8008 9186.5,-3061.8071"/>
<text text-anchor="middle" x="8923" y="-3046.6055" font-family="Inconsolata" font-size="14.00" fill="#000000">*** define</text>
<text text-anchor="middle" x="8923" y="-3015.2055" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8923" y="-2999.8055" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_ast_node(id, first, t, last, str, metas, offset)</text>
<text text-anchor="middle" x="8923" y="-2984.4054" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local offset = offset or 0</text>
<text text-anchor="middle" x="8923" y="-2969.0054" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.first = first + offset</text>
<text text-anchor="middle" x="8923" y="-2953.6054" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.last &#160;= last + offset &#45; 1</text>
<text text-anchor="middle" x="8923" y="-2938.2053" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.str &#160;&#160;= str</text>
<text text-anchor="middle" x="8923" y="-2922.8053" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if metas[id] then</text>
<text text-anchor="middle" x="8923" y="-2907.4053" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;t = metas[id](t, str)</text>
<text text-anchor="middle" x="8923" y="-2892.0052" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;assert(t.id == id)</text>
<text text-anchor="middle" x="8923" y="-2876.6052" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="8923" y="-2861.2052" font-family="Inconsolata" font-size="14.00" fill="#000000">	 &#160;t.id = id</text>
<text text-anchor="middle" x="8923" y="-2845.8051" font-family="Inconsolata" font-size="14.00" fill="#000000">	 &#160;setmetatable(t, {__index = Node,</text>
<text text-anchor="middle" x="8923" y="-2830.4051" font-family="Inconsolata" font-size="14.00" fill="#000000">	 &#160;	 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;__tostring = Node.toString})</text>
<text text-anchor="middle" x="8923" y="-2815.0051" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="8923" y="-2799.6051" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;assert(t.isNode, &quot;failed isNode: &quot; .. id)</text>
<text text-anchor="middle" x="8923" y="-2784.205" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;assert(t.str)</text>
<text text-anchor="middle" x="8923" y="-2768.805" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return t</text>
<text text-anchor="middle" x="8923" y="-2753.405" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="8923" y="-2706.0049" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; some useful/common lpeg patterns</text>
<text text-anchor="middle" x="8923" y="-2690.6049" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cp = L.Cp</text>
<text text-anchor="middle" x="8923" y="-2675.2049" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cc = L.Cc</text>
<text text-anchor="middle" x="8923" y="-2659.8048" font-family="Inconsolata" font-size="14.00" fill="#000000">local Ct = L.Ct</text>
<text text-anchor="middle" x="8923" y="-2644.4048" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg1_str = L.Carg(1)</text>
<text text-anchor="middle" x="8923" y="-2629.0048" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg2_metas = L.Carg(2)</text>
<text text-anchor="middle" x="8923" y="-2613.6047" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg3_offset = L.Carg(3)</text>
<text text-anchor="middle" x="8923" y="-2566.2047" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; setup an environment where you can easily define lpeg grammars</text>
<text text-anchor="middle" x="8923" y="-2550.8047" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; with lots of syntax sugar</text>
<text text-anchor="middle" x="8923" y="-2535.4047" font-family="Inconsolata" font-size="14.00" fill="#000000">local function define(func, g, e)</text>
<text text-anchor="middle" x="8923" y="-2520.0046" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;g = g or {}</text>
<text text-anchor="middle" x="8923" y="-2504.6046" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if e == nil then</text>
<text text-anchor="middle" x="8923" y="-2489.2046" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;e = V == &quot; 5.1&quot; and getfenv(func) or _G</text>
<text text-anchor="middle" x="8923" y="-2473.8045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="8923" y="-2458.4045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local suppressed = {}</text>
<text text-anchor="middle" x="8923" y="-2443.0045" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env = {}</text>
<text text-anchor="middle" x="8923" y="-2427.6044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env_index = {</text>
<text text-anchor="middle" x="8923" y="-2412.2044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;START = function(name) g[1] = name end,</text>
<text text-anchor="middle" x="8923" y="-2396.8044" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;SUPPRESS = function(...)</text>
<text text-anchor="middle" x="8923" y="-2381.4043" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;suppressed = {}</text>
<text text-anchor="middle" x="8923" y="-2366.0043" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;for i = 1, select(&#39;#&#39;, ...) do</text>
<text text-anchor="middle" x="8923" y="-2350.6043" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;suppressed[select(i, ... )] = true</text>
<text text-anchor="middle" x="8923" y="-2335.2042" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="8923" y="-2319.8042" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end,</text>
<text text-anchor="middle" x="8923" y="-2304.4042" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;V = L.V,</text>
<text text-anchor="middle" x="8923" y="-2289.0042" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;P = L.P,</text>
<text text-anchor="middle" x="8923" y="-2273.6041" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;}</text>
<text text-anchor="middle" x="8923" y="-2242.2041" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env_index, { __index = e })</text>
<text text-anchor="middle" x="8923" y="-2226.8041" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env, {</text>
<text text-anchor="middle" x="8923" y="-2211.404" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__index = env_index,</text>
<text text-anchor="middle" x="8923" y="-2196.004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__newindex = function( _, name, val )</text>
<text text-anchor="middle" x="8923" y="-2180.604" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if suppressed[ name ] then</text>
<text text-anchor="middle" x="8923" y="-2165.2039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = val</text>
<text text-anchor="middle" x="8923" y="-2149.8039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else</text>
<text text-anchor="middle" x="8923" y="-2134.4039" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = (Cc(name) </text>
<text text-anchor="middle" x="8923" y="-2119.0038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* Cp() </text>
<text text-anchor="middle" x="8923" y="-2103.6038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* Ct(val)</text>
<text text-anchor="middle" x="8923" y="-2088.2038" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* Cp()</text>
<text text-anchor="middle" x="8923" y="-2072.8037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* arg1_str</text>
<text text-anchor="middle" x="8923" y="-2057.4037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* arg2_metas)</text>
<text text-anchor="middle" x="8923" y="-2042.0037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;			* arg3_offset / make_ast_node</text>
<text text-anchor="middle" x="8923" y="-2026.6037" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="8923" y="-2011.2036" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="8923" y="-1995.8036" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;})</text>
<text text-anchor="middle" x="8923" y="-1980.4036" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45;&#45; call passed function with custom environment (5.1&#45; and 5.2&#45;style)</text>
<text text-anchor="middle" x="8923" y="-1965.0035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="8923" y="-1949.6035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;setfenv( func, env )</text>
<text text-anchor="middle" x="8923" y="-1934.2035" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="8923" y="-1918.8034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;func( env )</text>
<text text-anchor="middle" x="8923" y="-1903.4034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert( g[ 1 ] and g[ g[ 1 ] ], &quot;no start rule defined&quot; )</text>
<text text-anchor="middle" x="8923" y="-1888.0034" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return g</text>
<text text-anchor="middle" x="8923" y="-1872.6033" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="8923" y="-1857.2033" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="8923" y="-1825.8033" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8923" y="-1810.4032" font-family="Inconsolata" font-size="14.00" fill="#000000">local function refineMetas(metas)</text>
<text text-anchor="middle" x="8923" y="-1795.0032" font-family="Inconsolata" font-size="14.00" fill="#000000">	for _,v in pairs(metas) do</text>
<text text-anchor="middle" x="8923" y="-1779.6032" font-family="Inconsolata" font-size="14.00" fill="#000000">		if not v[&quot;__tostring&quot;] then</text>
<text text-anchor="middle" x="8923" y="-1764.2032" font-family="Inconsolata" font-size="14.00" fill="#000000">			v[&quot;__tostring&quot;] = Node.toString</text>
<text text-anchor="middle" x="8923" y="-1748.8031" font-family="Inconsolata" font-size="14.00" fill="#000000">		end</text>
<text text-anchor="middle" x="8923" y="-1733.4031" font-family="Inconsolata" font-size="14.00" fill="#000000">	end</text>
<text text-anchor="middle" x="8923" y="-1718.0031" font-family="Inconsolata" font-size="14.00" fill="#000000">	return metas</text>
<text text-anchor="middle" x="8923" y="-1702.603" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="8923" y="-1687.203" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="8923" y="-1639.803" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8923" y="-1624.4029" font-family="Inconsolata" font-size="14.00" fill="#000000">local function new(grammar_template, metas)</text>
<text text-anchor="middle" x="8923" y="-1609.0029" font-family="Inconsolata" font-size="14.00" fill="#000000">	if type(grammar_template) == &#39;function&#39; then</text>
<text text-anchor="middle" x="8923" y="-1593.6029" font-family="Inconsolata" font-size="14.00" fill="#000000">		local metas = metas or {}</text>
<text text-anchor="middle" x="8923" y="-1578.2028" font-family="Inconsolata" font-size="14.00" fill="#000000">		local grammar = define(grammar_template, nil, metas)</text>
<text text-anchor="middle" x="8923" y="-1562.8028" font-family="Inconsolata" font-size="14.00" fill="#000000">		local parse = function(str, offset)</text>
<text text-anchor="middle" x="8923" y="-1547.4028" font-family="Inconsolata" font-size="14.00" fill="#000000">			local offset = offset or 0</text>
<text text-anchor="middle" x="8923" y="-1532.0027" font-family="Inconsolata" font-size="14.00" fill="#000000">			return L.match(grammar, str, 1, str, metas, offset) &#45;&#45; other </text>
<text text-anchor="middle" x="8923" y="-1516.6027" font-family="Inconsolata" font-size="14.00" fill="#000000">		end</text>
<text text-anchor="middle" x="8923" y="-1501.2027" font-family="Inconsolata" font-size="14.00" fill="#000000">		return parse</text>
<text text-anchor="middle" x="8923" y="-1485.8027" font-family="Inconsolata" font-size="14.00" fill="#000000">	else</text>
<text text-anchor="middle" x="8923" y="-1470.4026" font-family="Inconsolata" font-size="14.00" fill="#000000">		s:halt(&quot;no way to build grammar out of &quot; .. type(template))</text>
<text text-anchor="middle" x="8923" y="-1455.0026" font-family="Inconsolata" font-size="14.00" fill="#000000">	end</text>
<text text-anchor="middle" x="8923" y="-1439.6026" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="8923" y="-1424.2025" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
<text text-anchor="middle" x="8923" y="-1392.8025" font-family="Inconsolata" font-size="14.00" fill="#000000">#!lua</text>
<text text-anchor="middle" x="8923" y="-1377.4025" font-family="Inconsolata" font-size="14.00" fill="#000000">return new</text>
<text text-anchor="middle" x="8923" y="-1362.0024" font-family="Inconsolata" font-size="14.00" fill="#000000">#/lua</text>
</g>
<!-- section_13&#45;&gt;leaf_78 -->
<g id="edge78" class="edge">
<title>section_13&#45;&gt;leaf_78</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7958.8096,-3831.1869C7933.2612,-3737.1963 7830.5653,-3303.6072 8047,-3097.8055 8144.2805,-3005.3042 8543.9946,-3144.1637 8650,-3061.8055 8650.3841,-3061.5071 8650.7677,-3061.2081 8651.1508,-3060.9086"/>
<polygon fill="#000000" stroke="#000000" points="8653.4921,-3063.5179 8659.1173,-3054.5397 8649.121,-3058.0503 8653.4921,-3063.5179"/>
</g>
<!-- leaf_25 -->
<g id="node26" class="node">
<title>leaf_25</title>
<polygon fill="none" stroke="#c0c0c0" points="562,-1287.4027 0,-1287.4027 0,-1217.0019 562,-1217.0019 562,-1287.4027"/>
<text text-anchor="middle" x="281" y="-1256.1023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;The internal function @define creates a custom environment variable, neatly</text>
<text text-anchor="middle" x="281" y="-1240.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">sidestepping lua&#39;s pedantic insistance on prepending =local= to all values of </text>
<text text-anchor="middle" x="281" y="-1225.3023" font-family="Inconsolata" font-size="14.00" fill="#000000">significance. </text>
</g>
<!-- block_18&#45;&gt;leaf_25 -->
<g id="edge25" class="edge">
<title>block_18&#45;&gt;leaf_25</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2194.749,-2189.4601C2205.1177,-2076.1491 2253.9304,-1472.4354 2129,-1353.8024 2097.6089,-1323.9936 613.9634,-1323.1042 571,-1317.8024 521.4974,-1311.6936 468.0485,-1300.8504 420.685,-1289.7171"/>
<polygon fill="#000000" stroke="#000000" points="421.2123,-1286.2451 410.6741,-1287.3386 419.5942,-1293.0555 421.2123,-1286.2451"/>
</g>
<!-- leaf_26 -->
<g id="node27" class="node">
<title>leaf_26</title>
<polygon fill="none" stroke="#c0c0c0" points="1121.5,-1271.5029 580.5,-1271.5029 580.5,-1232.9017 1121.5,-1232.9017 1121.5,-1271.5029"/>
<text text-anchor="middle" x="851" y="-1256.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">More relevantly, it constructs a full grammar, which will return a table of</text>
<text text-anchor="middle" x="851" y="-1241.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">type Node. </text>
</g>
<!-- block_19&#45;&gt;leaf_26 -->
<g id="edge26" class="edge">
<title>block_19&#45;&gt;leaf_26</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2324.7119,-2189.4732C2334.8533,-2076.2413 2382.4874,-1472.9221 2258,-1353.8024 2212.6995,-1310.4552 1192.1579,-1326.0184 1130,-1317.8024 1060.0807,-1308.5605 982.0581,-1289.4427 926.3392,-1274.2182"/>
<polygon fill="#000000" stroke="#000000" points="927.1212,-1270.8033 916.5507,-1271.5209 925.2616,-1277.5518 927.1212,-1270.8033"/>
</g>
<!-- leaf_27 -->
<g id="node28" class="node">
<title>leaf_27</title>
<polygon fill="none" stroke="#c0c0c0" points="1680.5,-1286.8035 1139.5,-1286.8035 1139.5,-1217.601 1680.5,-1217.601 1680.5,-1286.8035"/>
<text text-anchor="middle" x="1410" y="-1271.8023" font-family="Inconsolata" font-size="14.00" fill="#000000">If you stick to =lpeg= patterns, as you should, all array values will be of</text>
<text text-anchor="middle" x="1410" y="-1256.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">Node, as is intended. &#160;Captures will interpolate various other sorts of Lua</text>
<text text-anchor="middle" x="1410" y="-1241.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">values, which will induce halting in some places and silently corrupt</text>
<text text-anchor="middle" x="1410" y="-1225.6022" font-family="Inconsolata" font-size="14.00" fill="#000000">execution in others. </text>
</g>
<!-- block_20&#45;&gt;leaf_27 -->
<g id="edge27" class="edge">
<title>block_20&#45;&gt;leaf_27</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2454.6804,-2189.5058C2464.6316,-2076.4708 2511.3169,-1474.1334 2388,-1353.8024 2332.3388,-1299.489 1765.9957,-1328.7466 1689,-1317.8024 1641.8422,-1311.0994 1590.9411,-1300.2369 1545.6898,-1289.2628"/>
<polygon fill="#000000" stroke="#000000" points="1546.3694,-1285.8258 1535.8238,-1286.8469 1544.7044,-1292.625 1546.3694,-1285.8258"/>
</g>
<!-- leaf_28 -->
<g id="node29" class="node">
<title>leaf_28</title>
<polygon fill="none" stroke="#c0c0c0" points="2253.5,-1286.8035 1698.5,-1286.8035 1698.5,-1217.601 2253.5,-1217.601 2253.5,-1286.8035"/>
<text text-anchor="middle" x="1976" y="-1271.8023" font-family="Inconsolata" font-size="14.00" fill="#000000">Though as yet poorly thought through, the [[elpatt module][./elpatt]] is</text>
<text text-anchor="middle" x="1976" y="-1256.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">intended to provide only those patterns which are allowed in Grammars, while</text>
<text text-anchor="middle" x="1976" y="-1241.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">expanding the scope of some favorites to properly respect utf&#45;8 and otherwise</text>
<text text-anchor="middle" x="1976" y="-1225.6022" font-family="Inconsolata" font-size="14.00" fill="#000000">behave. </text>
</g>
<!-- block_21&#45;&gt;leaf_28 -->
<g id="edge28" class="edge">
<title>block_21&#45;&gt;leaf_28</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2584.5333,-2189.6499C2593.5968,-2077.4853 2635.8549,-1479.4878 2518,-1353.8024 2478.8546,-1312.0561 2319.2784,-1328.1876 2263,-1317.8024 2218.4909,-1309.589 2170.4336,-1299.2085 2126.6084,-1289.1429"/>
<polygon fill="#000000" stroke="#000000" points="2127.2718,-1285.7041 2116.7409,-1286.8656 2125.6976,-1292.5248 2127.2718,-1285.7041"/>
</g>
<!-- leaf_29 -->
<g id="node30" class="node">
<title>leaf_29</title>
<polygon fill="none" stroke="#c0c0c0" points="2736,-1270.2023 2272,-1270.2023 2272,-1234.2023 2736,-1234.2023 2736,-1270.2023"/>
<text text-anchor="middle" x="2504" y="-1248.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">There are examples of the format in the [[spec module][./spec]].</text>
</g>
<!-- block_22&#45;&gt;leaf_29 -->
<g id="edge29" class="edge">
<title>block_22&#45;&gt;leaf_29</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2716.906,-2189.6603C2736.3336,-2094.7264 2815.1374,-1648.3321 2648,-1353.8024 2627.7278,-1318.0787 2589.117,-1291.8822 2556.9763,-1275.0448"/>
<polygon fill="#000000" stroke="#000000" points="2558.1737,-1271.728 2547.6713,-1270.332 2555.0109,-1277.9727 2558.1737,-1271.728"/>
</g>
<!-- leaf_30 -->
<g id="node31" class="node">
<title>leaf_30</title>
<polygon fill="none" stroke="#c0c0c0" points="2931.5,-1270.2023 2754.5,-1270.2023 2754.5,-1234.2023 2931.5,-1234.2023 2931.5,-1270.2023"/>
<text text-anchor="middle" x="2843" y="-1248.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">Special fields include:</text>
</g>
<!-- block_23&#45;&gt;leaf_30 -->
<g id="edge30" class="edge">
<title>block_23&#45;&gt;leaf_30</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2843,-2189.5679C2843,-2072.2526 2843,-1424.1373 2843,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="2846.5001,-1280.2429 2843,-1270.2429 2839.5001,-1280.2429 2846.5001,-1280.2429"/>
</g>
<!-- leaf_31 -->
<g id="node32" class="node">
<title>leaf_31</title>
<polygon fill="none" stroke="#c0c0c0" points="3498,-1302.7024 2950,-1302.7024 2950,-1201.7021 3498,-1201.7021 3498,-1302.7024"/>
<text text-anchor="middle" x="3224" y="-1287.5024" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;START : &#160;a string which must be the same as the starting rule.</text>
<text text-anchor="middle" x="3224" y="-1272.1023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;SUPPRESS : &#160;either a string or an array of strings. These rules will be</text>
<text text-anchor="middle" x="3224" y="-1256.7023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;removed from the Node. </text>
<text text-anchor="middle" x="3224" y="-1241.3023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;P : &#160;The lpeg P function. &#160;Recognizes a certain pattern.</text>
<text text-anchor="middle" x="3224" y="-1225.9022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45; &#160;V : &#160;The lpeg V function. &#160;Used for non&#45;terminal rvalues in a grammar. </text>
</g>
<!-- block_24&#45;&gt;leaf_31 -->
<g id="edge31" class="edge">
<title>block_24&#45;&gt;leaf_31</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M2968.5621,-2189.6108C2946.2093,-2093.5067 2854.0828,-1638.5989 3038,-1353.8024 3049.4933,-1336.005 3065.2257,-1321.0737 3082.7089,-1308.6197"/>
<polygon fill="#000000" stroke="#000000" points="3085.1148,-1311.2167 3091.4213,-1302.7032 3081.1822,-1305.4257 3085.1148,-1311.2167"/>
</g>
<!-- leaf_39 -->
<g id="node40" class="node">
<title>leaf_39</title>
<polygon fill="none" stroke="#c0c0c0" points="4113.5,-1279.5027 3516.5,-1279.5027 3516.5,-1224.9019 4113.5,-1224.9019 4113.5,-1279.5027"/>
<text text-anchor="middle" x="3815" y="-1248.4023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;By default a node will inherit from the Node class. &#160;If you want custom behavior,</text>
<text text-anchor="middle" x="3815" y="-1233.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">you must pass in a table of metatable constructors.</text>
</g>
<!-- block_34&#45;&gt;leaf_39 -->
<g id="edge39" class="edge">
<title>block_34&#45;&gt;leaf_39</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4516.5853,-2189.6005C4525.9623,-2077.1371 4569.7845,-1477.6502 4450,-1353.8024 4399.0221,-1301.0953 4194.391,-1329.4787 4122,-1317.8024 4061.597,-1308.0598 3995.1346,-1294.2471 3939.5423,-1281.8074"/>
<polygon fill="#000000" stroke="#000000" points="3940.1743,-1278.3622 3929.65,-1279.5828 3938.6384,-1285.1917 3940.1743,-1278.3622"/>
</g>
<!-- leaf_40 -->
<g id="node41" class="node">
<title>leaf_40</title>
<polygon fill="none" stroke="#c0c0c0" points="4700.5,-1317.9027 4131.5,-1317.9027 4131.5,-1186.5019 4700.5,-1186.5019 4700.5,-1317.9027"/>
<text text-anchor="middle" x="4416" y="-1302.6024" font-family="Inconsolata" font-size="14.00" fill="#000000">That&#39;s a fairly specific beast. &#160;Any rule defined above will have an =id=</text>
<text text-anchor="middle" x="4416" y="-1287.2024" font-family="Inconsolata" font-size="14.00" fill="#000000">corresonding to the name of the rule. &#160;Unless =SUPPRESS=ed, this will become</text>
<text text-anchor="middle" x="4416" y="-1271.8023" font-family="Inconsolata" font-size="14.00" fill="#000000">a Node. &#160;If the =metas= parameter has a key corresponding to =id=, then it</text>
<text text-anchor="middle" x="4416" y="-1256.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">must return a function taking two parameters:</text>
<text text-anchor="middle" x="4416" y="-1241.0023" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;</text>
<text text-anchor="middle" x="4416" y="-1225.6022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; node : &#160;The node under construction, which under normal circumstances will</text>
<text text-anchor="middle" x="4416" y="-1210.2022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;already have the =first= and =last= fields.</text>
<text text-anchor="middle" x="4416" y="-1194.8022" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#45; str &#160;: &#160;The entire str the grammar is parsing.</text>
</g>
<!-- block_35&#45;&gt;leaf_40 -->
<g id="edge40" class="edge">
<title>block_35&#45;&gt;leaf_40</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4649.1559,-2189.7874C4670.0722,-2094.5835 4756.0611,-1643.5214 4580,-1353.8024 4573.5493,-1343.1874 4565.5259,-1333.5158 4556.5207,-1324.7369"/>
<polygon fill="#000000" stroke="#000000" points="4558.8216,-1322.0976 4549.0995,-1317.8868 4554.0737,-1327.2414 4558.8216,-1322.0976"/>
</g>
<!-- leaf_41 -->
<g id="node42" class="node">
<title>leaf_41</title>
<polygon fill="none" stroke="#c0c0c0" points="5287.5,-1270.2023 4718.5,-1270.2023 4718.5,-1234.2023 5287.5,-1234.2023 5287.5,-1270.2023"/>
<text text-anchor="middle" x="5003" y="-1248.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">Which must return that same node, decorated in whatever fashion is appropriate.</text>
</g>
<!-- block_36&#45;&gt;leaf_41 -->
<g id="edge41" class="edge">
<title>block_36&#45;&gt;leaf_41</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4770.8583,-2189.7961C4750.0147,-2094.6362 4664.3363,-1643.7625 4840,-1353.8024 4862.681,-1316.3639 4904.96,-1290.606 4940.7748,-1274.3937"/>
<polygon fill="#000000" stroke="#000000" points="4942.4405,-1277.4854 4950.2028,-1270.2745 4939.6379,-1271.0709 4942.4405,-1277.4854"/>
</g>
<!-- leaf_42 -->
<g id="node43" class="node">
<title>leaf_42</title>
<polygon fill="none" stroke="#c0c0c0" points="5882,-1279.4027 5306,-1279.4027 5306,-1225.0018 5882,-1225.0018 5882,-1279.4027"/>
<text text-anchor="middle" x="5594" y="-1264.1023" font-family="Inconsolata" font-size="14.00" fill="#000000">The node will not have a metatable at this point, and the function must attach a</text>
<text text-anchor="middle" x="5594" y="-1248.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">metatable with =__index= equal to some table which itself has the =__index=</text>
<text text-anchor="middle" x="5594" y="-1233.3023" font-family="Inconsolata" font-size="14.00" fill="#000000">Node as some recursive backstop.</text>
</g>
<!-- block_37&#45;&gt;leaf_42 -->
<g id="edge42" class="edge">
<title>block_37&#45;&gt;leaf_42</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M4903.4158,-2189.6016C4894.0455,-2077.1447 4850.2567,-1477.69 4970,-1353.8024 5020.6533,-1301.3959 5224.0852,-1329.6539 5296,-1317.8024 5355.0485,-1308.0712 5420.0127,-1294.1541 5474.173,-1281.6403"/>
<polygon fill="#000000" stroke="#000000" points="5475.2076,-1284.9932 5484.1564,-1279.3214 5473.6238,-1278.1748 5475.2076,-1284.9932"/>
</g>
<!-- leaf_43 -->
<g id="node44" class="node">
<title>leaf_43</title>
<polygon fill="none" stroke="#c0c0c0" points="6427.5,-1279.5027 5900.5,-1279.5027 5900.5,-1224.9019 6427.5,-1224.9019 6427.5,-1279.5027"/>
<text text-anchor="middle" x="6164" y="-1264.4023" font-family="Inconsolata" font-size="14.00" fill="#000000">You might say the return value must /inherit/ from Node, if we were using</text>
<text text-anchor="middle" x="6164" y="-1249.0023" font-family="Inconsolata" font-size="14.00" fill="#000000">a language that did that sort of thing. </text>
</g>
<!-- block_38&#45;&gt;leaf_43 -->
<g id="edge43" class="edge">
<title>block_38&#45;&gt;leaf_43</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M5033.2868,-2189.4974C5023.1346,-2076.4119 4975.4014,-1473.8222 5099,-1353.8024 5130.5989,-1323.1184 5847.3893,-1323.9758 5891,-1317.8024 5947.446,-1309.8121 6009.2954,-1295.431 6059.8303,-1282.1662"/>
<polygon fill="#000000" stroke="#000000" points="6061.011,-1285.4742 6069.7814,-1279.5303 6059.2186,-1278.7075 6061.011,-1285.4742"/>
</g>
<!-- leaf_50 -->
<g id="node51" class="node">
<title>leaf_50</title>
<polygon fill="none" stroke="#c0c0c0" points="6500,-1270.2023 6446,-1270.2023 6446,-1234.2023 6500,-1234.2023 6500,-1270.2023"/>
</g>
<!-- block_46&#45;&gt;leaf_50 -->
<g id="edge50" class="edge">
<title>block_46&#45;&gt;leaf_50</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6751.4278,-2189.7459C6759.854,-2078.1606 6798.9341,-1483.0526 6685,-1353.8024 6632.2036,-1293.9087 6573.2629,-1365.1838 6509,-1317.8024 6496.2948,-1308.4348 6487.5402,-1293.1811 6481.8482,-1279.7392"/>
<polygon fill="#000000" stroke="#000000" points="6485.1015,-1278.4478 6478.2322,-1270.3817 6478.5721,-1280.9711 6485.1015,-1278.4478"/>
</g>
<!-- codeblock_51 -->
<g id="node52" class="node">
<title>codeblock_51</title>
<ellipse fill="none" stroke="#000000" cx="6595" cy="-1252.2023" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="6595" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 73&#45;78</text>
</g>
<!-- block_47&#45;&gt;codeblock_51 -->
<g id="edge51" class="edge">
<title>block_47&#45;&gt;codeblock_51</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6885.326,-2189.7361C6913.1113,-2091.4193 7032.0726,-1615.6639 6815,-1353.8024 6775.6442,-1306.3263 6736.3378,-1345.0163 6681,-1317.8024 6659.332,-1307.1466 6637.7339,-1290.6448 6621.6022,-1276.8582"/>
<polygon fill="#000000" stroke="#000000" points="6623.5248,-1273.89 6613.6932,-1269.9416 6618.9167,-1279.1593 6623.5248,-1273.89"/>
</g>
<!-- leaf_53 -->
<g id="node54" class="node">
<title>leaf_53</title>
<polygon fill="none" stroke="#c0c0c0" points="7070,-1272.1044 6690,-1272.1044 6690,-1232.3002 7070,-1232.3002 7070,-1272.1044"/>
<text text-anchor="middle" x="6880" y="-1240.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">I like the dedication shown in this style of import.</text>
</g>
<!-- block_47&#45;&gt;leaf_53 -->
<g id="edge53" class="edge">
<title>block_47&#45;&gt;leaf_53</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6880,-2189.5679C6880,-2072.7644 6880,-1429.7819 6880,-1282.3387"/>
<polygon fill="#000000" stroke="#000000" points="6883.5001,-1282.2164 6880,-1272.2164 6876.5001,-1282.2164 6883.5001,-1282.2164"/>
</g>
<!-- leaf_54 -->
<g id="node55" class="node">
<title>leaf_54</title>
<polygon fill="none" stroke="#c0c0c0" points="7419.5,-1270.2023 7088.5,-1270.2023 7088.5,-1234.2023 7419.5,-1234.2023 7419.5,-1270.2023"/>
<text text-anchor="middle" x="7254" y="-1248.7023" font-family="Inconsolata" font-size="14.00" fill="#000000">It&#39;s the kind of thing I&#39;d like to automate. </text>
</g>
<!-- block_48&#45;&gt;leaf_54 -->
<g id="edge54" class="edge">
<title>block_48&#45;&gt;leaf_54</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7016.9507,-2189.7765C6996.5934,-2094.5168 6913.2005,-1643.2165 7090,-1353.8024 7112.9202,-1316.2829 7155.456,-1290.5271 7191.4643,-1274.3359"/>
<polygon fill="#000000" stroke="#000000" points="7193.1623,-1277.4145 7200.9426,-1270.2229 7190.3757,-1270.993 7193.1623,-1277.4145"/>
</g>
<!-- codeblock_55 -->
<g id="node56" class="node">
<title>codeblock_55</title>
<ellipse fill="none" stroke="#000000" cx="7515" cy="-1252.2023" rx="77.4211" ry="18"/>
<text text-anchor="middle" x="7515" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 84&#45;99</text>
</g>
<!-- block_49&#45;&gt;codeblock_55 -->
<g id="edge55" class="edge">
<title>block_49&#45;&gt;codeblock_55</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7154.5368,-2189.7319C7125.7268,-2090.4039 7001.211,-1606.2054 7230,-1353.8024 7290.0696,-1287.5329 7346.0762,-1353.698 7428,-1317.8024 7450.7817,-1307.8204 7473.1118,-1290.7871 7489.4445,-1276.5789"/>
<polygon fill="#000000" stroke="#000000" points="7491.8264,-1279.1444 7496.9562,-1269.8742 7487.1651,-1273.922 7491.8264,-1279.1444"/>
</g>
<!-- leaf_57 -->
<g id="node58" class="node">
<title>leaf_57</title>
<polygon fill="none" stroke="#c0c0c0" points="7664,-1270.2023 7610,-1270.2023 7610,-1234.2023 7664,-1234.2023 7664,-1270.2023"/>
</g>
<!-- block_49&#45;&gt;leaf_57 -->
<g id="edge57" class="edge">
<title>block_49&#45;&gt;leaf_57</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7154.2934,-2189.7369C7123.8464,-2089.427 6990.6606,-1596.7465 7230,-1353.8024 7288.1315,-1294.7954 7531.8423,-1363.3908 7601,-1317.8024 7614.354,-1308.9995 7623.1898,-1293.4911 7628.7647,-1279.7628"/>
<polygon fill="#000000" stroke="#000000" points="7632.1135,-1280.7962 7632.2657,-1270.2025 7625.5404,-1278.3891 7632.1135,-1280.7962"/>
</g>
<!-- leaf_52 -->
<g id="node53" class="node">
<title>leaf_52</title>
<polygon fill="none" stroke="#c0c0c0" points="6715,-610.5015 6475,-610.5015 6475,-540.1007 6715,-540.1007 6715,-610.5015"/>
<text text-anchor="middle" x="6595" y="-595.2011" font-family="Inconsolata" font-size="14.00" fill="#000000">local L = require &quot;lpeg&quot;</text>
<text text-anchor="middle" x="6595" y="-563.8011" font-family="Inconsolata" font-size="14.00" fill="#000000">local s = require &quot;status&quot; </text>
<text text-anchor="middle" x="6595" y="-548.4011" font-family="Inconsolata" font-size="14.00" fill="#000000">local Node = require &quot;node/node&quot;</text>
</g>
<!-- codeblock_51&#45;&gt;leaf_52 -->
<g id="edge52" class="edge">
<title>codeblock_51&#45;&gt;leaf_52</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M6595,-1234.0968C6595,-1145.358 6595,-755.2316 6595,-620.9219"/>
<polygon fill="#000000" stroke="#000000" points="6598.5001,-620.584 6595,-610.584 6591.5001,-620.5841 6598.5001,-620.584"/>
</g>
<!-- leaf_56 -->
<g id="node57" class="node">
<title>leaf_56</title>
<polygon fill="none" stroke="#c0c0c0" points="7424.5,-686.9019 7065.5,-686.9019 7065.5,-463.7003 7424.5,-463.7003 7424.5,-686.9019"/>
<text text-anchor="middle" x="7245" y="-671.9013" font-family="Inconsolata" font-size="14.00" fill="#000000">local assert = assert</text>
<text text-anchor="middle" x="7245" y="-656.5013" font-family="Inconsolata" font-size="14.00" fill="#000000">local string, io = assert( string ), assert( io )</text>
<text text-anchor="middle" x="7245" y="-641.1012" font-family="Inconsolata" font-size="14.00" fill="#000000">local V = string.sub( assert( _VERSION ), &#45;4 )</text>
<text text-anchor="middle" x="7245" y="-625.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">local _G = assert( _G )</text>
<text text-anchor="middle" x="7245" y="-610.3012" font-family="Inconsolata" font-size="14.00" fill="#000000">local error = assert( error )</text>
<text text-anchor="middle" x="7245" y="-594.9011" font-family="Inconsolata" font-size="14.00" fill="#000000">local pairs = assert( pairs )</text>
<text text-anchor="middle" x="7245" y="-579.5011" font-family="Inconsolata" font-size="14.00" fill="#000000">local next = assert( next )</text>
<text text-anchor="middle" x="7245" y="-564.1011" font-family="Inconsolata" font-size="14.00" fill="#000000">local type = assert( type )</text>
<text text-anchor="middle" x="7245" y="-548.701" font-family="Inconsolata" font-size="14.00" fill="#000000">local tostring = assert( tostring )</text>
<text text-anchor="middle" x="7245" y="-533.301" font-family="Inconsolata" font-size="14.00" fill="#000000">local setmetatable = assert( setmetatable )</text>
<text text-anchor="middle" x="7245" y="-517.901" font-family="Inconsolata" font-size="14.00" fill="#000000">if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="7245" y="-502.501" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local setfenv = assert( setfenv )</text>
<text text-anchor="middle" x="7245" y="-487.1009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local getfenv = assert( getfenv )</text>
<text text-anchor="middle" x="7245" y="-471.7009" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_55&#45;&gt;leaf_56 -->
<g id="edge56" class="edge">
<title>codeblock_55&#45;&gt;leaf_56</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7497.6159,-1234.5279C7479.5348,-1215.2981 7451.4747,-1182.9548 7434,-1150.6022 7354.5455,-1003.5006 7300.8716,-817.1519 7271.6094,-697.0839"/>
<polygon fill="#000000" stroke="#000000" points="7274.9518,-696.0144 7269.1994,-687.1172 7268.1479,-697.6597 7274.9518,-696.0144"/>
</g>
<!-- leaf_65 -->
<g id="node66" class="node">
<title>leaf_65</title>
<polygon fill="none" stroke="#c0c0c0" points="7736,-1270.2023 7682,-1270.2023 7682,-1234.2023 7736,-1234.2023 7736,-1270.2023"/>
</g>
<!-- block_60&#45;&gt;leaf_65 -->
<g id="edge65" class="edge">
<title>block_60&#45;&gt;leaf_65</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7814.8027,-2189.5798C7813.5266,-2098.5913 7804.2857,-1684.727 7740,-1353.8024 7735.036,-1328.2492 7726.1216,-1299.9868 7719.1222,-1279.7714"/>
<polygon fill="#000000" stroke="#000000" points="7722.396,-1278.5308 7715.7668,-1270.2661 7715.7952,-1280.8609 7722.396,-1278.5308"/>
</g>
<!-- codeblock_66 -->
<g id="node67" class="node">
<title>codeblock_66</title>
<ellipse fill="none" stroke="#000000" cx="7841" cy="-1252.2023" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="7841" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 104&#45;179</text>
</g>
<!-- block_61&#45;&gt;codeblock_66 -->
<g id="edge66" class="edge">
<title>block_61&#45;&gt;codeblock_66</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7964.821,-2189.6497C7968.4684,-2098.1617 7979.3264,-1679.2136 7890,-1353.8024 7882.6608,-1327.066 7868.4525,-1298.8275 7857.2177,-1278.9257"/>
<polygon fill="#000000" stroke="#000000" points="7860.1741,-1277.0464 7852.1427,-1270.1365 7854.1121,-1280.5467 7860.1741,-1277.0464"/>
</g>
<!-- leaf_68 -->
<g id="node69" class="node">
<title>leaf_68</title>
<polygon fill="none" stroke="#c0c0c0" points="8000,-1270.2023 7946,-1270.2023 7946,-1234.2023 8000,-1234.2023 8000,-1270.2023"/>
</g>
<!-- block_61&#45;&gt;leaf_68 -->
<g id="edge68" class="edge">
<title>block_61&#45;&gt;leaf_68</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7964.1718,-2189.5679C7965.2766,-2072.2526 7971.3807,-1424.1373 7972.7342,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="7976.2357,-1280.2754 7972.8301,-1270.2429 7969.236,-1280.2094 7976.2357,-1280.2754"/>
</g>
<!-- codeblock_69 -->
<g id="node70" class="node">
<title>codeblock_69</title>
<ellipse fill="none" stroke="#000000" cx="8105" cy="-1252.2023" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="8105" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 181&#45;190</text>
</g>
<!-- block_62&#45;&gt;codeblock_69 -->
<g id="edge69" class="edge">
<title>block_62&#45;&gt;codeblock_69</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8112.8473,-2189.5679C8111.8652,-2072.2526 8106.4394,-1424.1373 8105.2363,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="8108.7347,-1280.2132 8105.151,-1270.2429 8101.735,-1280.2719 8108.7347,-1280.2132"/>
</g>
<!-- leaf_71 -->
<g id="node72" class="node">
<title>leaf_71</title>
<polygon fill="none" stroke="#c0c0c0" points="8264,-1270.2023 8210,-1270.2023 8210,-1234.2023 8264,-1234.2023 8264,-1270.2023"/>
</g>
<!-- block_62&#45;&gt;leaf_71 -->
<g id="edge71" class="edge">
<title>block_62&#45;&gt;leaf_71</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8115.3663,-2189.5679C8130.5893,-2072.2526 8214.6895,-1424.1373 8233.3372,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="8236.843,-1280.6102 8234.659,-1270.2429 8229.9012,-1279.7093 8236.843,-1280.6102"/>
</g>
<!-- codeblock_72 -->
<g id="node73" class="node">
<title>codeblock_72</title>
<ellipse fill="none" stroke="#000000" cx="8369" cy="-1252.2023" rx="87.0948" ry="18"/>
<text text-anchor="middle" x="8369" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 193&#45;207</text>
</g>
<!-- block_63&#45;&gt;codeblock_72 -->
<g id="edge72" class="edge">
<title>block_63&#45;&gt;codeblock_72</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8369,-2189.5679C8369,-2072.2526 8369,-1424.1373 8369,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="8372.5001,-1280.2429 8369,-1270.2429 8365.5001,-1280.2429 8372.5001,-1280.2429"/>
</g>
<!-- leaf_74 -->
<g id="node75" class="node">
<title>leaf_74</title>
<polygon fill="none" stroke="#c0c0c0" points="8528,-1270.2023 8474,-1270.2023 8474,-1234.2023 8528,-1234.2023 8528,-1270.2023"/>
</g>
<!-- block_63&#45;&gt;leaf_74 -->
<g id="edge74" class="edge">
<title>block_63&#45;&gt;leaf_74</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8371.519,-2189.5679C8387.7241,-2072.2526 8477.2501,-1424.1373 8497.1009,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="8500.6067,-1280.6278 8498.508,-1270.2429 8493.6725,-1279.6699 8500.6067,-1280.6278"/>
</g>
<!-- codeblock_75 -->
<g id="node76" class="node">
<title>codeblock_75</title>
<ellipse fill="none" stroke="#000000" cx="8633" cy="-1252.2023" rx="86.7905" ry="18"/>
<text text-anchor="middle" x="8633" y="-1248.0023" font-family="Helvetica,sans-Serif" font-size="14.00" fill="#000000">code block 209&#45;211</text>
</g>
<!-- block_64&#45;&gt;codeblock_75 -->
<g id="edge75" class="edge">
<title>block_64&#45;&gt;codeblock_75</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8577.0878,-2189.5679C8584.0854,-2072.2526 8622.7444,-1424.1373 8631.3163,-1280.4292"/>
<polygon fill="#000000" stroke="#000000" points="8634.8222,-1280.4336 8631.9239,-1270.2429 8627.8346,-1280.0167 8634.8222,-1280.4336"/>
</g>
<!-- leaf_77 -->
<g id="node78" class="node">
<title>leaf_77</title>
<polygon fill="none" stroke="#c0c0c0" points="8792,-1270.2023 8738,-1270.2023 8738,-1234.2023 8792,-1234.2023 8792,-1270.2023"/>
</g>
<!-- block_64&#45;&gt;leaf_77 -->
<g id="edge77" class="edge">
<title>block_64&#45;&gt;leaf_77</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8571.5133,-2189.6566C8548.6957,-2092.8499 8454.0666,-1631.2791 8650,-1353.8024 8672.2563,-1322.2834 8700.7215,-1344.0535 8729,-1317.8024 8740.2289,-1307.3785 8748.7523,-1292.6362 8754.6797,-1279.7667"/>
<polygon fill="#000000" stroke="#000000" points="8757.9753,-1280.9625 8758.7082,-1270.393 8751.5441,-1278.1985 8757.9753,-1280.9625"/>
</g>
<!-- leaf_67 -->
<g id="node68" class="node">
<title>leaf_67</title>
<polygon fill="none" stroke="#c0c0c0" points="7949,-1150.4033 7443,-1150.4033 7443,-.1989 7949,-.1989 7949,-1150.4033"/>
<text text-anchor="middle" x="7696" y="-1135.4022" font-family="Inconsolata" font-size="14.00" fill="#000000">local function make_ast_node(id, first, t, last, str, metas, offset)</text>
<text text-anchor="middle" x="7696" y="-1120.0021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;local offset = offset or 0</text>
<text text-anchor="middle" x="7696" y="-1104.6021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.first = first + offset</text>
<text text-anchor="middle" x="7696" y="-1089.2021" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.last &#160;= last + offset &#45; 1</text>
<text text-anchor="middle" x="7696" y="-1073.802" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;t.str &#160;&#160;= str</text>
<text text-anchor="middle" x="7696" y="-1058.402" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;if metas[id] then</text>
<text text-anchor="middle" x="7696" y="-1043.002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;t = metas[id](t, str)</text>
<text text-anchor="middle" x="7696" y="-1027.6019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;assert(t.id == id)</text>
<text text-anchor="middle" x="7696" y="-1012.2019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;else</text>
<text text-anchor="middle" x="7696" y="-996.8019" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;t.id = id</text>
<text text-anchor="middle" x="7696" y="-981.4018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;setmetatable(t, {__index = Node,</text>
<text text-anchor="middle" x="7696" y="-966.0018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;__tostring = Node.toString})</text>
<text text-anchor="middle" x="7696" y="-950.6018" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;end</text>
<text text-anchor="middle" x="7696" y="-935.2017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;assert(t.isNode, &quot;failed isNode: &quot; .. id)</text>
<text text-anchor="middle" x="7696" y="-919.8017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;assert(t.str)</text>
<text text-anchor="middle" x="7696" y="-904.4017" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;return t</text>
<text text-anchor="middle" x="7696" y="-889.0017" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
<text text-anchor="middle" x="7696" y="-841.6016" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; some useful/common lpeg patterns</text>
<text text-anchor="middle" x="7696" y="-826.2016" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cp = L.Cp</text>
<text text-anchor="middle" x="7696" y="-810.8016" font-family="Inconsolata" font-size="14.00" fill="#000000">local Cc = L.Cc</text>
<text text-anchor="middle" x="7696" y="-795.4015" font-family="Inconsolata" font-size="14.00" fill="#000000">local Ct = L.Ct</text>
<text text-anchor="middle" x="7696" y="-780.0015" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg1_str = L.Carg(1)</text>
<text text-anchor="middle" x="7696" y="-764.6015" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg2_metas = L.Carg(2)</text>
<text text-anchor="middle" x="7696" y="-749.2014" font-family="Inconsolata" font-size="14.00" fill="#000000">local arg3_offset = L.Carg(3)</text>
<text text-anchor="middle" x="7696" y="-701.8014" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; setup an environment where you can easily define lpeg grammars</text>
<text text-anchor="middle" x="7696" y="-686.4014" font-family="Inconsolata" font-size="14.00" fill="#000000">&#45;&#45; with lots of syntax sugar</text>
<text text-anchor="middle" x="7696" y="-671.0013" font-family="Inconsolata" font-size="14.00" fill="#000000">local function define(func, g, e)</text>
<text text-anchor="middle" x="7696" y="-655.6013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;g = g or {}</text>
<text text-anchor="middle" x="7696" y="-640.2013" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if e == nil then</text>
<text text-anchor="middle" x="7696" y="-624.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;e = V == &quot; 5.1&quot; and getfenv(func) or _G</text>
<text text-anchor="middle" x="7696" y="-609.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="7696" y="-594.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local suppressed = {}</text>
<text text-anchor="middle" x="7696" y="-578.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env = {}</text>
<text text-anchor="middle" x="7696" y="-563.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;local env_index = {</text>
<text text-anchor="middle" x="7696" y="-547.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;START = function(name) g[1] = name end,</text>
<text text-anchor="middle" x="7696" y="-532.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;SUPPRESS = function(...)</text>
<text text-anchor="middle" x="7696" y="-517.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;suppressed = {}</text>
<text text-anchor="middle" x="7696" y="-501.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;for i = 1, select(&#39;#&#39;, ...) do</text>
<text text-anchor="middle" x="7696" y="-486.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;suppressed[select(i, ... )] = true</text>
<text text-anchor="middle" x="7696" y="-470.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="7696" y="-455.4009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end,</text>
<text text-anchor="middle" x="7696" y="-440.0009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;V = L.V,</text>
<text text-anchor="middle" x="7696" y="-424.6008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;P = L.P,</text>
<text text-anchor="middle" x="7696" y="-409.2008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;}</text>
<text text-anchor="middle" x="7696" y="-377.8008" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env_index, { __index = e })</text>
<text text-anchor="middle" x="7696" y="-362.4007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;setmetatable(env, {</text>
<text text-anchor="middle" x="7696" y="-347.0007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__index = env_index,</text>
<text text-anchor="middle" x="7696" y="-331.6007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;__newindex = function( _, name, val )</text>
<text text-anchor="middle" x="7696" y="-316.2007" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;if suppressed[ name ] then</text>
<text text-anchor="middle" x="7696" y="-300.8006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = val</text>
<text text-anchor="middle" x="7696" y="-285.4006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;else</text>
<text text-anchor="middle" x="7696" y="-270.0006" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;g[ name ] = (Cc(name) </text>
<text text-anchor="middle" x="7696" y="-254.6005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Cp() </text>
<text text-anchor="middle" x="7696" y="-239.2005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Ct(val)</text>
<text text-anchor="middle" x="7696" y="-223.8005" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* Cp()</text>
<text text-anchor="middle" x="7696" y="-208.4004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* arg1_str</text>
<text text-anchor="middle" x="7696" y="-193.0004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* arg2_metas)</text>
<text text-anchor="middle" x="7696" y="-177.6004" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;* arg3_offset / make_ast_node</text>
<text text-anchor="middle" x="7696" y="-162.2003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;end</text>
<text text-anchor="middle" x="7696" y="-146.8003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="7696" y="-131.4003" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;})</text>
<text text-anchor="middle" x="7696" y="-116.0002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#45;&#45; call passed function with custom environment (5.1&#45; and 5.2&#45;style)</text>
<text text-anchor="middle" x="7696" y="-100.6002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if V == &quot; 5.1&quot; then</text>
<text text-anchor="middle" x="7696" y="-85.2002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;setfenv( func, env )</text>
<text text-anchor="middle" x="7696" y="-69.8002" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="7696" y="-54.4001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;func( env )</text>
<text text-anchor="middle" x="7696" y="-39.0001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;assert( g[ 1 ] and g[ g[ 1 ] ], &quot;no start rule defined&quot; )</text>
<text text-anchor="middle" x="7696" y="-23.6001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return g</text>
<text text-anchor="middle" x="7696" y="-8.2" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_66&#45;&gt;leaf_67 -->
<g id="edge67" class="edge">
<title>codeblock_66&#45;&gt;leaf_67</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M7837.1216,-1234.0968C7833.7237,-1218.2347 7828.2631,-1192.7426 7821.4213,-1160.8032"/>
<polygon fill="#000000" stroke="#000000" points="7824.7714,-1159.7325 7819.2544,-1150.6874 7817.9267,-1161.1988 7824.7714,-1159.7325"/>
</g>
<!-- leaf_70 -->
<g id="node71" class="node">
<title>leaf_70</title>
<polygon fill="none" stroke="#c0c0c0" points="8242.5,-641.0015 7967.5,-641.0015 7967.5,-509.6007 8242.5,-509.6007 8242.5,-641.0015"/>
<text text-anchor="middle" x="8105" y="-625.7012" font-family="Inconsolata" font-size="14.00" fill="#000000">local function refineMetas(metas)</text>
<text text-anchor="middle" x="8105" y="-610.3012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;for _,v in pairs(metas) do</text>
<text text-anchor="middle" x="8105" y="-594.9011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;if not v[&quot;__tostring&quot;] then</text>
<text text-anchor="middle" x="8105" y="-579.5011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;v[&quot;__tostring&quot;] = Node.toString</text>
<text text-anchor="middle" x="8105" y="-564.1011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="8105" y="-548.701" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="8105" y="-533.301" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;return metas</text>
<text text-anchor="middle" x="8105" y="-517.901" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_69&#45;&gt;leaf_70 -->
<g id="edge70" class="edge">
<title>codeblock_69&#45;&gt;leaf_70</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8105,-1234.0968C8105,-1151.3218 8105,-806.3086 8105,-651.2988"/>
<polygon fill="#000000" stroke="#000000" points="8108.5001,-650.9202 8105,-640.9202 8101.5001,-650.9202 8108.5001,-650.9202"/>
</g>
<!-- leaf_73 -->
<g id="node74" class="node">
<title>leaf_73</title>
<polygon fill="none" stroke="#c0c0c0" points="8745.5,-679.5016 8260.5,-679.5016 8260.5,-471.1006 8745.5,-471.1006 8745.5,-679.5016"/>
<text text-anchor="middle" x="8503" y="-664.2013" font-family="Inconsolata" font-size="14.00" fill="#000000">local function new(grammar_template, metas)</text>
<text text-anchor="middle" x="8503" y="-648.8012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;if type(grammar_template) == &#39;function&#39; then</text>
<text text-anchor="middle" x="8503" y="-633.4012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local metas = metas or {}</text>
<text text-anchor="middle" x="8503" y="-618.0012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local grammar = define(grammar_template, nil, metas)</text>
<text text-anchor="middle" x="8503" y="-602.6012" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;local parse = function(str, offset)</text>
<text text-anchor="middle" x="8503" y="-587.2011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;local offset = offset or 0</text>
<text text-anchor="middle" x="8503" y="-571.8011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;&#160;&#160;return L.match(grammar, str, 1, str, metas, offset) &#45;&#45; other </text>
<text text-anchor="middle" x="8503" y="-556.4011" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;end</text>
<text text-anchor="middle" x="8503" y="-541.001" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;return parse</text>
<text text-anchor="middle" x="8503" y="-525.601" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;else</text>
<text text-anchor="middle" x="8503" y="-510.201" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;&#160;&#160;s:halt(&quot;no way to build grammar out of &quot; .. type(template))</text>
<text text-anchor="middle" x="8503" y="-494.8009" font-family="Inconsolata" font-size="14.00" fill="#000000"> &#160;end</text>
<text text-anchor="middle" x="8503" y="-479.4009" font-family="Inconsolata" font-size="14.00" fill="#000000">end</text>
</g>
<!-- codeblock_72&#45;&gt;leaf_73 -->
<g id="edge73" class="edge">
<title>codeblock_72&#45;&gt;leaf_73</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8372.5842,-1234.0968C8387.7341,-1157.5672 8447.2588,-856.8781 8480.4058,-689.4357"/>
<polygon fill="#000000" stroke="#000000" points="8483.8461,-690.08 8482.3547,-679.5907 8476.9794,-688.7206 8483.8461,-690.08"/>
</g>
<!-- leaf_76 -->
<g id="node77" class="node">
<title>leaf_76</title>
<polygon fill="none" stroke="#c0c0c0" points="8850,-593.3011 8764,-593.3011 8764,-557.3011 8850,-557.3011 8850,-593.3011"/>
<text text-anchor="middle" x="8807" y="-571.8011" font-family="Inconsolata" font-size="14.00" fill="#000000">return new</text>
</g>
<!-- codeblock_75&#45;&gt;leaf_76 -->
<g id="edge76" class="edge">
<title>codeblock_75&#45;&gt;leaf_76</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M8664.6077,-1235.3259C8693.3079,-1218.1391 8734.0967,-1188.6378 8754,-1150.6022 8852.7699,-961.8507 8824.1314,-690.3016 8811.5084,-603.2641"/>
<polygon fill="#000000" stroke="#000000" points="8814.967,-602.7262 8810.0229,-593.3557 8808.0443,-603.7641 8814.967,-602.7262"/>
</g>
</g>
</svg>