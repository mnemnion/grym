digraph lpegNode {

node [fontname=Helvetica]
edge [style=dashed]

doc_0 [label="doc - 126"]


doc_0 -> { section_1}
{rank=same; section_1}

section_1 [label="section: 1-39"]


// END RANK doc_0

section_1 -> { header_2 prose_3 codeblock_4 section_5}
{rank=same; header_2 prose_3 codeblock_4 section_5}

header_2 [label="1 : Knit module"]

prose_3 [label="prose"]

codeblock_4 [label="code block 4-37"]

section_5 [label="section: 40-126"]


// END RANK section_1

header_2 -> leaf_6
leaf_6  [color=Gray,shape=rectangle,fontname=Inconsolata,label=" * Knit module"]
// END RANK header_2

prose_3 -> { raw_7}
{rank=same; raw_7}

raw_7 [label="raw"]


// END RANK prose_3

raw_7 -> leaf_8
leaf_8  [color=Gray,shape=rectangle,fontname=Inconsolata,label="
 
"]
// END RANK raw_7

codeblock_4 -> leaf_9
leaf_9  [color=Gray,shape=rectangle,fontname=Inconsolata,label="local L = require \"lpeg\"

local s = require \"status\"
local a = require \"ansi\"
s.chatty = true

local pl_file = require \"pl.file\"
local pl_dir = require \"pl.dir\"
local pl_path = require \"pl.path\"
local getfiles = pl_dir.getfiles
local getdirectories = pl_dir.getdirectories
local makepath = pl_dir.makepath
local extension = pl_path.extension
local dirname = pl_path.dirname
local basename = pl_path.basename
local read = pl_file.read
local write = pl_file.write
local delete = pl_file.delete
local isdir = pl_path.isdir

local epeg = require \"epeg\"

local knitter = require \"knit/knitter\"

local walk = require \"walk\"
local strHas = walk.strHas
local endsWith = walk.endsWith
local subLastFor = walk.subLastFor
local writeOnChange = walk.writeOnChange

local Doc = require \"Orbit/doc\"
"]
// END RANK codeblock_4

section_5 -> { header_10 prose_11 prose_12 codeblock_13 prose_14 codeblock_15}
{rank=same; header_10 prose_11 prose_12 codeblock_13 prose_14 codeblock_15}

header_10 [label="3 : knit_dir(knitter, pwd, depth)"]

prose_11 [label="prose"]

prose_12 [label="prose"]

codeblock_13 [label="code block 48-97"]

prose_14 [label="prose"]

codeblock_15 [label="code block 103-125"]


// END RANK section_5

header_10 -> leaf_16
leaf_16  [color=Gray,shape=rectangle,fontname=Inconsolata,label="*** knit_dir(knitter, pwd, depth)"]
// END RANK header_10

prose_11 -> { raw_17 prespace_18 literal_19 raw_20 prespace_21 literal_22 raw_23}
{rank=same; raw_17 prespace_18 literal_19 raw_20 prespace_21 literal_22 raw_23}

raw_17 [label="raw"]

prespace_18 [label="prespace"]

literal_19 [label="literal"]

raw_20 [label="raw"]

prespace_21 [label="prespace"]

literal_22 [label="literal"]

raw_23 [label="raw"]


// END RANK prose_11

raw_17 -> leaf_24
leaf_24  [color=Gray,shape=rectangle,fontname=Inconsolata,label="

 Walks a given directory, kniting the contents of"]
// END RANK raw_17

prespace_18 -> leaf_25
leaf_25  [color=Gray,shape=rectangle,fontname=Inconsolata,label=" "]
// END RANK prespace_18

literal_19 -> leaf_26
leaf_26  [color=Gray,shape=rectangle,fontname=Inconsolata,label="/org/"]
// END RANK literal_19

raw_20 -> leaf_27
leaf_27  [color=Gray,shape=rectangle,fontname=Inconsolata,label="
 into"]
// END RANK raw_20

prespace_21 -> leaf_28
leaf_28  [color=Gray,shape=rectangle,fontname=Inconsolata,label=" "]
// END RANK prespace_21

literal_22 -> leaf_29
leaf_29  [color=Gray,shape=rectangle,fontname=Inconsolata,label="/src/"]
// END RANK literal_22

raw_23 -> leaf_30
leaf_30  [color=Gray,shape=rectangle,fontname=Inconsolata,label=". 
"]
// END RANK raw_23

prose_12 -> { raw_31}
{rank=same; raw_31}

raw_31 [label="raw"]


// END RANK prose_12

raw_31 -> leaf_32
leaf_32  [color=Gray,shape=rectangle,fontname=Inconsolata,label="
 - [X] TODO fix up the orb/notes directory so it doesn't explode
       the knit.
"]
// END RANK raw_31

codeblock_13 -> leaf_33
leaf_33  [color=Gray,shape=rectangle,fontname=Inconsolata,label="local function knit_dir(knitter, orb_dir, pwd)
    local knits = {}
    for dir in pl_dir.walk(orb_dir, false, false) do
        if not strHas(\".git\", dir) and isdir(dir)
            and not strHas(\"src/lib\", dir) then

            local files = getfiles(dir)
            s:verb(\"  * \" .. dir)
            local subdirs = getdirectories(dir)
            for _, f in ipairs(files) do
                if extension(f) == \".orb\" then
                    -- read and knit
                    s:verb(\"    - \" .. f)
                    local orb_f = read(f)
                    local knitted = knitter:knit(Doc(orb_f))
                    local src_dir = subLastFor(\"/orb\", \"/src\", dirname(f))
                    makepath(src_dir)
                    local bare_name = basename(f):sub(1, -5) -- 4 == #\".orb\"
                    local out_name = src_dir .. \"/\" .. bare_name .. \".lua\"
                    local current_src = read(out_name) or \"\"
                    local changed = writeOnChange(knitted, current_src, out_name, 0)
                    if changed then
                        local tmp_dir = \"../tmp\" .. src_dir
                        makepath(tmp_dir)
                        local tmp_out = \"../tmp\" .. out_name
                        write(tmp_out, current_src)
                        knits[#knits + 1] = out_name
                    end     
                end
            end
        end
    end



    -- collect changed files if any
    local grymbacks = \"\"
    for _, v in ipairs(knits) do
        grymbacks = grymbacks .. v .. \"\\n\"
    end
    if grymbacks ~= \"\" then
        s:chat(\"grymbacks: \\n\" .. grymbacks)
    end
    -- if nothing changes, no rollback is needed, empty file
    write(pwd .. \"/.grymback\", grymbacks)
    return true
end
"]
// END RANK codeblock_13

prose_14 -> { raw_34}
{rank=same; raw_34}

raw_34 [label="raw"]


// END RANK prose_14

raw_34 -> leaf_35
leaf_35  [color=Gray,shape=rectangle,fontname=Inconsolata,label="
- [ ] #todo add some proper codex detection and correction

"]
// END RANK raw_34

codeblock_15 -> leaf_36
leaf_36  [color=Gray,shape=rectangle,fontname=Inconsolata,label="
local function knit_all(knitter, pwd)
    local did_knit = false
    for dir in pl_dir.walk(pwd, false, false) do
        if not strHas(\".git\", dir) and 
            not strHas(\"/tmp\", dir) and isdir(dir) 
            and endsWith(\"orb\", dir) then
            s:chat(a.cyan(\"Knit: \" .. dir))
            did_knit = knit_dir(knitter, dir, pwd)
        end
    end
    if not did_knit then
        s:chat(\"No orb directory to knit. No action taken.\")
    end
    return did_knit
end

knitter.knit_all = knit_all


return knitter"]
// END RANK codeblock_15


}
